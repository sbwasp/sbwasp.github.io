

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.5. loadlibrary &mdash; South Bay WASP 1.0.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="South Bay WASP 1.0.2 documentation" href="../index.html"/>
        <link rel="up" title="8. Pentest Study" href="../pentest_study.html"/>
        <link rel="next" title="8.6. Linux Exploitation Tricks" href="linux_exploitation_tricks.html"/>
        <link rel="prev" title="8.4. exiftool" href="exiftool.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2factor.html">8.1. 2 Factor Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="email_security.html">8.2. Email Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="exfiltration.html">8.3. Exfiltration</a></li>
<li class="toctree-l2"><a class="reference internal" href="exiftool.html">8.4. <strong class="program">exiftool</strong></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.5. loadlibrary</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-s-loadlibrary">8.5.1. What’s loadlibrary?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-windows-dll-s-on-linux">8.5.1.1. Running Windows DLL’s on Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-tool-to-run-microsoft-malware-protection-engine">8.5.1.2. Building the tool to run Microsoft Malware Protection Engine</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-msmpeng">8.5.2. Running MsMpEng</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtain-sample-malware">8.5.2.1. Obtain sample malware</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scanning-malware-with-msmpeng">8.5.2.2. Scanning malware with MsMpEng</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="linux_exploitation_tricks.html">8.6. Linux Exploitation Tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="llmnr.html">8.7. Windows broadcast name resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntlm.html">8.8. NTLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="passwords.html">8.9. Password Cracking Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="php.html">8.10. PHP &amp; MySQL Shortcomings</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnerabilities.html">8.11. Vulnerabilites</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">8.12. WiFi Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_study.html">8. Pentest Study</a> &raquo;</li>
        
      <li>8.5. loadlibrary</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/study/loadlibrary.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>8.5. <a class="reference external" href="https://github.com/taviso/loadlibrary">loadlibrary</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-s-loadlibrary">
<h2>8.5.1. What’s <a class="reference external" href="https://github.com/taviso/loadlibrary">loadlibrary</a>?<a class="headerlink" href="#what-s-loadlibrary" title="Permalink to this headline">¶</a></h2>
<div class="section" id="running-windows-dll-s-on-linux">
<h3>8.5.1.1. Running Windows DLL’s on Linux<a class="headerlink" href="#running-windows-dll-s-on-linux" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://github.com/taviso/loadlibrary">loadlibrary</a>:</p>
<blockquote>
<div><p>This repository contains a library that allows native Linux programs to load and call functions from a Windows DLL.</p>
<p>As a demonstration, I’ve ported Windows Defender to Linux.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./mpclient eicar.com
<span class="go">main(): Scanning eicar.com...</span>
<span class="go">EngineScanCallback(): Scanning input</span>
<span class="go">EngineScanCallback(): Threat Virus:DOS/EICAR_Test_File identified.</span>
</pre></div>
</div>
</div></blockquote>
<p>The motivation is to allow using Linux to fuzz Windows software:</p>
<blockquote>
<div><p>Distributed, scalable fuzzing on Windows can be challenging and inefficient. This is especially true for endpoint security products, which use complex interconnected components that span across kernel and user space. This often requires spinning up an entire virtualized Windows environment to fuzz them or collect coverage data.</p>
<p>This is less of a problem on Linux, and I’ve found that porting components of Windows Antivirus products to Linux is often possible. This allows me to run the code I’m testing in minimal containers with very little overhead, and easily scale up testing.</p>
<p>This is just personal opinion, but I also think Linux has better tools.</p>
</div></blockquote>
<p>The software selected to port is Windows Defender:</p>
<blockquote>
<div><p>MsMpEng is the Malware Protection service that is enabled by default on Windows 8, 8.1, 10, Windows Server 2016, and so on. Additionally, Microsoft Security Essentials, System Centre Endpoint Protection and various other Microsoft security products share the same core engine.</p>
<p>The core component of MsMpEng responsible for scanning and analysis is called mpengine. Mpengine is a vast and complex attack surface, comprising of handlers for dozens of esoteric archive formats, executable packers, full system emulators for various architectures and interpreters for various languages. All of this code is accessible to remote attackers.</p>
</div></blockquote>
</div>
<div class="section" id="building-the-tool-to-run-microsoft-malware-protection-engine">
<span id="load-library"></span><h3>8.5.1.2. Building the tool to run Microsoft Malware Protection Engine<a class="headerlink" href="#building-the-tool-to-run-microsoft-malware-protection-engine" title="Permalink to this headline">¶</a></h3>
<p>Running MsMpEng on Linux requires downloading the MS antimalware program from <a class="reference external" href="https://www.microsoft.com/security/portal/definitions/adl.aspx#manual">Antimalware and antispyware updates</a>. Here’s the required steps for a Google Compute Engine Debian 9 instance:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>

<span class="c1"># Get taviso/loadlibrary from GitHub:</span>
<span class="c1">#     https://github.com/taviso/loadlibrary</span>


<span class="c1"># ***************************************************************************</span>
<span class="c1"># Install required packages</span>
<span class="c1"># ***************************************************************************</span>
sudo apt install <span class="se">\</span>
            libc6-dev-x32 gcc-multilib lib32readline-dev cabextract <span class="se">\</span>
                gdb libimage-exiftool-perl -y

<span class="c1"># ***************************************************************************</span>
<span class="c1"># Get loadlibrary</span>
<span class="c1"># ***************************************************************************</span>
<span class="nb">cd</span>
mkdir -p av
<span class="nb">cd</span> av
git clone https://github.com/taviso/loadlibrary.git

<span class="c1"># ***************************************************************************</span>
<span class="c1"># Get MsMpEng</span>
<span class="c1"># ***************************************************************************</span>
<span class="c1"># Pre-load mpam-fe.exe</span>
<span class="nb">cd</span> loadlibrary/engine
curl -L -o mpam-fe.exe <span class="s1">&#39;https://go.microsoft.com/fwlink/?LinkID=121721&amp;arch=x86&#39;</span>
cabextract mpam-fe.exe
exiftool mpengine.dll <span class="p">|</span> grep <span class="s1">&#39;Product Version Number&#39;</span>
<span class="c1"># NOTE: bug fixed in 1.1.13903.0</span>
<span class="nb">cd</span> ..

<span class="c1"># ***************************************************************************</span>
<span class="c1"># Make</span>
<span class="c1"># ***************************************************************************</span>
<span class="c1"># make loadlibrary</span>
make
<span class="nb">cd</span> ..
</pre></div>
</div>
</div>
</div>
<div class="section" id="running-msmpeng">
<h2>8.5.2. Running MsMpEng<a class="headerlink" href="#running-msmpeng" title="Permalink to this headline">¶</a></h2>
<div class="section" id="obtain-sample-malware">
<h3>8.5.2.1. Obtain sample malware<a class="headerlink" href="#obtain-sample-malware" title="Permalink to this headline">¶</a></h3>
<p>A quick search will show many sources of downloadable malware:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># ***************************************************************************</span>
<span class="c1"># Get some sample viruses</span>
<span class="c1">#</span>
<span class="c1"># https://zeltser.com/malware-sample-sources/</span>
<span class="c1"># http://vxheaven.org/vl.php</span>
<span class="c1">#</span>
<span class="c1"># ***************************************************************************</span>

<span class="nb">cd</span>
mkdir -p av/samples
<span class="nb">cd</span> av/samples

curl -L -o theZoo.zip https://github.com/ytisf/theZoo/zipball/master

mkdir -p Virus.Win
<span class="nb">cd</span> Virus.Win
curl -L -o Virus.Win.tgz http://vxheaven.org/dl/Virus.Win.tgz
tar -xzf Virus.Win.tgz
</pre></div>
</div>
</div>
<div class="section" id="scanning-malware-with-msmpeng">
<h3>8.5.2.2. Scanning malware with MsMpEng<a class="headerlink" href="#scanning-malware-with-msmpeng" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># ***************************************************************************</span>
<span class="c1"># Do some sample runs of ./mpclient (Windows Defender aka MsMpEng)</span>
<span class="c1"># ***************************************************************************</span>
<span class="nb">cd</span> ~/av/loadlibrary
<span class="nv">SAMPLES</span><span class="o">=</span>~/av/samples

./mpclient <span class="nv">$SAMPLES</span>/theZoo.zip <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep Threat <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> tee threats.txt

./mpclient <span class="nv">$SAMPLES</span>/Virus.Win/Virus.Win32.Mooder.l

./mpclient <span class="nv">$SAMPLES</span>/Virus.Win/Virus.Win32.W* <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> grep Threat <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> tee threats.txt
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="linux_exploitation_tricks.html" class="btn btn-neutral float-right" title="8.6. Linux Exploitation Tricks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="exiftool.html" class="btn btn-neutral" title="8.4. exiftool" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>