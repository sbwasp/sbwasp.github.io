

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="default-src 'none'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self'; img-src 'self'; style-src 'self'; font-src 'self'; form-action 'self'; frame-ancestors 'none'; base-uri 'self'" http-equiv="Content-Security-Policy" />
<meta content="nosniff" http-equiv="X-Content-Type-Options" />
<meta content="deny" http-equiv="X-Frame-Options" />
<meta content="1; mode=block" http-equiv="X-XSS-Protection" />
<meta content="strict-origin" http-equiv="Referrer-Policy" />
<meta content="max-age=31536000; includeSubDomains" http-equiv="Strict-Transport-Security" />
<meta content="'*'" http-equiv="Access-Control-Allow-Origin" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.1. 2 Factor Authentication &mdash; South Bay WASP 1.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8.2. Cryptography" href="crypto.html" />
    <link rel="prev" title="8. Pentest Study" href="../pentest_study.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.1. 2 Factor Authentication</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id21">8.1.1. 2FA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-dark-ages-of-passwords">8.1.1.1. The Dark Ages of passwords</a></li>
<li class="toctree-l4"><a class="reference internal" href="#common-2fa-options">8.1.1.2. Common 2FA options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#websites-restrict-2fa-options">8.1.1.3. Websites restrict 2FA options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#one-person-s-preferred-2fa-options-techniques">8.1.1.4. One person’s preferred 2FA options, techniques</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overall-2fa-plan">8.1.1.5. Overall 2FA plan</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#fido-u2f">8.1.2. FIDO U2F</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-a-security-key">8.1.2.1. What is a security key?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-was-the-security-key-set-up">8.1.2.2. How was the security key set up?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-does-it-work">8.1.2.3. How does it work?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-are-the-shortcomings">8.1.2.4. What are the shortcomings?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#will-it-be-near-universally-adopted">8.1.2.5. Will it be near-universally adopted?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#totp-and-hotp-2fa">8.1.3. TOTP and HOTP 2FA</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#totp-based-apps">8.1.3.1. TOTP-based apps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">8.1.3.2. TOTP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="crypto.html">8.2. Cryptography</a></li>
<li class="toctree-l2"><a class="reference internal" href="dnssec.html">8.3. DNSSEC, DANE, and DNS encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="email_security.html">8.4. Email Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="exfiltration.html">8.5. Exfiltration</a></li>
<li class="toctree-l2"><a class="reference internal" href="exiftool.html">8.6. <strong class="program">exiftool</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="fw.html">8.7. Firewalls</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">8.8. IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="loadlibrary.html">8.9. loadlibrary</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_exploitation_tricks.html">8.10. Linux Exploitation Tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_networking.html">8.11. Linux networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="llmnr.html">8.12. Windows broadcast name resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="nftables.html">8.13. nftables</a></li>
<li class="toctree-l2"><a class="reference internal" href="not_getting_hacked.html">8.14. Not getting hacked</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntlm.html">8.15. NTLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="passwords.html">8.16. Password Cracking Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="php.html">8.17. PHP &amp; MySQL Shortcomings</a></li>
<li class="toctree-l2"><a class="reference internal" href="static_websites.html">8.18. Static websites</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtualization_networking.html">8.19. Virtualization &amp; networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnerabilities.html">8.20. Vulnerabilites</a></li>
<li class="toctree-l2"><a class="reference internal" href="waf.html">8.21. WAF Evasion</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">8.22. WiFi Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_study.html">8. Pentest Study</a> &raquo;</li>
        
      <li>8.1. 2 Factor Authentication</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/study/2factor.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="factor-authentication">
<span id="fa"></span><h1>8.1. 2 Factor Authentication<a class="headerlink" href="#factor-authentication" title="Permalink to this headline">¶</a></h1>
<p>Pentesters need security, too.</p>
<div class="section" id="id21">
<h2>8.1.1. 2FA<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-dark-ages-of-passwords">
<h3>8.1.1.1. The Dark Ages of passwords<a class="headerlink" href="#the-dark-ages-of-passwords" title="Permalink to this headline">¶</a></h3>
<p>My password manager has over 125 password entries. This is the dark ages of passwords forcing us to use password managers, and cloud-based ones to solve the problems of disaster recovery and syncing passwords on multiple devices. (Your house burns down with all your devices including 2FA ones: tell me how you’re going to recover. If you do there’s something non-local, likely in the cloud.) The good news is there are only ~ 30 accounts worth securing with 2FA, the bad news ~ 10 have no 2FA. Embarrassingly all those were financial or medical providers who should be <em>most</em> instead of <em>least</em> likely to have 2FA. The Mint application offered SMS/email codes; Charles Schwab and Fidelity apppear to use the Symantec VIP system based on either a unique hardware token (why not FIDO U2F?) or the Symantec VIP Access app (why not standard TOTP?) with both requiring setup talking to a human over the phone. Note - security doesn’t add to the bottom line so the financial and medical industries lag behind the tech industry. Most disappointingly, while Amazon does support TOTP it uses just the (inexpensive) Gemalto line of hardware security devices.</p>
<p>In an ideal world I would expect an account service where I might have 3 accounts: one for sites I don’t care about, another for financial institutions, and a third for IT-related sites. Of course there are data beyond passwords to store for some of the accounts that might be stored in a password manager, but they aren’t needed frequently to use the application.</p>
</div>
<div class="section" id="common-2fa-options">
<h3>8.1.1.2. Common 2FA options<a class="headerlink" href="#common-2fa-options" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="https://twofactorauth.org/">Two Factor Auth (2FA)</a> for a list of websites providing 2FA. Here are a few of the most common 2FA methods:</p>
<dl class="docutils">
<dt>Hardware device</dt>
<dd>Something you physically carry, most simply &amp; cheaply a FIDO U2F USB-A device (see <a class="reference internal" href="#fido-u2f"><span class="std std-ref">FIDO U2F</span></a>).</dd>
<dt>TOTP software</dt>
<dd>An application like <strong class="program">Authy</strong> often running on a cell phone generating a 6-8 digit pin (see <a class="reference internal" href="#totp"><span class="std std-ref">TOTP and HOTP 2FA</span></a>).</dd>
<dt>Less secure options</dt>
<dd>Email or SMS message, both subject to account takeover (mail or phone number).</dd>
</dl>
</div>
<div class="section" id="websites-restrict-2fa-options">
<h3>8.1.1.3. Websites restrict 2FA options<a class="headerlink" href="#websites-restrict-2fa-options" title="Permalink to this headline">¶</a></h3>
<p>You have to accomodate multiple 2FA options based on the websites you use.</p>
<p>Google is amongst the best:</p>
<ul class="simple">
<li>Multiple U2F and Yubico-like hardware security keys</li>
<li>Multiple TOTP apps like Google Authenticator and Authy</li>
<li>Backup codes</li>
<li>Voice/text messages (phone-dependent)</li>
<li>Google Prompt (phone-dependent)</li>
</ul>
<p>As noted above, most financial sites didn’t offer any 2FA options. A number of sites offered only SMS/email messages.</p>
<p>Bitbucket offered TOTP or hardware security keys, but not both. And GitHub restricted the number of hardware security keys (only 3).</p>
<p>Note that one TOTP code can be used by all of your TOTP apps for that site, so there is no restriction on the number of TOTP apps per site.</p>
</div>
<div class="section" id="one-person-s-preferred-2fa-options-techniques">
<h3>8.1.1.4. One person’s preferred 2FA options, techniques<a class="headerlink" href="#one-person-s-preferred-2fa-options-techniques" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Hardware 2FA devices are the preferred option.</p>
<p>Either a FIDO U2F device (inexpensive) or Yubico with NFC if phones need access to an account where both U2F and TOTP are not allowed.</p>
</li>
<li><p class="first">TOTP app Authy with Google Authenticator redundantly set up.</p>
<p>Authy has two big advantages. First, a Chrome browser plugin is available which allows doing the authentication from a desktop/notebook. Second, Authy allows (password protected) cloud backup and syncing to multiple/new devices. That backup can be turned off.</p>
<p>Note that when you set up TOTP <strong>never scan the QR code, instead click the</strong> <em>Can’t scan the barcode?</em> <strong>option to get a security code to save in your password managers</strong>. The security code can not only be used to provision your first device/app, but can be reused on any number of other devices/TOTP apps, including a new replacement phone.</p>
</li>
<li><p class="first">SMS/email messages are a last resort.</p>
</li>
</ol>
</div>
<div class="section" id="overall-2fa-plan">
<h3>8.1.1.5. Overall 2FA plan<a class="headerlink" href="#overall-2fa-plan" title="Permalink to this headline">¶</a></h3>
<p>The idea is to be able to have your house with all your devices and 2FA burn down and still get access to your accounts.</p>
<ol class="arabic">
<li><p class="first">Don’t depend on cell phones</p>
<p>Android cell phones are mostly insecure due to lack of patches. The latest Android One phones from non-Google vendors are only guaranteed 18 months of updates. Most people keep their phones much longer. Google’s phones are supported 3 years, while iPhones tend to be supported 4-5 years.</p>
<p>Users generally have only 1 cell phone which can fail, making their TOTP &amp; password manager apps unavailable.</p>
<p>Cell coverage is not always available so SMS/email to phones is not dependable.</p>
</li>
<li><p class="first">Have multiple password managers</p>
<p>The author has at least 2, with one of them protected with multiple passwords (no 2FA) and the other a password + U2F device + TOTP app. All TOTP security codes are stored in the password manager to allow setting up multiple devices including a replacement cell phone. Yes, you could store a backup hardware U2F device elsewhere, but the tradeoff is it might be stolen or take time to access in an emergency.</p>
</li>
<li><p class="first">Have some memorized passwords</p>
<p>I have a password manager that’s protected by 2 passwords (to handle the case of total destruction of all computing resources). Additionally almost everyone memorizes their cell phone encryption password. And I memorize my Google password to allow getting onto my Chromebook (usually without having to use my U2F device). Not doing so would make me heavily dependent on my phone. Often-used SSH keys passwords are also memorized.</p>
</li>
<li><p class="first">Prefer <strong class="program">Authy</strong> over <strong class="program">Google Authenticator</strong></p>
<p>Setup a desktop with Chrome’s <strong class="program">Authy</strong> extension. It’s not really a second factor when both the password and <strong class="program">Authy</strong> code are done on the desktop, but I’m OK with that. Use <strong class="program">Authy</strong> and possibly <strong class="program">Google Authenticator</strong> on your cell phone.</p>
</li>
<li><p class="first">Passwords stored exclusively in the password manager without 2FA should be “impossible”</p>
<p>This rule might be violated for unimportant sites.</p>
</li>
<li><p class="first">Prefer hardware security devices &gt; TOTP apps &gt; SMS/email</p>
<p>Buy multiple U2F or Yubico-like devices (with NFC if needed for your phone); use Authy on Chrome + Authy &amp; Google Authenticator on your phone; use SMS/email notification only when other 2 methods are not available.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="fido-u2f">
<span id="id22"></span><h2>8.1.2. <a class="reference external" href="https://fidoalliance.org/about">FIDO</a> <a class="reference external" href="https://fidoalliance.org/download/">U2F</a><a class="headerlink" href="#fido-u2f" title="Permalink to this headline">¶</a></h2>
<p>This started with notice of <a class="reference external" href="https://fidoalliance.org/news/item/google-launches-security-key">Google Launches Security Key, World’s First Deployment of Fast Identity Online Universal Second Factor (FIDO U2F) Authentication</a> announcing Google’s <a class="reference external" href="http://googleonlinesecurity.blogspot.com/2014/10/strengthening-2-step-verification-with.html">Strengthening 2-Step Verification with Security Key</a>. Basically, Google’s 2-step verification added support for the FIDO (Fast IDentity Online) U2F (Universal 2nd Factor) security keys, a simple USB hardware device. Currently only Google supports FIDO U2F and it requires the Google Chrome browser version 38+. For details consult <a class="reference external" href="https://fidoalliance.org/specifications/download/">FIDO technical specifications</a>; the detailed overview <a class="reference external" href="https://fidoalliance.org/specs/fido-u2f-overview-v1.0-rd-20141008.pdf">FIDO U2F Architectural Overview</a> is freely quoted below without attribution.</p>
<div class="section" id="what-is-a-security-key">
<h3>8.1.2.1. What is a security key?<a class="headerlink" href="#what-is-a-security-key" title="Permalink to this headline">¶</a></h3>
<p>For actual devices see <a class="reference external" href="http://www.amazon.com/s/?field-keywords=%22FIDO%20U2F%20Security%20Key%22">Amazon FIDO U2F Security Key search</a>.</p>
</div>
<div class="section" id="how-was-the-security-key-set-up">
<h3>8.1.2.2. How was the security key set up?<a class="headerlink" href="#how-was-the-security-key-set-up" title="Permalink to this headline">¶</a></h3>
<p>Simple FIDO U2F devices can be used for Google account 2 factor authentication. While the devices usually lack NFC, Google has multiple choices for <a class="reference external" href="https://www.google.com/landing/2step/features.html">Google account 2-factor authentication</a> that handle desktops, tablets, and mobile phones.</p>
<ul class="simple">
<li>Google Chrome supports FIDO U2F since (ancient) version 38. Currently Opera also supports FIDO U2F, but Firefox support is at best spotty until FIDO 2 (see <a class="reference external" href="https://www.yubico.com/2017/11/how-to-navigate-fido-u2f-in-firefox-quantum/">How to Navigate FIDO U2F in Firefox Quantum</a>).</li>
<li>The security key should work out-of-the-box on Windows and Linux.</li>
<li>The target account’s Google 2-factor authentication was enabled using these options:<ul>
<li>Security keys: this option was enabled and the 2 keys were registered.</li>
<li>Verification codes: the primary option for verification codes was set up to default to Google Authenticator (for the mobile phone), which was installed and configured on the mobile phone. Two backup options were selected: the mobile phone’s number was configured as a backup number, and 10 backup one-use codes were generated in case all the other methods failed.</li>
<li>Registered computers: when first logging into Google using the security key, an option is presented to register the computer to avoid further security key use on that computer. All such computers will be listed under registered computers (which starts off as an empty list).</li>
</ul>
</li>
</ul>
<p>The net effect is that Google login from a desktop computer will ask for the security key, but the mobile phone will default to the Google Authenticator app. If these are not available the backup phone or one of the backup codes could be used to login.</p>
<p>Linux KVM virtual machines need direct access to the USB device, otherwise one of the backup login methods is required.</p>
<p>Note that there is a many-to-many mapping between security keys and accounts; multiple security keys can be used with any one account account, and any one security key can be used with multiple accounts. So the 2 purchased security keys can be backups to each other for all of the user’s accounts. The first security key usage on a computer will ask if the computer should be registered to not require the security key in the future.</p>
</div>
<div class="section" id="how-does-it-work">
<h3>8.1.2.3. How does it work?<a class="headerlink" href="#how-does-it-work" title="Permalink to this headline">¶</a></h3>
<p>Here is an overview of security key functionality:</p>
<blockquote>
<div><p>The U2F device and protocol need to guarantee user privacy and security. At the core of the protocol, the U2F device has a capability (ideally, embodied in a secure element) which mints an origin-specific public/private key pair. The U2F device gives the public key and a Key Handle to the origin online service or website during the user registration step.</p>
<p>Later, when the user performs an authentication, the origin online service or website sends the Key Handle back to the U2F device via the browser. The U2F device uses the Key Handle to identify the user’s private key, and creates a signature which is sent back to the origin to verify the presence of the U2F device. Thus, the Key Handle is simply an identifier of a particular key on the U2F device.</p>
</div></blockquote>
</div>
<div class="section" id="what-are-the-shortcomings">
<h3>8.1.2.4. What are the shortcomings?<a class="headerlink" href="#what-are-the-shortcomings" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://fidoalliance.org/specs/fido-security-ref-v1.0-rd-20141008.pdf">FIDO Security Reference</a> provides security details including preventing MITM and phishing attacks. Here we add a couple of points:</p>
<ul>
<li><p class="first">Currently it requires a USB interface, but future implementations will address this issue.</p>
</li>
<li><p class="first">The security key is a tiny, limited computer with much of the actual hardware &amp; software implementation and crypto algorithms unspecified, allowing potentially weak vendor implementations.</p>
<p>The actual security key implementations are unknown and unspecified. What crypto algorithms does the key use? What is done in software vs. hardware? Can the firmware/software be updated? (There’s no winning answer to that question: yes implies a security risk for malware updating the security key, no implies bugs can’t be fixed without buying a new security key.) Can you verify the security key has not been tampered with?</p>
<p>And since organizations have obtained certificates to impersonate legitimate sites, there exists the distinct possibility of such organizations issuing fake security keys that not only don’t provide good security, but actually are attack vectors into the user’s computers. Additionally, malware on the computer can freely access the security key when inserted, creating further attack opportunities (though having such malware is itself a “game over” problem).</p>
</li>
<li><p class="first">Additionally, to allow for cheap devices with fixed, limited storage, the Key Handle issued by a U2F device:</p>
<blockquote>
<div><p>“can ‘store’ (i.e., contain) the private key for the origin and the hash of the origin encrypted with a ‘wrapping’ key known only to the U2F device secure element. When the Key Handle goes back to the secure element it ‘unwraps’ it to ‘retrieve’ the private key and the origin that it was generated for.</p>
</div></blockquote>
<p>So cheap devices can actually hand the encoded private key to authenticating web sites. Done poorly, this provides an attack vector.</p>
</li>
<li><p class="first">Should a web site want to discriminate between “good” and “bad” security keys, the standard allows the following:</p>
<blockquote>
<div><p>Every U2F device device has a shared ‘Attestation’ key pair which is present on it – this key is shared across a large number of U2F device units made by the same vendor (this is to prevent individual identifiability of the U2F device). Every public key output by the U2F device during the registration step is signed with the attestation private key.</p>
<p>The intention is that the public keys of all the ‘Attestation’ key pairs used by each vendor will be available in the public domain – this could be implemented by certificates chaining to a root public key or literally as a list. We will work within FIDO to decide the details on how certified vendors can publish their attestation public keys.</p>
<p>When such an infrastructure is available, a particular relying party – say, a bank – might choose to accept only U2F devices from certain vendors which have the appropriate published certifications. To enforce this policy, it can verify that the public key from a U2F device presented by the user is from a vendor it trusts.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="will-it-be-near-universally-adopted">
<h3>8.1.2.5. Will it be near-universally adopted?<a class="headerlink" href="#will-it-be-near-universally-adopted" title="Permalink to this headline">¶</a></h3>
<p>The big question is will it be near-universally adopted with a smart phone implementation? If so, it may strenghten user identification to the pint that the biggest weak point might be social engineering the account recovery process.</p>
</div>
</div>
<div class="section" id="totp-and-hotp-2fa">
<span id="totp"></span><h2>8.1.3. TOTP and HOTP 2FA<a class="headerlink" href="#totp-and-hotp-2fa" title="Permalink to this headline">¶</a></h2>
<div class="section" id="totp-based-apps">
<h3>8.1.3.1. TOTP-based apps<a class="headerlink" href="#totp-based-apps" title="Permalink to this headline">¶</a></h3>
<div class="section" id="some-totp-apps">
<h4>8.1.3.1.1. Some TOTP apps<a class="headerlink" href="#some-totp-apps" title="Permalink to this headline">¶</a></h4>
<p>Here’s an incomplete listing of TOTP-based apps and their platform support:</p>
<table border="1" class="colwidths-given docutils" id="id24">
<caption><span class="caption-text">TOTP apps</span><a class="headerlink" href="#id24" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Application</th>
<th class="head">License</th>
<th class="head">Platform support</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Google Authenticator</td>
<td>Proprietary</td>
<td>Android, BlackBerry, iOS</td>
</tr>
<tr class="row-odd"><td>Authy (Twilio)</td>
<td>Proprietary</td>
<td>Android, Chrome Browser, iOS, macOS, Windows (32 &amp; 64 bit)</td>
</tr>
<tr class="row-even"><td>FreeOTP</td>
<td>Apache 2.0</td>
<td>Android, iOS</td>
</tr>
<tr class="row-odd"><td>andOTOP</td>
<td>MIT</td>
<td>Android</td>
</tr>
<tr class="row-even"><td>Yubico Authenticator (+ YubiKey w/OTP)</td>
<td>Proprietary</td>
<td>macOS, Windows, Ubuntu, other Linux (source)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="choosing-an-app">
<h4>8.1.3.1.2. Choosing an app<a class="headerlink" href="#choosing-an-app" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://blog.agilebits.com/2015/01/26/totp-for-1password-users/">TOTP for 1Password users</a> rightfully argues that one time passwords are not really a second factor when they are stored on the same device as the password:</p>
<blockquote>
<div><p>We need to make the distinction between <strong>one time passwords</strong> and <strong>second factor security</strong>. One time passwords are often part of second factor security systems, but using one time passwords doesn’t automatically give you second factor security. Indeed, <em>when you store your TOTP secret in the same place that you keep your password for a site, you do not have second factor security</em>.</p>
<p>… To be truly second factor, the TOTP secret (from which the one time password is generated) must not be stored on the same device that you use the regular password on.</p>
</div></blockquote>
<p><strong class="program">Authy</strong> is the best choice as it optionally allows cloud backup and automatic update of multiple devices. But saving the TOTP secret code in a password manager allows recovering any app on a different cell phone.</p>
<p>Of course sites like Google avoid this problem with mutiple, redundant options: sending a security code via text message, backup phone numbers, phone call, backup codes, Google Authenticator, register computer (to not use 2FA), and multiple U2F devices. Using multiple U2F devices with Google Authenticator makes it very hard to get locked out of your account.</p>
</div>
</div>
<div class="section" id="id23">
<h3>8.1.3.2. TOTP<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p>TOTP is <a class="reference external" href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_algorithm">Time-based One-time Password algorithm</a>:</p>
<blockquote>
<div><p>… is an algorithm that computes a one-time password from a shared secret key and the current time. It has been adopted as Internet Engineering Task Force[1] standard RFC 6238,[1] is the cornerstone of Initiative For Open Authentication (OATH), and is used in a number of two-factor authentication systems.</p>
<p>TOTP is an example of a hash-based message authentication code (HMAC). It combines a secret key with the current timestamp using a cryptographic hash function to generate a one-time password. Because network latency and out-of-sync clocks can result in the password recipient having to try a range of possible times to authenticate against, the timestamp typically increases in 30-second intervals, which thus cuts the potential search space.</p>
<p>In a typical two-factor authentication application, setup proceeds as follows: a user enters username and password into a website or other server, the server generates a secret key which the user enters on to their TOTP application on a smartphone or other device (often by scanning a QR code). To verify that process worked, the user application immediately generates a one-time password to be checked by the server.</p>
<p>On subsequent authentications, the user enters their username, password and the current one-time password. The server checks the username and password as normal then also runs TOTP to verify the entered one-time password. For this to work, the clocks of the user’s device and the server need to be roughly synchronized (the server will typically accept one-time passwords generated from timestamps that differ by ±1 time interval from the client’s timestamp).</p>
</div></blockquote>
<p>The algorithm is defined in <a class="reference external" href="https://tools.ietf.org/html/rfc6238">RFC 6238</a> <em>TOTP: Time-Based One-Time Password Algorithm</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">4.</span>  <span class="n">TOTP</span> <span class="n">Algorithm</span>

   <span class="n">This</span> <span class="n">variant</span> <span class="n">of</span> <span class="n">the</span> <span class="n">HOTP</span> <span class="n">algorithm</span> <span class="n">specifies</span> <span class="n">the</span> <span class="n">calculation</span> <span class="n">of</span> <span class="n">a</span>
   <span class="n">one</span><span class="o">-</span><span class="n">time</span> <span class="n">password</span> <span class="n">value</span><span class="p">,</span> <span class="n">based</span> <span class="n">on</span> <span class="n">a</span> <span class="n">representation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">counter</span> <span class="k">as</span>
   <span class="n">a</span> <span class="n">time</span> <span class="n">factor</span><span class="o">.</span>

<span class="mf">4.1</span><span class="o">.</span>  <span class="n">Notations</span>

   <span class="n">o</span>  <span class="n">X</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">time</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">seconds</span> <span class="p">(</span><span class="n">default</span> <span class="n">value</span> <span class="n">X</span> <span class="o">=</span>
      <span class="mi">30</span> <span class="n">seconds</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">system</span> <span class="n">parameter</span><span class="o">.</span>

   <span class="n">o</span>  <span class="n">T0</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">Unix</span> <span class="n">time</span> <span class="n">to</span> <span class="n">start</span> <span class="n">counting</span> <span class="n">time</span> <span class="n">steps</span> <span class="p">(</span><span class="n">default</span> <span class="n">value</span> <span class="ow">is</span>
      <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="n">the</span> <span class="n">Unix</span> <span class="n">epoch</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">also</span> <span class="n">a</span> <span class="n">system</span> <span class="n">parameter</span><span class="o">.</span>

<span class="mf">4.2</span><span class="o">.</span>  <span class="n">Description</span>

   <span class="n">Basically</span><span class="p">,</span> <span class="n">we</span> <span class="n">define</span> <span class="n">TOTP</span> <span class="k">as</span> <span class="n">TOTP</span> <span class="o">=</span> <span class="n">HOTP</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">),</span> <span class="n">where</span> <span class="n">T</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">integer</span>
   <span class="ow">and</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">time</span> <span class="n">steps</span> <span class="n">between</span> <span class="n">the</span> <span class="n">initial</span> <span class="n">counter</span>
   <span class="n">time</span> <span class="n">T0</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">current</span> <span class="n">Unix</span> <span class="n">time</span><span class="o">.</span>

   <span class="n">More</span> <span class="n">specifically</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="n">Current</span> <span class="n">Unix</span> <span class="n">time</span> <span class="o">-</span> <span class="n">T0</span><span class="p">)</span> <span class="o">/</span> <span class="n">X</span><span class="p">,</span> <span class="n">where</span> <span class="n">the</span>
   <span class="n">default</span> <span class="n">floor</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">computation</span><span class="o">.</span>

   <span class="n">For</span> <span class="n">example</span><span class="p">,</span> <span class="k">with</span> <span class="n">T0</span> <span class="o">=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Time</span> <span class="n">Step</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">the</span> <span class="n">current</span>
   <span class="n">Unix</span> <span class="n">time</span> <span class="ow">is</span> <span class="mi">59</span> <span class="n">seconds</span><span class="p">,</span> <span class="ow">and</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">the</span> <span class="n">current</span> <span class="n">Unix</span> <span class="n">time</span> <span class="ow">is</span>
   <span class="mi">60</span> <span class="n">seconds</span><span class="o">.</span>

   <span class="n">The</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">this</span> <span class="n">algorithm</span> <span class="n">MUST</span> <span class="n">support</span> <span class="n">a</span> <span class="n">time</span> <span class="n">value</span> <span class="n">T</span>
   <span class="n">larger</span> <span class="n">than</span> <span class="n">a</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">integer</span> <span class="n">when</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">beyond</span> <span class="n">the</span> <span class="n">year</span> <span class="mf">2038.</span>  <span class="n">The</span>
   <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">system</span> <span class="n">parameters</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">T0</span> <span class="n">are</span> <span class="n">pre</span><span class="o">-</span><span class="n">established</span> <span class="n">during</span>
   <span class="n">the</span> <span class="n">provisioning</span> <span class="n">process</span> <span class="ow">and</span> <span class="n">communicated</span> <span class="n">between</span> <span class="n">a</span> <span class="n">prover</span> <span class="ow">and</span>
   <span class="n">verifier</span> <span class="k">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">provisioning</span> <span class="n">step</span><span class="o">.</span>  <span class="n">The</span> <span class="n">provisioning</span> <span class="n">flow</span> <span class="ow">is</span>
   <span class="n">out</span> <span class="n">of</span> <span class="n">scope</span> <span class="n">of</span> <span class="n">this</span> <span class="n">document</span><span class="p">;</span> <span class="n">refer</span> <span class="n">to</span> <span class="p">[</span><span class="n">RFC6030</span><span class="p">]</span> <span class="k">for</span> <span class="n">such</span>
   <span class="n">provisioning</span> <span class="n">container</span> <span class="n">specifications</span><span class="o">.</span>
</pre></div>
</div>
<p>From <a class="reference external" href="https://tools.ietf.org/html/rfc4226">RFC 4226</a> <em>HOTP: An HMAC-Based One-Time Password Algorithm</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">5.</span>  <span class="n">HOTP</span> <span class="n">Algorithm</span>

   <span class="n">In</span> <span class="n">this</span> <span class="n">section</span><span class="p">,</span> <span class="n">we</span> <span class="n">introduce</span> <span class="n">the</span> <span class="n">notation</span> <span class="ow">and</span> <span class="n">describe</span> <span class="n">the</span> <span class="n">HOTP</span>
   <span class="n">algorithm</span> <span class="n">basic</span> <span class="n">blocks</span> <span class="o">--</span> <span class="n">the</span> <span class="n">base</span> <span class="n">function</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">an</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span>
   <span class="n">value</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">truncation</span> <span class="n">method</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">an</span> <span class="n">HOTP</span> <span class="n">value</span><span class="o">.</span>

<span class="mf">5.1</span><span class="o">.</span>  <span class="n">Notation</span> <span class="ow">and</span> <span class="n">Symbols</span>

   <span class="n">A</span> <span class="n">string</span> <span class="n">always</span> <span class="n">means</span> <span class="n">a</span> <span class="n">binary</span> <span class="n">string</span><span class="p">,</span> <span class="n">meaning</span> <span class="n">a</span> <span class="n">sequence</span> <span class="n">of</span> <span class="n">zeros</span>
   <span class="ow">and</span> <span class="n">ones</span><span class="o">.</span>

   <span class="n">If</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">string</span><span class="p">,</span> <span class="n">then</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">denotes</span> <span class="n">its</span> <span class="n">length</span><span class="o">.</span>

   <span class="n">If</span> <span class="n">n</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">number</span><span class="p">,</span> <span class="n">then</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">denotes</span> <span class="n">its</span> <span class="n">absolute</span> <span class="n">value</span><span class="o">.</span>

   <span class="n">If</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">string</span><span class="p">,</span> <span class="n">then</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">denotes</span> <span class="n">its</span> <span class="n">i</span><span class="o">-</span><span class="n">th</span> <span class="n">bit</span><span class="o">.</span>  <span class="n">We</span> <span class="n">start</span> <span class="n">numbering</span>
   <span class="n">the</span> <span class="n">bits</span> <span class="n">at</span> <span class="mi">0</span><span class="p">,</span> <span class="n">so</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">...</span><span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">where</span> <span class="n">n</span> <span class="o">=</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">length</span>
   <span class="n">of</span> <span class="n">s</span><span class="o">.</span>

   <span class="n">Let</span> <span class="n">StToNum</span> <span class="p">(</span><span class="n">String</span> <span class="n">to</span> <span class="n">Number</span><span class="p">)</span> <span class="n">denote</span> <span class="n">the</span> <span class="n">function</span> <span class="n">that</span> <span class="k">as</span> <span class="nb">input</span> <span class="n">a</span>
   <span class="n">string</span> <span class="n">s</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">number</span> <span class="n">whose</span> <span class="n">binary</span> <span class="n">representation</span> <span class="ow">is</span> <span class="n">s</span><span class="o">.</span> <span class="p">(</span><span class="n">For</span>
   <span class="n">example</span><span class="p">,</span> <span class="n">StToNum</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span> <span class="o">=</span> <span class="mf">6.</span><span class="p">)</span>

   <span class="n">Here</span> <span class="ow">is</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">symbols</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">document</span><span class="o">.</span>

   <span class="n">Symbol</span>  <span class="n">Represents</span>
   <span class="o">-------------------------------------------------------------------</span>
   <span class="n">C</span>       <span class="mi">8</span><span class="o">-</span><span class="n">byte</span> <span class="n">counter</span> <span class="n">value</span><span class="p">,</span> <span class="n">the</span> <span class="n">moving</span> <span class="n">factor</span><span class="o">.</span>  <span class="n">This</span> <span class="n">counter</span>
           <span class="n">MUST</span> <span class="n">be</span> <span class="n">synchronized</span> <span class="n">between</span> <span class="n">the</span> <span class="n">HOTP</span> <span class="n">generator</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span>
           <span class="ow">and</span> <span class="n">the</span> <span class="n">HOTP</span> <span class="n">validator</span> <span class="p">(</span><span class="n">server</span><span class="p">)</span><span class="o">.</span>

   <span class="n">K</span>       <span class="n">shared</span> <span class="n">secret</span> <span class="n">between</span> <span class="n">client</span> <span class="ow">and</span> <span class="n">server</span><span class="p">;</span> <span class="n">each</span> <span class="n">HOTP</span>
           <span class="n">generator</span> <span class="n">has</span> <span class="n">a</span> <span class="n">different</span> <span class="ow">and</span> <span class="n">unique</span> <span class="n">secret</span> <span class="n">K</span><span class="o">.</span>

   <span class="n">T</span>       <span class="n">throttling</span> <span class="n">parameter</span><span class="p">:</span> <span class="n">the</span> <span class="n">server</span> <span class="n">will</span> <span class="n">refuse</span> <span class="n">connections</span>
           <span class="kn">from</span> <span class="nn">a</span> <span class="n">user</span> <span class="n">after</span> <span class="n">T</span> <span class="n">unsuccessful</span> <span class="n">authentication</span> <span class="n">attempts</span><span class="o">.</span>

   <span class="n">s</span>       <span class="n">resynchronization</span> <span class="n">parameter</span><span class="p">:</span> <span class="n">the</span> <span class="n">server</span> <span class="n">will</span> <span class="n">attempt</span> <span class="n">to</span>
           <span class="n">verify</span> <span class="n">a</span> <span class="n">received</span> <span class="n">authenticator</span> <span class="n">across</span> <span class="n">s</span> <span class="n">consecutive</span>
           <span class="n">counter</span> <span class="n">values</span><span class="o">.</span>

   <span class="n">Digit</span>   <span class="n">number</span> <span class="n">of</span> <span class="n">digits</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">HOTP</span> <span class="n">value</span><span class="p">;</span> <span class="n">system</span> <span class="n">parameter</span><span class="o">.</span>

<span class="mf">5.2</span><span class="o">.</span>  <span class="n">Description</span>

   <span class="n">The</span> <span class="n">HOTP</span> <span class="n">algorithm</span> <span class="ow">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">an</span> <span class="n">increasing</span> <span class="n">counter</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">a</span>
   <span class="n">static</span> <span class="n">symmetric</span> <span class="n">key</span> <span class="n">known</span> <span class="n">only</span> <span class="n">to</span> <span class="n">the</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">validation</span>
   <span class="n">service</span><span class="o">.</span>  <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="n">create</span> <span class="n">the</span> <span class="n">HOTP</span> <span class="n">value</span><span class="p">,</span> <span class="n">we</span> <span class="n">will</span> <span class="n">use</span> <span class="n">the</span> <span class="n">HMAC</span><span class="o">-</span>
   <span class="n">SHA</span><span class="o">-</span><span class="mi">1</span> <span class="n">algorithm</span><span class="p">,</span> <span class="k">as</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">RFC</span> <span class="mi">2104</span> <span class="p">[</span><span class="n">BCK2</span><span class="p">]</span><span class="o">.</span>

   <span class="n">As</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">the</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span> <span class="n">calculation</span> <span class="ow">is</span> <span class="mi">160</span> <span class="n">bits</span><span class="p">,</span> <span class="n">we</span> <span class="n">must</span>
   <span class="n">truncate</span> <span class="n">this</span> <span class="n">value</span> <span class="n">to</span> <span class="n">something</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">easily</span> <span class="n">entered</span> <span class="n">by</span> <span class="n">a</span>
   <span class="n">user</span><span class="o">.</span>

                   <span class="n">HOTP</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">C</span><span class="p">)</span> <span class="o">=</span> <span class="n">Truncate</span><span class="p">(</span><span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">C</span><span class="p">))</span>

   <span class="n">Where</span><span class="p">:</span>

     <span class="o">-</span> <span class="n">Truncate</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">function</span> <span class="n">that</span> <span class="n">converts</span> <span class="n">an</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span>
       <span class="n">value</span> <span class="n">into</span> <span class="n">an</span> <span class="n">HOTP</span> <span class="n">value</span> <span class="k">as</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">Section</span> <span class="mf">5.3</span><span class="o">.</span>

   <span class="n">The</span> <span class="n">Key</span> <span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">the</span> <span class="n">Counter</span> <span class="p">(</span><span class="n">C</span><span class="p">),</span> <span class="ow">and</span> <span class="n">Data</span> <span class="n">values</span> <span class="n">are</span> <span class="n">hashed</span> <span class="n">high</span><span class="o">-</span><span class="n">order</span>
   <span class="n">byte</span> <span class="n">first</span><span class="o">.</span>

   <span class="n">The</span> <span class="n">HOTP</span> <span class="n">values</span> <span class="n">generated</span> <span class="n">by</span> <span class="n">the</span> <span class="n">HOTP</span> <span class="n">generator</span> <span class="n">are</span> <span class="n">treated</span> <span class="k">as</span> <span class="n">big</span>
   <span class="n">endian</span><span class="o">.</span>

<span class="mf">5.3</span><span class="o">.</span>  <span class="n">Generating</span> <span class="n">an</span> <span class="n">HOTP</span> <span class="n">Value</span>

   <span class="n">We</span> <span class="n">can</span> <span class="n">describe</span> <span class="n">the</span> <span class="n">operations</span> <span class="ow">in</span> <span class="mi">3</span> <span class="n">distinct</span> <span class="n">steps</span><span class="p">:</span>

   <span class="n">Step</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Generate</span> <span class="n">an</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span> <span class="n">value</span> <span class="n">Let</span> <span class="n">HS</span> <span class="o">=</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>  <span class="o">//</span> <span class="n">HS</span>
   <span class="ow">is</span> <span class="n">a</span> <span class="mi">20</span><span class="o">-</span><span class="n">byte</span> <span class="n">string</span>

   <span class="n">Step</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Generate</span> <span class="n">a</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span> <span class="n">string</span> <span class="p">(</span><span class="n">Dynamic</span> <span class="n">Truncation</span><span class="p">)</span>
   <span class="n">Let</span> <span class="n">Sbits</span> <span class="o">=</span> <span class="n">DT</span><span class="p">(</span><span class="n">HS</span><span class="p">)</span>   <span class="o">//</span>  <span class="n">DT</span><span class="p">,</span> <span class="n">defined</span> <span class="n">below</span><span class="p">,</span>
                        <span class="o">//</span>  <span class="n">returns</span> <span class="n">a</span> <span class="mi">31</span><span class="o">-</span><span class="n">bit</span> <span class="n">string</span>

   <span class="n">Step</span> <span class="mi">3</span><span class="p">:</span> <span class="n">Compute</span> <span class="n">an</span> <span class="n">HOTP</span> <span class="n">value</span>
   <span class="n">Let</span> <span class="n">Snum</span>  <span class="o">=</span> <span class="n">StToNum</span><span class="p">(</span><span class="n">Sbits</span><span class="p">)</span>   <span class="o">//</span> <span class="n">Convert</span> <span class="n">S</span> <span class="n">to</span> <span class="n">a</span> <span class="n">number</span> <span class="ow">in</span>
                                    <span class="mf">0.</span><span class="o">..</span><span class="mi">2</span><span class="o">^</span><span class="p">{</span><span class="mi">31</span><span class="p">}</span><span class="o">-</span><span class="mi">1</span>
   <span class="n">Return</span> <span class="n">D</span> <span class="o">=</span> <span class="n">Snum</span> <span class="n">mod</span> <span class="mi">10</span><span class="o">^</span><span class="n">Digit</span> <span class="o">//</span>  <span class="n">D</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">range</span>
                                    <span class="mf">0.</span><span class="o">..</span><span class="mi">10</span><span class="o">^</span><span class="p">{</span><span class="n">Digit</span><span class="p">}</span><span class="o">-</span><span class="mi">1</span>

   <span class="n">The</span> <span class="n">Truncate</span> <span class="n">function</span> <span class="n">performs</span> <span class="n">Step</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Step</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="n">the</span> <span class="n">dynamic</span>
   <span class="n">truncation</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">the</span> <span class="n">reduction</span> <span class="n">modulo</span> <span class="mi">10</span><span class="o">^</span><span class="n">Digit</span><span class="o">.</span>  <span class="n">The</span> <span class="n">purpose</span> <span class="n">of</span>
   <span class="n">the</span> <span class="n">dynamic</span> <span class="n">offset</span> <span class="n">truncation</span> <span class="n">technique</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">a</span> <span class="mi">4</span><span class="o">-</span><span class="n">byte</span>
   <span class="n">dynamic</span> <span class="n">binary</span> <span class="n">code</span> <span class="kn">from</span> <span class="nn">a</span> <span class="mi">160</span><span class="o">-</span><span class="n">bit</span> <span class="p">(</span><span class="mi">20</span><span class="o">-</span><span class="n">byte</span><span class="p">)</span> <span class="n">HMAC</span><span class="o">-</span><span class="n">SHA</span><span class="o">-</span><span class="mi">1</span> <span class="n">result</span><span class="o">.</span>

    <span class="n">DT</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">//</span> <span class="n">String</span> <span class="o">=</span> <span class="n">String</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">...</span><span class="n">String</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span>
     <span class="n">Let</span> <span class="n">OffsetBits</span> <span class="n">be</span> <span class="n">the</span> <span class="n">low</span><span class="o">-</span><span class="n">order</span> <span class="mi">4</span> <span class="n">bits</span> <span class="n">of</span> <span class="n">String</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span>
     <span class="n">Offset</span> <span class="o">=</span> <span class="n">StToNum</span><span class="p">(</span><span class="n">OffsetBits</span><span class="p">)</span> <span class="o">//</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">OffSet</span> <span class="o">&lt;=</span> <span class="mi">15</span>
     <span class="n">Let</span> <span class="n">P</span> <span class="o">=</span> <span class="n">String</span><span class="p">[</span><span class="n">OffSet</span><span class="p">]</span><span class="o">...</span><span class="n">String</span><span class="p">[</span><span class="n">OffSet</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
     <span class="n">Return</span> <span class="n">the</span> <span class="n">Last</span> <span class="mi">31</span> <span class="n">bits</span> <span class="n">of</span> <span class="n">P</span>

   <span class="n">The</span> <span class="n">reason</span> <span class="k">for</span> <span class="n">masking</span> <span class="n">the</span> <span class="n">most</span> <span class="n">significant</span> <span class="n">bit</span> <span class="n">of</span> <span class="n">P</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">avoid</span>
   <span class="n">confusion</span> <span class="n">about</span> <span class="n">signed</span> <span class="n">vs</span><span class="o">.</span> <span class="n">unsigned</span> <span class="n">modulo</span> <span class="n">computations</span><span class="o">.</span>  <span class="n">Different</span>
   <span class="n">processors</span> <span class="n">perform</span> <span class="n">these</span> <span class="n">operations</span> <span class="n">differently</span><span class="p">,</span> <span class="ow">and</span> <span class="n">masking</span> <span class="n">out</span> <span class="n">the</span>
   <span class="n">signed</span> <span class="n">bit</span> <span class="n">removes</span> <span class="nb">all</span> <span class="n">ambiguity</span><span class="o">.</span>

   <span class="n">Implementations</span> <span class="n">MUST</span> <span class="n">extract</span> <span class="n">a</span> <span class="mi">6</span><span class="o">-</span><span class="n">digit</span> <span class="n">code</span> <span class="n">at</span> <span class="n">a</span> <span class="n">minimum</span> <span class="ow">and</span> <span class="n">possibly</span>
   <span class="mi">7</span> <span class="ow">and</span> <span class="mi">8</span><span class="o">-</span><span class="n">digit</span> <span class="n">code</span><span class="o">.</span>  <span class="n">Depending</span> <span class="n">on</span> <span class="n">security</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">Digit</span> <span class="o">=</span> <span class="mi">7</span> <span class="ow">or</span>
   <span class="n">more</span> <span class="n">SHOULD</span> <span class="n">be</span> <span class="n">considered</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">a</span> <span class="n">longer</span> <span class="n">HOTP</span> <span class="n">value</span><span class="o">.</span>

   <span class="n">The</span> <span class="n">following</span> <span class="n">paragraph</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">example</span> <span class="n">of</span> <span class="n">using</span> <span class="n">this</span> <span class="n">technique</span> <span class="k">for</span>
   <span class="n">Digit</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="n">that</span> <span class="n">a</span> <span class="mi">6</span><span class="o">-</span><span class="n">digit</span> <span class="n">HOTP</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">calculated</span> <span class="kn">from</span> <span class="nn">the</span>
   <span class="n">HMAC</span> <span class="n">value</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="crypto.html" class="btn btn-neutral float-right" title="8.2. Cryptography" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../pentest_study.html" class="btn btn-neutral" title="8. Pentest Study" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.3',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>