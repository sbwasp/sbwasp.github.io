

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="default-src 'none'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self'; img-src 'self'; style-src 'self'; font-src 'self'; form-action 'self'; frame-ancestors 'none'; base-uri 'self'" http-equiv="Content-Security-Policy" />
<meta content="nosniff" http-equiv="X-Content-Type-Options" />
<meta content="deny" http-equiv="X-Frame-Options" />
<meta content="1; mode=block" http-equiv="X-XSS-Protection" />
<meta content="strict-origin" http-equiv="Referrer-Policy" />
<meta content="max-age=31536000; includeSubDomains" http-equiv="Strict-Transport-Security" />
<meta content="'*'" http-equiv="Access-Control-Allow-Origin" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.5. Firewalls &mdash; South Bay WASP 1.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="South Bay WASP 1.0.3 documentation" href="../index.html"/>
        <link rel="up" title="8. Pentest Study" href="../pentest_study.html"/>
        <link rel="next" title="8.6. IPv6" href="ipv6.html"/>
        <link rel="prev" title="8.4. exiftool" href="exiftool.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2factor.html">8.1. 2 Factor Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="email_security.html">8.2. Email Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="exfiltration.html">8.3. Exfiltration</a></li>
<li class="toctree-l2"><a class="reference internal" href="exiftool.html">8.4. <strong class="program">exiftool</strong></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.5. Firewalls</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#erlite-3-firewall">8.5.1. ERLite-3 firewall</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ipv6-dnsmasq-slaac-and-stateless-dhcpv6">8.5.1.1. IPv6 dnsmasq, SLAAC, and stateless DHCPv6</a></li>
<li class="toctree-l4"><a class="reference internal" href="#firewall-overview">8.5.1.2. Firewall overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#firewall-rulesets">8.5.1.3. Firewall rulesets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lede-project-firewalls">8.5.2. LEDE Project firewalls</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id24">8.5.2.1. LEDE Project</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lede-linux-is-not-standard-linux">8.5.2.2. LEDE Linux is not standard Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#emulating-a-lede-virtual-image">8.5.2.3. Emulating a LEDE virtual image</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#firewall-and-ipv6-inadequacies">8.5.3. Firewall and IPv6 inadequacies</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#firewalls-trying-to-hide-complexity">8.5.3.1. Firewalls trying to hide complexity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ipv6-standard-inadequacies">8.5.3.2. IPv6 standard inadequacies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#perimeter-firewall-addressing">8.5.4. Perimeter firewall addressing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-interface-address">8.5.4.1. External interface address</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prefix-delegation-and-addressing-non-wan-interfaces">8.5.4.2. Prefix delegation and addressing non-wan interfaces</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#internal-firewall-addressing">8.5.5. Internal firewall addressing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id32">8.5.5.1. External interface address</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">8.6. IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="loadlibrary.html">8.7. loadlibrary</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_exploitation_tricks.html">8.8. Linux Exploitation Tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_networking.html">8.9. Linux networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="llmnr.html">8.10. Windows broadcast name resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="nftables.html">8.11. nftables</a></li>
<li class="toctree-l2"><a class="reference internal" href="not_getting_hacked.html">8.12. Not getting hacked</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntlm.html">8.13. NTLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="passwords.html">8.14. Password Cracking Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="php.html">8.15. PHP &amp; MySQL Shortcomings</a></li>
<li class="toctree-l2"><a class="reference internal" href="static_websites.html">8.16. Static websites</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtualization_networking.html">8.17. Virtualization &amp; networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnerabilities.html">8.18. Vulnerabilites</a></li>
<li class="toctree-l2"><a class="reference internal" href="waf.html">8.19. WAF Evasion</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">8.20. WiFi Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_study.html">8. Pentest Study</a> &raquo;</li>
        
      <li>8.5. Firewalls</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/study/fw.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="firewalls">
<span id="id21"></span><h1>8.5. Firewalls<a class="headerlink" href="#firewalls" title="Permalink to this headline">¶</a></h1>
<div class="section" id="erlite-3-firewall">
<h2>8.5.1. ERLite-3 firewall<a class="headerlink" href="#erlite-3-firewall" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ipv6-dnsmasq-slaac-and-stateless-dhcpv6">
<h3>8.5.1.1. IPv6 <a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a>, SLAAC, and stateless DHCPv6<a class="headerlink" href="#ipv6-dnsmasq-slaac-and-stateless-dhcpv6" title="Permalink to this headline">¶</a></h3>
<p>Want to implement IPv6? Here the <a class="reference external" href="https://www.ubnt.com/edgemax/edgerouter-lite/">Ubiquiti EdgeRouter Lite</a> firewall is configured to accept a /56 IPv6 <a class="reference external" href="https://en.wikipedia.org/wiki/Prefix_delegation">Prefix delegation</a> from Spectrum Internet and distribute the addresses across 2 internal networks using SLAAC. <a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> (a caching DNS/DHCP server) is configured to provide DHCPv6 options via stateless DHCPv6. From a client perspective, IPv6-capable clients automatically get IPv6 addresses via SLAAC, and get DNS/NTP server options from stateless DHCPv6 via dnsmasq.</p>
</div>
<div class="section" id="firewall-overview">
<h3>8.5.1.2. Firewall overview<a class="headerlink" href="#firewall-overview" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id22">
<h4>8.5.1.2.1. ERLite-3 firewall<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>The ERL3 runs <a class="reference external" href="https://dl.ubnt.com/guides/edgemax/EdgeOS_UG.pdf">EdgeOS</a> which supports Cavium Octeon and MIPs chips. Both EdgeOS and <a class="reference external" href="https://wiki.vyos.net/wiki/Main_Page">VyOS</a> were forked from <a class="reference external" href="https://wiki.vyos.net/wiki/Vyatta">Vyatta</a>. The OS is currently based on Debian 7 (Wheezy) running a Linux 3.x kernel. The current Debian release is Debian 9 (Stretch) with Linux kernel 4.9.</p>
<p>For more information consult the <a class="reference external" href="https://help.ubnt.com/hc/en-us/categories/200321064-EdgeMAX">EdgeMAX Help Center</a>, <a class="reference external" href="http://www.forshee.me/2016/03/01/ubiquiti-edgerouter-lite-setup-part-1-the-basics.html">Ubiquiti EdgeRouter Lite Setup Part 1: The Basics</a>  (a 6-part series, especially the Key-Based SSH Login instructions), and <a class="reference external" href="https://networkjutsu.com/my-home-router-edgerouter-lite/">My Home Router – EdgeRouter Lite</a> (another multi-part series).</p>
<p>The command line has 2 modes: normal mode (“$” prompt) and configuration mode (“#” prompt), entered via the <code class="docutils literal"><span class="pre">configure</span></code> command and exited via the <code class="docutils literal"><span class="pre">exit</span></code> command.</p>
<p>There are 2 versions of the configuration: running and boot. After <code class="docutils literal"><span class="pre">configure</span></code> and typing in some configuration commands, the configuration changes can be saved to the running configuration via <code class="docutils literal"><span class="pre">commit</span></code> (or <code class="docutils literal"><span class="pre">discard</span></code> to not save). To make those changes persist after boot issue the <code class="docutils literal"><span class="pre">save</span></code> command.</p>
</div>
<div class="section" id="zone-vs-interface-based-firewall">
<h4>8.5.1.2.2. Zone vs interface-based firewall<a class="headerlink" href="#zone-vs-interface-based-firewall" title="Permalink to this headline">¶</a></h4>
<p>Our example will be a zone-based firewall and we explain the difference with the more popular interface-based firewall rulesets.</p>
<p>EdgeOS supports both the traditional per-interface (ACL-based in EdgeOS documentation) and zone-based firewalls. See <a class="reference external" href="https://www.nnbfn.net/2011/06/per-interface-vs-zone-based-firewall/">Per Interface vs. Zone Based Firewall</a>. The EdgeOS GUI only supports per-interface firewall, and thus most organizations use per-interface. However, there are some configuration options that are only available via the CLI. In many cases the CLI can be used alongside the GUI, but in the case of zones only the CLI can be used for configuration.</p>
<p>To make clear the difference, if you have 3 interfaces eth0, eth1, and eth2 then you have 4 zones: WAN (eth0), LAN (eth1), GUEST (eth2) (or call it DMZ or WIFI or …), and LOCAL (the firewall itself). For each pair, say WAN=&gt;GUEST, 2 rulesets (IPv4 and IPv6) are created for the allowed traffic from the WAN zone to the GUEST zone. This makes it very easy to determine the traffic permitted between zones. The ERL has 2x4x3 = 24 zone rulesets.</p>
<p>In contrast, an interface-based firewall has 4 rulesets per interface, actually 2 IPv4 and 2 IPv6. Take the WAN interface, then 1 ruleset WAN_LOCAL lists the traffic allowed from the WAN to the firewall itself. The ruleset WAN_IN lists the traffic allowed from the WAN to the other interfaces (LAN and GUEST). That means 2x2x3 = 12 rulesets. It’s a little harder to determine what traffic goes from WAN=&gt;LAN as the WAN_IN ruleset lists both WAN=&gt;LAN and WAN=&gt;GUEST traffic.</p>
</div>
<div class="section" id="firewall-backup">
<h4>8.5.1.2.3. Firewall backup<a class="headerlink" href="#firewall-backup" title="Permalink to this headline">¶</a></h4>
<p>While it’s best to save the configuration, you can also save the commands required to create that configuration. Having the commands makes it easier to explore modification (and learning) of the EdgeOS configuration. Here’s the backup for both the configuration (which can be restored) and the commands (which can be re-executed).</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># /config/user-data persists between boots</span>
<span class="nv">CONFIG</span><span class="o">=</span><span class="sb">`</span>date +%Y%m%d%H%M<span class="sb">`</span>-firewall-config.eos
<span class="nv">COMMANDS</span><span class="o">=</span><span class="si">${</span><span class="nv">CONFIG</span><span class="p">/config/commands</span><span class="si">}</span>
<span class="hll">show configuration all &gt; /config/user-data/<span class="nv">$CONFIG</span>
</span><span class="hll">show configuration commands &gt; /config/user-data/<span class="nv">$COMMANDS</span>
</span><span class="c1">## To load a saved config:</span>
<span class="c1"># configure</span>
<span class="c1"># load /config/user-data/$CONFIG</span>
</pre></div>
</div>
<p>The backups can easily be <code class="docutils literal"><span class="pre">scp</span></code> copied to/from another host.</p>
</div>
</div>
<div class="section" id="firewall-rulesets">
<h3>8.5.1.3. Firewall rulesets<a class="headerlink" href="#firewall-rulesets" title="Permalink to this headline">¶</a></h3>
<div class="section" id="isp-prefix-delegation">
<h4>8.5.1.3.1. ISP prefix delegation<a class="headerlink" href="#isp-prefix-delegation" title="Permalink to this headline">¶</a></h4>
<p>We’ll start with commands for ISP prefix delegation (the heart of IPv6 address allocation).</p>
<p><a class="reference external" href="https://tools.ietf.org/html/rfc3633">RFC 3633</a> IPv6 Prefix Options for Dynamic Host Configuration Protocol (DHCP) version 6 defines a mechanism by which <a class="reference external" href="https://en.wikipedia.org/wiki/DHCPv6">DHCPv6</a> can be used to delegate a network address prefix to a network. This is known as <a class="reference external" href="https://en.wikipedia.org/wiki/Prefix_delegation">prefix delegation</a>. The router can then assign addresses to clients within the network using either DHCPv6 or <a class="reference external" href="https://en.wikipedia.org/wiki/IPv6_address#Stateless_address_autoconfiguration">stateless address autoconfiguraton</a> (SLAAC). With SLAAC the router advertises a prefix to clients, and clients pick their own address within that network. This example will use dhcpv6-stateless, which uses SLAAC for address assignment but also allows the DHCPv6 server to pass other information to the clients.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># Configure all interfaces for IPv6 automatic configuration.
# Use only 1 NS (neighbor solicitation) message for DAD (duplicate address detection).

<span class="hll">set interfaces ethernet eth0 ipv6 address autoconf
</span><span class="hll">set interfaces ethernet eth0 ipv6 dup-addr-detect-transmits 1
</span>
<span class="hll">set interfaces ethernet eth1 ipv6 address autoconf
</span><span class="hll">set interfaces ethernet eth1 ipv6 dup-addr-detect-transmits 1
</span>
<span class="hll">set interfaces ethernet eth2 ipv6 address autoconf
</span><span class="hll">set interfaces ethernet eth2 ipv6 dup-addr-detect-transmits 1
</span>

# Use IA_NA (non-temporary address) with /56 IA_PD (prefix delegation) on eth0
<span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 prefix-length 56
</span># DHCPv6 option 14 = Rapid Commit (DHCPv6 client uses a 2 message exchange, not 4).
<span class="hll">set interfaces ethernet eth0 dhcpv6-pd rapid-commit enable
</span>
# For eth1, eth2: create subnet, give i/f the &#39;::1&#39; address, turn on dhcpv6-stateless.
<span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth1 prefix-id &#39;:0&#39;
</span><span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth1 host-address &#39;::1&#39;
</span><span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth1 service dhcpv6-stateless
</span>
<span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth2 prefix-id &#39;:1&#39;
</span><span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth2 host-address &#39;::1&#39;
</span><span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth2 service dhcpv6-stateless
</span></pre></div>
</div>
</div>
<div class="section" id="firewall-dns-ipv4-dhcp">
<h4>8.5.1.3.2. Firewall DNS &amp; IPv4 DHCP<a class="headerlink" href="#firewall-dns-ipv4-dhcp" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://www.isc.org/downloads/dhcp/">ISC DHCP</a> is the default DHCP server with <a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> being a relatively new alternative. (See <a class="reference external" href="https://help.ubnt.com/hc/en-us/articles/115002673188-EdgeRouter-Using-dnsmasq-for-DHCP-Server">EdgeRouter - Using dnsmasq for DHCP Server</a>.) dnsmasq combines both caching DNS and DHCP allowing DHCP client names to appear in DNS.</p>
<div class="section" id="isc-dhcp-ipv4">
<h5>8.5.1.3.2.1. ISC DHCP IPv4<a class="headerlink" href="#isc-dhcp-ipv4" title="Permalink to this headline">¶</a></h5>
<p>Here’s the configuration for ISC DHCP:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># Set hostname and domain for firewall
<span class="hll">set system host-name fw
</span><span class="hll">set system domain-name home.local
</span># Make lookup of firewall&#39;s address return the one on the client&#39;s interface.
<span class="hll">set service dns forwarding options localise-queries
</span><span class="hll">set system ip override-hostname-ip 192.168.1.1
</span><span class="hll">set system static-host-mapping host-name fw inet 192.168.1.1
</span><span class="hll">set system static-host-mapping host-name fw inet 192.168.2.1
</span><span class="hll">set system static-host-mapping host-name fw inet 192.168.3.1
</span>
# DNSMASQ not enabled by default (ISC DHCPD default, but doesn&#39;t update DNS)
<span class="hll">set service dhcp-server use-dnsmasq disable
</span>
# Set system name-server to itself, which will cache and forward to list below
<span class="hll">set system name-server 127.0.0.1
</span><span class="hll">set system name-server ::1
</span># Forwarding for system name-server (it&#39;s a caching server so needs real DNS)
<span class="hll">set service dns forwarding name-server 8.8.8.8
</span><span class="hll">set service dns forwarding name-server 8.8.4.4
</span><span class="hll">set service dns forwarding name-server &#39;2001:4860:4860::8888&#39;
</span><span class="hll">set service dns forwarding name-server &#39;2001:4860:4860::8844&#39;
</span><span class="hll">set service dns forwarding cache-size 400
</span># DNS listen on eth1 &amp; eth2 (forwarded to localhost, then list above)
<span class="hll">set service dns forwarding listen-on eth1
</span><span class="hll">set service dns forwarding listen-on eth2
</span>
# Get IP, default route, but not DNS from ISP
<span class="hll">set interfaces ethernet eth0 dhcp-options default-route update
</span><span class="hll">set interfaces ethernet eth0 dhcp-options default-route-distance 210
</span><span class="hll">set interfaces ethernet eth0 dhcp-options name-server no-update
</span>
# ISC DHCP not disabled
<span class="hll">set service dhcp-server disabled false
</span># DHCP server updates /etc/hosts for client leases.
<span class="hll">set service dhcp-server hostfile-update enable
</span>
# GUEST DHCP configuration (unifi-controller is DHCP option 43 to locate unifi controller)
<span class="hll">set service dhcp-server shared-network-name GUEST authoritative enable
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 default-router 192.168.2.1
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 dns-server 192.168.2.1
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 ntp-server 192.168.2.1
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 domain-name bitbender.org
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 lease 86400
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 start 192.168.2.38 stop 192.168.2.243
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 static-mapping ubiquiti ip-address 192.168.2.2
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 static-mapping ubiquiti mac-address &#39;44:d9:e7:f6:48:f2&#39;
</span><span class="hll">set service dhcp-server shared-network-name GUEST subnet 192.168.2.0/24 unifi-controller 192.168.1.29
</span>
# LAN DHCP configuration (unifi-controller is DHCP option 43 to locate unifi controller)
<span class="hll">set service dhcp-server shared-network-name LAN authoritative enable
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 default-router 192.168.1.1
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 dns-server 192.168.1.1
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 ntp-server 192.168.1.1
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 domain-name bitbender.org
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 lease 86400
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 start 192.168.1.101 stop 192.168.1.200
</span><span class="hll">set service dhcp-server shared-network-name LAN subnet 192.168.1.0/24 unifi-controller 192.168.1.29
</span></pre></div>
</div>
</div>
<div class="section" id="dnsmasq-dhcp-ipv4">
<h5>8.5.1.3.2.2. dnsmasq DHCP IPv4<a class="headerlink" href="#dnsmasq-dhcp-ipv4" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> combines both DHCP and DNS for IPv4 &amp; IPv6 in a single daemon that registers DHCP leases in DNS. You’ll be lost without the <a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html">dnsmasq manpage</a> and the commands <code class="docutils literal"><span class="pre">dnsmasq</span> <span class="pre">--help</span> <span class="pre">dhcp</span></code> &amp; <code class="docutils literal"><span class="pre">dnsmasq</span> <span class="pre">--help</span> <span class="pre">dhcp6</span></code> listing the availble DHCP options.</p>
<p>Each time you make a dnsmasq configuration change you must remember to restart dnsmasq:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo service dnsmasq force-reload
</pre></div>
</div>
<p>To change the above ISC DHCP configuration to use <a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> requires these changes:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># Remove the existing DHCP configuration (and more).
<span class="hll">delete service dns forwarding
</span><span class="hll">delete service dhcp-server
</span>
# Disable ISC DHCP
<span class="hll">set service dhcp-server disabled false
</span><span class="hll">set service dhcp-server hostfile-update disable
</span><span class="hll">set service dhcp-server use-dnsmasq enable
</span># Don&#39;t bind to all interfaces, skip eth0
<span class="hll">set service dns forwarding options bind-interfaces
</span><span class="hll">set service dns forwarding except-interface eth0
</span># Add domain to simple names in /etc/hosts
<span class="hll">set service dns forwarding options expand-hosts
</span># Do not forward reverse lookups for private addresses
<span class="hll">set service dns forwarding options bogus-priv
</span># Return DNS lookups matching the interface&#39;s IP
<span class="hll">set service dns forwarding options localise-queries
</span># Change firewall&#39;s IP in /etc/hosts from 127.0.0.1
<span class="hll">set system ip override-hostname-ip 192.168.1.1
</span><span class="hll">set system static-host-mapping host-name fw inet 192.168.1.1
</span><span class="hll">set system static-host-mapping host-name fw inet 192.168.2.1
</span><span class="hll">set system static-host-mapping host-name fw inet 192.168.3.1
</span># DHCP server is only DHCP on network.
<span class="hll">set service dns forwarding options dhcp-authoritative
</span>
# dnsmasq is caching server so needs to forward to real DNS
<span class="hll">set service dns forwarding name-server 8.8.8.8
</span><span class="hll">set service dns forwarding name-server 8.8.4.4
</span><span class="hll">set service dns forwarding name-server &#39;2001:4860:4860::8888&#39;
</span><span class="hll">set service dns forwarding name-server &#39;2001:4860:4860::8844&#39;
</span><span class="hll">set service dns forwarding cache-size 400
</span># DNS requests for plain names (without dots) are never forwarded
<span class="hll">set service dns forwarding options domain-needed
</span># Add dns names matching the interface IPv4/v6 addresses
<span class="hll">set service dns forwarding options &#39;interface-name=lan.bitbender.org,eth1&#39;
</span><span class="hll">set service dns forwarding options &#39;interface-name=guest.bitbender.org,eth2&#39;
</span>
# guest subnet
<span class="hll">set service dhcp-server shared-network-name guest authoritative enable
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 default-router 192.168.2.1
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 dns-server 192.168.2.1
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 domain-name home.local
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 lease 86400
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 ntp-server 192.168.2.1
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 start 192.168.2.38 stop 192.168.2.243
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 static-mapping ubiquiti ip-address 192.168.2.2
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 static-mapping ubiquiti mac-address &#39;44:d9:e7:f6:48:f2&#39;
</span><span class="hll">set service dhcp-server shared-network-name guest subnet 192.168.2.0/24 unifi-controller 192.168.1.10
</span>
# lan subnet
<span class="hll">set service dhcp-server shared-network-name lan authoritative enable
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 default-router 192.168.1.1
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 dns-server 192.168.1.1
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 domain-name home.local
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 lease 86400
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 ntp-server 192.168.1.1
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 start 192.168.1.101 stop 192.168.1.200
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 static-mapping backup ip-address 192.168.1.10
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 static-mapping backup mac-address &#39;00:30:67:bc:41:d0&#39;
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 static-mapping printer ip-address 192.168.1.3
</span><span class="hll">set service dhcp-server shared-network-name lan subnet 192.168.1.0/24 static-mapping printer mac-address &#39;30:05:5c:13:9b:e5&#39;
</span></pre></div>
</div>
</div>
<div class="section" id="dnsmasq-dhcp-ipv6">
<h5>8.5.1.3.2.3. dnsmasq DHCP IPv6<a class="headerlink" href="#dnsmasq-dhcp-ipv6" title="Permalink to this headline">¶</a></h5>
<p>Finally we get to Stateless DHCPv6 using dnsmasq, relying on SLAAC for IPv6 and default gateway settings, with dnsmasq giving the DNS and NTP servers. From <a class="reference external" href="https://weirdfellow.wordpress.com/2014/09/05/dhcpv6-and-ra-with-dnsmasq/">DHCPv6 and RA with dnsmasq</a>, dnsmasq option combination <code class="docutils literal"><span class="pre">ra-names</span></code> means “DNS will try to guess the auto-configured addresses.” According to the article Microsoft doesn’t follow IEEE EUI-64 so the “ra-names option will have no effect – DNS will not guess correctly the IPv6 address of those machines, so no entry in DNS will be populated.” This behaviour can be changed and reverted to IEEE EUI-64 by executing these commands on the Windows client:”</p>
<div class="highlight-bat"><div class="highlight"><pre><span></span>netsh interface ipv6 set global randomizeidentifiers=disabled
netsh advfirewall firewall add rule name=<span class="s2">&quot;ICMPv4 8&quot;</span> protocol=icmpv4:8,any dir=in action=allow
netsh advfirewall firewall add rule name=<span class="s2">&quot;ICMPv6 128&quot;</span> protocol=icmpv6:128,any dir=in action=allow
</pre></div>
</div>
<p>The additional configuration modifications to enable SLAAC, ra-stateless, and ra-names plus pass on the IPv6 DNS and NTP addresses are:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># dnsmasq provides dhcpv6-stateless (DHCP options only - SLAAC provides address &amp; gateway).
<span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth1 service dhcpv6-stateless
</span><span class="hll">set interfaces ethernet eth0 dhcpv6-pd pd 0 interface eth2 service dhcpv6-stateless
</span>
# Turn on ra-stateless providing IPv6 DNS &amp; NTP servers
<span class="hll">set service dns forwarding options &#39;dhcp-range=set:eth1v6,::,constructor:eth1,ra-stateless,ra-names,12h&#39;
</span><span class="hll">set service dns forwarding options &#39;dhcp-option=tag:eth1v6,option6:dns-server,[::]&#39;
</span><span class="hll">set service dns forwarding options &#39;dhcp-option=tag:eth1v6,option6:ntp-server,[::]&#39;
</span>
<span class="hll">set service dns forwarding options &#39;dhcp-range=set:eth2v6,::,constructor:eth2,ra-stateless,ra-names,12h&#39;
</span><span class="hll">set service dns forwarding options &#39;dhcp-option=tag:eth2v6,option6:dns-server,[::]&#39;
</span><span class="hll">set service dns forwarding options &#39;dhcp-option=tag:eth2v6,option6:ntp-server,[::]&#39;
</span></pre></div>
</div>
</div>
</div>
<div class="section" id="firewall-system-configuration">
<h4>8.5.1.3.3. Firewall system configuration<a class="headerlink" href="#firewall-system-configuration" title="Permalink to this headline">¶</a></h4>
<p>Here are the general configuration options:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>set firewall all-ping enable
set firewall broadcast-ping disable
set firewall receive-redirects disable
set firewall send-redirects enable
set firewall source-validation disable
set firewall syn-cookies enable
set interfaces ethernet eth0 address dhcp
set interfaces ethernet eth0 description Internet

set interfaces ethernet eth0 duplex auto
set interfaces ethernet eth0 mac &#39;00:24:54:57:8e:55&#39;
set interfaces ethernet eth0 speed auto
set interfaces ethernet eth1 address 192.168.1.1/24
set interfaces ethernet eth1 description Local
set interfaces ethernet eth1 duplex auto
set interfaces ethernet eth1 speed auto
set interfaces ethernet eth2 address 192.168.2.1/24
set interfaces ethernet eth2 description &#39;Local 2&#39;
set interfaces ethernet eth2 duplex auto
set interfaces ethernet eth2 speed auto
set interfaces loopback lo

set service gui http-port 80
set service gui https-port 443
set service gui older-ciphers disable
set service nat rule 5010 description &#39;masquerade for WAN&#39;
set service nat rule 5010 outbound-interface eth0
set service nat rule 5010 type masquerade
set service ssh port 22
set service ssh protocol-version v2
set system domain-name home.local
set system host-name fw
set system ip override-hostname-ip 192.168.1.1
set system login banner pre-login &#39;********************************************************************\n*                                                                  *\n* * * *                      bitbender                       * * * *\n* * * *                   WARNING NOTICE:                    * * * *\n*   This system is restricted solely to bitbender authorized       *\n*   users for legitimate business purposes only. The actual or     *\n*   attempted unauthorized access, use, or modification of this    *\n*   system is strictly prohibited by bitbender. Unauthorized       *\n*   users are subject to disciplinary proceedings and/or           *\n*   criminal and civil penalties under state, federal, or other    *\n*   domestic and foreign laws. The use of this system may be       *\n*   monitored and recorded for administrative and security reasons.*\n*   Anyone accessing this system expressly consents to such        *\n*   monitoring and is advised that if monitoring reveals possible  *\n*   evidence of criminal activity, bitbender may provide the       *\n*   evidence of such activity to law enforcement officials. All    *\n*   users must comply with bitbender instructions regarding the    *\n*   protection of bitbender information assets.                    *\n*                                                                  *\n********************************************************************\n&#39;
set system login user someone authentication encrypted-password &#39;$6$aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;
set system login user someone authentication plaintext-password &#39;&#39;
set system login user someone full-name &#39;&#39;
set system login user someone level admin

set system ntp server 0.ubnt.pool.ntp.org
set system ntp server 1.ubnt.pool.ntp.org
set system ntp server 2.ubnt.pool.ntp.org
set system ntp server 3.ubnt.pool.ntp.org
set system offload hwnat disable
set system offload ipsec enable
set system offload ipv4 forwarding enable
set system offload ipv6 forwarding enable
set system syslog global facility all level notice
set system syslog global facility protocols level debug
set system time-zone UTC
set system traffic-analysis dpi enable
set system traffic-analysis export enable
</pre></div>
</div>
</div>
<div class="section" id="zone-configurations">
<h4>8.5.1.3.4. zone configurations<a class="headerlink" href="#zone-configurations" title="Permalink to this headline">¶</a></h4>
<p>Here is boilerplate for applying the zone configurations. Zone ruleset lan-guest-6 is for IPv6 traffic from zone lan to zone guest (with “-6” dropped for IPv4). Each zone is associated with an interface (eth0, eth1, eth2, and local for the firewall itself).</p>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">set zone-policy zone GUEST default-action drop
</span>set zone-policy zone GUEST from LAN firewall ipv6-name lan-guest-6
set zone-policy zone GUEST from LAN firewall name lan-guest
set zone-policy zone GUEST from WAN firewall ipv6-name wan-guest-6
set zone-policy zone GUEST from WAN firewall name wan-guest
set zone-policy zone GUEST from local firewall ipv6-name local-guest-6
set zone-policy zone GUEST from local firewall name local-guest
set zone-policy zone GUEST interface eth2
<span class="hll">set zone-policy zone LAN default-action drop
</span>set zone-policy zone LAN from GUEST firewall ipv6-name guest-lan-6
set zone-policy zone LAN from GUEST firewall name guest-lan
set zone-policy zone LAN from WAN firewall ipv6-name wan-lan-6
set zone-policy zone LAN from WAN firewall name wan-lan
set zone-policy zone LAN from local firewall ipv6-name local-lan-6
set zone-policy zone LAN from local firewall name local-lan
set zone-policy zone LAN interface eth1
<span class="hll">set zone-policy zone WAN default-action drop
</span>set zone-policy zone WAN from GUEST firewall ipv6-name guest-wan-6
set zone-policy zone WAN from GUEST firewall name guest-wan
set zone-policy zone WAN from LAN firewall ipv6-name lan-wan-6
set zone-policy zone WAN from LAN firewall name lan-wan
set zone-policy zone WAN from local firewall ipv6-name local-wan-6
set zone-policy zone WAN from local firewall name local-wan
set zone-policy zone WAN interface eth0
<span class="hll">set zone-policy zone local default-action drop
</span>set zone-policy zone local from GUEST firewall ipv6-name guest-local-6
set zone-policy zone local from GUEST firewall name guest-local
set zone-policy zone local from LAN firewall ipv6-name lan-local-6
set zone-policy zone local from LAN firewall name lan-local
set zone-policy zone local from WAN firewall ipv6-name wan-local-6
set zone-policy zone local from WAN firewall name wan-local
set zone-policy zone local local-zone
</pre></div>
</div>
<p>We’re not providing all the firewall rules as they generally differ too much. But as an example, if you wanted to allow all IPv4 traffic in a given zone:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>set firewall name allow-all default-action accept
set firewall name allow-all description &#39;IPv4 allow all, drop invalid&#39;
set firewall name allow-all rule 1 action accept
set firewall name allow-all rule 1 state established enable
set firewall name allow-all rule 1 state related enable
set firewall name allow-all rule 2 action drop
set firewall name allow-all rule 2 log enable
set firewall name allow-all rule 2 state invalid enable
</pre></div>
</div>
<p>Another snippet is to drop traffic except for continuation of already allowed traffic.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>set firewall name allow-est-drop-inv default-action drop
set firewall name allow-est-drop-inv description &#39;IPv4 allow established, drop invalid&#39;
set firewall name allow-est-drop-inv enable-default-log
set firewall name allow-est-drop-inv rule 1 action accept
set firewall name allow-est-drop-inv rule 1 state established enable
set firewall name allow-est-drop-inv rule 1 state related enable
set firewall name allow-est-drop-inv rule 2 action drop
set firewall name allow-est-drop-inv rule 2 log enable
set firewall name allow-est-drop-inv rule 2 state invalid enable
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="lede-project-firewalls">
<span id="lede-project"></span><h2>8.5.2. LEDE Project firewalls<a class="headerlink" href="#lede-project-firewalls" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id24">
<h3>8.5.2.1. LEDE Project<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://lede-project.org/">LEDE</a> (Linux Embedded Development Environment):</p>
<blockquote>
<div>The LEDE Project (“Linux Embedded Development Environment”) is a Linux operating system based on OpenWrt. It is a complete replacement for the vendor-supplied firmware of a wide range of wireless routers and non-network devices. See the <a class="reference external" href="https://lede-project.org/toh/start">Table of Hardware</a> for supported devices. For more information about LEDE Project organization, see the <a class="reference external" href="https://lede-project.org/about">About LEDE</a> pages.</div></blockquote>
<p>It’s a fork of OpenWRT but the 2 organizations intent to remerge (<a class="reference external" href="http://lists.infradead.org/pipermail/lede-adm/2017-June/000552.html">[LEDE-DEV] LEDE call for vote on remerge proposal V3</a>).</p>
<p>There is a list of <a class="reference external" href="https://lede-project.org/packages/start">LEDE Project - Packages</a> and since it’s open source you can view the <a class="reference external" href="https://git.lede-project.org/">LEDE source code</a>.</p>
<p>Users can start with <a class="reference external" href="https://lede-project.org/docs/user-guide/start">LEDE User Guide</a> and developers with <a class="reference external" href="https://lede-project.org/docs/guide-developer/start">LEDE Developer Guide</a>.</p>
<p>For initial flashing see <a class="reference external" href="https://lede-project.org/docs/guide-quick-start/factory_installation">Factory install: First-time installation of LEDE on a device</a> and for updates see <a class="reference external" href="https://lede-project.org/docs/guide-quick-start/sysupgrade.luci">Sysupgrading an existing LEDE device from the web admin GUI</a>.</p>
<p>For questions there’s the <a class="reference external" href="https://forum.lede-project.org/">LEDE Project Forum</a>.</p>
</div>
<div class="section" id="lede-linux-is-not-standard-linux">
<h3>8.5.2.2. LEDE Linux is not standard Linux<a class="headerlink" href="#lede-linux-is-not-standard-linux" title="Permalink to this headline">¶</a></h3>
<p>While LEDE is a Linux-based distribution, it is very different from Debian and fedora.</p>
<div class="section" id="lede-uses-musl-libc">
<h4>8.5.2.2.1. LEDE uses musl libc<a class="headerlink" href="#lede-uses-musl-libc" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://lede-project.org/faq/after_installation#command_not_found">Command not found</a>, LEDE uses <a class="reference external" href="https://www.musl-libc.org/">musl libc</a>.</p>
</div>
<div class="section" id="busybox-shell">
<h4>8.5.2.2.2. BusyBox shell<a class="headerlink" href="#busybox-shell" title="Permalink to this headline">¶</a></h4>
<p>LEDE uses the <a class="reference external" href="https://en.wikipedia.org/wiki/BusyBox">Wikipedia - BusyBox</a> shell: “<strong>BusyBox</strong> is software that provides several stripped-down Unix tools in a single executable file.” See <a class="reference external" href="https://busybox.net/downloads/BusyBox.html">BusyBox Command Help</a> for documentation and <a class="reference external" href="https://busybox.net/live_bbox/live_bbox.html">BusyBox in VM</a> for a live running <strong class="program">BusyBox</strong>. <strong class="program">BusyBox</strong> provides a list of <a class="reference external" href="https://busybox.net/tinyutils.html">External Tiny Utilities</a> not provided by <strong class="program">BusyBox</strong>.</p>
<p>Here are commands illustrating virtually all shell commands are merely links to <strong class="program">BusyBox</strong>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">ls -l /bin   <span class="c1"># most executables are links to busybox</span>
</span>ls -l /sbin
ls -l /usr/bin
ls -l /usr/sbin

<span class="hll">ls -l /bin/busybox   <span class="c1"># busybox is small (378,437 bytes)</span>
</span></pre></div>
</div>
</div>
<div class="section" id="lede-boots-with-u-boot">
<h4>8.5.2.2.3. LEDE boots with U-Boot<a class="headerlink" href="#lede-boots-with-u-boot" title="Permalink to this headline">¶</a></h4>
<p>LEDE’s boot loader is <a class="reference external" href="https://en.wikipedia.org/wiki/Das_U-Boot">Das U-Boot</a>:</p>
<blockquote>
<div><p>Das U-Boot (subtitled “the Universal Boot Loader” and often shortened to U-Boot) is an open source, primary boot loader used in embedded devices to package the instructions to boot the device’s operating system kernel. It is available for a number of computer architectures, including 68k, ARM, Blackfin, MicroBlaze, MIPS, Nios, SuperH, PPC, RISC-V and x86.</p>
<p>U-Boot is both a first-stage and second-stage bootloader. It is loaded by the system’s ROM or BIOS from a supported boot device, such as an SD card, SATA drive, NOR flash (e.g. using SPI or I²C), or NAND flash. If there are size constraints, U-Boot may be split into stages: the platform would load a small SPL (Secondary Program Loader), which is a stripped-down version of U-Boot, and the SPL would do initial hardware configuration and load the larger, fully featured version of U-Boot.</p>
<p>Regardless of whether the SPL is used, U-Boot performs both first-stage (e.g., configuring memory controllers and SDRAM) and second-stage booting (performing multiple steps to load a modern operating system from a variety of devices that must be configured, presenting a menu for users to interact with and control the boot process, etc.).</p>
</div></blockquote>
<p>The code can be found at GitHub <a class="reference external" href="https://github.com/u-boot/u-boot">u-boot/u-boot</a>.</p>
</div>
<div class="section" id="busybox-runs-init-with-etc-init-d">
<h4>8.5.2.2.4. BusyBox runs <code class="docutils literal"><span class="pre">init</span></code> with <code class="file docutils literal"><span class="pre">/etc/init.d/</span></code><a class="headerlink" href="#busybox-runs-init-with-etc-init-d" title="Permalink to this headline">¶</a></h4>
<p>Latest Kali’s <code class="docutils literal"><span class="pre">/sbin/init</span></code> is a link to <code class="docutils literal"><span class="pre">/lib/systemd/systemd</span></code>. In contrast, LEDE uses the more traditional startup with <code class="file docutils literal"><span class="pre">init</span></code> and  <code class="file docutils literal"><span class="pre">/etc/inittab</span></code>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="hll"><span class="gp">root@LEDE:/#</span> cat /etc/inittab
</span><span class="go">::sysinit:/etc/init.d/rcS S boot</span>
<span class="go">::shutdown:/etc/init.d/rcS K shutdown</span>
<span class="go">ttyAMA0::askfirst:/usr/libexec/login.sh</span>
<span class="go">ttyS0::askfirst:/usr/libexec/login.sh</span>
<span class="go">hvc0::askfirst:/usr/libexec/login.sh</span>
</pre></div>
</div>
<p>Boot is comparatively simple:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="hll"><span class="gp">root@LEDE:/#</span> cat /etc/init.d/boot
</span><span class="gp">#</span>!/bin/sh /etc/rc.common
<span class="gp">#</span> Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2006</span>-2011 OpenWrt.org

<span class="go">START=10</span>
<span class="go">STOP=98</span>

<span class="go">uci_apply_defaults() {</span>
<span class="go">        . /lib/functions/system.sh</span>

<span class="go">        cd /etc/uci-defaults || return 0</span>
<span class="go">        files=&quot;$(ls)&quot;</span>
<span class="go">        [ -z &quot;$files&quot; ] &amp;&amp; return 0</span>
<span class="go">        mkdir -p /tmp/.uci</span>
<span class="go">        for file in $files; do</span>
<span class="go">                ( . &quot;./$(basename $file)&quot; ) &amp;&amp; rm -f &quot;$file&quot;</span>
<span class="go">        done</span>
<span class="go">        uci commit</span>
<span class="go">}</span>

<span class="go">boot() {</span>
<span class="go">        [ -f /proc/mounts ] || /sbin/mount_root</span>
<span class="go">        [ -f /proc/jffs2_bbc ] &amp;&amp; echo &quot;S&quot; &gt; /proc/jffs2_bbc</span>
<span class="go">        [ -f /proc/net/vlan/config ] &amp;&amp; vconfig set_name_type DEV_PLUS_VID_NO_PAD</span>

<span class="go">        mkdir -p /var/run</span>
<span class="go">        mkdir -p /var/log</span>
<span class="go">        mkdir -p /var/lock</span>
<span class="go">        mkdir -p /var/state</span>
<span class="go">        mkdir -p /var/tmp</span>
<span class="go">        mkdir -p /tmp/.uci</span>
<span class="go">        chmod 0700 /tmp/.uci</span>
<span class="go">        touch /var/log/wtmp</span>
<span class="go">        touch /var/log/lastlog</span>
<span class="go">        touch /tmp/resolv.conf.auto</span>
<span class="go">        ln -sf /tmp/resolv.conf.auto /tmp/resolv.conf</span>
<span class="go">        grep -q debugfs /proc/filesystems &amp;&amp; /bin/mount -o noatime -t debugfs debugfs /sys/kernel/debug</span>
<span class="go">        [ &quot;$FAILSAFE&quot; = &quot;true&quot; ] &amp;&amp; touch /tmp/.failsafe</span>

<span class="go">        /sbin/kmodloader</span>

<span class="go">        [ ! -f /etc/config/wireless ] &amp;&amp; {</span>
<span class="gp">                #</span> compat <span class="k">for</span> brcm47xx and mvebu
<span class="go">                sleep 1</span>
<span class="go">        }</span>

<span class="go">        /bin/config_generate</span>
<span class="go">        uci_apply_defaults</span>

<span class="gp">        #</span> temporary hack <span class="k">until</span> configd exists
<span class="go">        /sbin/reload_config</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<div class="section" id="busybox-service-management">
<h4>8.5.2.2.5. BusyBox service management<a class="headerlink" href="#busybox-service-management" title="Permalink to this headline">¶</a></h4>
<p>See <a class="reference external" href="https://lede-project.org/docs/user-guide/services">Managing system services</a>.</p>
<p>On the CLI <code class="docutils literal"><span class="pre">service</span></code> manages services:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">service   <span class="c1"># list available services</span>
</span><span class="hll">service dropbear   <span class="c1"># list available actions for a service</span>
</span><span class="hll">service dropbear reload   <span class="c1"># check/start/stop/restart/reload/enable/disable</span>
</span></pre></div>
</div>
<p>The Luci web interface option <span class="menuselection">System ‣ Startup</span> also manages services.</p>
</div>
<div class="section" id="configuring-lede-with-uci">
<h4>8.5.2.2.6. Configuring LEDE with <strong class="program">uci</strong><a class="headerlink" href="#configuring-lede-with-uci" title="Permalink to this headline">¶</a></h4>
<p>See <a class="reference external" href="https://lede-project.org/docs/user-guide/introduction_to_lede_configuration">How configuring LEDE works</a>. Then see <a class="reference external" href="https://lede-project.org/docs/user-guide/start">LEDE User Guide</a> configuration sections. Of particular interest for a firewall is <a class="reference external" href="https://lede-project.org/docs/user-guide/firewall_configuration">Firewall configuration</a> which describes the zone-based firewall configuration.</p>
<p>The configuration files are in <code class="file docutils literal"><span class="pre">/etc/config/</span></code> and are manipulated using <strong class="program">uci</strong>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">uci   <span class="c1"># see options</span>
</span><span class="hll">uci show   <span class="c1"># see current settings</span>
</span>
<span class="hll"><span class="c1"># Change LAN interface IP</span>
</span>uci <span class="nb">set</span> network.lan.ipaddr<span class="o">=</span><span class="s1">&#39;192.168.200.1&#39;</span>   <span class="c1"># change IP</span>
uci changes   <span class="c1"># see what changed</span>
uci commit network   <span class="c1"># save changes to files</span>
reload_config   <span class="c1"># apply changes to system</span>
</pre></div>
</div>
</div>
<div class="section" id="opkg-package-manager">
<h4>8.5.2.2.7. <strong class="program">opkg</strong> package manager<a class="headerlink" href="#opkg-package-manager" title="Permalink to this headline">¶</a></h4>
<p>Here’s an example of the <strong class="program">opkg</strong> package manager:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">opkg   <span class="c1"># opkg options</span>
</span><span class="hll">opkg list-installed
</span><span class="hll">opkg list-upgradable
</span><span class="hll">opkg remove pppoe
</span><span class="hll">opkg list
</span><span class="hll">opkg list-changed-conffiles
</span></pre></div>
</div>
</div>
</div>
<div class="section" id="emulating-a-lede-virtual-image">
<h3>8.5.2.3. Emulating a LEDE virtual image<a class="headerlink" href="#emulating-a-lede-virtual-image" title="Permalink to this headline">¶</a></h3>
<p>Here we follow <a class="reference external" href="https://lede-project.org/docs/guide-developer/test-virtual-image-using-armvirt">Testing LEDE with a virtual image using the armvirt target</a>.</p>
<div class="section" id="lede-downloads-zimage-and-rootfs">
<h4>8.5.2.3.1. LEDE downloads, zImage, and rootfs<a class="headerlink" href="#lede-downloads-zimage-and-rootfs" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference external" href="http://lede-project.tetaneutral.net/releases/17.01.4/targets/armvirt/generic/">Index of /releases/17.01.4/targets/armvirt/generic/</a> show a variety of of downloads. The following will help sort them out.</p>
<dl class="docutils">
<dt>zImage</dt>
<dd><p class="first">compressed self-extracting Linux kernel</p>
<p class="last">may also contain initial file system initramfs (formerly initrd), used by the kernel before bringing up the root fs</p>
</dd>
<dt>rootfs</dt>
<dd>root filesystem, available in a variety of formats: cpio, squashfs, ext4, tar</dd>
</dl>
<p>Later we show using the zImage-initramfs, then zImage + root.ext4.</p>
<p>Here we download the demonstrated files:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Download LEDE zImage* and root.ext4</span>
<span class="nv">RELEASE</span><span class="o">=</span><span class="m">17</span>.01.4
<span class="nv">STORAGE</span><span class="o">=</span>/media/<span class="nv">$USER</span>/STORAGE
<span class="nv">VMS</span><span class="o">=</span><span class="si">${</span><span class="nv">STORAGE</span><span class="si">}</span>/vm
<span class="o">(</span> <span class="nb">cd</span> <span class="si">${</span><span class="nv">VMS</span><span class="si">}</span><span class="p">;</span>
<span class="hll">  curl -O http://lede-project.tetaneutral.net/releases/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/targets/armvirt/generic/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-zImage-initramfs
</span><span class="hll">  curl -O http://lede-project.tetaneutral.net/releases/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/targets/armvirt/generic/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-zImage
</span><span class="hll">  curl -O http://lede-project.tetaneutral.net/releases/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/targets/armvirt/generic/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-root.ext4.gz
</span>  gunzip lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-root.ext4.gz
<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="armvirt-zimage-initramfs">
<h4>8.5.2.3.2. armvirt zImage-initramfs<a class="headerlink" href="#armvirt-zimage-initramfs" title="Permalink to this headline">¶</a></h4>
<p>The zImage-initramfs file contains the kernel and rootfs in one file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Download LEDE initramfs</span>
<span class="nv">RELEASE</span><span class="o">=</span><span class="m">17</span>.01.4
<span class="nv">STORAGE</span><span class="o">=</span>/media/<span class="nv">$USER</span>/STORAGE
<span class="nv">VMS</span><span class="o">=</span><span class="si">${</span><span class="nv">STORAGE</span><span class="si">}</span>/vm
<span class="hll"><span class="nv">VM</span><span class="o">=</span><span class="si">${</span><span class="nv">VMS</span><span class="si">}</span>/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-zImage-initramfs
</span>
<span class="hll">sudo apt install qemu-system-arm -y
</span>
<span class="hll">qemu-system-arm -nographic -M virt -m <span class="m">64</span> -kernel <span class="si">${</span><span class="nv">VM</span><span class="si">}</span>
</span><span class="c1"># System prompt looks like:</span>

BusyBox v1.25.1 <span class="o">()</span> built-in shell <span class="o">(</span>ash<span class="o">)</span>

     _________
    /        /<span class="se">\ </span>     _    ___ ___  ___
   /  LE    /  <span class="se">\ </span>   <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> __<span class="p">|</span>   <span class="se">\|</span> __<span class="p">|</span>
  /    DE  /    <span class="se">\ </span>  <span class="p">|</span> <span class="p">|</span>__<span class="p">|</span> _<span class="o">||</span> <span class="p">|</span><span class="o">)</span> <span class="p">|</span> _<span class="p">|</span>
 /________/  LE  <span class="se">\ </span> <span class="p">|</span>____<span class="p">|</span>___<span class="p">|</span>___/<span class="p">|</span>___<span class="p">|</span>                      lede-project.org
 <span class="se">\ </span>       <span class="se">\ </span>  DE /
  <span class="se">\ </span>   LE  <span class="se">\ </span>   /  -----------------------------------------------------------
   <span class="se">\ </span> DE    <span class="se">\ </span> /    Reboot <span class="o">(</span><span class="m">17</span>.01.4, r3533-d0bf257c46<span class="o">)</span>
    <span class="se">\_</span>_______<span class="se">\/</span>    -----------------------------------------------------------

<span class="o">===</span> WARNING! <span class="o">=====================================</span>
There is no root password defined on this device!
Use the <span class="s2">&quot;passwd&quot;</span> <span class="nb">command</span> to <span class="nb">set</span> up a new password
in order to prevent unauthorized SSH logins.
--------------------------------------------------
<span class="hll">root@LEDE:/# df -h
</span>Filesystem                Size      Used Available Use% Mounted on
rootfs                   <span class="m">27</span>.2M      <span class="m">6</span>.3M     <span class="m">20</span>.9M  <span class="m">23</span>% /
tmpfs                    <span class="m">29</span>.5M     <span class="m">52</span>.0K     <span class="m">29</span>.5M   <span class="m">0</span>% /tmp
tmpfs                   <span class="m">512</span>.0K         <span class="m">0</span>    <span class="m">512</span>.0K   <span class="m">0</span>% /dev
<span class="hll">root@LEDE:/# ip addr show
</span><span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN qlen <span class="m">1</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
<span class="m">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq_codel master br-lan state UP qlen <span class="m">1000</span>
    link/ether <span class="m">52</span>:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff
<span class="m">3</span>: br-lan: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP qlen <span class="m">1000</span>
    link/ether <span class="m">52</span>:54:00:12:34:56 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.1.1/24 brd <span class="m">192</span>.168.1.255 scope global br-lan
       valid_lft forever preferred_lft forever
    inet6 fd5f:a2de:a603::1/60 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe12:3456/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll">root@LEDE:/# poweroff
</span></pre></div>
</div>
<p>This lacks local network connectivity, so use the slow <code class="docutils literal"><span class="pre">-net</span> <span class="pre">user</span></code> networking. Note: the VM’s local 192.168.1.0/24 network collided with the host’s network range, so mods were made to change VM’s network to 192.168.200.0/24:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># If host local network collides with 192.168.1.0/24</span>
<span class="nv">RELEASE</span><span class="o">=</span><span class="m">17</span>.01.4
<span class="nv">STORAGE</span><span class="o">=</span>/media/<span class="nv">$USER</span>/STORAGE
<span class="nv">VMS</span><span class="o">=</span><span class="si">${</span><span class="nv">STORAGE</span><span class="si">}</span>/vm
<span class="hll"><span class="nv">VM</span><span class="o">=</span><span class="si">${</span><span class="nv">VMS</span><span class="si">}</span>/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-zImage-initramfs
</span>
<span class="hll"><span class="c1"># Create TAP adapter</span>
</span><span class="nv">LAN</span><span class="o">=</span>lede-tap0
sudo ip tuntap add mode tap <span class="nv">$LAN</span>
sudo ip link <span class="nb">set</span> dev <span class="nv">$LAN</span> up

<span class="c1"># Run VM</span>
<span class="hll">sudo qemu-system-arm <span class="se">\</span>
</span><span class="hll">    -device virtio-net-pci,netdev<span class="o">=</span>lan <span class="se">\</span>
</span><span class="hll">    -netdev tap,id<span class="o">=</span>lan,ifname<span class="o">=</span><span class="nv">$LAN</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\</span>
</span><span class="hll">    -device virtio-net-pci,netdev<span class="o">=</span>wan <span class="se">\</span>
</span><span class="hll">    -netdev user,id<span class="o">=</span>wan,hostfwd<span class="o">=</span>tcp::5555-:80 <span class="se">\</span>
</span><span class="hll">    -M virt <span class="se">\</span>
</span><span class="hll">    -nographic <span class="se">\</span>
</span><span class="hll">    -m <span class="m">64</span> <span class="se">\</span>
</span><span class="hll">    -kernel <span class="nv">$VM</span>
</span>
<span class="c1"># On the running server:</span>
<span class="c1"># If host local network collides with 192.168.1.0/24</span>
<span class="hll">uci <span class="nb">set</span> network.lan.ipaddr<span class="o">=</span><span class="s1">&#39;192.168.200.1&#39;</span>
</span><span class="hll">uci commit network
</span><span class="hll">reload_config
</span>
<span class="hll">ping lede-project.org
</span><span class="hll">ping6 lede-project.org
</span><span class="hll">wget -O /dev/null http://www.example.com/
</span><span class="hll">wget -6 -O /dev/null http://www.example.com/
</span>
<span class="hll">poweroff
</span></pre></div>
</div>
</div>
<div class="section" id="armvirt-zimage-root-ext4">
<h4>8.5.2.3.3. armvirt zImage + root.ext4<a class="headerlink" href="#armvirt-zimage-root-ext4" title="Permalink to this headline">¶</a></h4>
<p>Here we combine a zImage and persistent ext4-formatted root partition:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># If TAP not created previously:</span>
</span><span class="nv">LAN</span><span class="o">=</span>lede-tap0
sudo ip tuntap add mode tap <span class="nv">$LAN</span>
sudo ip link <span class="nb">set</span> dev <span class="nv">$LAN</span> up

<span class="hll"><span class="c1"># zImage (no initramfs) + root.ext4</span>
</span><span class="nv">STORAGE</span><span class="o">=</span>/media/<span class="nv">$USER</span>/STORAGE
<span class="nv">VMS</span><span class="o">=</span><span class="si">${</span><span class="nv">STORAGE</span><span class="si">}</span>/vm
<span class="nv">RELEASE</span><span class="o">=</span><span class="m">17</span>.01.4
<span class="hll"><span class="nv">EXT4</span><span class="o">=</span><span class="si">${</span><span class="nv">VMS</span><span class="si">}</span>/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-root.ext4
</span><span class="hll"><span class="nv">ZIMAGE</span><span class="o">=</span><span class="si">${</span><span class="nv">VMS</span><span class="si">}</span>/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-zImage
</span><span class="hll">sudo qemu-system-arm <span class="se">\</span>
</span>     -nographic <span class="se">\</span>
     -M virt <span class="se">\</span>
     -m <span class="m">64</span> <span class="se">\</span>
<span class="hll">     -kernel <span class="si">${</span><span class="nv">ZIMAGE</span><span class="si">}</span> <span class="se">\</span>
</span><span class="hll">     -drive <span class="nv">file</span><span class="o">=</span><span class="si">${</span><span class="nv">EXT4</span><span class="si">}</span>,format<span class="o">=</span>raw,if<span class="o">=</span>virtio <span class="se">\</span>
</span><span class="hll">     -append <span class="s1">&#39;root=/dev/vda rootwait&#39;</span> <span class="se">\</span>
</span>     -device virtio-net-pci,netdev<span class="o">=</span>lan <span class="se">\</span>
<span class="hll">     -netdev tap,id<span class="o">=</span>lan,ifname<span class="o">=</span><span class="nv">$LAN</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\</span>
</span>     -device virtio-net-pci,netdev<span class="o">=</span>wan <span class="se">\</span>
<span class="hll">     -netdev user,id<span class="o">=</span>wan,hostfwd<span class="o">=</span>tcp::5555-:80
</span>
<span class="c1"># If host local network collides with 192.168.1.0/24</span>
<span class="hll">uci <span class="nb">set</span> network.lan.ipaddr<span class="o">=</span><span class="s1">&#39;192.168.200.1&#39;</span>
</span><span class="hll">uci commit network
</span><span class="hll">reload_config
</span>
<span class="hll">ping lede-project.org
</span><span class="hll">ping6 lede-project.org
</span><span class="hll">wget -O /dev/null http://www.example.com/
</span><span class="hll">wget -6 -O /dev/null http://www.example.com/
</span>
<span class="hll">poweroff
</span>
<span class="hll"><span class="c1"># ... after restart see that changes persist</span>
</span>
<span class="hll">ip addr show
</span><span class="hll">ping lede-project.org
</span><span class="hll">ping6 lede-project.org
</span><span class="hll">wget -O /dev/null http://www.example.com/
</span><span class="hll">wget -6 -O /dev/null http://www.example.com/
</span></pre></div>
</div>
<p>Here’s a better configuration. We’ll start by preparing the required networking:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># Move existing host adapter enp5s0 behind a bridge br0</span>
</span>cat &gt; br_up.sh <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">#!/usr/bin/env bash</span>

<span class="s">BRIDGE=br0</span>
<span class="s">DEV=enp5s0</span>
<span class="s"># nmcli networking off</span>
<span class="s">nmcli device set $DEV managed no</span>
<span class="s">sudo ip addr flush dev $DEV</span>
<span class="s">sudo ip -6 route flush table all</span>
<span class="s"># Create bridge and slave DEV</span>
<span class="s">if ! ip link show ${BRIDGE} &amp;&gt;/dev/null; then</span>
<span class="s">  sudo ip link add name ${BRIDGE} type bridge</span>
<span class="s">fi</span>
<span class="s">sudo ip link set ${BRIDGE} up</span>
<span class="s">sudo ip link set ${DEV} master ${BRIDGE}</span>
<span class="s">sudo ip link set ${DEV} up</span>
<span class="s">sudo dhclient -6 -S</span>
<span class="s">sudo dhclient ${BRIDGE}</span>
<span class="s">EOF</span>
chmod +x br_up.sh
sudo ./br_up.sh

<span class="hll"><span class="c1"># Create extra LEDE interfaces to allow for:</span>
</span><span class="hll"><span class="c1">#   LEDE firewall LAN and WAN interfaces</span>
</span><span class="hll"><span class="c1">#   LEDE bridge for network behind the firewall</span>
</span><span class="hll"><span class="c1">#   Two client interfaces for LEDE bridge</span>
</span>cat &gt; lede_up.sh <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">#!/usr/bin/env bash</span>

<span class="s">BRIDGE=br0</span>
<span class="s">DEV=enp5s0</span>
<span class="s">LEDE_BRIDGE=lede-br0</span>
<span class="s">LEDE_BRIDGE_IP=192.168.200.254/24</span>
<span class="s">LAN=lede-tap0</span>
<span class="s">LAN_IP=192.168.200.1/24</span>
<span class="s">WAN=lede-tap1</span>
<span class="s">GUEST=lede-tap2</span>
<span class="s">GUEST_IP=192.168.200.100/24</span>
<span class="s">GUEST2=lede-tap3</span>
<span class="s">GUEST2_IP=192.168.200.101/24</span>
<span class="s">ip link add name ${LEDE_BRIDGE} type bridge</span>
<span class="s">ip addr add ${LEDE_BRIDGE_IP} dev ${LEDE_BRIDGE}</span>
<span class="s">ip link set ${LEDE_BRIDGE} up</span>
<span class="s">for tap in ${LAN} ${GUEST} ${GUEST2}; do</span>
<span class="s">  ip tuntap add dev ${tap} mode tap</span>
<span class="s">  ip link set dev ${tap} master ${LEDE_BRIDGE}</span>
<span class="s">  ip link set dev ${tap} up</span>
<span class="s">done</span>
<span class="s">ip tuntap add dev ${WAN} mode tap</span>
<span class="s">ip link set dev ${WAN} master ${BRIDGE}</span>
<span class="s">ip link set dev ${WAN} up</span>
<span class="s"># ip addr add ${LAN_IP} dev ${LAN}</span>
<span class="s"># ip addr add ${GUEST_IP} dev ${GUEST}</span>
<span class="s"># ip addr add ${GUEST2_IP} dev ${GUEST2}</span>
<span class="s">EOF</span>
chmod +x lede_up.sh
sudo ./lede_up.sh
</pre></div>
</div>
<p>Now we use the above network for the LEDE firewall:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># LEDE network created above</span>
</span><span class="nv">LAN</span><span class="o">=</span>lede-tap0
<span class="nv">WAN</span><span class="o">=</span>lede-tap1

<span class="nv">STORAGE</span><span class="o">=</span>/media/<span class="nv">$USER</span>/STORAGE
<span class="nv">VMS</span><span class="o">=</span><span class="si">${</span><span class="nv">STORAGE</span><span class="si">}</span>/vm
<span class="nv">RELEASE</span><span class="o">=</span><span class="m">17</span>.01.4
<span class="nv">EXT4</span><span class="o">=</span><span class="si">${</span><span class="nv">VMS</span><span class="si">}</span>/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-root.ext4
<span class="nv">ZIMAGE</span><span class="o">=</span><span class="si">${</span><span class="nv">VMS</span><span class="si">}</span>/lede-<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>-armvirt-zImage
<span class="hll">sudo qemu-system-arm <span class="se">\</span>
</span>     -nographic <span class="se">\</span>
     -M virt <span class="se">\</span>
     -m <span class="m">64</span> <span class="se">\</span>
     -kernel <span class="si">${</span><span class="nv">ZIMAGE</span><span class="si">}</span> <span class="se">\</span>
     -drive <span class="nv">file</span><span class="o">=</span><span class="si">${</span><span class="nv">EXT4</span><span class="si">}</span>,format<span class="o">=</span>raw,if<span class="o">=</span>virtio <span class="se">\</span>
     -append <span class="s1">&#39;root=/dev/vda rootwait&#39;</span> <span class="se">\</span>
     -device virtio-net-pci,netdev<span class="o">=</span>lan <span class="se">\</span>
<span class="hll">     -netdev tap,id<span class="o">=</span>lan,ifname<span class="o">=</span><span class="nv">$LAN</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no <span class="se">\</span>
</span>     -device virtio-net,netdev<span class="o">=</span>wan <span class="se">\</span>
<span class="hll">     -netdev tap,id<span class="o">=</span>wan,ifname<span class="o">=</span><span class="nv">$WAN</span>,script<span class="o">=</span>no,downscript<span class="o">=</span>no
</span>
ping lede-project.org
ping6 lede-project.org
wget -O /dev/null http://www.example.com/
wget -6 -O /dev/null http://www.example.com/
</pre></div>
</div>
<p>Tearing down the network involves:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># Tear down the LEDE network</span>
</span>cat &gt; lede_down.sh <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">#!/usr/bin/env bash</span>

<span class="s">BRIDGE=br0</span>
<span class="s">DEV=enp5s0</span>
<span class="s"># Create guest networking</span>
<span class="s">LEDE_BRIDGE=lede-br0</span>
<span class="s">LAN=lede-tap0</span>
<span class="s">WAN=lede-tap1</span>
<span class="s">GUEST=lede-tap2</span>
<span class="s">GUEST2=lede-tap3</span>
<span class="s">for tap in ${LAN} ${GUEST} ${GUEST2} ${WAN}; do</span>
<span class="s">  ip tuntap del dev ${tap} mode tap</span>
<span class="s">done</span>
<span class="s">ip link del dev ${LEDE_BRIDGE}</span>
<span class="s">EOF</span>
chmod +x lede_down.sh
sudo ./lede_down.sh

<span class="hll"><span class="c1"># Remove br0</span>
</span>cat &gt; br_down.sh <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">#!/usr/bin/env bash</span>

<span class="s">BRIDGE=br0</span>
<span class="s">DEV=enp5s0</span>
<span class="s"># Delete bridge and slave eth i/f</span>
<span class="s">dhclient -r ${BRIDGE}</span>
<span class="s">ip link set dev ${DEV} nomaster</span>
<span class="s">ip link delete dev ${BRIDGE} type bridge</span>
<span class="s"># NetworkManager manage DEV</span>
<span class="s">nmcli device set $DEV managed yes</span>
<span class="s">EOF</span>
chmod +x br_down.sh
sudo ./br_down.sh
</pre></div>
</div>
</div>
<div class="section" id="initial-configuration">
<h4>8.5.2.3.4. Initial configuration<a class="headerlink" href="#initial-configuration" title="Permalink to this headline">¶</a></h4>
<p>What’s missing from the configuration? No root password or ssh keys enforced, no external access to firewall, no HTTPS configured, no IPv6 on internal network, … . We fix a few of them here:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># Set root password</span>
</span>passwd

<span class="hll"><span class="c1"># If host local network collides with 192.168.1.0/24</span>
</span>uci <span class="nb">set</span> network.lan.ipaddr<span class="o">=</span><span class="s1">&#39;192.168.200.1&#39;</span>
uci commit network
reload_config

<span class="hll"><span class="c1"># Replace internal VM switch with external switch</span>
</span>uci get network.lan.type
uci delete network.lan.type
uci commit network
reload_config

<span class="hll"><span class="c1"># Configure dhcp</span>
</span>uci show dhcp
<span class="c1"># dhcp.@dnsmasq[0].rebind_protection=&#39;0&#39;</span>
uci <span class="nb">set</span> dhcp.@dnsmasq<span class="o">[</span><span class="m">0</span><span class="o">]</span>.local<span class="o">=</span><span class="s1">&#39;/bitbender.org/&#39;</span>
uci <span class="nb">set</span> dhcp.@dnsmasq<span class="o">[</span><span class="m">0</span><span class="o">]</span>.domain<span class="o">=</span><span class="s1">&#39;bitbender.org&#39;</span>
uci <span class="nb">set</span> dhcp.wan.hostname<span class="o">=</span><span class="s1">&#39;lede&#39;</span>
uci commit network
reload_config

<span class="hll"><span class="c1"># Setup HTTPS web interface</span>
</span>opkg update
opkg install luci-ssl
service uhttpd restart
netstat -tanl <span class="p">|</span> grep <span class="m">443</span>
wget -O /dev/null https://lede
wget -6 -O /dev/null https://localhost
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="firewall-and-ipv6-inadequacies">
<h2>8.5.3. Firewall and IPv6 inadequacies<a class="headerlink" href="#firewall-and-ipv6-inadequacies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="firewalls-trying-to-hide-complexity">
<h3>8.5.3.1. Firewalls trying to hide complexity<a class="headerlink" href="#firewalls-trying-to-hide-complexity" title="Permalink to this headline">¶</a></h3>
<div class="section" id="friendly-web-and-cli-interfaces">
<h4>8.5.3.1.1. Friendly web and CLI interfaces<a class="headerlink" href="#friendly-web-and-cli-interfaces" title="Permalink to this headline">¶</a></h4>
<p>Firewalls try to make configuration easy for users. EdgeRouter products configure EdgeOS though its CLI and web interfaces, while LEDE is configured using the <a class="reference external" href="https://lede-project.org/docs/guide-developer/uci-defaults">UCI CLI</a> or web-based <a class="reference external" href="https://lede-project.org/docs/guide-quick-start/webadmingui">LuCI</a>. The idea is to hide the implementation details. Then several comparatively high level statements can be used to configure several services and the user need not know about the service details.</p>
</div>
<div class="section" id="example-of-hiding-isp-dhcp-configuration">
<h4>8.5.3.1.2. Example of hiding ISP DHCP configuration<a class="headerlink" href="#example-of-hiding-isp-dhcp-configuration" title="Permalink to this headline">¶</a></h4>
<p>An example is ERLite-3 configuration of the DHCP client: the DHCP4 client is implemented by the <a class="reference external" href="https://www.isc.org/downloads/dhcp/">ISC DHCP</a> <code class="docutils literal"><span class="pre">dhclient</span></code>, while DHCPv6 client is handled by WIDE-DHCP6 <code class="docutils literal"><span class="pre">dhcp6c</span></code>. Similarly, for LEDE: DHCP4 client is implemented by <code class="docutils literal"><span class="pre">udhcpc</span></code> (part of BusyBox), while DHCPv6 client is handled by <code class="docutils literal"><span class="pre">odhcpc6c</span></code> (an OpenWrt package). Having the user choose and configure these packages would be more difficult.</p>
<p>Nothing in the configuration of the ERLite-3 or LEDE firewalls would hint at the actual packages involved in getting IPv4 and IPv6 addresses from their ISP.</p>
</div>
<div class="section" id="but-where-s-the-documentation-where-are-the-examples">
<h4>8.5.3.1.3. But where’s the documentation? Where are the examples?<a class="headerlink" href="#but-where-s-the-documentation-where-are-the-examples" title="Permalink to this headline">¶</a></h4>
<p>The weak point in all this is that two referenced firewall’s documentation is not complete nor does it have extensive examples. Contrast that with the Red Hat Linux documentation.</p>
<p>In particularly difficult cases the user must use forums and Internet searching to solve their problem. It can be very frustrating to not know the list of configuration options or their meaning.</p>
</div>
<div class="section" id="what-if-you-re-forced-to-dig-beneath-the-friendly-layer">
<h4>8.5.3.1.4. What if you’re forced to dig beneath the friendly layer?<a class="headerlink" href="#what-if-you-re-forced-to-dig-beneath-the-friendly-layer" title="Permalink to this headline">¶</a></h4>
<p>For example, ERLite-3’s use of <strong class="program">dnsmasq</strong> involves pass-thru commands like this:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">set service dns forwarding options &#39;dhcp-range=set:eth2v6,::,constructor:eth2,ra-stateless,ra-names,12h&#39;
</span></pre></div>
</div>
<p>The quoted text is actually a <strong class="program">dnsmasq</strong> configuration option. So much for hiding the underlying application.</p>
<p>Right now this author is struggling to configure passing an ISP’s prefix delegations to internal subnets. Configuration documentation is lacking, as are examples. Given how long IPv6 has been around, it’s amazing the lack of comprehensive documentation and examples. That forces the author to learn the underlying packages and try to guess how the friendly interface can be manipulated to get the underlying configuration files configured to hand out prefix delegations.</p>
<p>And after the prefix delegation problem gets solved, how do the routing tables get updated to reflect the new prefix delegation? Or does the firewall do that automatically?</p>
</div>
</div>
<div class="section" id="ipv6-standard-inadequacies">
<h3>8.5.3.2. IPv6 standard inadequacies<a class="headerlink" href="#ipv6-standard-inadequacies" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id27">
<h4>8.5.3.2.1. RFC 3633<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h4>
<p>And many of the standards are not complete, forcing vendor-specific software or network admins to fill the void. Consider <a class="reference external" href="https://tools.ietf.org/html/rfc3633#section-14">RFC 3633 14. Relay agent behavior</a>:</p>
<blockquote>
<div>If a delegating router communicates with a requesting router through a relay agent, the delegating router may need a protocol or other out-of-band communication to add routing information for delegated prefixes into the provider edge router.</div></blockquote>
<p>“out-of-band communication to add routing information” means routing changes are not handled by DHCP. That means that as prefix delegations are provided throughout the network, the routing information must be update accordingly.</p>
<p>While IPv6 can use SLAAC to pick up addresses, how does IPv6 prefix distribution get the ISP-allocated address ranges to hosts throughout the network? And how are the routing tables updated?</p>
</div>
<div class="section" id="id28">
<h4>8.5.3.2.2. <a class="reference external" href="https://tools.ietf.org/html/draft-petrescu-relay-route-pd-problem-00">Route Problem at Relay during DHCPv6 Prefix Delegation draft-petrescu-relay-route-pd-problem-00.txt</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://tools.ietf.org/html/draft-petrescu-relay-route-pd-problem-00">Route Problem at Relay during DHCPv6 Prefix Delegation draft-petrescu-relay-route-pd-problem-00.txt</a>:</p>
<blockquote>
<div><p>In practice, some topologies may accommodate easily the deployment of Prefix Delegation, yet other topologies may pose problems with respect to PD.  A topology where the Requesting Router is a neighbor to the Delegating Router, and the Requesting Router’s default route is the Delegating Router, may easily accommodate the Prefix Delegation operation (in this case too, the delegating router needs the operation of route set-up for network reachability).</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>.                         /----------\
                          | Internet |
                          \----------/
                                |
                          +------------+
                          | Delegating |
                          |   Router   |
                          +------------+
                                |
                          +------------+
                          | Requesting |
                          |   Router   |
                          +------------+
                               |            +--------+
                               \------------| Host PC|
                                            +--------+
</pre></div>
</div>
<p>On another hand, a topology where the Requesting Router is not an immediate IP neighbor to the Delegating Router, and/or RR’s default route is not the DR, the operation of allocating a prefix must necessarily involve an operation of route set up.  This topology is illustrated below.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>.                        /----------\
                         | Internet |
                         \----------/
                               |
                               |         +------------+
                              ...--------| Delegating |
                               |         |   Router   |
                               |         +------------+
                               |
                        +------------+
                        | DHCP Relay |
                        +------------+
                               |
                        +------------+
                        | Requesting |
                        |   Router   |
                        +------------+
                               |            +--------+
                               \------------| Host PC|
                                            +--------+
</pre></div>
</div>
</div></blockquote>
<p>Here is the problem from the ISP’s perspective:</p>
<blockquote>
<div><div class="highlight-text"><div class="highlight"><pre><span></span>.             +------+------+  DHCPv6 Server
              |    DHCPv6   |
              |    Server   |
              |             |
              +------+------+
                     |
            _________|_________
           /                   \
          |  ISP Core Network   |
           \___________________/
                     |  Network-facing interface
                     |
              +------+------+
              |   Provider  |
              |     Edge    |  DHCPv6 Relay Agent, DHCPv6 Requestor
              |    Router   |
              +------+------+
                     |  Customer-facing interface
            _________|_________
           /                   \
          |   Access Network    |
           \___________________/
                     |
                     |
              +------+------+
              |   Customer  |  DHCPv6 Client
              |     Edge    |  DHCPv6-PD Requesting Router
              |    Router   |
              +------+------+
                     |
            _________|_________
           /                   \
          |  Customer Network   |
           \___________________/
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="perimeter-firewall-addressing">
<h2>8.5.4. Perimeter firewall addressing<a class="headerlink" href="#perimeter-firewall-addressing" title="Permalink to this headline">¶</a></h2>
<p>We’ll take the example of a perimeter ERLite-3 firewall (connected to the ISP) with a LEDE (OpenWrt) firewall somewhere on an internal network. How do the firewalls get their IPv6 address and participate in allocating the ISP’s /56 prefix distribution?</p>
<div class="section" id="external-interface-address">
<h3>8.5.4.1. External interface address<a class="headerlink" href="#external-interface-address" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dhclient-isc-dhcp-for-dhcpv4-dhcp6c-wide-dhcpv6-for-dhcpv6">
<h4>8.5.4.1.1. <code class="docutils literal"><span class="pre">dhclient</span></code> (ISC DHCP) for DHCPv4, <code class="docutils literal"><span class="pre">dhcp6c</span></code> (WIDE-DHCPv6) for DHCPv6<a class="headerlink" href="#dhclient-isc-dhcp-for-dhcpv4-dhcp6c-wide-dhcpv6-for-dhcpv6" title="Permalink to this headline">¶</a></h4>
<p>The ERLite-3 firewall get’s each of <code class="docutils literal"><span class="pre">eth0</span></code>, <code class="docutils literal"><span class="pre">eth1</span></code>, and <code class="docutils literal"><span class="pre">eth2</span></code>’s IPv6 address from the following configurations.</p>
<p>Here is <code class="docutils literal"><span class="pre">eth0</span></code> configuration:</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">eth0</span></code> configuration for DHCP</span><a class="headerlink" href="#id33" title="Permalink to this code">¶</a></div>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">set interfaces ethernet eth0 address dhcp
</span>set interfaces ethernet eth0 description Internet
set interfaces ethernet eth0 dhcp-options default-route update
set interfaces ethernet eth0 dhcp-options default-route-distance 210
set interfaces ethernet eth0 dhcp-options name-server no-update
set interfaces ethernet eth0 duplex auto
<span class="hll">set interfaces ethernet eth0 ipv6 address autoconf
</span><span class="hll">set interfaces ethernet eth0 ipv6 dup-addr-detect-transmits 1
</span>set interfaces ethernet eth0 mac &#39;00:11:22:33:44:55&#39;
set interfaces ethernet eth0 speed auto
</pre></div>
</div>
</div>
<p><code class="docutils literal"><span class="pre">eth0</span></code> configuration results in:</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal"><span class="pre">ip</span> <span class="pre">addr</span> <span class="pre">show</span> <span class="pre">dev</span> <span class="pre">eth0</span></code></span><a class="headerlink" href="#id34" title="Permalink to this code">¶</a></div>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">ubnt@fw:~$ ip addr show dev eth0
</span>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default
    link/ether 00:11:22:33:44:55 brd ff:ff:ff:ff:ff:ff
<span class="hll">    inet 172.250.252.135/19 brd 255.255.255.255 scope global eth0
</span>       valid_lft forever preferred_lft forever
<span class="hll">    inet6 2605:e000:9fc0:e:2440:b0b2:69eb:ba0b/128 scope global
</span>       valid_lft forever preferred_lft forever
    inet6 fe80::224:54ff:fe57:8e55/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>
</div>
</div>
<p>DHCP IPv4 uses <code class="docutils literal"><span class="pre">dhclient</span></code>, IPv6 uses <code class="docutils literal"><span class="pre">dhcp6c</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">DHCP clients``dhclient`` &amp; <code class="docutils literal"><span class="pre">dhcp6c</span></code></span><a class="headerlink" href="#id35" title="Permalink to this code">¶</a></div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">ubnt@fw:~$</span> ps -ef <span class="p">|</span> grep dh
<span class="hll"><span class="go">root      3886     1  0 Oct16 ?        00:00:00 /usr/sbin/dhcp6c -c /var/run/dhcp6c-eth0-pd.conf -p /var/run/dhcp6c-eth0-pd.pid -df eth0</span>
</span><span class="hll"><span class="go">root      4086     1  0 Oct16 ?        00:00:00 /sbin/dhclient -q -nw -cf /var/run/dhclient_eth0.conf -pf /var/run/dhclient_eth0.pid -lf /var/run/dhclient_eth0.leases eth0</span>
</span></pre></div>
</div>
</div>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">dhclient</span></code></dt>
<dd>IPv4 uses the <a class="reference external" href="https://www.isc.org/downloads/dhcp/">ISC DHCP</a> client configured via <code class="file docutils literal"><span class="pre">/var/run/dhclient_eth0.conf</span></code> (see <a class="reference external" href="https://www.isc.org/wp-content/uploads/2017/08/dhcp41clientconf.html">dhclient.conf</a>):</dd>
</dl>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">/var/run/dhclient_eth0.conf</span><a class="headerlink" href="#id36" title="Permalink to this code">¶</a></div>
<div class="highlight-text"><div class="highlight"><pre><span></span>#
# autogenerated by vyatta-interfaces.pl on Mon Oct 16 20:27:29 UTC 2017
#
option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;

interface &quot;eth0&quot; {
<span class="hll">        send host-name &quot;fw&quot;;
</span><span class="hll">        request subnet-mask, broadcast-address, routers, domain-name-servers, interface-mtu;
</span>}
</pre></div>
</div>
</div>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">dhcp6c</span></code></dt>
<dd>IPv6 uses the <a class="reference external" href="https://github.com/jinmei/wide-dhcpv6">WIDE-DHCPv6</a> client configured via <code class="file docutils literal"><span class="pre">/var/run/dhcp6c-eth0-pd.conf</span></code> (see <a class="reference external" href="https://github.com/jinmei/wide-dhcpv6/blob/master/dhcp6c.conf.sample">jinmei/wide-dhcpv6</a>):</dd>
</dl>
<div class="literal-block-wrapper docutils container" id="dhcp6c-conf">
<div class="code-block-caption"><span class="caption-text">/var/run/dhcp6c-eth0-pd.conf</span><a class="headerlink" href="#dhcp6c-conf" title="Permalink to this code">¶</a></div>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">interface eth0 {
</span><span class="hll">        send ia-na 0;
</span>        request domain-name-servers, domain-name;
        send rapid-commit;
<span class="hll">        send ia-pd 0;
</span><span class="hll">        script &quot;/opt/vyatta/sbin/ubnt-dhcp6c-script&quot;;
</span>};

<span class="hll">id-assoc na 0 {};
</span>
<span class="hll">id-assoc pd 0 {
</span><span class="hll">        prefix ::/56 infinity;
</span><span class="hll">        prefix-interface eth1 {
</span>                sla-id 0;
                sla-len 8;
                ifid 1;
        };
<span class="hll">        prefix-interface eth2 {
</span>                sla-id 1;
                sla-len 8;
                ifid 1;
        };
<span class="hll">        prefix-interface eth2.3 {
</span>                sla-id 2;
                sla-len 8;
                ifid 1;
        };
};
</pre></div>
</div>
</div>
</div>
<div class="section" id="dhcpv6c-hook-dhcpv6-pd-response-pl">
<h4>8.5.4.1.2. <code class="docutils literal"><span class="pre">dhcpv6c</span></code> hook <code class="docutils literal"><span class="pre">dhcpv6-pd-response.pl</span></code><a class="headerlink" href="#dhcpv6c-hook-dhcpv6-pd-response-pl" title="Permalink to this headline">¶</a></h4>
<p>There’s a lot going on in the <a class="reference internal" href="#dhcp6c-conf"><span class="std std-ref">/var/run/dhcp6c-eth0-pd.conf</span></a> file. The wan interface uses DHCPv6 (not SLAAC) and requests both an IA_NA (Identity Association for Non-temporary Address (IA_NA)) and IA_PD (“Identity Association for Prefix Delegation (IA_PD)). First <strong>id-na</strong> is .</p>
<p>The IA_NA is the wan IPv6 address and the configuration is as follows:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll"># Request a stateful DHCPv6 address along with DNS server list and domain name
</span>{ send ia-na 0;  request domain-name-servers, domain-name; }
id-assoc na 0 {};
</pre></div>
</div>
<p>Request a /56 prefix delegation.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">{ send ia-pd 0; }
</span>id-assoc pd 0 { prefix ::/56 infinity; ... }
</pre></div>
</div>
<p>And finally a hook <strong class="program">/opt/vyatta/sbin/ubnt-dhcp6c-script</strong> that calls <strong class="program">/opt/vyatta/sbin/dhcpv6-pd-response.pl</strong> which processes the information received from WIDE-DHCPv6:</p>
<ul>
<li><p class="first">Internal DNS</p>
<p>Create <code class="file docutils literal"><span class="pre">/etc/pd-resolv-INTERFACE.conf</span></code> and possibly update <code class="file docutils literal"><span class="pre">/etc/resolv.conf</span></code>.</p>
</li>
<li><p class="first">Internal DHCPv6</p>
<p>Create/update <code class="file docutils literal"><span class="pre">/var/run/dhcpv6-INTERFACE-pd.conf</span></code> files for each interface. For DHCPv6, <strong class="program">start_dhcpv6_daemon</strong> (in Perl module <strong class="program">/opt/vyatta/share/perl5/Vyatta/DhcpPd.pm</strong>) tries to run <code class="docutils literal"><span class="pre">/usr/sbin/dhcpd3</span></code> (vyos-modified  <a class="reference external" href="https://github.com/vyos/vyatta-dhcp3">vyos/vyatta-dhcp3</a>) as a daemon, which will fail when running <code class="docutils literal"><span class="pre">dnsmasq</span></code> for DHCPv6.</p>
</li>
<li><p class="first">Internal Router Advertisements</p>
<p>Create the <code class="file docutils literal"><span class="pre">/var/un/pd-radvd-INTERFACE.conf</span></code> file to update <code class="file docutils literal"><span class="pre">/etc/radvd.conf</span></code> and possibly restart <code class="docutils literal"><span class="pre">radvd</span></code>.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="prefix-delegation-and-addressing-non-wan-interfaces">
<h3>8.5.4.2. Prefix delegation and addressing non-wan interfaces<a class="headerlink" href="#prefix-delegation-and-addressing-non-wan-interfaces" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id31">
<h4>8.5.4.2.1. Prefix delegation<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h4>
<p>The prior section ended with the WIDE-DHCP6 (<code class="docutils literal"><span class="pre">dhcp6c</span></code>) configuration file <a class="reference internal" href="#dhcp6c-conf"><span class="std std-ref">/var/run/dhcp6c-eth0-pd.conf</span></a> implementing some of the following ERLite-3 configuration lines:</p>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-text">ERLite-3 prefix delegation configuration</span><a class="headerlink" href="#id37" title="Permalink to this code">¶</a></div>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth1 host-address <span class="s1">&#39;::1&#39;</span>
<span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth1 prefix-id <span class="s1">&#39;:0&#39;</span>
</span><span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth1 service dhcpv6-stateless
</span><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth2 host-address <span class="s1">&#39;::1&#39;</span>
<span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth2 prefix-id <span class="s1">&#39;:1&#39;</span>
</span><span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth2 service dhcpv6-stateless
</span><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth2.3 host-address <span class="s1">&#39;::1&#39;</span>
<span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth2.3 prefix-id <span class="s1">&#39;:2&#39;</span>
</span><span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> interface eth2.3 service dhcpv6-stateless
</span><span class="hll"><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd pd <span class="m">0</span> prefix-length <span class="m">56</span>
</span><span class="nb">set</span> interfaces ethernet eth0 dhcpv6-pd rapid-commit <span class="nb">enable</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal"><span class="pre">dhcp6c</span></code> requests the prefix delegations but does not do the IP address assignments: neither the <code class="docutils literal"><span class="pre">host-address</span> <span class="pre">'::1'</span></code> above nor the handing out of the IPv6 addresses from the prefixes. Again, the hook <strong class="program">ubnt-dhcp6c-script</strong> funnels the WIDE-DHCP6 data to scripts that set up dhcpv6_stateless and dhcpv6_stateful configuration.</p>
</div>
<div class="section" id="radvd">
<h4>8.5.4.2.2. <code class="docutils literal"><span class="pre">radvd</span></code><a class="headerlink" href="#radvd" title="Permalink to this headline">¶</a></h4>
<p>Here is the resulting <strong class="program">radvd</strong> configuration file:</p>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-text"><code class="file docutils literal"><span class="pre">/etc/radvd.conf</span></code></span><a class="headerlink" href="#id38" title="Permalink to this code">¶</a></div>
<div class="highlight-text"><div class="highlight"><pre><span></span><span class="hll">interface eth1 {
</span>#   This section was automatically generated by the Vyatta
#   configuration sub-system.  Do not edit it.
#
<span class="hll">#   service type [dhcpv6-stateless]
</span>#
    IgnoreIfMissing on;
<span class="hll">    AdvSendAdvert on;
</span><span class="hll">    AdvManagedFlag off;
</span><span class="hll">    AdvOtherConfigFlag on;
</span>    prefix ::/64 {
<span class="hll">          AdvOnLink on;
</span><span class="hll">          AdvAutonomous on;
</span>    };
};
<span class="hll">interface eth2.3 {
</span>#   This section was automatically generated by the Vyatta
#   configuration sub-system.  Do not edit it.
#
<span class="hll">#   service type [dhcpv6-stateless]
</span>#
    IgnoreIfMissing on;
<span class="hll">    AdvSendAdvert on;
</span><span class="hll">    AdvManagedFlag off;
</span><span class="hll">    AdvOtherConfigFlag on;
</span>    prefix ::/64 {
<span class="hll">          AdvOnLink on;
</span><span class="hll">          AdvAutonomous on;
</span>    };
};
<span class="hll">interface eth2 {
</span>#   This section was automatically generated by the Vyatta
#   configuration sub-system.  Do not edit it.
#
<span class="hll">#   service type [dhcpv6-stateless]
</span>#
    IgnoreIfMissing on;
<span class="hll">    AdvSendAdvert on;
</span><span class="hll">    AdvManagedFlag off;
</span><span class="hll">    AdvOtherConfigFlag on;
</span>    prefix ::/64 {
<span class="hll">          AdvOnLink on;
</span><span class="hll">          AdvAutonomous on;
</span>    };
};
</pre></div>
</div>
</div>
<p>For more information on <strong class="program">radvd</strong>, see <a class="reference external" href="http://www.litech.org/radvd/">Linux IPv6 Router Advertisement Daemon (radvd)</a> and <a class="reference external" href="https://github.com/reubenhwk/radvd">reubenhwk/radvd</a>.</p>
</div>
</div>
</div>
<div class="section" id="internal-firewall-addressing">
<h2>8.5.5. Internal firewall addressing<a class="headerlink" href="#internal-firewall-addressing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id32">
<h3>8.5.5.1. External interface address<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p>The LEDE 17.01.4 firewall configures the <code class="docutils literal"><span class="pre">eth1</span></code> (wan) and <code class="docutils literal"><span class="pre">eth0</span></code> (lan) interface addresses like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="hll"><span class="gp">root@LEDE:/#</span> uci show network
</span><span class="go">network.loopback=interface</span>
<span class="go">network.loopback.ifname=&#39;lo&#39;</span>
<span class="go">network.loopback.proto=&#39;static&#39;</span>
<span class="go">network.loopback.ipaddr=&#39;127.0.0.1&#39;</span>
<span class="go">network.loopback.netmask=&#39;255.0.0.0&#39;</span>
<span class="go">network.globals=globals</span>
<span class="go">network.globals.ula_prefix=&#39;fd29:4dc4:ebc1::/48&#39;</span>
<span class="go">network.lan=interface</span>
<span class="go">network.lan.ifname=&#39;eth0&#39;</span>
<span class="go">network.lan.proto=&#39;static&#39;</span>
<span class="go">network.lan.netmask=&#39;255.255.255.0&#39;</span>
<span class="go">network.lan.ip6assign=&#39;60&#39;</span>
<span class="go">network.lan.ipaddr=&#39;192.168.200.1&#39;</span>
<span class="go">network.wan=interface</span>
<span class="hll"><span class="go">network.wan.ifname=&#39;eth1&#39;</span>
</span><span class="hll"><span class="go">network.wan.proto=&#39;dhcp&#39;</span>
</span><span class="hll"><span class="go">network.wan6=interface</span>
</span><span class="hll"><span class="go">network.wan6.ifname=&#39;eth1&#39;</span>
</span><span class="hll"><span class="go">network.wan6.proto=&#39;dhcpv6&#39;</span>
</span></pre></div>
</div>
<p>The key wan(6) configuration lines are:</p>
<dl class="docutils">
<dt>network.wan.proto=’dhcp’</dt>
<dd><code class="docutils literal"><span class="pre">udhcpc</span></code> assigns address and netmask by DHCP</dd>
<dt>network.wan6.proto=’dhcpv6’</dt>
<dd><code class="docutils literal"><span class="pre">odhcpc6c</span></code> obtains address and netmask by DHCP6</dd>
</dl>
<p>Here are the addressing related processes:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="hll"><span class="gp">root@LEDE:/#</span> ps -w
</span><span class="hll"><span class="go">  858 root      1028 S    udhcpc -p /var/run/udhcpc-eth1.pid -s /lib/netifd/dhcp.script -f -t 0 -i eth1 -C -O 121</span>
</span><span class="hll"><span class="go">  860 root       796 S    odhcp6c -s /lib/netifd/dhcpv6.script -P0 -t120 eth1</span>
</span><span class="hll"><span class="go"> 3581 dnsmasq    864 S    /usr/sbin/dnsmasq -C /var/etc/dnsmasq.conf.cfg02411c -k -x /var/run/dnsmasq/dnsmasq.cfg02411c.pid</span>
</span></pre></div>
</div>
<p><code class="docutils literal"><span class="pre">udhcpc</span></code> is the wan IPv4 DHCP client. It’s actually BusyBox. See <a class="reference external" href="https://en.wikipedia.org/wiki/Udhcpc">udhcpc</a>.</p>
<p><code class="docutils literal"><span class="pre">odhcp6c</span></code> is the wan IPv6 DHCPv6 client. It’s actually an embedded system DHCPv6 client. See <a class="reference external" href="https://github.com/openwrt/odhcp6c">openwrt/odhcp6c</a>.</p>
<p><code class="docutils literal"><span class="pre">dnsmasq</span></code> is the lan DHCP server.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ipv6.html" class="btn btn-neutral float-right" title="8.6. IPv6" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="exiftool.html" class="btn btn-neutral" title="8.4. exiftool" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>