

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.14. Virtualization &amp; networking &mdash; South Bay WASP 1.0.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="South Bay WASP 1.0.2 documentation" href="../index.html"/>
        <link rel="up" title="8. Pentest Study" href="../pentest_study.html"/>
        <link rel="next" title="8.15. Vulnerabilites" href="vulnerabilities.html"/>
        <link rel="prev" title="8.13. PHP &amp; MySQL Shortcomings" href="php.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2factor.html">8.1. 2 Factor Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="email_security.html">8.2. Email Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="exfiltration.html">8.3. Exfiltration</a></li>
<li class="toctree-l2"><a class="reference internal" href="exiftool.html">8.4. <strong class="program">exiftool</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="fw.html">8.5. Firewalls</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">8.6. IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="loadlibrary.html">8.7. loadlibrary</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux_exploitation_tricks.html">8.8. Linux Exploitation Tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="llmnr.html">8.9. Windows broadcast name resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="nftables.html">8.10. nftables</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntlm.html">8.11. NTLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="passwords.html">8.12. Password Cracking Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="php.html">8.13. PHP &amp; MySQL Shortcomings</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.14. Virtualization &amp; networking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#virtualization">8.14.1. Virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-we-re-ignoring">8.14.1.1. What we’re ignoring</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hypervisors">8.14.1.2. Hypervisors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-role-of-hypervisors">8.14.1.3. The role of hypervisors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kali-linux-and-kvm-virtualization">8.14.2. Kali linux and KVM virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#virt-manager-libvirt-and-qemu-kvm">8.14.2.1. virt-manager, libvirt, and qemu-kvm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#networking-to-support-virtualization">8.14.3. Networking to support virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#virt-manager-networking">8.14.3.1. <strong class="program">virt-manager</strong> networking</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virsh-on-virt-manager-vms">8.14.3.2. <code class="docutils literal"><span class="pre">virsh</span></code> on <strong class="program">virt-manager</strong> VMs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#linux-networking-commands">8.14.4. Linux networking commands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#why-bother-with-command-line-networking">8.14.4.1. Why bother with command line networking?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avoid-deprecated-packages">8.14.4.2. Avoid deprecated packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iproute2-command-line-networking">8.14.4.3. <strong class="program">iproute2</strong> command line networking</a></li>
<li class="toctree-l4"><a class="reference internal" href="#network-manager-networking">8.14.4.4. <strong class="program">network-manager</strong> networking</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mods-to-networking-imply-mods-to-iptables-or-nftables">8.14.4.5. Mods to networking imply mods to <strong class="program">iptables</strong> or <strong class="program">nftables</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vulnerabilities.html">8.15. Vulnerabilites</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">8.16. WiFi Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_study.html">8. Pentest Study</a> &raquo;</li>
        
      <li>8.14. Virtualization &amp; networking</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/study/virtualization_networking.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="virtualization-networking">
<span id="virt-net"></span><h1>8.14. Virtualization &amp; networking<a class="headerlink" href="#virtualization-networking" title="Permalink to this headline">¶</a></h1>
<div class="section" id="virtualization">
<h2>8.14.1. Virtualization<a class="headerlink" href="#virtualization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-we-re-ignoring">
<h3>8.14.1.1. What we’re ignoring<a class="headerlink" href="#what-we-re-ignoring" title="Permalink to this headline">¶</a></h3>
<p>We’ll discuss containers and networking later. For now we’re ignoring containers, also known as <a class="reference external" href="https://en.wikipedia.org/wiki/Operating-system-level_virtualization">Operating-system-level virtualization</a>, including <a class="reference external" href="https://en.wikipedia.org/wiki/Docker_(software)">Docker</a> and Linux Containers (<a class="reference external" href="https://en.wikipedia.org/wiki/LXC">Wikipedia LXC</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/Container_Linux_by_CoreOS">Container Linux by CoreOS</a>).</p>
<p>See <a class="reference external" href="https://en.wikipedia.org/wiki/Comparison_of_platform_virtualization_software">Comparison of platform virtualization software</a> for a more complete list of virtualization software.</p>
</div>
<div class="section" id="hypervisors">
<h3>8.14.1.2. Hypervisors<a class="headerlink" href="#hypervisors" title="Permalink to this headline">¶</a></h3>
<div class="section" id="type-1-vs-type-2-hypervisors">
<h4>8.14.1.2.1. Type-1 vs type-2 hypervisors<a class="headerlink" href="#type-1-vs-type-2-hypervisors" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://en.wikipedia.org/wiki/Hypervisor">Hypervisor</a>:</p>
<blockquote>
<div><dl class="docutils">
<dt>Type-1, native or bare-metal hypervisors</dt>
<dd>These hypervisors run directly on the host’s hardware to control the hardware and to manage guest operating systems. For this reason, they are sometimes called bare metal hypervisors. … Modern equivalents include <a class="reference external" href="https://en.wikipedia.org/wiki/Xen">Xen</a>, Oracle VM Server for SPARC, Oracle VM Server for x86, Microsoft <a class="reference external" href="https://en.wikipedia.org/wiki/Hyper-V">Hyper-V</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/VMware_ESXi">VMware ESX/ESXi</a>.</dd>
<dt>Type-2 or hosted hypervisors</dt>
<dd>These hypervisors run on a conventional operating system (OS) just as other computer programs do. A guest operating system runs as a process on the host. Type-2 hypervisors abstract guest operating systems from the host operating system. VMware Workstation, VMware Player, VirtualBox, Parallels Desktop for Mac and QEMU are examples of type-2 hypervisors.</dd>
</dl>
<p>The distinction between these two types is not necessarily clear. Linux’s Kernel-based Virtual Machine (KVM) and FreeBSD’s bhyve are kernel modules that effectively convert the host operating system to a type-1 hypervisor. At the same time, since Linux distributions and FreeBSD are still general-purpose operating systems, with other applications competing for VM resources, KVM and bhyve can also be categorized as type-2 hypervisors.</p>
</div></blockquote>
</div>
<div class="section" id="full-virtualization-vs-paravirtualization">
<h4>8.14.1.2.2. Full virtualization vs paravirtualization<a class="headerlink" href="#full-virtualization-vs-paravirtualization" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://en.wikipedia.org/wiki/Full_virtualization">Full virtualization</a>:</p>
<blockquote>
<div>Full virtualization requires that every salient feature of the hardware be reflected into one of several virtual machines – including the full instruction set, input/output operations, interrupts, memory access, and whatever other elements are used by the software that runs on the bare machine, and that is intended to run in a virtual machine. In such an environment, any software capable of execution on the raw hardware can be run in the virtual machine and, in particular, any operating systems. The obvious test of full virtualization is whether an operating system intended for stand-alone use can successfully run inside a virtual machine.</div></blockquote>
<p>In contrast, <a class="reference external" href="https://en.wikipedia.org/wiki/Paravirtualization">Paravirtualization</a>:</p>
<blockquote>
<div><p>paravirtualization is a virtualization technique that presents to virtual machines a software interface, which is similar yet not identical to the underlying hardware-software interface. …</p>
<p>Paravirtualization requires the guest operating system to be explicitly ported for the para-API — a conventional OS distribution that is not paravirtualization-aware cannot be run on top of a paravirtualizing VMM.</p>
<p>A hypervisor provides the virtualization of the underlying computer system. In full virtualization, a guest operating system runs unmodified on a hypervisor. However, improved performance and efficiency is achieved by having the guest operating system communicate with the hypervisor. By allowing the guest operating system to indicate its intent to the hypervisor, each can cooperate to obtain better performance when running in a virtual machine. This type of communication is referred to as paravirtualization.</p>
</div></blockquote>
<p>From <a class="reference external" href="https://en.wikipedia.org/wiki/Hypervisor">Hypervisor</a>:</p>
<blockquote>
<div><p>Starting in 2005, CPU vendors have added hardware virtualization assistance to their products, for example: Intel VT-x (codenamed Vanderpool) and AMD-V (codenamed Pacifica).</p>
<p>An alternative approach requires modifying the guest operating-system to make system calls to the hypervisor, rather than executing machine I/O instructions that the hypervisor simulates. This is called paravirtualization … .</p>
</div></blockquote>
</div>
</div>
<div class="section" id="the-role-of-hypervisors">
<h3>8.14.1.3. The role of hypervisors<a class="headerlink" href="#the-role-of-hypervisors" title="Permalink to this headline">¶</a></h3>
<div class="section" id="xen-kvm-and-hyper-v-run-the-big-3-public-clouds">
<h4>8.14.1.3.1. Xen, KVM, and Hyper-V run the big 3 public clouds<a class="headerlink" href="#xen-kvm-and-hyper-v-run-the-big-3-public-clouds" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Amazon_Elastic_Compute_Cloud">Amazon Elastic Compute Cloud</a> “uses Xen virtualization”, <a class="reference external" href="https://en.wikipedia.org/wiki/Google_Compute_Engine">Google Compute Engine</a> “uses KVM as the hypervisor”, and <a class="reference external" href="https://en.wikipedia.org/wiki/Microsoft_Azure">Microsoft Azure</a> runs “a customized version of Hyper-V, known as the Microsoft Azure Hypervisor”.</p>
</div>
<div class="section" id="but-containers-are-growing-in-importance">
<h4>8.14.1.3.2. But containers are growing in importance<a class="headerlink" href="#but-containers-are-growing-in-importance" title="Permalink to this headline">¶</a></h4>
<p>Given the rise of cloud computing, that puts Xen, KVM, and Hyper-V in the virtualization lead.</p>
<p>But from Google’s <a class="reference external" href="https://speakerdeck.com/jbeda/containers-at-scale">Containers At Scale</a> presentation (circa May 22, 2014), slide 2 says “<strong>Everything</strong> at Google runs in a container. … We start over 2 billion containers per week.”</p>
<p>In fact <a class="reference external" href="https://techcrunch.com/2017/08/09/aws-just-proved-why-standards-drive-technology-platforms/">AWS just proved why standards drive technology platforms</a> (circa Aug 9, 2017) reports “AWS was smart enough to recognize that Kubernetes is becoming an industry standard in itself, and that when it comes to build versus buy versus going open source, AWS wisely recognized that battle has been fought and won.” Containers are big and <a class="reference external" href="https://kubernetes.io/">Kubernetes</a> (“an open-source system for automating deployment, scaling, and management of containerized applications”) is the standard based for managing containers.</p>
<p>The point here is that hypervisors are a necessary base for running the cloud, but are a fungible, small player in running the cloud.</p>
</div>
</div>
</div>
<div class="section" id="kali-linux-and-kvm-virtualization">
<h2>8.14.2. Kali linux and KVM virtualization<a class="headerlink" href="#kali-linux-and-kvm-virtualization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="virt-manager-libvirt-and-qemu-kvm">
<h3>8.14.2.1. virt-manager, libvirt, and qemu-kvm<a class="headerlink" href="#virt-manager-libvirt-and-qemu-kvm" title="Permalink to this headline">¶</a></h3>
<p>For a good introduction see redhat’s <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_getting_started_guide/index">Virtualization Getting Started Guide</a> and the other <a class="reference external" href="https://access.redhat.com/documentation/en/red-hat-enterprise-linux/?category=virtualization&amp;version=7">Product Documentation for Red Hat Enterprise Linux - Virtualization</a> docs. Especially <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_tuning_and_optimization_guide/index">Virtualization Tuning and Optimization Guide</a>.</p>
<p>Windows VMs should take advantage of <a class="reference external" href="https://fedoraproject.org/wiki/Windows_Virtio_Drivers">fedora Windows Virtio Drivers</a>.</p>
<p>Also see <a class="reference external" href="https://libvirt.org/docs.html">libvirt docs</a>.</p>
<div class="section" id="virt-manager">
<h4>8.14.2.1.1. virt-manager<a class="headerlink" href="#virt-manager" title="Permalink to this headline">¶</a></h4>
<p>The most user-friendly (GUI) way to use <strong class="program">libvirt</strong> is the Python application <a class="reference external" href="https://github.com/virt-manager/virt-manager">virt-manager/virt-manager</a>. See <a class="reference external" href="https://virt-manager.org/screenshots/">VMM Screenshots</a>.</p>
<p>From <a class="reference external" href="https://virt-manager.org/">Virtual Machine Manager</a> (VMM):</p>
<blockquote>
<div><p>The <strong>virt-manager</strong> application is a desktop user interface for managing virtual machines through libvirt. It primarily targets <strong>KVM</strong> VMs, but also manages <strong>Xen</strong> and <strong>LXC</strong> (linux containers). It presents a summary view of running domains, their live performance &amp; resource utilization statistics. Wizards enable the creation of new domains, and configuration &amp; adjustment of a domain’s resource allocation &amp; virtual hardware. An embedded VNC and SPICE client viewer presents a full graphical console to the guest domain.</p>
<p><strong>About virt-manager’s supporting tools</strong></p>
<p><strong>virt-install</strong> is a command line tool which provides an easy way to provision operating systems into virtual machines.</p>
<p><strong>virt-viewer</strong> is a lightweight UI interface for interacting with the graphical display of virtualized guest OS. It can display VNC or SPICE, and uses libvirt to lookup the graphical connection details.</p>
<p><strong>virt-clone</strong> is a command line tool for cloning existing inactive guests. It copies the disk images, and defines a config with new name, UUID and MAC address pointing to the copied disks.</p>
<p><strong>virt-xml</strong> is a command line tool for easily editing libvirt domain XML using virt-install’s command line options.</p>
<p><strong>virt-convert</strong> is a command line tool for converting OVF and VMX VM configurations to run with libvirt.</p>
</div></blockquote>
<p><strong class="program">virt-manager</strong> can be installed via <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">virt-manager</span> <span class="pre">-y</span></code> and requires <strong class="program">iptables</strong> and <strong class="program">ebtables</strong>. Also useful for VMs using spice: <strong class="program">spice-vdagent</strong> (Spice agent for Linux) and <strong class="program">xserver-xorg-video-qxl</strong> (qxl video driver).</p>
<p><strong class="program">virt-manager</strong> configuration files are stored in <code class="file docutils literal"><span class="pre">/etc/libvirt/</span></code>:</p>
<dl class="docutils">
<dt><code class="file docutils literal"><span class="pre">/etc/libvirt/nwfilter/</span></code></dt>
<dd>XML files containing <strong class="program">ipfilter</strong> rules to allow virtualization network traffic.</dd>
<dt><code class="file docutils literal"><span class="pre">/etc/libvirt/qemu/</span></code></dt>
<dd>XML files defining each VM.</dd>
<dt><code class="file docutils literal"><span class="pre">/etc/libvirt/qemu/networks</span></code></dt>
<dd>XML files defining the added networks.</dd>
<dt><code class="file docutils literal"><span class="pre">/etc/libvirt/qemu/networks/autostart/</span></code></dt>
<dd>Links to <code class="file docutils literal"><span class="pre">/etc/libvirt/qemu/networks</span></code> networks to be started on boot.</dd>
</dl>
<p>These files allow the command line <code class="docutils literal"><span class="pre">virsh</span></code> (from package <strong class="program">libvirt-clients</strong>) to automate manipulation of <strong class="program">virt-manager</strong> VMs and networks.</p>
</div>
<div class="section" id="libvirt-and-virsh">
<h4>8.14.2.1.2. <strong class="program">libvirt</strong> and <code class="docutils literal"><span class="pre">virsh</span></code><a class="headerlink" href="#libvirt-and-virsh" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://github.com/libvirt/libvirt">libvirt/libvirt</a>:</p>
<blockquote>
<div>Libvirt provides a portable, long term stable C API for managing the virtualization technologies provided by many operating systems. It includes support for QEMU, KVM, Xen, LXC, bhyve, Virtuozzo, VMware vCenter and ESX, VMware Desktop, Hyper-V, VirtualBox and the POWER Hypervisor.</div></blockquote>
<p><strong class="program">libvirt</strong> provides the command line tool <strong class="program">virsh</strong> that does much of what <strong class="program">virt-manager</strong> does. Much of the difficult input is provided in XML files, for example the <a class="reference external" href="http://libvirt.org/formatnetwork.html">libvirt Network XML format</a>.</p>
<p>See the <a class="reference external" href="https://libvirt.org/docs.html">libvirt Docs</a> for more information.</p>
</div>
<div class="section" id="qemu">
<h4>8.14.2.1.3. <strong class="program">QEMU</strong><a class="headerlink" href="#qemu" title="Permalink to this headline">¶</a></h4>
<p>Start with <a class="reference external" href="https://wiki.qemu.org/Documentation">QEMU Documentation</a>.</p>
<div class="section" id="program-vs-system-emulation-with-kvm-xen-speedup">
<h5>8.14.2.1.3.1. Program vs system emulation (with KVM/Xen speedup)<a class="headerlink" href="#program-vs-system-emulation-with-kvm-xen-speedup" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/QEMU#Operating_modes">Wikipedia QEMU - Operating modes</a> describes <strong class="program">QEMU</strong>’s 4 optating modes:</p>
<blockquote>
<div><dl class="docutils">
<dt>User-mode emulation</dt>
<dd>In this mode QEMU runs single Linux or Darwin/macOS programs that were compiled for a different instruction set. System calls are thunked for endianness and for 32/64 bit mismatches. Fast cross-compilation and cross-debugging are the main targets for user-mode emulation.</dd>
<dt>System emulation</dt>
<dd>In this mode QEMU emulates a full computer system, including peripherals. It can be used to provide virtual hosting of several virtual computers on a single computer. QEMU can boot many guest operating systems, including Linux, Solaris, Microsoft Windows, DOS, and BSD;[4] it supports emulating several instruction sets, including x86, MIPS, 32-bit ARMv7, ARMv8, PowerPC, SPARC, ETRAX CRIS and MicroBlaze.</dd>
<dt>KVM Hosting</dt>
<dd>Here QEMU deals with the setting up and migration of KVM images. It is still involved in the emulation of hardware, but the execution of the guest is done by KVM as requested by QEMU.</dd>
<dt>Xen Hosting</dt>
<dd>QEMU is involved only in the emulation of hardware; the execution of the guest is done within Xen and is totally hidden from QEMU.</dd>
</dl>
</div></blockquote>
<p>From <a class="reference external" href="https://wiki.qemu.org/Main_Page">QEMU</a>:</p>
<blockquote>
<div>When used as a virtualizer, QEMU achieves near native performance by executing the guest code directly on the host CPU. QEMU supports virtualization when executing under the Xen hypervisor or using the KVM kernel module in Linux. When using KVM, QEMU can virtualize x86, server and embedded PowerPC, 64-bit POWER, S390, 32-bit and 64-bit ARM, and MIPS guests.</div></blockquote>
</div>
<div class="section" id="qemu-networking">
<h5>8.14.2.1.3.2. <strong class="program">QEMU</strong> networking<a class="headerlink" href="#qemu-networking" title="Permalink to this headline">¶</a></h5>
<p>Networking consists of (1) a guest VM’s virtual network device, plus (2) backend packet transmission to host’s network.</p>
<p><strong class="program">QEMU</strong> defaults to (1) an OS-appropriate network device and (2) slow (non-root user) <a class="reference external" href="https://en.wikipedia.org/wiki/Slirp">SLiRP</a> backend emulating a NAT’ed network.</p>
<p>More performant options below include bridging the host network allowing the <strong class="program">QEMU</strong> device direct access to the local network (and DHCP, IPCMv6, NAT, …) or creating a bridge to isolate the VMs (possibly behind NAT). These involve creating bridges and TAP (see <a class="reference external" href="https://en.wikipedia.org/wiki/TUN/TAP">TUN/TAP</a>) interfaces.</p>
</div>
</div>
</div>
</div>
<div class="section" id="networking-to-support-virtualization">
<h2>8.14.3. Networking to support virtualization<a class="headerlink" href="#networking-to-support-virtualization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="virt-manager-networking">
<h3>8.14.3.1. <strong class="program">virt-manager</strong> networking<a class="headerlink" href="#virt-manager-networking" title="Permalink to this headline">¶</a></h3>
<p>Here is the resulting network diagram for the example below:</p>
<img src="../_images/graphviz-aa3402218021966048d91ee7bb19917ac39390e5.png" alt="digraph H {

  firewall [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;2&quot;&gt;site firewall&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;eth0 external IP&lt;/td&gt;&lt;td port='port_2'&gt;eth1 192.168.1.1/24&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  bridge [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;5&quot;&gt;site bridge&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;eth0&lt;/td&gt;&lt;td port='port_2'&gt;eth1&lt;/td&gt;&lt;td port='port_3'&gt;eth2&lt;/td&gt;&lt;td port='port_4'&gt;eth3&lt;/td&gt;&lt;td port='port_5'&gt;eth4&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  br0 [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;br0 192.168.1.29/24&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;enp5s0&lt;/td&gt;&lt;td port='port_2'&gt;vnet0&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  host [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;host&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;lo&lt;/td&gt;&lt;td port='port_2'&gt;enp5s0&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  pfsense [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;pfsense&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;re0 192.168.1.114/24&lt;/td&gt;&lt;td port='port_2'&gt;re1 192.168.100.1/24&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  virbr1 [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;virbr1&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;vnet1&lt;/td&gt;&lt;td port='port_2'&gt;vnet2&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  taxing [
   shape=plaintext
   label=&lt;
     &lt;table border='1' cellborder='1'&gt;
       &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;testing&lt;/td&gt;&lt;/tr&gt;
       &lt;tr&gt;&lt;td port='port_1'&gt;Local Area Connection 4&lt;/td&gt;&lt;/tr&gt;
     &lt;/table&gt;
  &gt;];

  firewall:port_2   -&gt; bridge:port_1;
  bridge:port_2   -&gt; host:port_2;
  br0:port_1   -&gt; host:port_2;
  br0:port_2   -&gt; pfsense:port_1;
  pfsense:port_2   -&gt; virbr1:port_1;
  virbr1:port_2 -&gt; taxing:port_1;

}" />
<div class="section" id="virt-manager-configuration">
<h4>8.14.3.1.1. <strong class="program">virt-manager</strong> configuration<a class="headerlink" href="#virt-manager-configuration" title="Permalink to this headline">¶</a></h4>
<p>Here is the <strong class="program">virt-manager</strong> networking configuration:</p>
<div class="figure" id="id4">
<img alt="../_images/01-VMM.png" src="../_images/01-VMM.png" />
<p class="caption"><span class="caption-text">VMM showing 2 VMs: pfsense (firewall) &amp; taxing (Windows host)</span></p>
</div>
<div class="figure" id="id5">
<img alt="../_images/02-VMM-NetworkInterfaces.png" src="../_images/02-VMM-NetworkInterfaces.png" />
<p class="caption"><span class="caption-text">VMM showing host interfaces: lo, <code class="docutils literal"><span class="pre">br0</span></code> with slave <code class="docutils literal"><span class="pre">enp5s0</span></code></span></p>
</div>
<div class="figure" id="id6">
<img alt="../_images/03-VMM-VirtualNetworks-default.png" src="../_images/03-VMM-VirtualNetworks-default.png" />
<p class="caption"><span class="caption-text">VMM showing virt-manager default network <code class="docutils literal"><span class="pre">virbr0</span></code> (not active on boot)</span></p>
</div>
<div class="figure" id="id7">
<img alt="../_images/04-VMM-VirtualNetworks-pfsense.png" src="../_images/04-VMM-VirtualNetworks-pfsense.png" />
<p class="caption"><span class="caption-text">VMM showing pfsense network with <code class="docutils literal"><span class="pre">virbr1</span></code> (active on boot)</span></p>
</div>
<div class="figure" id="id8">
<img alt="../_images/05-VMM-pfsense-external-nic.png" src="../_images/05-VMM-pfsense-external-nic.png" />
<p class="caption"><span class="caption-text">VMM showing pfsense VMs external NIC</span></p>
</div>
<div class="figure" id="id9">
<img alt="../_images/06-VMM-pfsense-internal-nic.png" src="../_images/06-VMM-pfsense-internal-nic.png" />
<p class="caption"><span class="caption-text">VMM showing pfsense VMs internal NIC</span></p>
</div>
<div class="figure" id="id10">
<img alt="../_images/07-VMM-taxing-nic.png" src="../_images/07-VMM-taxing-nic.png" />
<p class="caption"><span class="caption-text">VMM showing taxing VMs NIC</span></p>
</div>
</div>
<div class="section" id="host-network-configuration">
<h4>8.14.3.1.2. Host network configuration<a class="headerlink" href="#host-network-configuration" title="Permalink to this headline">¶</a></h4>
<p>Outside of <strong class="program">virt-manager</strong>’s installation, a bridge <code class="docutils literal"><span class="pre">br0</span></code> was created to allow VMs to connect directly to the local network.</p>
<p>By default, a Kali install has <strong class="program">NetworkManager</strong> manage the <code class="docutils literal"><span class="pre">enp5s0</span></code> Ethernet interface and <strong class="program">networking</strong> manage the loopback interface. However, <strong class="program">networking</strong> is configured to control <code class="docutils literal"><span class="pre">enp5s0</span></code> and slave it to the new bridge <code class="docutils literal"><span class="pre">br0</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">hacker@debian:~$ cat /etc/network/interfaces
</span><span class="c1"># This file describes the network interfaces available on your system</span>
<span class="c1"># and how to activate them. For more information, see interfaces(5).</span>

<span class="nb">source</span> /etc/network/interfaces.d/*

<span class="c1"># The loopback network interface</span>
auto lo
iface lo inet loopback

<span class="c1"># The primary network interface</span>
<span class="hll">auto enp5s0
</span>allow-hotplug enp5s0
iface enp5s0 inet6 auto

<span class="hll">auto br0
</span><span class="hll">iface br0 inet static
</span>        address <span class="m">192</span>.168.1.29
        netmask <span class="m">255</span>.255.255.0
        gateway <span class="m">192</span>.168.1.1
        dns-nameservers <span class="m">192</span>.168.1.1
        dns-search bitbender.org
<span class="hll">        bridge_ports enp5s0
</span>        bridge_stp off
        bridge_fd <span class="m">0</span>
        bridge_maxwait <span class="m">0</span>
</pre></div>
</div>
<p>To demonstrate that <strong class="program">NetworkManager</strong> no longer controls any networking devices, run <code class="docutils literal"><span class="pre">nmcli</span></code>. Notice that since <code class="docutils literal"><span class="pre">virbr0</span></code> is not active on boot it does not exist (until needed).</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">hacker@debian:~$ nmcli
</span><span class="hll">virbr1: connected to virbr1
</span>        <span class="s2">&quot;virbr1&quot;</span>
        bridge, <span class="m">52</span>:54:00:25:B8:97, sw, mtu <span class="m">1500</span>
        inet4 <span class="m">192</span>.168.100.1/24

<span class="hll">br0: unmanaged
</span>        <span class="s2">&quot;br0&quot;</span>
        bridge, <span class="m">00</span>:30:67:BC:3F:96, sw, mtu <span class="m">1500</span>

<span class="hll">enp5s0: unmanaged
</span>        <span class="s2">&quot;Realtek RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller&quot;</span>
        ethernet <span class="o">(</span>r8169<span class="o">)</span>, <span class="m">00</span>:30:67:BC:3F:96, hw, mtu <span class="m">1500</span>

<span class="hll">lo: unmanaged
</span>        <span class="s2">&quot;lo&quot;</span>
        loopback <span class="o">(</span>unknown<span class="o">)</span>, <span class="m">00</span>:00:00:00:00:00, sw, mtu <span class="m">65536</span>

<span class="hll">virbr1-nic: unmanaged
</span>        <span class="s2">&quot;virbr1-nic&quot;</span>
        tun, <span class="m">52</span>:54:00:25:B8:97, sw, mtu <span class="m">1500</span>
</pre></div>
</div>
<p>Finally, use <strong class="program">iproute2</strong> to display that <code class="docutils literal"><span class="pre">virbr1-nic</span></code> is slaved to <code class="docutils literal"><span class="pre">virbr1</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">hacker@debian:~$ ip addr show
</span><span class="hll"><span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">2</span>: enp5s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
<span class="hll"><span class="m">3</span>: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.1.29/24 brd <span class="m">192</span>.168.1.255 scope global br0
       valid_lft forever preferred_lft forever
    inet6 <span class="m">2605</span>:e000:9382:4f00:230:67ff:febc:3f96/64 scope global mngtmpaddr dynamic
       valid_lft 43079sec preferred_lft 14118sec
    inet6 fe80::230:67ff:febc:3f96/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">4</span>: virbr1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="m">1500</span> qdisc noqueue state DOWN group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.100.1/24 brd <span class="m">192</span>.168.100.255 scope global virbr1
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">5</span>: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state DOWN group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
</pre></div>
</div>
</div>
<div class="section" id="virt-manager-starting-up-pfsense-firewall-network">
<h4>8.14.3.1.3. <strong class="program">virt-manager</strong> starting up pfSense firewall &amp; network<a class="headerlink" href="#virt-manager-starting-up-pfsense-firewall-network" title="Permalink to this headline">¶</a></h4>
<p>Within the VMM GUI a network for the pfSense VM was created. After bringing up the pfsense firewall the interface <code class="docutils literal"><span class="pre">re0</span></code> (<code class="docutils literal"><span class="pre">vnet0</span></code>) is connected to <code class="docutils literal"><span class="pre">br0</span></code> and interface <code class="docutils literal"><span class="pre">re1</span></code> (<code class="docutils literal"><span class="pre">vnet1</span></code>) is connected to the virtual network pfsense (<code class="docutils literal"><span class="pre">virbr1</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">hacker@debian:~$ ip addr show
</span><span class="hll"><span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">2</span>: enp5s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
<span class="hll"><span class="m">3</span>: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.1.29/24 brd <span class="m">192</span>.168.1.255 scope global br0
       valid_lft forever preferred_lft forever
    inet6 <span class="m">2605</span>:e000:9382:4f00:230:67ff:febc:3f96/64 scope global mngtmpaddr dynamic
       valid_lft 86339sec preferred_lft 14339sec
    inet6 fe80::230:67ff:febc:3f96/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">4</span>: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.100.1/24 brd <span class="m">192</span>.168.100.255 scope global virbr1
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">5</span>: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state DOWN group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
<span class="hll"><span class="m">6</span>: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/ether fe:54:00:91:7e:a0 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe91:7ea0/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">7</span>: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/ether fe:54:00:2a:a5:3a brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe2a:a53a/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>
</div>
</div>
<div class="section" id="virt-manager-starting-up-windows-client-behind-firewall">
<h4>8.14.3.1.4. <strong class="program">virt-manager</strong> starting up Windows client behind firewall<a class="headerlink" href="#virt-manager-starting-up-windows-client-behind-firewall" title="Permalink to this headline">¶</a></h4>
<p>Windows (behind the pfsense firewall) is brought up on interface <code class="docutils literal"><span class="pre">Local</span> <span class="pre">Area</span> <span class="pre">Connection</span> <span class="pre">4</span></code> (<code class="docutils literal"><span class="pre">vnet2</span></code>):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="hll">hacker@debian:~$ ip addr show
</span><span class="hll"><span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">2</span>: enp5s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
<span class="hll"><span class="m">3</span>: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.1.29/24 brd <span class="m">192</span>.168.1.255 scope global br0
       valid_lft forever preferred_lft forever
    inet6 <span class="m">2605</span>:e000:9382:4f00:230:67ff:febc:3f96/64 scope global mngtmpaddr dynamic
       valid_lft 43198sec preferred_lft 14314sec
    inet6 fe80::230:67ff:febc:3f96/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">4</span>: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.100.1/24 brd <span class="m">192</span>.168.100.255 scope global virbr1
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">5</span>: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state DOWN group default qlen <span class="m">1000</span>
</span>    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
<span class="hll"><span class="m">6</span>: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/ether fe:54:00:91:7e:a0 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe91:7ea0/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">7</span>: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/ether fe:54:00:2a:a5:3a brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe2a:a53a/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll"><span class="m">8</span>: vnet2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state UNKNOWN group default qlen <span class="m">1000</span>
</span>    link/ether fe:54:00:2d:1a:80 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe2d:1a80/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>
</div>
</div>
</div>
<div class="section" id="virsh-on-virt-manager-vms">
<h3>8.14.3.2. <code class="docutils literal"><span class="pre">virsh</span></code> on <strong class="program">virt-manager</strong> VMs<a class="headerlink" href="#virsh-on-virt-manager-vms" title="Permalink to this headline">¶</a></h3>
<p>Here is <code class="docutils literal"><span class="pre">virsh</span></code> command line running the VMs create via <strong class="program">virt-manager</strong>. Note that the existing XML configuration files created by <strong class="program">virt-manager</strong> allows this simple use of <code class="docutils literal"><span class="pre">virsh</span></code>. Without <strong class="program">virt-manager</strong> <code class="docutils literal"><span class="pre">virsh</span></code> would have to dig deep in the list of commands to create the required components that it simply uses here. (See <a class="reference external" href="https://libvirt.org/virshcmdref.html">Virsh Command Reference</a>, <a class="reference external" href="https://linux.die.net/man/1/virsh">virsh(1) - Linux man page</a>, and more simply <a class="reference external" href="https://help.ubuntu.com/community/KVM/Virsh">KVM/Virsh</a>.)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>hacker@debian:~$ <span class="c1"># virsh help</span>
hacker@debian:~$ <span class="c1"># virsh help interface</span>
hacker@debian:~$ <span class="c1"># virsh help network</span>
hacker@debian:~$ <span class="c1"># virsh help interface</span>
<span class="hll">hacker@debian:~$ sudo virsh list --all
</span> Id    Name                           State
----------------------------------------------------
<span class="hll"> -     pfsense                        shut off
</span><span class="hll"> -     taxing                         shut off
</span>hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
<span class="hll">hacker@debian:~$ sudo virsh net-list
</span> Name                 State      Autostart     Persistent
----------------------------------------------------------
<span class="hll"> pfsense              active     yes           yes
</span>
<span class="hll">hacker@debian:~$ sudo virsh net-info pfsense
</span>Name:           pfsense
UUID:           ac162bc3-66f6-42aa-9ebb-e11f212e454b
Active:         yes
Persistent:     yes
Autostart:      yes
Bridge:         virbr1
<span class="hll">hacker@debian:~$ sudo virsh iface-list
</span> Name                 State      MAC Address
---------------------------------------------------
 br0                  active     <span class="m">00</span>:30:67:bc:3f:96
 lo                   active     <span class="m">00</span>:00:00:00:00:00
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$ <span class="c1"># virsh help domain</span>
<span class="hll">hacker@debian:~$ sudo virsh list --all
</span> Id    Name                           State
----------------------------------------------------
 -     pfsense                        shut off
 -     taxing                         shut off
<span class="hll">hacker@debian:~$ sudo virsh start pfsense
</span>Domain pfsense started
<span class="hll">hacker@debian:~$ sudo virsh list --all
</span> Id    Name                           State
----------------------------------------------------
<span class="hll"> <span class="m">1</span>     pfsense                        running
</span> -     taxing                         shut off
hacker@debian:~$ <span class="c1"># Starting pfsense creates vnet0 (re0), vnet1 (re1)</span>
<span class="hll">hacker@debian:~$ ip addr show dev vnet0
</span><span class="m">6</span>: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UNKNOWN group default qlen <span class="m">1000</span>
    link/ether fe:54:00:91:7e:a0 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe91:7ea0/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll">hacker@debian:~$ ip addr show dev vnet1
</span><span class="m">7</span>: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state UNKNOWN group default qlen <span class="m">1000</span>
    link/ether fe:54:00:2a:a5:3a brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe2a:a53a/64 scope link
       valid_lft forever preferred_lft forever
<span class="hll">hacker@debian:~$ sudo virsh domiflist pfsense
</span>Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet0      bridge     br0        rtl8139     <span class="m">52</span>:54:00:91:7e:a0
vnet1      network    pfsense    rtl8139     <span class="m">52</span>:54:00:2a:a5:3a
hacker@debian:~$ <span class="c1"># Notice reported mac differs from first octet of ip link show</span>
<span class="hll">hacker@debian:~$ ip link show dev vnet0
</span><span class="m">6</span>: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UNKNOWN mode DEFAULT group default qlen <span class="m">1000</span>
    link/ether fe:54:00:91:7e:a0 brd ff:ff:ff:ff:ff:ff
<span class="hll">hacker@debian:~$ ip link show dev vnet1
</span><span class="m">7</span>: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state UNKNOWN mode DEFAULT group default qlen <span class="m">1000</span>
    link/ether fe:54:00:2a:a5:3a brd ff:ff:ff:ff:ff:ff
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
<span class="hll">hacker@debian:~$ dig +short pfsense
</span><span class="m">192</span>.168.1.114
hacker@debian:~$ <span class="c1"># Notice the spice listener on port 5900</span>
<span class="hll">hacker@debian:~$ ss -Htnl <span class="s1">&#39;sport = 5900&#39;</span>
</span>LISTEN     <span class="m">0</span>      <span class="m">128</span>    <span class="m">127</span>.0.0.1:5900                     *:*
<span class="hll">hacker@debian:~$ sudo virsh list --all
</span> Id    Name                           State
----------------------------------------------------
 <span class="m">1</span>     pfsense                        running
 -     taxing                         shut off
<span class="hll">hacker@debian:~$ virt-viewer --connect<span class="o">=</span>qemu:///system <span class="m">1</span>
</span>hacker@debian:~$ <span class="c1"># Now connected to GUI of pfSense command line</span>
hacker@debian:~$ <span class="c1">#  can see WAN -&gt; re0 -&gt;</span>
hacker@debian:~$ <span class="c1">#     v4/DHCP4: 192.168.1.114/24</span>
hacker@debian:~$ <span class="c1">#     v6/DHCP6: 2605:e000:9382:4t00:5054:ff:fe91:7ea0/64</span>
hacker@debian:~$ <span class="c1">#  can see LAN -&gt; re1 -&gt;</span>
hacker@debian:~$ <span class="c1">#     v4/: 192.168.100.1/24</span>
hacker@debian:~$ <span class="c1"># Terminate GUI</span>
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
<span class="hll">hacker@debian:~$ ssh root@pfsense
</span>hacker@debian:~$ <span class="c1"># Terminate SSH session</span>
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$ <span class="c1"># Start taxing VM</span>
<span class="hll">hacker@debian:~$ sudo virsh start taxing
</span>Domain taxing started

<span class="hll">hacker@debian:~$ sudo virsh list --all
</span> Id    Name                           State
----------------------------------------------------
 <span class="m">1</span>     pfsense                        running
 <span class="m">2</span>     taxing                         running
<span class="hll">hacker@debian:~$ sudo virsh domiflist taxing
</span>Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet2      network    pfsense    e1000       <span class="m">52</span>:54:00:2d:1a:80
hacker@debian:~$ <span class="c1"># Notice reported mac differs from first octet of ip link show</span>
<span class="hll">hacker@debian:~$ ip addr show dev vnet2
</span><span class="m">8</span>: vnet2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state UNKNOWN group default qlen <span class="m">1000</span>
    link/ether fe:54:00:2d:1a:80 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe2d:1a80/64 scope link
       valid_lft forever preferred_lft forever
hacker@debian:~$ <span class="c1"># Notice the spice listener on port 5901</span>
<span class="hll">hacker@debian:~$ ss -Htnl <span class="s1">&#39;sport = 5901&#39;</span>
</span>LISTEN     <span class="m">0</span>      <span class="m">128</span>    <span class="m">127</span>.0.0.1:5901                     *:*
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
<span class="hll">hacker@debian:~$ virt-viewer --connect<span class="o">=</span>qemu:///system <span class="m">2</span>
</span>hacker@debian:~$
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$ <span class="c1"># Shutdown taxing</span>
hacker@debian:~$ <span class="c1"># Shutdown pfsense</span>
<span class="hll">hacker@debian:~$ sudo virsh list --all
</span> Id    Name                           State
----------------------------------------------------
 -     pfsense                        shut off
 -     taxing                         shut off
hacker@debian:~$
hacker@debian:~$
hacker@debian:~$ <span class="c1"># vnet0, vnet1, and vnet2 deleted after hosts down</span>
<span class="hll">hacker@debian:~$ ip link show
</span><span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN mode DEFAULT group default qlen <span class="m">1000</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
<span class="m">2</span>: enp5s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq master br0 state UP mode DEFAULT group default qlen <span class="m">1000</span>
    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
<span class="m">3</span>: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP mode DEFAULT group default qlen <span class="m">1000</span>
    link/ether <span class="m">00</span>:30:67:bc:3f:96 brd ff:ff:ff:ff:ff:ff
<span class="m">4</span>: virbr1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="m">1500</span> qdisc noqueue state DOWN mode DEFAULT group default qlen <span class="m">1000</span>
    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
<span class="m">5</span>: virbr1-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc fq master virbr1 state DOWN mode DEFAULT group default qlen <span class="m">1000</span>
    link/ether <span class="m">52</span>:54:00:25:b8:97 brd ff:ff:ff:ff:ff:ff
</pre></div>
</div>
</div>
</div>
<div class="section" id="linux-networking-commands">
<h2>8.14.4. Linux networking commands<a class="headerlink" href="#linux-networking-commands" title="Permalink to this headline">¶</a></h2>
<div class="section" id="why-bother-with-command-line-networking">
<h3>8.14.4.1. Why bother with command line networking?<a class="headerlink" href="#why-bother-with-command-line-networking" title="Permalink to this headline">¶</a></h3>
<p><strong class="program">libvirt</strong>’s VMM GUI allows both fast one-off virtualization, plus fast setup that can be followed up with <code class="docutils literal"><span class="pre">virsh</span></code>-based automation for repeated virtualization runs.</p>
<p>When command line networking is useful:</p>
<ol class="arabic simple">
<li><strong class="program">libvirt</strong> and/or <strong class="program">virt-manager</strong> is not available on all systems while <strong class="program">iproute2</strong> usually is.</li>
<li><strong class="program">libvirt</strong> is tied to <strong class="program">iptables</strong> and complicates switching to <strong class="program">nftables</strong>.</li>
<li>Debugging networking configuration issues may require deep knowledge of command line networking.</li>
<li>Professional developement: pentesters should understand command line networking.</li>
</ol>
</div>
<div class="section" id="avoid-deprecated-packages">
<h3>8.14.4.2. Avoid deprecated packages<a class="headerlink" href="#avoid-deprecated-packages" title="Permalink to this headline">¶</a></h3>
<p><strong class="program">bridge-utils</strong>, <strong class="program">net-tools`are all deprecated in lieu of :program:`iproute2</strong>. So this presentation will avoid <code class="docutils literal"><span class="pre">brctl</span></code>, <code class="docutils literal"><span class="pre">ifconfig</span></code>, … i lieu of <code class="docutils literal"><span class="pre">ip</span> <span class="pre">...</span></code> and <code class="docutils literal"><span class="pre">bridge</span></code>.</p>
</div>
<div class="section" id="iproute2-command-line-networking">
<h3>8.14.4.3. <strong class="program">iproute2</strong> command line networking<a class="headerlink" href="#iproute2-command-line-networking" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="https://wiki.archlinux.org/index.php/Network_bridge">Network bridge</a> for a description of both <strong class="program">iproute2</strong> and deprecated <strong class="program">bridge-utils</strong>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">BRIDGE</span><span class="o">=</span>br1
<span class="nv">NUMTAP</span><span class="o">=</span><span class="m">3</span>
<span class="nv">IP</span><span class="o">=</span><span class="m">192</span>.168.1.4/24
<span class="nv">U</span><span class="o">=</span><span class="nv">$USER</span>
<span class="nv">G</span><span class="o">=</span>sudo

<span class="c1"># Create the bridge</span>
sudo ip link add name <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span> <span class="nb">type</span> bridge
sudo ip link <span class="nb">set</span> <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span> up
sudo ip addr add <span class="si">${</span><span class="nv">IP</span><span class="si">}</span> dev <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span>

<span class="c1"># Create tap interfaces</span>
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;NUMTAP<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
  sudo ip tuntap add dev tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span> mode tap user <span class="si">${</span><span class="nv">U</span><span class="si">}</span> group <span class="si">${</span><span class="nv">G</span><span class="si">}</span>
  sudo ip link <span class="nb">set</span> dev tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span> master <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span>
  sudo ip link <span class="nb">set</span> dev tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span> up
<span class="k">done</span>

<span class="c1"># Show status</span>
ip link show

<span class="c1"># Tear down the network</span>
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;NUMTAP<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
  sudo ip tuntap del dev tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span> mode tap
<span class="k">done</span>
sudo ip link del dev <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span>
</pre></div>
</div>
</div>
<div class="section" id="network-manager-networking">
<h3>8.14.4.4. <strong class="program">network-manager</strong> networking<a class="headerlink" href="#network-manager-networking" title="Permalink to this headline">¶</a></h3>
<p>For <code class="docutils literal"><span class="pre">nmcli</span></code> documentation see: <a class="reference external" href="https://developer.gnome.org/NetworkManager/stable/nmcli.html">Gnome Developer - nmcli</a>, <a class="reference external" href="https://developer.gnome.org/NetworkManager/stable/nmcli-examples.html">Gnome Developer - nmcli-examples</a>, <a class="reference external" href="https://linux.die.net/man/1/nmcli">nmcli(1) - Linux man page</a>, and <a class="reference external" href="https://fedoraproject.org/wiki/Networking/CLI">fedora - Networking/CLI</a>.</p>
<p>Here are the equivalent <strong class="program">network-manager</strong> commands just completed for <strong class="program">iproute2</strong>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">BRIDGE</span><span class="o">=</span>br1
<span class="nv">NUMTAP</span><span class="o">=</span><span class="m">3</span>
<span class="nv">IP</span><span class="o">=</span><span class="m">192</span>.168.1.4/24
<span class="nv">U</span><span class="o">=</span><span class="nv">$UID</span>
<span class="nv">G</span><span class="o">=</span><span class="m">27</span>

<span class="c1"># Create the bridge</span>
nmcli con add ifname <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span> <span class="nb">type</span> bridge con-name <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span> ip4 <span class="si">${</span><span class="nv">IP</span><span class="si">}</span>
nmcli con show <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span>
nmcli con modify <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span> bridge.stp no
nmcli con show

<span class="c1"># Create tap interfaces</span>
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;NUMTAP<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
  nmcli con add <span class="nb">type</span> tun ifname tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span> <span class="se">\</span>
      con-name tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span> mode tap owner <span class="si">${</span><span class="nv">U</span><span class="si">}</span> group <span class="si">${</span><span class="nv">G</span><span class="si">}</span> master <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span>
  <span class="c1"># nmcli conn add type bridge-slave con-name ${BRIDGE}-tap${i} \</span>
  <span class="c1">#     ifname tap${i} master ${BRIDGE}</span>
  nmcli conn up tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span>
<span class="k">done</span>

<span class="c1"># Show status</span>
nmcli con show

<span class="c1"># Tear down the network</span>
<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> i&lt;NUMTAP<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
  nmcli con del tap<span class="si">${</span><span class="nv">i</span><span class="si">}</span>
<span class="k">done</span>
nmcli con del <span class="si">${</span><span class="nv">BRIDGE</span><span class="si">}</span>
</pre></div>
</div>
</div>
<div class="section" id="mods-to-networking-imply-mods-to-iptables-or-nftables">
<h3>8.14.4.5. Mods to networking imply mods to <strong class="program">iptables</strong> or <strong class="program">nftables</strong><a class="headerlink" href="#mods-to-networking-imply-mods-to-iptables-or-nftables" title="Permalink to this headline">¶</a></h3>
<p>Note that all the networking modification can require changes to the existing firewall configuration. <strong class="program">virt-manager</strong> has some built-in <strong class="program">iptables</strong> modification, but cannot deal with arbitrary firewall configurations nor with <strong class="program">nftables</strong> at all. In fact it would interfere with <strong class="program">nftables</strong>. This is where manual network and firewall configuration becomes useful.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="vulnerabilities.html" class="btn btn-neutral float-right" title="8.15. Vulnerabilites" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="php.html" class="btn btn-neutral" title="8.13. PHP &amp; MySQL Shortcomings" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>