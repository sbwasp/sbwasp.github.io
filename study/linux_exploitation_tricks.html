

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.6. Linux Exploitation Tricks &mdash; South Bay WASP 1.0.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="South Bay WASP 1.0.2 documentation" href="../index.html"/>
        <link rel="up" title="8. Pentest Study" href="../pentest_study.html"/>
        <link rel="next" title="8.7. Windows broadcast name resolution" href="llmnr.html"/>
        <link rel="prev" title="8.5. loadlibrary" href="loadlibrary.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_html.html">5. HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="2factor.html">8.1. 2 Factor Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="email_security.html">8.2. Email Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="exfiltration.html">8.3. Exfiltration</a></li>
<li class="toctree-l2"><a class="reference internal" href="exiftool.html">8.4. <strong class="program">exiftool</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="loadlibrary.html">8.5. loadlibrary</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">8.6. Linux Exploitation Tricks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#privilege-escalation">8.6.1. Privilege Escalation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#miscelaneous-exploits">8.6.2. Miscelaneous Exploits</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initializing-uninitialized-memory">8.6.3. Initializing Uninitialized Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overriding-libraries">8.6.4. Overriding Libraries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ld-preload-hack">8.6.4.1. LD_PRELOAD Hack</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rpath-and-environment-variables">8.6.4.2. RPATH and Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#setuid-executables">8.6.5. setuid executables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#real-effective-saved-uid-s">8.6.5.1. real/effective/saved uid’s</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changing-uid-s">8.6.5.2. Changing uid’s</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="llmnr.html">8.7. Windows broadcast name resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="ntlm.html">8.8. NTLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="passwords.html">8.9. Password Cracking Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="php.html">8.10. PHP &amp; MySQL Shortcomings</a></li>
<li class="toctree-l2"><a class="reference internal" href="vulnerabilities.html">8.11. Vulnerabilites</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">8.12. WiFi Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_study.html">8. Pentest Study</a> &raquo;</li>
        
      <li>8.6. Linux Exploitation Tricks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/study/linux_exploitation_tricks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linux-exploitation-tricks">
<h1>8.6. Linux Exploitation Tricks<a class="headerlink" href="#linux-exploitation-tricks" title="Permalink to this headline">¶</a></h1>
<div class="section" id="privilege-escalation">
<h2>8.6.1. Privilege Escalation<a class="headerlink" href="#privilege-escalation" title="Permalink to this headline">¶</a></h2>
<p>Here are 2 links to investiage privilege escalation:</p>
<ul class="simple">
<li><a class="reference external" href="http://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/">Basic Linux Privilege Escalation</a></li>
<li><a class="reference external" href="http://www.admin-magazine.com/Articles/Understanding-Privilege-Escalation">Understanding Privilege Escalation</a></li>
</ul>
</div>
<div class="section" id="miscelaneous-exploits">
<h2>8.6.2. Miscelaneous Exploits<a class="headerlink" href="#miscelaneous-exploits" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.dankalia.com/tutor/01005/0100501004.htm">Hacking Linux Part I: Privilege Escalation By gimboyd</a> is a short read of these exploits:</p>
<ul class="simple">
<li>Abusing users with ‘.’ in their PATH:</li>
<li>Shell Escape Sequences: (applications that allow you to run a shell)</li>
<li>IFS Exploit:</li>
<li>LD_PRELOAD Exploit: (covered in more detail in <a class="reference internal" href="#overriding-libraries"><span class="std std-ref">Overriding Libraries</span></a>)</li>
<li>symlinks</li>
</ul>
<p>Of the above the IFS (internal field separator) is perhaps the most confusing for beginners so we provide an IFS example below. From <code class="docutils literal"><span class="pre">man</span> <span class="pre">bash</span></code>:</p>
<blockquote>
<div>IFS The Internal Field Separator that is used for word splitting after expansion and to  split  lines  into words with the read builtin command.  The default value is “&lt;space&gt;&lt;tab&gt;&lt;newline&gt;”.</div></blockquote>
<p>Here is an example in C and bash illustrating some differences how IFS works:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">IFS</span><span class="o">=</span>/
<span class="gp">$</span> <span class="c1"># test.sh runs &quot;/bin/date&quot; and &quot;eval /bin/date&quot;</span>
<span class="gp">$</span> cat test.sh
<span class="gp">#</span>!/usr/bin/env bash

<span class="go">echo -n &quot;$IFS&quot; | od -bc</span>
<span class="go">echo try 1</span>
<span class="go">/bin/date</span>
<span class="go">echo try 2</span>
<span class="go">cmd=&quot;/bin/date&quot;; eval $cmd</span>
<span class="gp">$</span> <span class="c1"># test.sh ignores inherited IFS</span>
<span class="gp">$</span> ./test.sh
<span class="go">0000000 040 011 012</span>
<span class="go">             \t  \n</span>
<span class="go">0000003</span>
<span class="go">try 1</span>
<span class="go">Fri Sep  5 15:21:13 PDT 2014</span>
<span class="go">try 2</span>
<span class="go">Fri Sep  5 15:21:13 PDT 2014</span>
<span class="gp">$</span> <span class="c1"># &quot;. ./test.sh&quot; uses IFS and sees &quot;eval /bin/date&quot; as &quot;bin date&quot;</span>
<span class="gp">$</span> . ./test.sh
<span class="go">0000000 057</span>
<span class="go">          /</span>
<span class="go">0000001</span>
<span class="go">try 1</span>
<span class="go">Fri Sep  5 15:21:25 PDT 2014</span>
<span class="go">try 2</span>
<span class="go">-bash: bin: command not found</span>
<span class="gp">$</span> <span class="c1"># . test.c duplicates test.sh and acts like &quot;. ./test.sh&quot;</span>
<span class="gp">$</span> cat test.c
<span class="gp">#</span>include &lt;stdlib.h&gt;
<span class="go">main()</span>
<span class="go">{</span>
<span class="go">  system(&quot;echo -n \&quot;$IFS\&quot; | od -bc&quot;);</span>
<span class="go">  system(&quot;echo try 1&quot;);</span>
<span class="go">  system(&quot;/bin/date&quot;);</span>
<span class="go">  system(&quot;echo try 2&quot;);</span>
<span class="go">  system(&quot;cmd=\&quot;/bin/date\&quot;; eval $cmd&quot;);</span>
<span class="go">}</span>
<span class="gp">$</span> gcc -o <span class="nb">test</span> test.c
<span class="gp">$</span> chmod +x <span class="nb">test</span>
<span class="gp">$</span> ./test
<span class="go">0000000 057</span>
<span class="go">          /</span>
<span class="go">0000001</span>
<span class="go">try 1</span>
<span class="go">Fri Sep  5 15:22:10 PDT 2014</span>
<span class="go">try 2</span>
<span class="go">sh: 1: eval: bin: not found</span>
<span class="gp">$</span>
</pre></div>
</div>
</div>
<div class="section" id="initializing-uninitialized-memory">
<h2>8.6.3. Initializing Uninitialized Memory<a class="headerlink" href="#initializing-uninitialized-memory" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://vulnfactory.org/blog/2010/04/08/controlling-uninitialized-memory-with-ld_preload/">Controlling uninitialized memory with LD_PRELOAD</a> mentions that</p>
<blockquote>
<div><p>The source of this technique is in the way the Linux linker/loader, ld.so, handles the LD_PRELOAD environment variable. This variable allows users to specify libraries to be preloaded, effectively allowing users to override functions used in a particular binary. Of course, the LD_PRELOAD variable is ignored with setuid binaries, since otherwise an attacker could trivially override arbitrary functions in setuid binaries and easily take control of a system.</p>
<p>However, regardless of whether or not libraries specified via LD_PRELOAD are actually loaded at runtime, ld.so copies the name of each library onto the stack prior to executing the program, and doesn’t clean up after itself. By specifying a very long LD_PRELOAD variable and executing a binary, a portion of the stack will be overwritten with part of the LD_PRELOAD variable during linking, and it will stay that way once execution of the program begins, even on setuid binaries, where the library itself is not loaded.</p>
</div></blockquote>
<p>So here goes an example of loading some of memory with the letter “A”:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">hacker@kali64:~$ LD_PRELOAD=$</span><span class="o">(</span>python -c <span class="s1">&#39;print(&quot;A&quot;*1000)&#39;</span><span class="o">)</span> date
<span class="go">ERROR: ld.so: object &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39; from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</span>
<span class="go">Thu Sep  4 21:55:18 PDT 2014</span>
<span class="gp">hacker@kali64:~$</span>
</pre></div>
</div>
</div>
<div class="section" id="overriding-libraries">
<span id="id1"></span><h2>8.6.4. Overriding Libraries<a class="headerlink" href="#overriding-libraries" title="Permalink to this headline">¶</a></h2>
<p>A nifty trick is to override libraries. Consult <a class="reference external" href="http://www.yolinux.com/TUTORIALS/LibraryArchives-StaticAndDynamic.html">Static, Shared Dynamic and Loadable Linux Libraries</a> for an overview of libraries and <a class="reference external" href="http://linux.die.net/man/8/ld-linux">ld-linux(8) - Linux man page</a> for the LD_* environment variables.</p>
<p>Of course these tricks won’t work for a setuid/setgid program (unless ruid = euid, that is real uid = effective uid).</p>
<div class="section" id="ld-preload-hack">
<h3>8.6.4.1. LD_PRELOAD Hack<a class="headerlink" href="#ld-preload-hack" title="Permalink to this headline">¶</a></h3>
<p>Suppose a non-setuid program calls a libc routine, say <code class="docutils literal"><span class="pre">puts()</span></code> and you’d like to either override that call or inject code before/after that call. One method is to build a shared library redefining <code class="docutils literal"><span class="pre">puts()</span></code> and use LD_PRELOAD to force it to be preloaded &amp; override libc’s <code class="docutils literal"><span class="pre">puts()</span></code>. The example below is a conglomeration of ideas found in these articles:
<a class="reference external" href="http://www.noah.org/wiki/LD_PRELOAD_notes">LD PRELOAD notes</a>, <a class="reference external" href="http://www.programering.com/a/MzN3YzMwATY.html">The linux– function hijacking – Based on LD_PRELOAD</a>, <a class="reference external" href="http://fluxius.handgrep.se/2011/10/31/the-magic-of-ld_preload-for-userland-rootkits/">The magic of LD_PRELOAD for Userland Rootkits</a> (the last 2 links show handling a variable number of arguments).</p>
<p>Below, <em>main.c</em> just prints a simple message. <em>puts-replace.c</em> replaces it with an <code class="docutils literal"><span class="pre">exit(153)</span></code>, while <em>puts-inject.c</em> injects a write to file <em>evil.txt</em> prior to passing the call on to the real, original <code class="docutils literal"><span class="pre">puts()</span></code>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span> the unmodified program
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> cat main.c
<span class="gp">#</span>include &lt;stdio.h&gt;
<span class="go">main()</span>
<span class="go">{</span>
<span class="go">  puts(&quot;Hello&quot;);</span>
<span class="go">  puts(&quot;Goodbye&quot;);</span>
<span class="go">}</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> gcc -o main main.c
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> ./main
<span class="go">Hello</span>
<span class="go">Goodbye</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span> replace puts with exit<span class="o">(</span><span class="m">153</span><span class="o">)</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> cat puts-replace.c
<span class="gp">#</span>include &lt;stdio.h&gt;
<span class="gp">#</span>include &lt;stdlib.h&gt;
<span class="go">int puts(const char *s)</span>
<span class="go">{</span>
<span class="go">  // this puts just silently exits the whole program</span>
<span class="go">  exit(153);</span>
<span class="go">}</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> gcc -shared -fPIC -D_GNU_SOURCE <span class="se">\</span>
    -o puts-replace.so puts-replace.c
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ LD_PRELOAD=$</span>PWD/puts-replace.so ./main
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ echo $</span>?
<span class="go">153</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span> inject code in puts - write to evil.txt
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> cat puts-inject.c
<span class="gp">#</span>include &lt;dlfcn.h&gt;
<span class="gp">#</span>include &lt;stdio.h&gt;
<span class="go">int puts(const char *s)</span>
<span class="go">{</span>
<span class="go">  static int (*orig_puts) (const char *s) = NULL;</span>

<span class="go">  // inject evil code here</span>
<span class="go">  FILE *fp = fopen(&quot;evil.txt&quot;, &quot;a&quot;);</span>
<span class="go">  fprintf(fp, &quot;%s\n&quot;, &quot;some secret&quot;);</span>
<span class="go">  fclose(fp);</span>

<span class="go">  // dynamically load original puts if needed, then call it</span>
<span class="go">  if (orig_puts == NULL)</span>
<span class="go">    orig_puts = (int (*)()) dlsym(RTLD_NEXT, &quot;puts&quot;);</span>
<span class="go">  return (*orig_puts)(s);</span>
<span class="go">}</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> gcc -shared -ldl -fPIC -D_GNU_SOURCE <span class="se">\</span>
    -o puts-inject.so puts-inject.c
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ LD_PRELOAD=$</span>PWD/puts-inject.so ./main
<span class="go">Hello</span>
<span class="go">Goodbye</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> cat evil.txt
<span class="go">some secret</span>
<span class="go">some secret</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span>
</pre></div>
</div>
<p>Using <code class="docutils literal"><span class="pre">nm</span> <span class="pre">-D</span></code> we can view the “U” undefined and “T” defined symbols in our <em>main</em> and two shared objects <em>puts-replace.so</em> and <em>puts-inject.so</em>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span> main requires puts <span class="o">(</span>and __libc_start_main<span class="o">)</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> nm -D main
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="go">                 U __libc_start_main</span>
<span class="go">                 U puts</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span> puts-replace.so provides puts and requires <span class="nb">exit</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> nm -D puts-replace.so
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="go">                 U exit</span>
<span class="go">00000000000006c0 T puts</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span> puts-inject.so provides puts and requires
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$ #</span>   support <span class="k">for</span> the injected code
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span> nm -D puts-inject.so
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="go">                 U dlsym</span>
<span class="go">                 U fclose</span>
<span class="go">                 U fopen</span>
<span class="go">                 U fprintf</span>
<span class="go">00000000000007c0 T puts</span>
<span class="gp">hacker@kali64:~/local/LD_PRELOAD$</span>
</pre></div>
</div>
</div>
<div class="section" id="rpath-and-environment-variables">
<h3>8.6.4.2. RPATH and Environment Variables<a class="headerlink" href="#rpath-and-environment-variables" title="Permalink to this headline">¶</a></h3>
<p>ELF file RPATH specification and environment variables affect the load order for an executable. When looking for an exploit you can check the ELF file to see if there is an RPATH specification that might allow overriding a shared library:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">hacker@kali64:~$</span> readelf --dynamic /usr/bin/some_exe <span class="p">|</span> grep PATH
<span class="go"> 0x000000000000000f (RPATH)    Library rpath: [/usr/lib/binutils/avr/git]</span>
<span class="go"> 0x000000000000001d (RUNPATH)  Library runpath: [/usr/lib/binutils/avr/git]</span>
</pre></div>
</div>
<p><a class="reference external" href="http://man7.org/linux/man-pages/man8/ld.so.8.html">ld.so(8) man page</a> description section mentions the library search order:</p>
<blockquote>
<div><p>When resolving library dependencies, the dynamic linker first inspects each dependency string to see if it contains a slash (this can occur if a library pathname containing slashes was specified at link time). If a slash is found, then the dependency string is interpreted as a (relative or absolute) pathname, and the library is loaded using that pathname.</p>
<p>If a library dependency does not contain a slash, then it is searched for in the following order:</p>
<ul class="simple">
<li>(ELF only) Using the directories specified in the DT_RPATH dynamic section attribute of the binary if present and DT_RUNPATH attribute does not exist. Use of DT_RPATH is deprecated.</li>
<li>Using the environment variable LD_LIBRARY_PATH. Except if the executable is a set-user-ID/set-group-ID binary, in which case it is ignored.</li>
<li>(ELF only) Using the directories specified in the DT_RUNPATH dynamic section attribute of the binary if present.</li>
<li>From the cache file /etc/ld.so.cache, which contains a compiled list of candidate libraries previously found in the augmented library path. If, however, the binary was linked with the -z nodeflib linker option, libraries in the default library paths are skipped. Libraries installed in hardware capability directories (see below) are preferred to other libraries.</li>
<li>In the default path /lib, and then /usr/lib. If the binary was linked with the -z nodeflib linker option, this step is skipped.</li>
</ul>
</div></blockquote>
<p>So where does this leave us? Check the ELF for additional RPATH specification that contains a writable directory.</p>
</div>
</div>
<div class="section" id="setuid-executables">
<h2>8.6.5. setuid executables<a class="headerlink" href="#setuid-executables" title="Permalink to this headline">¶</a></h2>
<p>A setuid executable is created via <code class="docutils literal"><span class="pre">chmod</span> <span class="pre">u+s</span></code>. This affects several aspects of running the program: the started process runs as the owning user of the program file, and the invoking user is prohibited from altering the new process in any way. So running <code class="docutils literal"><span class="pre">gdb</span></code> on a setuid program actually runs it as a normal non-setuid program. Altering LD_LIBRARY_PATH, <code class="docutils literal"><span class="pre">ptrace</span></code>, or other attempts to alter the program are also not permitted. To find setuid/setgid programs:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># find setuid or getuid programs</span>
find / -type f -perm /6000 -exec stat -c <span class="s2">&quot;%A %a %n&quot;</span> <span class="o">{}</span> <span class="se">\;</span>
<span class="c1"># find only setuid programs</span>
find / -type f -perm /4000
</pre></div>
</div>
<div class="section" id="real-effective-saved-uid-s">
<h3>8.6.5.1. real/effective/saved uid’s<a class="headerlink" href="#real-effective-saved-uid-s" title="Permalink to this headline">¶</a></h3>
<p>Sometimes setuid programs drop permissions in a way that allows the program to revert back to root. To understand this you should be aware that the process has 3 important uids: real (ruid), effective (euid), and saved (suid). The ruid starts out as the uid of the executing user, euid as the owner of the setuid program, and suid the same as euid. From there the program can use different methods to drop permissions, some of which can be reversed.</p>
<blockquote>
<div>Side Note: Linux has a fourth uid, the fsuid <a class="reference external" href="https://en.wikipedia.org/wiki/User_identifier#File_system_user_ID">filesystem user ID</a> “which is used explicitly for access control to the file system. It matches the euid unless explicitly set otherwise. It may be root’s user ID only if ruid, suid, or euid is root. Whenever the euid is changed, the change is propagated to the fsuid.” There are equivalent group real, effective and saved gids.</div></blockquote>
<p>You can see your uid &amp; gid via the <code class="docutils literal"><span class="pre">id</span></code> command and view all four of your real/effective/saved/fs uid’s &amp; gid’s as the first three after <em>Uid</em> in <code class="docutils literal"><span class="pre">cat</span> <span class="pre">/proc/$$/task/$$/status</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-A2</span> <span class="pre">TracerPid</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">hacker@kali64:~$</span> cat /proc/<span class="nv">$$</span>/task/<span class="nv">$$</span>/status <span class="p">|</span> grep -A2 TracerPid
<span class="go">TracerPid:    0</span>
<span class="go">Uid:  1000    1000    1000    1000</span>
<span class="go">Gid:  1001    1001    1001    1001</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-uid-s">
<h3>8.6.5.2. Changing uid’s<a class="headerlink" href="#changing-uid-s" title="Permalink to this headline">¶</a></h3>
<p>When dropping permissions from root it may be possible to revert to root depending on how permissions were dropped. Here are the restrictions on changing these id’s from <a class="reference external" href="http://linux.die.net/man/2/setresuid">setresuid()</a>:</p>
<blockquote>
<div><p>Unprivileged user processes may change the real UID, effective UID, and saved set-user-ID, each to one of: the current real UID, the current effective UID or the current saved set-user-ID.</p>
<p>Privileged processes (on Linux, those having the CAP_SETUID capability) may set the real UID, effective UID, and saved set-user-ID to arbitrary values.</p>
</div></blockquote>
<p>The following setuid C program starts off by showing all 4 uids set to root then back to to their original values. It then illustrates the difference between <code class="docutils literal"><span class="pre">seteuid()</span></code> and <code class="docutils literal"><span class="pre">setuid()</span></code>: <code class="docutils literal"><span class="pre">setuid()</span></code> also sets the suid and so cannot revert to root. Additionally, starting a subprocess via <code class="docutils literal"><span class="pre">system()</span></code> sets suid to the euid preventing the subprocess reverting to root.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">printit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uid_t</span> <span class="n">ruid</span><span class="p">,</span> <span class="n">euid</span><span class="p">,</span> <span class="n">suid</span><span class="p">;</span>
    <span class="n">getresuid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ruid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">euid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">suid</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;UID:    %-4d    %-4d    %-4d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ruid</span><span class="p">,</span> <span class="n">euid</span><span class="p">,</span> <span class="n">suid</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;cat /proc/$$/task/$$/status | grep -i uid&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
   <span class="c1">// Starting with</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* Starting out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* setresuid(0,0,0) illustrate setting all uids to root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">setresuid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* setresuid(1000,0,0) get uids back to starting values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">setresuid</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* seteuid(1000) lowers to 1000 and process can raise to root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">seteuid</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* seteuid(0) back at root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">seteuid</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* setuid(1000) also sets suid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">setuid</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******* setuid(0) suid 1000 stops raise to root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">setuid</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
   <span class="n">printit</span><span class="p">();</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">hacker@kali64:~$</span> cat &gt; test.sh &lt;&lt;EOF
<span class="gp">#</span>!/usr/bin/env bash

<span class="go">gcc test.c -o test</span>
<span class="go">sudo chown root.root test</span>
<span class="go">sudo chmod u+s test</span>
<span class="go">EOF</span>
<span class="gp">hacker@kali64:~$</span> ./test.sh
<span class="gp">hacker@kali64:~$</span> ./test
<span class="go">******* Starting out</span>
<span class="go">UID:    1000    0       0</span>
<span class="go">Uid:  1000    0       0       0</span>
<span class="go">******* setresuid(0,0,0) illustrate setting all to root</span>
<span class="go">UID:    0       0       0</span>
<span class="go">Uid:  0       0       0       0</span>
<span class="go">******* setresuid(1000,0,0) get back to start</span>
<span class="go">UID:    1000    0       0</span>
<span class="go">Uid:  1000    0       0       0</span>
<span class="go">******* seteuid(1000) lowers to 1000 and process can raise to root</span>
<span class="go">UID:    1000    1000    0</span>
<span class="go">Uid:  1000    1000    1000    1000</span>
<span class="go">******* seteuid(0) back at root</span>
<span class="go">UID:    1000    0       0</span>
<span class="go">Uid:  1000    0       0       0</span>
<span class="go">******* setuid(1000) also sets suid</span>
<span class="go">UID:    1000    1000    1000</span>
<span class="go">Uid:  1000    1000    1000    1000</span>
<span class="go">******* setuid(0) suid 1000 stops raise to root</span>
<span class="go">UID:    1000    1000    1000</span>
<span class="go">Uid:  1000    1000    1000    1000</span>
<span class="gp">hacker@kali64:~$</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="llmnr.html" class="btn btn-neutral float-right" title="8.7. Windows broadcast name resolution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="loadlibrary.html" class="btn btn-neutral" title="8.5. loadlibrary" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>