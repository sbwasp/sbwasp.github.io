

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="default-src 'none'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self'; img-src 'self'; style-src 'self'; font-src 'self'; form-action 'self'; frame-ancestors 'none'; base-uri 'self'" http-equiv="Content-Security-Policy" />
<meta content="nosniff" http-equiv="X-Content-Type-Options" />
<meta content="deny" http-equiv="X-Frame-Options" />
<meta content="1; mode=block" http-equiv="X-XSS-Protection" />
<meta content="strict-origin" http-equiv="Referrer-Policy" />
<meta content="max-age=31536000; includeSubDomains" http-equiv="Strict-Transport-Security" />
<meta content="'*'" http-equiv="Access-Control-Allow-Origin" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5.10. XSS Tutorial &mdash; South Bay WASP 1.0.3 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="South Bay WASP 1.0.3 documentation" href="../index.html"/>
        <link rel="up" title="5. HTML" href="../pentest_html.html"/>
        <link rel="next" title="6. Pentest Network Tools" href="../pentest_network_tools.html"/>
        <link rel="prev" title="5.9. HSTS Tutorial" href="hsts.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> South Bay WASP
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pentest_intro.html">1. South Bay WASP Meetup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_kali.html">2. Kali Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_challenges.html">3. Pentest Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_encryption.html">4. Encryption</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../pentest_html.html">5. HTML</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="standards.html">5.1. Standards</a></li>
<li class="toctree-l2"><a class="reference internal" href="http.html">5.2. HTTP(S) vs HTML</a></li>
<li class="toctree-l2"><a class="reference internal" href="parsing.html">5.3. Parsing &amp; Rendering HTML</a></li>
<li class="toctree-l2"><a class="reference internal" href="scripting.html">5.4. Scripting</a></li>
<li class="toctree-l2"><a class="reference internal" href="data.html">5.5. Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="html_security.html">5.6. HTML security</a></li>
<li class="toctree-l2"><a class="reference internal" href="messaging.html">5.7. HTML Web Messaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="html_exploits.html">5.8. HTML exploits</a></li>
<li class="toctree-l2"><a class="reference internal" href="hsts.html">5.9. HSTS Tutorial</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.10. XSS Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#xss-exploit-to-study">5.10.1. XSS exploit to study</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xss-background">5.10.2. XSS background</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#html-javascript-is-a-mess">5.10.2.1. HTML/JavaScript is a mess</a></li>
<li class="toctree-l4"><a class="reference internal" href="#introductory-reading-materials">5.10.2.2. introductory reading materials</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#encoding-escaping">5.10.3. encoding/escaping</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#encoding-escaping-types">5.10.3.1. encoding/escaping types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-python-encoding-scripts">5.10.3.2. example python encoding scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parsing-decoding-order">5.10.3.3. parsing/decoding order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#places-to-xss-inject-input">5.10.3.4. places to XSS inject input</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#double-encoding-why-order-matters">5.10.4. double encoding &amp; why order matters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-side-trip-on-url-encoding">5.10.5. a side trip on URL encoding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#url-encoding-standards-and-python-routines">5.10.5.1. URL encoding standards and python routines</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subtleties-in-url-encoding">5.10.5.2. subtleties in URL encoding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#url-encoding-example">5.10.5.3. URL encoding example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#url-encoding-example-and-iceweasel">5.10.5.4. URL encoding example and <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#entering-data-vs-escaped-data-double-encoding">5.10.5.5. entering data vs. escaped data (double-encoding)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#so-how-do-you-get-that-script-alert-foo-script-to-stop">5.10.5.6. so how do you get that <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('foo')</span> <span class="pre">&lt;/script&gt;</span></code> to stop?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_network_tools.html">6. Pentest Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_recon.html">7. Pentest Reconnaisance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_study.html">8. Pentest Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_buffer_overflow.html">9. Pentest Buffer Overflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_scripting.html">10. Pentest scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pentest_presentations.html">11. Pentest Presentations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">South Bay WASP</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../pentest_html.html">5. HTML</a> &raquo;</li>
        
      <li>5.10. XSS Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/html/xss.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="xss-tutorial">
<span id="id21"></span><h1>5.10. XSS Tutorial<a class="headerlink" href="#xss-tutorial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="xss-exploit-to-study">
<h2>5.10.1. XSS exploit to study<a class="headerlink" href="#xss-exploit-to-study" title="Permalink to this headline">¶</a></h2>
<p>Here is an actual exploit to study: <a class="reference external" href="https://blog.gaborszathmari.me/2014/12/10/wordpress-exploitation-with-xss/">WordpreXSS Exploitation</a>.</p>
</div>
<div class="section" id="xss-background">
<h2>5.10.2. XSS background<a class="headerlink" href="#xss-background" title="Permalink to this headline">¶</a></h2>
<div class="section" id="html-javascript-is-a-mess">
<h3>5.10.2.1. HTML/JavaScript is a mess<a class="headerlink" href="#html-javascript-is-a-mess" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.owasp.org/index.php/Injection_Theory">OWASP Injection Theory</a>:</p>
<blockquote>
<div>XSS is a form of injection where the interpreter is the browser and attacks are buried in an HTML document. HTML is easily the worst mashup of code and data of all time, as there are so many possible places to put code and so many different valid encodings. HTML is particularly difficult because it is not only hierarchical, but also contains many different parsers (XML, HTML, JavaScript, VBScript, CSS, URL, etc…).</div></blockquote>
<p><a class="reference external" href="https://www.owasp.org/images/c/c5/Unraveling_some_Mysteries_around_DOM-based_XSS.pdf">Unraveling some of the Mysteries around DOM-based XSS</a> ends with this summary:</p>
<ul class="simple">
<li>Client XSS is becoming WAY more prevalent</li>
<li>Its generally being ignored</li>
<li>We need to KNOW what JavaScript APIs are safe vs. unsafe</li>
<li>We need more systematic techniques for finding Client XSS flaws</li>
<li>We need better guidance on how to avoid / fix such flaws</li>
</ul>
<p>It is difficult for both web site developers and pentesters to learn the attack surface, which is a huge advantage to pentesters: there’s lots of bad coders whipping out web sites and a persistent, methodical pentester who learns HTML, JavaScript, and CSS will find exploits.</p>
</div>
<div class="section" id="introductory-reading-materials">
<h3>5.10.2.2. introductory reading materials<a class="headerlink" href="#introductory-reading-materials" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Start with <a class="reference external" href="https://www.owasp.org/index.php/Types_of_Cross-Site_Scripting">Types of Cross-Site Scripting</a></li>
<li><a class="reference external" href="https://www.owasp.org/index.php/Cross-site_Scripting_(XSS)">OWASP Cross-site Scripting (XSS)</a></li>
<li><a class="reference external" href="http://danmcinerney.org/modern-techniques-for-xss-discovery/">Modern techniques for XSS discovery</a></li>
<li><a class="reference external" href="https://www.google.com/about/appsecurity/learning/xss/index.html">Google Application Security Learning Cross-site scripting</a></li>
<li><a class="reference external" href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet">XSS (Cross Site Scripting) Prevention Cheat Sheet</a></li>
<li><a class="reference external" href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet">DOM based XSS Prevention Cheat Sheet</a></li>
<li><a class="reference external" href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet">XSS Filter Evasion Cheat Sheet</a></li>
<li><a class="reference external" href="https://docs.google.com/viewer?srcid=0B_Ci-1YbMqshWUtlaGRyLVBVd28&amp;pid=explorer">The Ultimate XSS Protection Cheat Sheet for Developers</a></li>
<li><a class="reference external" href="http://secappdev.org/handouts/2014/Jim%20Manico/SecAppDev%202014%20XSS%20Defense.pdf">Advanced  XSS  Defense</a></li>
</ul>
</div>
</div>
<div class="section" id="encoding-escaping">
<h2>5.10.3. encoding/escaping<a class="headerlink" href="#encoding-escaping" title="Permalink to this headline">¶</a></h2>
<div class="section" id="encoding-escaping-types">
<h3>5.10.3.1. encoding/escaping types<a class="headerlink" href="#encoding-escaping-types" title="Permalink to this headline">¶</a></h3>
<p>Note that the encoding techniques here focus on encoding all non-alphanumeric characters &lt; 256; 0-127 correspond to ascii, 0-255 correspond to latin-1. The characters 0-255 are the potentially dangerous characters: all HTML, CSS, and JavaScript syntax-defined characters are in that range, so characters above 256 cannot be used to alter the HTML, CSS, or JavaScript. So they can be left as-is.</p>
<dl class="docutils">
<dt>HTML attributes:</dt>
<dd>Enclose within single (‘) or double (“) quotes in addition to appropriate encoding below based on the context.</dd>
<dt>URL encoding:</dt>
<dd><p class="first">All non-alphanumeric &lt; 256 ==&gt; %HH</p>
<p class="last"><a class="reference external" href="https://mothereff.in/url">URL encoder/decoder</a> is close to the above encoding, but not quite (try “query=!&amp;x=!”).</p>
</dd>
<dt>HTML element encoding:</dt>
<dd><p class="first">( &amp;, &lt;, &gt;, ” ) ==&gt; &amp;entity; ( ‘, / ) ==&gt; &amp;#xHH;</p>
<p><a class="reference external" href="https://mothereff.in/html-entities">HTML entity encoder/decoder</a> is close to the above encoding, but not quite (try “/”).</p>
<p class="last">See <a class="reference external" href="http://www.w3.org/International/questions/qa-escapes">NCRs (numeric character references)</a>.</p>
</dd>
<dt>CSS encoding:</dt>
<dd><p class="first">All non-alphanumeric &lt; 256 ==&gt; \HH (see <a class="reference external" href="http://www.w3.org/International/questions/qa-escapes#cssescapes">Using character escapes in markup and CSS - CSS escapes</a> for trailing spaces)</p>
<p>Alternatively, use the 6 digit hex encoding: e.g. “\HHHHHH”.</p>
<p class="last"><a class="reference external" href="https://mothereff.in/css-escapes">CSS escapes</a> likes to backslash escape and not hex encode, and at times misses even backslash encoding (try “x_”).</p>
</dd>
<dt>JavaScript encoding:</dt>
<dd><p class="first">All non-alphanumeric &lt; 256 ==&gt; \xHH (HH = 2 hex digits).</p>
<p>Alternatively, use unicode \uHHHH. For more information see <a class="reference external" href="https://mathiasbynens.be/notes/javascript-escapes">JavaScript character escape sequences</a>. Note that JavaScript uses <a class="reference external" href="http://en.wikipedia.org/wiki/UTF-16">UCS-2</a> encoding internally, so some unicode characters would required two \uHHHH encodings.</p>
<p class="last"><a class="reference external" href="https://mothereff.in/js-escapes">JavaScript escapes</a> either \xHH for everything or “only escape non-ASCII and unprintable ASCII characters”.</p>
</dd>
</dl>
<p>Here are some general conversion utilities (none of which do the above):</p>
<dl class="docutils">
<dt><a class="reference external" href="http://rishida.net/tools/conversion/">Unicode Code Converter</a></dt>
<dd>Enter data in “Mixed input” and then one of the action buttons.</dd>
<dt><a class="reference external" href="http://ha.ckers.org/xsscalc.html">XSS (Cross Site Scripting) Cheat Sheet Calculator</a></dt>
<dd>Character encoding for filter evasion.</dd>
<dt><a class="reference external" href="https://mothereff.in/utf-8">UTF-8 encoder/decoder</a> (converts everything to \xHH)</dt>
<dd>UTF-8 is a universal encoding.</dd>
</dl>
</div>
<div class="section" id="example-python-encoding-scripts">
<span id="id22"></span><h3>5.10.3.2. example python encoding scripts<a class="headerlink" href="#example-python-encoding-scripts" title="Permalink to this headline">¶</a></h3>
<p><a class="reference download internal" href="../_downloads/xsscoder.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">xsscoder.py</span></code></a> is a python script that will do css, javascript, and % encoding.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="c1"># encode/decoders</span>
<span class="k">def</span> <span class="nf">isalphanum</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
  <span class="k">return</span><span class="p">(</span> \
    <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="s1">&#39;a&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span> <span class="ow">or</span> \
    <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="s1">&#39;A&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span> <span class="ow">or</span> \
    <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s1">&#39;9&#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">encoder</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">isalphanum</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">fmt</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_encoder</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
  <span class="k">return</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">encoder</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="n">css_encoder</span> <span class="o">=</span> <span class="n">make_encoder</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;02X&#39;</span><span class="p">)</span>
<span class="n">js_encoder</span> <span class="o">=</span> <span class="n">make_encoder</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">x&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;02X&#39;</span><span class="p">)</span>
<span class="n">url_encoder</span> <span class="o">=</span> <span class="n">make_encoder</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;02X&#39;</span><span class="p">)</span>

<span class="c1"># allow multiple strings passed</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;strings&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;strings to encode&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># encode each input string</span>
<span class="n">process_me</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">strings</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">process_me</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">(</span> <span class="n">css_encoder</span><span class="p">,</span> <span class="n">js_encoder</span><span class="p">,</span> <span class="n">url_encoder</span> <span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference download internal" href="../_downloads/urlquote.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">urlquote.py</span></code></a> is a python script that will do smart % encoding.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># % encode a full URL, preserving equal and ampersand in the query part</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="c1"># allow multiple strings passed</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;strings&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;strings to </span><span class="si">% e</span><span class="s2">ncode&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># % encode each input string</span>
<span class="n">process_me</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">strings</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">process_me</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">ql</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span><span class="n">doseq</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> \
        <span class="n">qs</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">fragment</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="section" id="parsing-decoding-order">
<h3>5.10.3.3. parsing/decoding order<a class="headerlink" href="#parsing-decoding-order" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://docs.google.com/viewer?srcid=0B_Ci-1YbMqshWUtlaGRyLVBVd28&amp;pid=explorer">The Ultimate XSS Protection Cheat Sheet for Developers</a>, the client decoding order is</p>
<blockquote>
<div>HTML DECODING ==&gt; URL DECODING ==&gt; JavaScript DECODING</div></blockquote>
<p>and parsing is</p>
<blockquote>
<div><p>HTML PARSER ==&gt; CSS PARSER ==&gt; JavaScript PARSER</p>
<p>For untrusted string in the context of Event Handler Attribute, do JavaScript Escape first and then perform HTML escape since the Browser performs HTML attribute decode before JavaScript string decode. For untrusted string in the context of JavaScript, do JavaScript String Escape. And always quote your attributes, either ( <code class="docutils literal notranslate"><span class="pre">'</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;</span></code> ) never use backticks ( <code class="docutils literal notranslate"><span class="pre">`</span></code> ).</p>
<p>Do not use any escaping shortcuts like <code class="docutils literal notranslate"><span class="pre">\&quot;</span></code> because the quote character may be matched by the HTML attribute parser which runs first. These escaping shortcuts are also susceptible to “escape-the-escape” attacks where the attacker sends <code class="docutils literal notranslate"><span class="pre">\&quot;</span></code> and the vulnerable code turns that into <code class="docutils literal notranslate"><span class="pre">\\&quot;</span></code> which enables the quote. If an event handler attribute is properly quoted, breaking out requires the corresponding quote. Unquoted attributes can be broken out of with many characters including <code class="docutils literal notranslate"><span class="pre">[space]</span> <span class="pre">%</span> <span class="pre">*</span> <span class="pre">+</span> <span class="pre">,</span> <span class="pre">-</span> <span class="pre">/</span> <span class="pre">;</span> <span class="pre">&lt;</span> <span class="pre">=</span> <span class="pre">&gt;</span> <span class="pre">^</span></code> and <code class="docutils literal notranslate"><span class="pre">|</span></code>. Also, a <code class="docutils literal notranslate"><span class="pre">&lt;/script&gt;</span></code> closing tag will close a script block even though it is inside a quoted string. Note that the HTML parser runs before the JavaScript parser.</p>
</div></blockquote>
<p>The reverse of this recommendation is <a class="reference external" href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet#RULE_.231_-_HTML_Escape_then_JavaScript_Escape_Before_Inserting_Untrusted_Data_into_HTML_Subcontext_within_the_Execution_Context">RULE #1 - HTML Escape then JavaScript Escape Before Inserting Untrusted Data into HTML Subcontext within the Execution Context</a>. This would apply to:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;HTML&gt; Tags and markup&quot;</span><span class="p">;</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">outerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;HTML&gt; Tags and markup&quot;</span><span class="p">;</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;&lt;HTML&gt; Tags and markup&quot;</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">writeln</span><span class="p">(</span><span class="s2">&quot;&lt;HTML&gt; Tags and markup&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>But before you get too excited and think you might just have a glimmer of an idea as to the order of processing, read <a class="reference external" href="http://www.html5rocks.com/en/tutorials/speed/script-loading/">Deep dive into the murky waters of script loading</a>:</p>
<blockquote>
<div>Like all of the WHATWG specs, it initially looks like the aftermath of a cluster bomb in a scrabble factory, but once you’ve read it for the 5th time and wiped the blood from your eyes, it’s actually pretty interesting …</div></blockquote>
</div>
<div class="section" id="places-to-xss-inject-input">
<h3>5.10.3.4. places to XSS inject input<a class="headerlink" href="#places-to-xss-inject-input" title="Permalink to this headline">¶</a></h3>
<p>XSS is predicated on the idea that user-generated input is injected into HTML/URL data. And the injection point’s context may be nested (e.g. JavaScript in an HTML attribute) making the parsing/decoding order important.</p>
<dl class="docutils">
<dt>HTML element:</dt>
<dd><p class="first">&lt;div&gt; … &lt;/div&gt;</p>
<p class="last">The inserted data should be HTML escaped with named character references:</p>
</dd>
<dt>HTML attribute:</dt>
<dd><p class="first">&lt;div attr=…&gt;  &lt;/div&gt;</p>
<p class="last">Attributes should be single (‘) or double (“) quoted and HTML escaped.</p>
</dd>
<dt>JavaScript or Event Handler Attribute:</dt>
<dd><p class="first">&lt;script&gt; alert(…) &lt;/script&gt;
&lt;script&gt; var x = … &lt;/script&gt;
&lt;img src=”x.jpg” onload=”…” &gt;</p>
<p class="last">Attributes should be single (‘) or double (“) quoted.
Strings should be JavaScript, then HTML encoded. The reason is that the HTML attribute decoding occurs first, then JavaScript.</p>
</dd>
<dt>JSON value in HTML context:</dt>
<dd><a class="reference external" href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet#RULE_.233.1_-_HTML_escape_JSON_values_in_an_HTML_context_and_read_the_data_with_JSON.parse">RULE #3.1 - HTML escape JSON values in an HTML context and read the data with JSON.parse</a></dd>
<dt>URL path in HTML attribute:</dt>
<dd>URL escape the path and not the full URL.</dd>
<dt>HTML style and CSS:</dt>
<dd>Both use CSS encoding and then for HTML style do HTML encoding as the order of parsing is HTML Parser first and then CSS Parser.</dd>
<dt>HTML string in JavaScript:</dt>
<dd>HTML encoding followed by JavaScript encoding.</dd>
</dl>
<p>There are some contexts that should never be used:</p>
<p><a class="reference external" href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet#RULE_.230_-_Never_Insert_Untrusted_Data_Except_in_Allowed_Locations">RULE #0 - Never Insert Untrusted Data Except in Allowed Locations</a> gives a number of “never do’s”</p>
<blockquote>
<div><p>&lt;script&gt;…NEVER PUT UNTRUSTED DATA HERE…&lt;/script&gt;   directly in a script</p>
<p>&lt;!–…NEVER PUT UNTRUSTED DATA HERE…–&gt;             inside an HTML comment</p>
<p>&lt;div …NEVER PUT UNTRUSTED DATA HERE…=test /&gt;       in an attribute name</p>
<p>&lt;NEVER PUT UNTRUSTED DATA HERE… href=”/test” /&gt;      in a tag name</p>
<p>&lt;style&gt;…NEVER PUT UNTRUSTED DATA HERE…&lt;/style&gt;     directly in CSS</p>
<p>Most importantly, never accept actual JavaScript code from an untrusted source and then run it.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="double-encoding-why-order-matters">
<h2>5.10.4. double encoding &amp; why order matters<a class="headerlink" href="#double-encoding-why-order-matters" title="Permalink to this headline">¶</a></h2>
<p>Let’s start with an unsafe example that violates <a class="reference external" href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet#RULE_.230_-_Never_Insert_Untrusted_Data_Except_in_Allowed_Locations">RULE #0 - Never Insert Untrusted Data Except in Allowed Locations</a>. Don’t do this other than to illustrate double encoding: both JavaScript and HTML encoding.</p>
<p>Normally for this example you’d stand up a server with a form whose data is injected into HTML with several different types of encoding. But we wish to get a simpler example you can do at home without a server: we use the following snippet of code to mimic script injection:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="s2">&quot;Hello &lt;script&gt;document.write(&#39; cruel &#39;)&lt;/script&gt; World!&quot;</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">test</span><span class="p">);</span>
</pre></div>
</div>
<p>The string <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;document.write('</span> <span class="pre">cruel</span> <span class="pre">')&lt;/script&gt;</span></code> can be JavaScript encoded as</p>
<blockquote>
<div>x3cscriptx3edocumentx2ewritex28x27x20cruelx20x27x29x3cx2fscriptx3e</div></blockquote>
<p>and (partly) HTML-encoded as:</p>
<blockquote>
<div>&amp;lt;script&gt;document.write(‘ cruel ‘)&amp;lt;/script&gt;</div></blockquote>
<p>We’ll create an HTML file showing no encoding, JavaScript encoding, and HTML encoding results. To really “protect” the inserted code you would have to first HTML encode, then JavaScript encode the string. That way the HTML parser won’t get confused. But injecting user input into &lt;script&gt; tags is a losing battle.</p>
<p>Download <a class="reference download internal" href="../_downloads/parsing_order_test.html" download=""><code class="xref download docutils literal notranslate"><span class="pre">parsing_order_test.html</span></code></a>  and then open it up in a browser to view the different encoding results. Here is the actual text for our PDF and epub format documentation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Parsing Order Test&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Parsing Order Test&lt;/h1&gt;
&lt;h2&gt;HTML ==&gt; JavaScript ==&gt; HTML&lt;/h2&gt;
&lt;hr/&gt;
&lt;hr/&gt;
&lt;hr/&gt;
&lt;div&gt; Normally for this example you&#39;d stand up a server with a form whose data is injected into HTML with several different types of encoding. But we wish to get a simpler example you can do at home without a server: we use the following snippet of code to mimic script injection:
&lt;br/&gt;
&lt;code&gt;
var test = &quot;STRING&quot;;
document.write(test);
&lt;/code&gt;
&lt;/div&gt;
&lt;br/&gt;
&lt;div&gt; Here goes our HTML encoding test running 4 different strings: safe string, unencoded dangerous string, JavaScript encoded dangerous string, HTML encoded dangerous string.
&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;&quot;Hello World!&quot;
&lt;/li&gt;
&lt;li&gt;&quot;Hello &amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;lt;/script&gt; World!&quot;
&lt;/li&gt;
&lt;li&gt;&quot;Hello \x3cscript\x3edocument\x2ewrite\x28\x27\x20cruel\x20\x27\x29\x3c\x2fscript\x3e World!&quot;
&lt;/li&gt;
&lt;li&gt;&quot;Hello &amp;amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;amp;lt;/script&gt; World!&quot;
&lt;/li&gt;
&lt;/ol&gt;

&lt;hr/&gt;
&lt;hr/&gt;
&lt;hr/&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;div&gt; Safe string &lt;mark&gt;&quot;Hello World!&quot;&lt;/mark&gt;, no encoding.&lt;/div&gt;
&lt;br/&gt;
&lt;div&gt; Mimic variable &quot;test&quot; with safe value &lt;mark&gt;Hello World!&lt;/mark&gt; injected into &quot;document.write(test)&quot;: &lt;/div&gt;
&lt;div&gt;&amp;lt;script&gt; var test = &quot;Hello World!&quot;; document.write(test) &amp;lt;/script&gt;&lt;/div&gt;
&lt;hr/&gt;
Results:
&lt;br/&gt;
&lt;script&gt; var test = &quot;Hello World!&quot;; document.write(test) &lt;/script&gt;
&lt;hr/&gt;
Explanation:
&lt;br/&gt;
The HTML parser sees the script tags, passes the enclosed text to the JavaScript processor, which returns the plain text &lt;mark&gt;Hello World!&lt;/mark&gt; to the HTML processor. Next we&#39;ll try injecting some code.
&lt;hr/&gt;
&lt;hr/&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;div&gt; Unsafe string &lt;mark&gt;&quot;Hello &amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;lt;/script&gt; World!&quot;&lt;/mark&gt;, no encoding.&lt;/div&gt;
&lt;br/&gt;
&lt;div&gt; Mimic variable &quot;test&quot; injected with unsafe value &lt;mark&gt;Hello &amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;lt;/script&gt; World!&lt;/mark&gt; into &quot;document.write(test)&quot;: &lt;/div&gt;
&lt;div&gt;&amp;lt;script&gt; var test = &quot;Hello &amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;lt;/script&gt; World!&quot;; document.write(test) &amp;lt;/script&gt;: &lt;/div&gt;
&lt;hr/&gt;
Results:
&lt;br/&gt;
&lt;script&gt; var test = &quot;Hello &lt;script&gt;document.write(&#39; cruel &#39;)&lt;/script&gt; World!&quot;; document.write(test) &lt;/script&gt;
&lt;hr/&gt;
Explanation:
&lt;br/&gt;
&lt;div&gt; We humans see the first &amp;lt;/script&gt; tag as within a JavaScript string, but the HTML parser doesn&#39;t understand JavaScript and looks inside the JavaScript text for HTML tags it thinks end the script. And finds one. It then passes the invalid code &lt;mark&gt;var test = &quot;Hello &amp;lt;script&gt;document.write(&#39; cruel &#39;)&lt;/mark&gt; to the JavaScript parser which returns the empty string to the HTML parser. The HTML parser then processes the trailing &lt;mark&gt;World!&quot; document.write(test)&lt;/mark&gt; which you see in the output.&lt;/div&gt;
&lt;hr/&gt;
&lt;hr/&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;div&gt; Unsafe string &lt;mark&gt;&quot;Hello \x3cscript\x3edocument\x2ewrite\x28\x27\x20cruel\x20\x27\x29\x3c\x2fscript\x3e World!&quot;&lt;/mark&gt;, JavaScript encoding.&lt;/div&gt;
&lt;br/&gt;
&lt;div&gt; Take the prior example but JavaScript-encode the value: &lt;/div&gt;
&lt;div&gt;&amp;lt;script&gt; var test = &quot;Hello \x3cscript\x3edocument\x2ewrite\x28\x27\x20cruel\x20\x27\x29\x3c\x2fscript\x3e World!&quot;; document.write(test)&amp;lt;/script&gt; &lt;/div&gt;
&lt;hr/&gt;
Results:
&lt;br/&gt;
&lt;script&gt; var test = &quot;Hello \x3cscript\x3edocument\x2ewrite\x28\x27\x20cruel\x20\x27\x29\x3c\x2fscript\x3e World!&quot;; document.write(test) &lt;/script&gt;
&lt;hr/&gt;
Explanation:
&lt;br/&gt;
&lt;div&gt; So JavaScript-encoding the injected data didn&#39;t stop the script running - in fact it did better. The HTML parser doesn&#39;t see the internal string tags so passes the whole script to the JavaScript processor; the JavaScript processor un-encodes the data (that&#39;s what it&#39;s supposed to do), returns &lt;mark&gt;Hello &amp;lt;script&gt; document.write(&#39; cruel &#39;)&amp;lt;/script&gt; World!&lt;/mark&gt; to the HTML parser. The HTML parser sees the script tags and again calls the JavaScript processor which outputs the string &quot;Hello cruel World!&quot; to the HTML parser.&lt;/div&gt;
&lt;hr/&gt;
&lt;hr/&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;div&gt; Unsafe string &lt;mark&gt;&quot;Hello &amp;amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;amp;lt;/script&gt; World!&quot;&lt;/mark&gt;, partly HTML encoding.&lt;/div&gt;
&lt;br/&gt;
&lt;div&gt; Take the prior example but HTML-encode the value: &lt;/div&gt;
&lt;div&gt;&amp;lt;script&gt; var test = &quot;Hello &amp;amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;amp;lt;/script&gt; World!&quot;; document.write(test) &amp;lt;/script&gt;&lt;/div&gt;
&lt;hr/&gt;
Results:
&lt;br/&gt;
&lt;script&gt; var test = &quot;Hello &amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;lt;/script&gt; World!&quot;; document.write(test) &lt;/script&gt;
&lt;hr/&gt;
Explanation:
&lt;br/&gt;
&lt;div&gt; So HTML-encoding the injected data does stop the script running. The HTML parser doesn&#39;t see the &amp;lt;/script&gt; tag in the JavaScript, so passes the whole string to the JavaScript processor, who executes it returning &lt;mark&gt;&amp;amp;lt;script&gt;document.write(&#39; cruel &#39;)&amp;amp;lt;/script&gt;&lt;/mark&gt; to the HTML processor who displays it as text (changing the &amp;amp;lt; to &amp;lt;). &lt;/div&gt;
&lt;hr/&gt;
&lt;hr/&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Lessons Learned&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;div&gt;The above code violates &lt;a href=https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet#RULE_.230_-_Never_Insert_Untrusted_Data_Except_in_Allowed_Locations&gt;RULE #0 - Never Insert Untrusted Data Except in Allowed Locations&lt;/a&gt;. Never inject data inside &amp;lt;script&gt; tags. No amount of encoding can save you.&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;div&gt;Having said the above is bad, it does illustrate that ordering is important when doing double-encoding. As we can see above, JavaScript encoding the injected value would leave nothing for the HTML encoding to do, resulting in XSS injection working. However, HTML encoding first, then JavaScript encoding results in as safe execution as we can get. Which is not safe at all.&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
</div>
<div class="section" id="a-side-trip-on-url-encoding">
<h2>5.10.5. a side trip on URL encoding<a class="headerlink" href="#a-side-trip-on-url-encoding" title="Permalink to this headline">¶</a></h2>
<p>Our concern with URL encoding is to learn enough to recoginize exploitation opportunities and create (python) scripts for pentests. Of the 6 parts to python’s URL breakdown (<code class="docutils literal notranslate"><span class="pre">scheme://netloc/path;parameters?query#fragment</span></code>), the one we are most likely to exploit is the <a class="reference external" href="http://en.wikipedia.org/wiki/Query_string">query string</a> coming from an application/x-www-form-urlencoded form. If you’d like to learn more about URL encoding, read on.</p>
<div class="section" id="url-encoding-standards-and-python-routines">
<h3>5.10.5.1. URL encoding standards and python routines<a class="headerlink" href="#url-encoding-standards-and-python-routines" title="Permalink to this headline">¶</a></h3>
<p>What are the latest URL standards? <a class="reference external" href="https://en.wikipedia.org/wiki/URI_scheme">URI scheme</a> references <a class="reference external" href="http://tools.ietf.org/html/rfc3986">RFC 3986 Uniform Resource Identifier (URI): Generic Syntax</a> as the latest URI standards, replacing <a class="reference external" href="http://tools.ietf.org/html/rfc1738">RFC 1738 Uniform Resource Locators (URL)</a>. <a class="reference external" href="http://tools.ietf.org/html/rfc3986#section-1.1.3">URI, URL, and URN</a> defines these 3 terms:</p>
<blockquote>
<div>A URI can be further classified as a locator, a name, or both.  The    term “Uniform Resource Locator” (URL) refers to the subset of URIs    that, in addition to identifying a resource, provide a means of    locating the resource by describing its primary access mechanism    (e.g., its network “location”).  The term “Uniform Resource Name” (URN) has been used historically to refer to both URIs under the “urn” scheme [RFC2141], which are required to remain globally unique and persistent even when the resource ceases to exist or becomes unavailable, and to any other URI with the properties of a name.</div></blockquote>
<p>So we’re interested in URLs. For a formal definition of URL format, <a class="reference external" href="http://tools.ietf.org/html/rfc3986#appendix-A">Appendix A. Collected ABNF for URI</a> defines the URI BNF. The actual parsing/decoding/encoding of URLs is complex and subject to errors, so we’re more concerned about the coding (python) libraries for parsing/encoding URLs. Review python 3’s <a class="reference external" href="https://docs.python.org/3.4/library/urllib.parse.html">21.8.1. URL Parsing</a>. <code class="docutils literal notranslate"><span class="pre">urllib.parse.urlparse()</span></code> parses</p>
<blockquote>
<div>a URL into six components, returning a 6-tuple. This corresponds to the general structure of a URL: scheme://netloc/path;parameters?query#fragment.</div></blockquote>
<p>The important thing to remember is that the different URL parts have different python routines for quoting and unquoting: <code class="docutils literal notranslate"><span class="pre">quote()</span></code>/<code class="docutils literal notranslate"><span class="pre">unquote()</span></code> for path, <code class="docutils literal notranslate"><span class="pre">quote_plus()</span></code>/<code class="docutils literal notranslate"><span class="pre">unquote_plus()</span></code> for form values, and <code class="docutils literal notranslate"><span class="pre">urllib.parse.urlencode()</span></code> to encode form parameters for submission. For python 2 consult <a class="reference external" href="https://docs.python.org/2/library/urllib.html#utility-functions">20.5.2. Utility functions</a>. (Remember, python 2 doesn’t handle unicode well.) Alternatively, <a class="reference external" href="http://docs.python-requests.org/en/latest/">requests</a> could be used in python.</p>
</div>
<div class="section" id="subtleties-in-url-encoding">
<h3>5.10.5.2. subtleties in URL encoding<a class="headerlink" href="#subtleties-in-url-encoding" title="Permalink to this headline">¶</a></h3>
<p>Read <a class="reference external" href="http://blog.lunatech.com/2009/02/03/what-every-web-developer-must-know-about-url-encoding">What every web developer must know about URL encoding</a>. Basically, there’s a reason for python’s library structure and how it treats URL processing: the different URL parts (“scheme://netloc/path;parameters?query#fragment” in python) have different encoding and parsing rules. As pointed out in the article, some languages have less than complete URL handling and hand-coding URL processing is prone to error.</p>
</div>
<div class="section" id="url-encoding-example">
<h3>5.10.5.3. URL encoding example<a class="headerlink" href="#url-encoding-example" title="Permalink to this headline">¶</a></h3>
<p>Let’s figure out what this means (and doesn’t mean). The string <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('boo')</span> <span class="pre">&lt;/script&gt;</span></code> entered in a form can be URL encoded several ways: it is enough to replace each space by “+” (alternatively it could have chosen “%20”). But it’s not wrong to URL encode the other non-alphanumeric characters. So then the following minimal/maximal encodings of <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('boo')</span> <span class="pre">&lt;/script&gt;</span></code> are both correct:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;+</span><span class="n">alert</span><span class="p">(</span><span class="s1">&#39;boo&#39;</span><span class="p">)</span><span class="o">+&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">%</span><span class="mi">3</span><span class="n">Cscript</span><span class="o">%</span><span class="mi">3</span><span class="n">E</span><span class="o">+</span><span class="n">alert</span><span class="o">%</span><span class="mi">28</span><span class="o">%</span><span class="n">E2</span><span class="o">%</span><span class="mi">80</span><span class="o">%</span><span class="mi">98</span><span class="n">boo</span><span class="o">%</span><span class="n">E2</span><span class="o">%</span><span class="mi">80</span><span class="o">%</span><span class="mi">99</span><span class="o">%</span><span class="mi">29</span><span class="o">+%</span><span class="mi">3</span><span class="n">C</span><span class="o">%</span><span class="mi">2</span><span class="n">Fscript</span><span class="o">%</span><span class="mi">3</span><span class="n">E</span>
</pre></div>
</div>
<p>We’ll show that is true by using <code class="docutils literal notranslate"><span class="pre">curl</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">hacker@kali:~$ #</span> Minimal URL encoding: encode spaces as +
<span class="gp">hacker@kali:~$</span> curl -v <span class="se">\</span>
<span class="s1">&#39;https://xss-game.appspot.com/level1/frame?query=&lt;script&gt;+alert(&#39;</span>boo<span class="s1">&#39;)+&lt;/script&gt;&#39;</span>
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="gp">&gt;</span> GET /level1/frame?query<span class="o">=</span>&lt;script&gt;+alert<span class="o">(</span>boo<span class="o">)</span>+&lt;/script&gt; HTTP/1.1
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="go">      &lt;div&gt;</span>
<span class="go">Sorry, no results were found for &lt;b&gt;&lt;script&gt; alert(boo) &lt;/script&gt;&lt;/b&gt;. &lt;a href=&#39;?&#39;&gt;Try again&lt;/a&gt;.</span>
<span class="go">    &lt;/div&gt;</span>
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>


<span class="gp">hacker@kali:~$ #</span> Full URL encoding
<span class="gp">hacker@kali:~$</span> curl -v <span class="se">\</span>
    <span class="s1">&#39;https://xss-game.appspot.com/level1/frame?&#39;</span><span class="se">\</span>
<span class="s1">&#39;query=%3Cscript%3E+alert%28%E2%80%98boo%E2%80%99%29+%3C%2Fscript%3E&#39;</span>
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="gp">&gt;</span> GET /level1/frame?query<span class="o">=</span>%3Cscript%3E+alert%28%E2%80%98boo%E2%80%99%29+%3C%2Fscript%3E HTTP/1.1
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
<span class="go">      &lt;div&gt;</span>
<span class="go">Sorry, no results were found for &lt;b&gt;&lt;script&gt; alert(‘boo’) &lt;/script&gt;&lt;/b&gt;. &lt;a href=&#39;?&#39;&gt;Try again&lt;/a&gt;.</span>
<span class="go">    &lt;/div&gt;</span>
<span class="gp">#</span><span class="c1">##################### SNIP ######################</span>
</pre></div>
</div>
<p>So either encoding is parsed by the server to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;script&gt; alert(‘boo’) &lt;/script&gt;
</pre></div>
</div>
<p>and returned to the client. If you actually enter the URL encoded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>https://xss-game.appspot.com/level1/frame?
query=%3Cscript%3E+alert%28%E2%80%98boo%E2%80%99%29+%3C%2Fscript%3E
</pre></div>
</div>
<p>in <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code>’s address field you will get a popup: the key point being that no amount of URL encoding will prevent the <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span></code> from executing on the client and therefore being a XSS attack.</p>
</div>
<div class="section" id="url-encoding-example-and-iceweasel">
<h3>5.10.5.4. URL encoding example and <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code><a class="headerlink" href="#url-encoding-example-and-iceweasel" title="Permalink to this headline">¶</a></h3>
<p>To illustrate URL encoding we’ll use the Google XSS game <a class="reference external" href="https://xss-game.appspot.com/level1/frame">level 1 frame</a> because it (1) uses an application/x-www-form-urlencoded form, giving us an opportunity to view URL encoding in a form; and (2) echo’s the form’s input back between <code class="docutils literal notranslate"><span class="pre">&lt;div&gt;</span></code> ,,, <code class="docutils literal notranslate"><span class="pre">&lt;/div&gt;</span></code> tags allowing us to view the string received by the web server and experiment with escaping html in div’s. We’ll use the <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code> browser along with it’s developer console to URL encode the form’s input and display the actual traffic to/from the server. Finally, we’ll use <code class="docutils literal notranslate"><span class="pre">curl</span></code> when we wish to view the raw traffic (unprocessed by <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code>).</p>
<p>We first warn you that what you see in <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code>’s address field is not what’s actually sent to the web site. Browsing to <a class="reference external" href="https://xss-game.appspot.com/level1/frame">level 1 frame</a> and entering <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('boo')</span> <span class="pre">&lt;/script&gt;</span></code> shows the following in <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code>’s address field:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>https://xss-game.appspot.com/level1/frame?
query=&lt;script&gt;+alert(&#39;boo&#39;)+&lt;%2Fscript&gt;
</pre></div>
</div>
<p>but when you copy-&amp;-paste the field it actually shows up as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>https://xss-game.appspot.com/level1/frame?
query=%3Cscript%3E+alert%28%E2%80%98boo%E2%80%99%29+%3C%2Fscript%3E
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code> developer console shows the actual GET request sent corresponds not to what’s shown in the address field but what’s returned by copy-&amp;-paste; and the data received is what’s exactly shown in the output html page:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Request URL: https://xss-game.appspot.com/level1/frame?
    query=%3Cscript%3E+alert%28%E2%80%98boo%E2%80%99%29+%3C%2Fscript%3E

Response body: &lt;script&gt; alert(‘boo’) &lt;/script&gt;
</pre></div>
</div>
<p>The upshot is that visual inspection of <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code>’s address field cannot be trusted - copy-&amp;-paste it to see what’s really used.</p>
</div>
<div class="section" id="entering-data-vs-escaped-data-double-encoding">
<h3>5.10.5.5. entering data vs. escaped data (double-encoding)<a class="headerlink" href="#entering-data-vs-escaped-data-double-encoding" title="Permalink to this headline">¶</a></h3>
<p>So form data are encoded prior to being sent to the server. However, do not make the mistake that entering these encoded values directly in the <strong>form</strong> generates the same results as the original unencoded string <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('boo')</span> <span class="pre">&lt;/script&gt;</span></code>. The URL encoded values entered in the form are encoded a second time, changing the results: entering the URL-encoded string <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;+alert('boo')+&lt;%2Fscript&gt;</span></code> in Google XSS game level 1 frame does not generate the <code class="docutils literal notranslate"><span class="pre">alert()</span></code> of the orginal input <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('boo')</span> <span class="pre">&lt;/script&gt;</span></code>. Data entry of “%2F” is not the same as “/” as the “%2F” will be URL encoded as “%252F”, which is “%2F” and not “/”. Try this out by entering non-URL-escaped <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('boo')</span> <span class="pre">&lt;/script&gt;</span></code> first, then the escaped <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;+alert('boo')+&lt;%2Fscript&gt;</span></code> in the form <a class="reference external" href="https://xss-game.appspot.com/level1/frame">https://xss-game.appspot.com/level1/frame</a>.</p>
</div>
<div class="section" id="so-how-do-you-get-that-script-alert-foo-script-to-stop">
<h3>5.10.5.6. so how do you get that <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span> <span class="pre">alert('foo')</span> <span class="pre">&lt;/script&gt;</span></code> to stop?<a class="headerlink" href="#so-how-do-you-get-that-script-alert-foo-script-to-stop" title="Permalink to this headline">¶</a></h3>
<p>Here’s something you should be able to explain if you understand the kinds of content and encoding. Go to Google’s <a class="reference external" href="https://xss-game.appspot.com/">XSS game</a> <a class="reference external" href="https://xss-game.appspot.com/level1">level 1</a> and enter the following 3 strings and explain the resulting differences:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span><span class="n">alert</span><span class="p">(</span><span class="s2">&quot;boo&quot;</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">script</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">alert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">boo</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;)</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">script</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
<span class="o">%</span><span class="mi">3</span><span class="n">Cscript</span><span class="o">%</span><span class="mi">3</span><span class="n">Ealert</span><span class="o">%</span><span class="mi">28</span><span class="o">%</span><span class="mi">22</span><span class="n">boo</span><span class="o">%</span><span class="mi">22</span><span class="o">%</span><span class="mi">29</span><span class="o">%</span><span class="mi">3</span><span class="n">C</span><span class="o">%</span><span class="mi">2</span><span class="n">Fscript</span><span class="o">%</span><span class="mi">3</span><span class="n">E</span>
</pre></div>
</div>
<p>You will see that URL encoding won’t stop the script, but following <a class="reference external" href="https://www.owasp.org/index.php/XSS_%28Cross_Site_Scripting%29_Prevention_Cheat_Sheet#RULE_.231_-_HTML_Escape_Before_Inserting_Untrusted_Data_into_HTML_Element_Content">RULE #1 - HTML Escape Before Inserting Untrusted Data into HTML Element Content</a> works (the middle of the 3 strings above).</p>
<p>HTML escaping involves replacing text with their HTML-standard defined <a class="reference external" href="http://www.w3.org/TR/html5/syntax.html#named-character-references">named character references</a>. The recommended replacements are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Character</th>
<th class="head">Named Character Reference</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&amp;</td>
<td>&amp;amp;</td>
</tr>
<tr class="row-odd"><td>&lt;</td>
<td>&amp;lt;</td>
</tr>
<tr class="row-even"><td>&gt;</td>
<td>&amp;gt;</td>
</tr>
<tr class="row-odd"><td>“</td>
<td>&amp;quot;</td>
</tr>
<tr class="row-even"><td>‘</td>
<td>&amp;#27;</td>
</tr>
<tr class="row-odd"><td>/</td>
<td>&amp;#2F;</td>
</tr>
<tr class="row-even"><td>`</td>
<td>&amp;#60;</td>
</tr>
</tbody>
</table>
<p>An example of a named character reference is “&amp;frac34;” representing the unicode character “U+000BEU” corresponding to the glyph “¾” (which is a single character showing “3/4”). On the server side this does not act like the single character, but when displayed on the client side looks like the single character. Here’s an example using <code class="docutils literal notranslate"><span class="pre">curl</span></code> at the Google <a class="reference external" href="https://xss-game.appspot.com/">XSS game</a> <a class="reference external" href="https://xss-game.appspot.com/level1">level 1</a> using “&amp;frac34;” URL encoded to “%26frac34%3B”:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">hacker@kali:~$</span> curl -v <span class="se">\</span>
  <span class="s1">&#39;https://xss-game.appspot.com/level1/frame?query=%26frac34%3B&#39;</span> <span class="se">\</span>
  <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> egrep <span class="s1">&#39;(GET|Sorry)&#39;</span>
<span class="gp">&gt;</span> GET /level1/frame?query<span class="o">=</span>%26frac34%3B HTTP/1.1
<span class="go">Sorry, no results were found for &lt;b&gt;&amp;frac34;&lt;/b&gt;. &lt;a href=&#39;?&#39;&gt;Try again&lt;/a&gt;.</span>
</pre></div>
</div>
<p>So you can see as before the URL encoded “%26frac34%3B” becomes “&amp;frac34;” on the server side (and not the character “¾”), remaining that in the returned HTML. Only when displayed in <code class="docutils literal notranslate"><span class="pre">iceweasel</span></code> will the single character “¾” be displayed.</p>
<p>From a defensive side the character entity references are great: they look like the real character in the browser but don’t act like it either at the server or client. So “&amp;lt;script&amp;gt;” looks like “&lt;script&gt;” but doesn’t create a “&lt;script&gt;” tag in HTML.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pentest_network_tools.html" class="btn btn-neutral float-right" title="6. Pentest Network Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="hsts.html" class="btn btn-neutral" title="5.9. HSTS Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, bitbender.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>